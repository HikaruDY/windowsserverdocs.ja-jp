---
ms.assetid: 342173ca-4e10-44f4-b2c9-02a6c26f7a4a
title: 記憶域スペース ダイレクトのボリュームの計画
ms.prod: windows-server-threshold
ms.author: cosdar
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: cosmosdarwin
ms.date: 01/10/2019
ms.localizationpriority: medium
ms.openlocfilehash: e2d9e6828584f4027aa32cec26572c2290098ab6
ms.sourcegitcommit: 6f5bd789e165baf2b399033dae3eb958d16bc988
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/10/2019
ms.locfileid: "9000234"
---
# 記憶域スペース ダイレクトのボリュームの計画

> 適用対象: Windows Server 2016、Windows Server 2019

このトピックでは、ファイルシステム、回復性の種類、サイズの選択など、ワークロードのパフォーマンスや容量のニーズを満たすように記憶域スペース ダイレクトでボリュームを計画する方法について説明します。

## 復習: ボリュームとは

ボリュームとは、Hyper-V 仮想マシン用の VHD ファイルや VHDX ファイルなど、ワークロードに必要なファイルを置くデータストアのことです。 ボリュームでは、記憶域スペース ダイレクトのフォールト トレランス、スケーラビリティ、パフォーマンス上のメリットを活かすため、記憶域プール内のドライブが組み合わされます。

   >[!NOTE]
   > 記憶域スペース ダイレクトのドキュメント全体で、"ボリューム" という用語は、クラスター共有ボリューム (CSV) や ReFS など、他の組み込み Windows 機能により提供される機能を含む、ボリュームとその下の仮想ディスクを総称して使われます。 記憶域スペース ダイレクトを正しく計画して展開するために、これらの実装レベルの違いを理解する必要はありません。

![ボリュームとはvolumes](media/plan-volumes/what-are-volumes.png)

すべてのボリュームには、クラスター内のすべてのサーバーが同時にアクセスできます。 作成されると、すべてのサーバーの **C:\ClusterStorage\** に表示されます。

![csv フォルダーのスクリーンショット](media/plan-volumes/csv-folder-screenshot.png)

## 作成するボリュームの数の選択

ボリュームの数は、クラスター内のサーバーの数の倍数にすることをお勧めします。 たとえば、4 台のサーバーがある場合は、4 ボリュームの合計数よりも 3 または 5 より一貫したパフォーマンスが発生します。 これにより、クラスターはボリュームの "所有権" (1 台のサーバーが各ボリュームのメタデータ オーケストレーションを処理) をサーバー間に均等に分散できます。

ボリュームの合計数を制限することをお勧めします。

| Windows Server 2016          | Windows Server 2019          |
|------------------------------|------------------------------|
| クラスターあたり最大 32 ボリューム | クラスターあたり最大 64 ボリューム |

## ファイルシステムの選択

記憶域スペース ダイレクトには新しい [Resilient File System (ReFS)](../refs/refs-overview.md) を使うことをお勧めします。 ReFS は、仮想化に特化して構築された高度なファイルシステムであり、大幅なパフォーマンス向上やデータ破損に対する組み込みの保護など、多くのメリットがあります。 Windows Server バージョン 1709 以降でデータ重複除去をなど、ほぼすべてのキーの NTFS 機能がサポートしています。 詳細については、ReFS の[機能の比較表](../refs/refs-overview.md#feature-comparison)を参照してください。

ReFS がまだサポートしていない機能がワークロードに必要な場合、代わりに NTFS を使うことができます。

   >[!TIP]
   > ファイル システムの異なるボリュームが同じクラスター内に共存することができます。

## 回復性の種類の選択

記憶域スペース ダイレクト内のボリュームには、ドライブやサーバーの障害などのハードウェアの問題から保護し、ソフトウェア更新などのサーバー メンテナンス時に継続的な可用性を確保できる回復性が備わっています。

   >[!NOTE]
   > どの回復性を選ぶかは、使うドライブの種類とは関係ありません。

### サーバーが 2 台の場合

サーバーが 2 台のクラスターの場合、選べるのは双方向ミラーリングだけです。 すべてのデータのコピーが 2 つ保持されます (各サーバーのドライブ上にコピー 1 つずつ)。 その記憶域の効率は 50% です。つまり、1 TB のデータを書き込むには、記憶域プールに少なくとも 2 TB の物理的な記憶域の容量が必要になります。 双方向ミラーリングでは、一度に 1 件のハードウェア障害 (ドライブやサーバー) に安全に対処できます。

![双方向ミラー](media/plan-volumes/two-way-mirror.png)

サーバーが 3 台以上ある場合、次の回復性の種類のいずれかを代わりに使うことをお勧めします。

### サーバーが 3 台の場合

サーバーが 3 台の場合は、3 方向ミラーリングを使って、フォールト トレランスとパフォーマンスを向上させてください。 3 方向ミラーリングでは、すべてのデータのコピーが 3 つ保持されます (各サーバーのドライブ上にコピー 1 つずつ)。 その記憶域の効率は 33.3% です。つまり、1 TB のデータを書き込むには、記憶域プールに少なくとも 3 TB の物理的な記憶域の容量が必要になります。 3 方向ミラーリングでは、[一度に少なくとも 2 件のハードウェア問題 (ドライブやサーバー)](storage-spaces-fault-tolerance.md#examples) に安全に対処できます。 2 つのノードが利用できなくなった場合、記憶域プールで、ディスクの 2/3 が利用できず、仮想ディスクにアクセスできなくなるために、クォーラムが失われます。 ただし、ノードがダウンすることができ、別のノード上の 1 つまたは複数のディスクが失敗することが、仮想ディスクのオンライン状態します。 たとえば、あるサーバーを再起動しているときに別のドライブやサーバーで突然障害が発生した場合、すべてのデータの安全性が保たれ、アクセスし続けることができます。

![3 方向ミラー](media/plan-volumes/three-way-mirror.png)

### サーバーが 4 台以上の場合

サーバーが 4 台以上の場合、ボリュームごとに 3 方向ミラーリング、デュアル パリティ (多くの場合、"イレイジャー コーディング" と呼ばれます)、またはこれら 2 つの混合のどれを使うかを選ぶことができます。

デュアル パリティでは、3 方向ミラーリングと同じフォールト トレランスが実現されますが、記憶域の効率はより優れています。 サーバーが 4 台の場合、その記憶域の効率は 50.0% です。つまり、2 TB のデータを格納するには、記憶域プールに少なくとも 4 TB の物理的な記憶域の容量が必要になります。 サーバーが 7 台の場合、記憶域の効率は 66.7% に上昇し、記憶域の効率は最大 80.0% まで上昇します。 ただし、トレードオフとしてパリティ エンコーディングは負荷が高く、パフォーマンスが低下する可能性があります。

![デュアル パリティ](media/plan-volumes/dual-parity.png)

どの回復性の種類を使うかは、ワークロードのニーズに応じて判断してください。 どのワークロードは最適な各回復性の種類と回復性の種類ごとのパフォーマンスと記憶域の効率をまとめた表を次に示します。

| **回復性の種類**| **容量効率**| **速度**| **ワークロード**
|--------------------|--------------------------------|--------------------------------|--------------------------
| **Mirror (ミラー)**         | ![記憶域の効率示す 33%](media\plan-volumes\3-way-mirror-storage-efficiency.png)<br>3 方向ミラーリング: 33% <br>双方向ミラー: 50%     |![100% のパフォーマンスの表示](media\plan-volumes\three-way-mirror-perf.png)<br> 最高のパフォーマンス  | 仮想化されたワークロード<br> データベース<br>その他の高パフォーマンス ワークロード |
| **ミラーリングによって高速化されたパリティ** |![約 50% を示す記憶域の効率](media\plan-volumes\mirror-accelerated-parity-storage-efficiency.png)<br> ミラーとパリティの縦横比に依存します。 | ![約 20% を示すパフォーマンス](media\plan-volumes\mirror-accelerated-parity-perf.png)<br>かなり遅い、ミラーしますが、デュアル パリティと高速に 2 回セットアップ<br> 大規模なシーケンシャル書き込みと読み取りの最適なオプション | アーカイブ、バックアップ<br> 仮想デスクトップ インフラストラクチャ     |
| **デュアル パリティ**               | ![約 80% を示す記憶域の効率](media\plan-volumes\dual-parity-storage-efficiency.png)<br>サーバーが 4 台: 50% <br>16 台のサーバー: 最大 80% | ![約 10% を示すパフォーマンス](media\plan-volumes\dual-parity-perf.png)<br>I/O 待機時間が最も高いと書き込みの CPU 使用率<br> 大規模なシーケンシャル書き込みと読み取りの最適なオプション | アーカイブ、バックアップ<br> 仮想デスクトップ インフラストラクチャ  |

#### パフォーマンスが最も重要な場合

SQL Server データベースやパフォーマンスが重視される Hyper-V 仮想マシンなど、待ち時間要件が高いワークロードまたは混合ランダム IOPS を必要とするワークロードは、パフォーマンスが最大限に高めるため、ミラーリングを使うボリュームで実行してください。

   >[!TIP]
   > ミラーリングは、他の種類の回復性よりも高速です。 Microsoft では、パフォーマンスが重要なほぼすべての例でミラーリングを使っています。

#### 容量が最も重要な場合

データ ウェアハウスや "コールド" 記憶域など、書き込み頻度が低いワークロードは、記憶域の効率を最大限に高めるため、デュアル パリティを使うボリュームで実行してください。 従来型のファイル サーバー、仮想デスクトップ インフラストラクチャ (VDI)、高速ドリフト ランダム IO トラフィックを多く生成しないワークロード、最高のパフォーマンスを必要としないワークロードなど、他の特定のワークロードでも、各自の判断でデュアル パリティを使うことができます。 パリティでは、特に書き込みにおいて、必然的にミラーリングと比較して CPU 使用率と IO 待機時間が上昇します。

#### データが一括で書き込まれる場合

アーカイブ対象やバックアップ対象などの大規模なシーケンシャル パスで書き込むワークロードの場合、Windows Server 2016 の新しいオプションとして、1 つのボリュームにミラーリングとデュアル パリティを混在させることができます。 書き込みはまずミラーリングされた部分に行われ、徐々にパリティ部分に移行していきます。 これにより、負荷の高いパリティ エンコーディングを長時間実行できるようになるため、大規模な書き込み時に取り込みが高速化されてリソース使用率が低下します。 各部分のサイズを設定する場合、一度に発生する書き込みの量 (毎日行うバックアップ 1 回分のサイズなど) がミラーリング部分に十分に収まるようにしてください。 たとえば、1 日に 1 回 100 GB を取り込む場合は、ミラーリング用に 150 GB ～ 200 GB を使い、残りをデュアル パリティに使うことを検討してください。

最終的な記憶率の効率は、選んだ比率によって決まります。 例については、[このデモ](https://www.youtube.com/watch?v=-LK2ViRGbWs&t=36m55s)をご覧ください。

   >[!TIP]
   > ミラーリング部分に十分な大きさがないことや、- ミラーリングによってパリティは、ユース ケースに適してデータ injestion を通じて途中書き込みのパフォーマンスの突然の低下を監視する可能性があります。 例として場合、400 MB/秒からのパフォーマンスが低下を 40 MB/秒に書き込むミラーリング部分を拡張または 3 方向ミラーへの切り替えを検討してください。

### NVMe、SSD、HDD を使った展開について

2 種類のドライブが展開に存在する場合、速い方のドライブがキャッシングに使用され、遅い方のドライブがデータ格納用として使用されます。 これは、自動的に行われます。詳しくは、「[記憶域スペース ダイレクトのキャッシュについて](understand-the-cache.md)」をご覧ください。 このような展開では、最終的にすべてのボリュームが同じ種類のドライブ (データ格納用ドライブ) が存在することになります。

3 種類のドライブがすべて存在する展開の場合、最も速いドライブ (NVMe) だけがキャッシュに使用され、残りの 2 種類のドライブ (SSD と HDD) がデータ格納用として使用されます。 ボリュームごとに、すべて SSD 階層に配置する、すべて HDD 階層に配置する、または 2 つの階層にまたがって配置するかを選ぶことができます。

   >[!IMPORTANT]
   > SSD 階層を使って、パフォーマンスを最も重視するワークロードをオールフラッシュに配置することをお勧めします。

## ボリュームのサイズの選択

各ボリュームのサイズを制限することをお勧めします。

| Windows Server 2016 | Windows Server 2019 |
|---------------------|---------------------|
| 最大 32 TB         | 64 TB まで         |

   >[!TIP]
   > ファイル サーバー ワークロードに見られるようなボリューム シャドウ コピー サービス (VSS) と Volsnap ソフトウェア プロバイダーに依存するバックアップ ソリューションを使っている場合、ボリューム サイズを 10 TB に制限するとパフォーマンスおよび信頼性が向上します。 新しい Hyper-V RCT API、ReFS のブロックの複製、ネイティブ SQL バックアップ API を使うバックアップ ソリューションは、最大 32 TB 以上で適切に動作します。

### フットプリント

ボリュームのサイズとは、使用可能な容量、つまり格納可能なデータの量を指します。 これは、**New-Volume** コマンドレットの **-Size** パラメーターにより示され、**Get-Volume** コマンドレットを実行すると **Size** プロパティに表示されます。

サイズは、ボリュームの*フットプリント*とは異なります。フットプリントは、記憶域プールにおいてボリュームが占める物理的な記憶域の最大容量です。 フットプリントは、その回復性の種類によって異なります。 たとえば、3 方向ミラーリングを使うボリュームのフットプリントはサイズの 3 倍です。

ボリュームのフットプリントは、記憶域プールに収まる必要があります。

![サイズとフットプリントの違い](media/plan-volumes/size-versus-footprint.png)

### 容量の予約

記憶域プール内の一部の容量を未割り当てのままにすると、ドライブで障害が発生した後、ボリューム領域が "インプレース" で修復され、データの安全性とパフォーマンスが向上します。 容量が十分ある場合、インプレースの即時並行修復を行うと、障害が発生したドライブを交換する前でもボリュームが完全回復状態になります。 これは自動的に行われます。

サーバー (ドライブが最大 4 台) あたりドライブ 1 台分に相当する容量を予約することをお勧めします。 各自の判断でさらに多く予約することができますが、この最小推奨容量で、ドライブの障害発生後インプレースの即時並行修復が正常に行われます。

![予約](media/plan-volumes/reserve.png)

たとえば、サーバーが 2 台あって容量が 1 TB のドライブを使っている場合、2 x 1 = 2 TB のプールを予約として取っておきます。 サーバーが 3 台あって容量が 1 TB のドライブを使っている場合、3 x 1 = 3 TB を予約として取っておきます。 サーバーが 4 台以上あって容量が 1 TB のドライブを使っている場合、4 x 1 = 4 TB を予約として取っておきます。

   >[!NOTE]
   > 3 種類のドライブ (NVMe + SSD + HDD) がすべてあるクラスターでは、サーバー (それぞれドライブが最大 4 台) あたり SSD + HDD 1 台分に相当する容量を予約することをお勧めします。

## 例: 容量計画

サーバーが 4 台存在するクラスターが 1 つあるとします。 各サーバーには、いくつかのキャッシュ ドライブと、データ格納用に 16 台の 2 TB ドライブがあります。

```
4 servers x 16 drives each x 2 TB each = 128 TB
```

記憶域プール内のこの 128 TB から、障害後ドライブを急いで交換しなくてもインプレースの修復が行われるように 4 台のドライブ (つまり 8 TB) を取っておきます。 こうすると、ボリュームを作成可能な 120 TB の物理容量がプール内に残ります。

```
128 TB – (4 x 2 TB) = 120 TB
```

展開でかなりアクティブな Hyper-V 仮想マシンをホストする必要があるが、コールド記憶域 (保持する必要がある古いファイルやバックアップ) も多くあるとします。 サーバーが 4 台あるため、ボリュームを 4 つ作成しましょう。

仮想マシンは、最初の 2 つのボリューム (*Volume1* および *Volume2*) に置きます。 ファイルシステムとして ReFS を選び (すばやい作成とチェックポイントのため)、パフォーマンスを最大限に高めるため回復性として 3 方向ミラーリングを選びます。 コールド記憶域は、別の 2 つのボリューム (*Volume 3* および *Volume 4*) に置きます。 ファイルシステムとして NTFS を選び (データ重複除去のため)、容量を最大限に大きくするため回復性としてデュアル パリティを選びます。

すべてのボリュームを同じサイズにする必要はありませんが、簡潔にするため、たとえばすべてのボリュームを 12 TB にすることができます。

*Volume1* と *Volume2*は、それぞれ 33.3% の効率で 12 TB 専有するため、記憶域の合計容量は 36 TB になります。

*Volume3* と *Volume4*は、それぞれ 50.0% の効率で 12 TB 専有するため、記憶域の合計容量は 24 TB になります。

```
36 TB + 36 TB + 24 TB + 24 TB = 120 TB
```

4 つのボリュームは、プール内で使用できる物理的な記憶域の容量とまったく同じになります。 よくできました。

![例](media/plan-volumes/example.png)

   >[!TIP]
   > すべてのボリュームをすぐに作成する必要はありません。 ボリュームはいつでも拡張できますし、新しいボリュームを後で作成することもできます。

簡潔にするため、この例を通じて 10 進法の単位を使っています (つまり、1 TB = 1,000,000,000,000 バイト)。 しかし、Windows の記憶域の数量は 2 進法の単位で表示されます。 たとえば、2 TB の各ドライブは Windows では 1.82 TiB と表示されます。 同様に、128 TB の記憶域プールは 116.41 TiB と表示されます。 これは正常です。

## 使用方法

「[記憶域スペース ダイレクトのボリュームの作成](create-volumes.md)」をご覧ください。

### 関連項目

- [記憶域スペース ダイレクトの概要](storage-spaces-direct-overview.md)
- [記憶域スペース ダイレクト用のドライブの選択](choosing-drives.md)
- [フォールト トレランスと記憶域の効率](storage-spaces-fault-tolerance.md)
