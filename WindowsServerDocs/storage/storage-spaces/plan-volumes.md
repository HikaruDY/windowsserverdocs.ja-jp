---
ms.assetid: 342173ca-4e10-44f4-b2c9-02a6c26f7a4a
title: 記憶域スペース ダイレクトのボリュームの計画
ms.prod: windows-server-threshold
ms.author: cosdar
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: cosmosdarwin
ms.date: 06/28/2019
ms.localizationpriority: medium
ms.openlocfilehash: a04a362b65af8f184037d26728a1c147ca8ef948
ms.sourcegitcommit: 63926404009f9e1330a4a0aa8cb9821a2dd7187e
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/29/2019
ms.locfileid: "67469666"
---
# <a name="planning-volumes-in-storage-spaces-direct"></a>記憶域スペース ダイレクトのボリュームの計画

> 適用対象:Windows Server 2019、Windows Server 2016

このトピックでは、ファイルシステム、回復性の種類、サイズの選択など、ワークロードのパフォーマンスや容量のニーズを満たすように記憶域スペース ダイレクトでボリュームを計画する方法について説明します。

## <a name="review-what-are-volumes"></a>確認する:ボリュームとは

ボリュームは、VHD などのワークロードが必要なファイルまたは HYPER-V 仮想マシンの VHDX ファイルを配置します。 ボリュームでは、記憶域スペース ダイレクトのフォールト トレランス、スケーラビリティ、パフォーマンス上のメリットを活かすため、記憶域プール内のドライブが組み合わされます。

   >[!NOTE]
   > 記憶域スペース ダイレクトのドキュメント全体で、"ボリューム" という用語は、クラスター共有ボリューム (CSV) や ReFS など、他の組み込み Windows 機能により提供される機能を含む、ボリュームとその下の仮想ディスクを総称して使われます。 記憶域スペース ダイレクトを正しく計画して展開するために、これらの実装レベルの違いを理解する必要はありません。

![ボリュームとはvolumes](media/plan-volumes/what-are-volumes.png)

すべてのボリュームには、クラスター内のすべてのサーバーが同時にアクセスできます。 作成後に表示**C:\ClusterStorage\\** すべてのサーバー。

![csv フォルダーのスクリーンショット](media/plan-volumes/csv-folder-screenshot.png)

## <a name="choosing-how-many-volumes-to-create"></a>作成するボリュームの数の選択

ボリュームの数は、クラスター内のサーバーの数の倍数にすることをお勧めします。 たとえば、4 台のサーバーがある場合は、3 または 5 よりも 4 つの合計ボリュームで一貫したパフォーマンスが発生します。 これにより、クラスターはボリュームの "所有権" (1 台のサーバーが各ボリュームのメタデータ オーケストレーションを処理) をサーバー間に均等に分散できます。

ボリュームの合計数を制限することをお勧めします。

| Windows Server 2016          | Windows Server 2019          |
|------------------------------|------------------------------|
| クラスターあたり最大 32 個のボリューム | クラスターあたり最大 64 個のボリューム |

## <a name="choosing-the-filesystem"></a>ファイルシステムの選択

記憶域スペース ダイレクトには新しい [Resilient File System (ReFS)](../refs/refs-overview.md) を使うことをお勧めします。 ReFS は、仮想化に特化して構築された高度なファイルシステムであり、大幅なパフォーマンス向上やデータ破損に対する組み込みの保護など、多くのメリットがあります。 Windows Server バージョン 1709 以降でデータ重複除去をなど、ほぼすべてのキーの NTFS 機能をサポートします。 ReFS を参照してください。[機能比較表](../refs/refs-overview.md#feature-comparison)詳細についてはします。

ReFS がまだサポートしていない機能がワークロードに必要な場合、代わりに NTFS を使うことができます。

   > [!TIP]
   > ファイル システムの異なるボリュームが同じクラスター内に共存することができます。

## <a name="choosing-the-resiliency-type"></a>回復性の種類の選択

記憶域スペース ダイレクト内のボリュームには、ドライブやサーバーの障害などのハードウェアの問題から保護し、ソフトウェア更新などのサーバー メンテナンス時に継続的な可用性を確保できる回復性が備わっています。

   > [!NOTE]
   > どの回復性を選ぶかは、使うドライブの種類とは関係ありません。

### <a name="with-two-servers"></a>サーバーが 2 台の場合

2 つのサーバー クラスター内では、双方向ミラーリングを使用できます。 Windows Server 2019 を実行している場合は、入れ子になったの回復性も使用できます。

双方向ミラーリングも、各サーバーのドライブ上のすべてのデータの 2 つのコピーを 1 つのコピーは保持されます。 そのストレージ効率は 50%-1 TB のデータを書き込むには少なくとも 2 TB の記憶域プールの物理記憶域容量の必要があります。 双方向ミラーリングも、(1 つのサーバーまたはドライブ) の時点でその 1 つのハードウェア障害が許容できる安全にします。

![双方向ミラー](media/plan-volumes/two-way-mirror.png)

入れ子になった回復性 (Windows Server 2019 でのみ使用できます) は、双方向ミラーでは、サーバーの間でデータの回復性を提供し、双方向ミラーまたはパリティのミラー高速で、サーバー内の回復を追加します。 入れ子は、1 つのサーバーが再起動または使用できない場合でも、データの回復力を提供します。 その記憶域の効率は、入れ子になった双方向ミラーリングの 25% と約 35 ~ 40% 入れ子になったミラー アクセラレータを使用したパリティの場合は。 入れ子になったの回復性は、(2 つのドライブまたはサーバーと、残りのサーバー上のドライブ)、一度に 2 つのハードウェア障害を許容安全にできます。 Windows Server 2019 を実行している場合、この追加されたデータの回復性のため、2 台のサーバー クラスターの運用環境のデプロイを入れ子になったの回復性を使用して勧めします。 詳細については、次を参照してください。[回復性の入れ子になった](nested-resiliency.md)します。

![入れ子になったミラー アクセラレータを使用したパリティ](media/nested-resiliency/nested-mirror-accelerated-parity.png)

### <a name="with-three-servers"></a>サーバーが 3 台の場合

サーバーが 3 台の場合は、3 方向ミラーリングを使って、フォールト トレランスとパフォーマンスを向上させてください。 3 方向ミラーリングでは、すべてのデータのコピーが 3 つ保持されます (各サーバーのドライブ上にコピー 1 つずつ)。 その記憶域の効率は 33.3% です。つまり、1 TB のデータを書き込むには、記憶域プールに少なくとも 3 TB の物理的な記憶域の容量が必要になります。 3 方向ミラーリングでは、[一度に少なくとも 2 件のハードウェア問題 (ドライブやサーバー)](storage-spaces-fault-tolerance.md#examples) に安全に対処できます。 2 つのノードが利用できなくなった場合、記憶域プールで 2/3 のディスクが利用できないと、仮想ディスクはアクセスできないために、クォーラムが失われます。 ただし、ノードがダウンして別のノードで 1 つまたは複数のディスクが失敗して、仮想ディスクはオンラインのまま。 たとえば、あるサーバーを再起動しているときに別のドライブやサーバーで突然障害が発生した場合、すべてのデータの安全性が保たれ、アクセスし続けることができます。

![3 方向ミラー](media/plan-volumes/three-way-mirror.png)

### <a name="with-four-or-more-servers"></a>サーバーが 4 台以上の場合

次の 4 つまたは複数のサーバーを選択できますボリュームごとに 3 方向ミラーリング、多くの場合 (「イレイジャー コーディング」)、デュアル パリティを使用して、またはパリティのミラー アクセラレータを使用した 2 つを混合するかどうか。

デュアル パリティでは、3 方向ミラーリングと同じフォールト トレランスが実現されますが、記憶域の効率はより優れています。 4 台のサーバーでは、その記憶域の効率は 50.0%—to 2 TB を保存、データの 4 TB の記憶域プールの物理記憶域容量の必要があります。 サーバーが 7 台の場合、記憶域の効率は 66.7% に上昇し、記憶域の効率は最大 80.0% まで上昇します。 ただし、トレードオフとしてパリティ エンコーディングは負荷が高く、パフォーマンスが低下する可能性があります。

![デュアル パリティ](media/plan-volumes/dual-parity.png)

どの回復性の種類を使うかは、ワークロードのニーズに応じて判断してください。 どのワークロードは、回復性の種類ごとのパフォーマンスとストレージの効率性と回復性の種類ごとに、適合をまとめた表を次に示します。

| 回復性の種類 | 容量の効率性 | 速度 | ワークロード |
| ------------------- | ----------------------  | --------- | ------------- |
| **ミラー**         | ![33% の記憶域の効率性の表示](media/plan-volumes/3-way-mirror-storage-efficiency.png)<br>3 方向ミラーの場合:33% <br>双-方向ミラー:50%     |![100% のパフォーマンスの表示](media/plan-volumes/three-way-mirror-perf.png)<br> 最高のパフォーマンス  | 仮想化されたワークロード<br> データベース<br>その他の高パフォーマンス ワークロード |
| **ミラーリングによって高速化されたパリティ** |![記憶域の効率が約 50% を示す](media/plan-volumes/mirror-accelerated-parity-storage-efficiency.png)<br> ミラーおよびパリティの割合によって異なります | ![約 20% を示すパフォーマンス](media/plan-volumes/mirror-accelerated-parity-perf.png)<br>非常に遅い、ミラーしますが、2 回にデュアル パリティとして高速セットアップ<br> 大量のシーケンシャル書き込みと読み取りに最も適した | アーカイブとバックアップ<br> 仮想デスクトップ インフラストラクチャ     |
| **デュアル パリティ**               | ![約 80% を示す記憶域の効率](media/plan-volumes/dual-parity-storage-efficiency.png)<br>4 台のサーバー:50% <br>16 台のサーバー: 最大 80% | ![約 10% を示すパフォーマンス](media/plan-volumes/dual-parity-perf.png)<br>最高の I/O 待機時間と書き込みの CPU 使用率<br> 大量のシーケンシャル書き込みと読み取りに最も適した | アーカイブとバックアップ<br> 仮想デスクトップ インフラストラクチャ  |

#### <a name="when-performance-matters-most"></a>パフォーマンスが最も重要な場合

SQL Server データベースやパフォーマンスが重視される Hyper-V 仮想マシンなど、待ち時間要件が高いワークロードまたは混合ランダム IOPS を必要とするワークロードは、パフォーマンスが最大限に高めるため、ミラーリングを使うボリュームで実行してください。

   >[!TIP]
   > ミラーリングは、他の種類の回復性よりも高速です。 Microsoft では、パフォーマンスが重要なほぼすべての例でミラーリングを使っています。

#### <a name="when-capacity-matters-most"></a>容量が最も重要な場合

データ ウェアハウスや "コールド" 記憶域など、書き込み頻度が低いワークロードは、記憶域の効率を最大限に高めるため、デュアル パリティを使うボリュームで実行してください。 従来型のファイル サーバー、仮想デスクトップ インフラストラクチャ (VDI)、高速ドリフト ランダム IO トラフィックを多く生成しないワークロード、最高のパフォーマンスを必要としないワークロードなど、他の特定のワークロードでも、各自の判断でデュアル パリティを使うことができます。 パリティでは、特に書き込みにおいて、必然的にミラーリングと比較して CPU 使用率と IO 待機時間が上昇します。

#### <a name="when-data-is-written-in-bulk"></a>データが一括で書き込まれる場合

アーカイブ対象やバックアップ対象などの大規模なシーケンシャル パスで書き込むワークロードの場合、Windows Server 2016 の新しいオプションとして、1 つのボリュームにミラーリングとデュアル パリティを混在させることができます。 書き込みはまずミラーリングされた部分に行われ、徐々にパリティ部分に移行していきます。 これにより、負荷の高いパリティ エンコーディングを長時間実行できるようになるため、大規模な書き込み時に取り込みが高速化されてリソース使用率が低下します。 各部分のサイズを設定する場合、一度に発生する書き込みの量 (毎日行うバックアップ 1 回分のサイズなど) がミラーリング部分に十分に収まるようにしてください。 たとえば、1 日に 1 回 100 GB を取り込む場合は、ミラーリング用に 150 GB ～ 200 GB を使い、残りをデュアル パリティに使うことを検討してください。

最終的な記憶率の効率は、選んだ比率によって決まります。 例については、[このデモ](https://www.youtube.com/watch?v=-LK2ViRGbWs&t=36m55s)をご覧ください。

   > [!TIP]
   > データの取り込みを途中で書き込みパフォーマンスの急激な低下を観察するミラー部分が十分な大きさではないこと、またはミラー アクセラレータを使用したパリティいないユース ケースに適している可能性があります。 たとえば場合、パフォーマンスが低下してを 400 MB/秒から 40 MB/秒に書き込むをミラー部分を拡張または 3 方向ミラーへの切り替えを検討してください。

### <a name="about-deployments-with-nvme-ssd-and-hdd"></a>NVMe、SSD、HDD を使った展開について

2 種類のドライブが展開に存在する場合、速い方のドライブがキャッシングに使用され、遅い方のドライブがデータ格納用として使用されます。 これは、自動的に行われます。詳しくは、「[記憶域スペース ダイレクトのキャッシュについて](understand-the-cache.md)」をご覧ください。 このような展開では、最終的にすべてのボリュームが同じ種類のドライブ (データ格納用ドライブ) が存在することになります。

3 種類のドライブがすべて存在する展開の場合、最も速いドライブ (NVMe) だけがキャッシュに使用され、残りの 2 種類のドライブ (SSD と HDD) がデータ格納用として使用されます。 ボリュームごとに、すべて SSD 階層に配置する、すべて HDD 階層に配置する、または 2 つの階層にまたがって配置するかを選ぶことができます。

   > [!IMPORTANT]
   > SSD 階層を使って、パフォーマンスを最も重視するワークロードをオールフラッシュに配置することをお勧めします。

## <a name="choosing-the-size-of-volumes"></a>ボリュームのサイズの選択

各ボリュームのサイズを制限することをお勧めします。

| Windows Server 2016 | Windows Server 2019 |
| ------------------- | ------------------- |
| 32 tb まで         | 最大 64 TB         |

   > [!TIP]
   > ボリューム シャドウ コピー サービス (VSS) と Volsnap ソフトウェア プロバイダーに依存しているバックアップ ソリューションを使用するかどうか: as はファイル サーバーのワークロードで一般的な-10 TB のボリューム サイズを制限するパフォーマンスと信頼性が向上します。 新しい Hyper-V RCT API、ReFS のブロックの複製、ネイティブ SQL バックアップ API を使うバックアップ ソリューションは、最大 32 TB 以上で適切に動作します。

### <a name="footprint"></a>フットプリント

ボリュームのサイズとは、使用可能な容量、つまり格納可能なデータの量を指します。 これは、**New-Volume** コマンドレットの **-Size** パラメーターにより示され、**Get-Volume** コマンドレットを実行すると **Size** プロパティに表示されます。

サイズは、ボリュームの*フットプリント*とは異なります。フットプリントは、記憶域プールにおいてボリュームが占める物理的な記憶域の最大容量です。 フットプリントは、その回復性の種類によって異なります。 たとえば、3 方向ミラーリングを使うボリュームのフットプリントはサイズの 3 倍です。

ボリュームのフットプリントは、記憶域プールに収まる必要があります。

![サイズとフットプリントの違い](media/plan-volumes/size-versus-footprint.png)

### <a name="reserve-capacity"></a>容量の予約

記憶域プール内の一部の容量を未割り当てのままにすると、ドライブで障害が発生した後、ボリューム領域が "インプレース" で修復され、データの安全性とパフォーマンスが向上します。 容量が十分ある場合、インプレースの即時並行修復を行うと、障害が発生したドライブを交換する前でもボリュームが完全回復状態になります。 これは自動的に行われます。

サーバー (ドライブが最大 4 台) あたりドライブ 1 台分に相当する容量を予約することをお勧めします。 各自の判断でさらに多く予約することができますが、この最小推奨容量で、ドライブの障害発生後インプレースの即時並行修復が正常に行われます。

![予約](media/plan-volumes/reserve.png)

たとえば、サーバーが 2 台あって容量が 1 TB のドライブを使っている場合、2 x 1 = 2 TB のプールを予約として取っておきます。 サーバーが 3 台あって容量が 1 TB のドライブを使っている場合、3 x 1 = 3 TB を予約として取っておきます。 サーバーが 4 台以上あって容量が 1 TB のドライブを使っている場合、4 x 1 = 4 TB を予約として取っておきます。

   >[!NOTE]
   > 3 種類のドライブ (NVMe + SSD + HDD) がすべてあるクラスターでは、サーバー (それぞれドライブが最大 4 台) あたり SSD + HDD 1 台分に相当する容量を予約することをお勧めします。

## <a name="example-capacity-planning"></a>以下に例を示します。容量計画

サーバーが 4 台存在するクラスターが 1 つあるとします。 各サーバーには、いくつかのキャッシュ ドライブと、データ格納用に 16 台の 2 TB ドライブがあります。

```
4 servers x 16 drives each x 2 TB each = 128 TB
```

記憶域プール内のこの 128 TB から、障害後ドライブを急いで交換しなくてもインプレースの修復が行われるように 4 台のドライブ (つまり 8 TB) を取っておきます。 こうすると、ボリュームを作成可能な 120 TB の物理容量がプール内に残ります。

```
128 TB – (4 x 2 TB) = 120 TB
```

展開でかなりアクティブな Hyper-V 仮想マシンをホストする必要があるが、コールド記憶域 (保持する必要がある古いファイルやバックアップ) も多くあるとします。 サーバーが 4 台あるため、ボリュームを 4 つ作成しましょう。

仮想マシンは、最初の 2 つのボリューム (*Volume1* および *Volume2*) に置きます。 ファイルシステムとして ReFS を選び (すばやい作成とチェックポイントのため)、パフォーマンスを最大限に高めるため回復性として 3 方向ミラーリングを選びます。 コールド記憶域は、別の 2 つのボリューム (*Volume 3* および *Volume 4*) に置きます。 ファイルシステムとして NTFS を選び (データ重複除去のため)、容量を最大限に大きくするため回復性としてデュアル パリティを選びます。

すべてのボリュームを同じサイズにする必要はありませんが、簡潔にするため、たとえばすべてのボリュームを 12 TB にすることができます。

*Volume1* と *Volume2*は、それぞれ 33.3% の効率で 12 TB 専有するため、記憶域の合計容量は 36 TB になります。

*Volume3* と *Volume4*は、それぞれ 50.0% の効率で 12 TB 専有するため、記憶域の合計容量は 24 TB になります。

```
36 TB + 36 TB + 24 TB + 24 TB = 120 TB
```

4 つのボリュームは、プール内で使用できる物理的な記憶域の容量とまったく同じになります。 よくできました。

![例](media/plan-volumes/example.png)

   >[!TIP]
   > すべてのボリュームをすぐに作成する必要はありません。 ボリュームはいつでも拡張できますし、新しいボリュームを後で作成することもできます。

簡潔にするため、この例を通じて 10 進法の単位を使っています (つまり、1 TB = 1,000,000,000,000 バイト)。 しかし、Windows の記憶域の数量は 2 進法の単位で表示されます。 たとえば、2 TB の各ドライブは Windows では 1.82 TiB と表示されます。 同様に、128 TB の記憶域プールは 116.41 TiB と表示されます。 これは正常な動作です。

## <a name="usage"></a>使用方法

「[記憶域スペース ダイレクトのボリュームの作成](create-volumes.md)」をご覧ください。

### <a name="see-also"></a>関連項目

- [記憶域スペース ダイレクトの概要](storage-spaces-direct-overview.md)
- [記憶域スペース ダイレクトのドライブを選択します。](choosing-drives.md)
- [フォールト トレランスと記憶域の効率](storage-spaces-fault-tolerance.md)
