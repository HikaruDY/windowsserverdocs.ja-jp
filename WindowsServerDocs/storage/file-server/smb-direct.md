---
title: SMB ダイレクトを使用してファイル サーバーのパフォーマンスを向上させる
description: Windows Server 2012 R2、Windows Server 2012、および Windows Server 2016 での SMB ダイレクト機能について説明します。
ms.prod: windows-server-threshold
ms.topic: article
author: JasonGerend
ms.author: jgerend
ms.technology: storage
ms.date: 04/05/2018
ms.localizationpriority: medium
ms.openlocfilehash: ed8fd5b4114fc9fd9c7dc278a98cea8cc67a8749
ms.sourcegitcommit: d31e266130b3b082372f7af4024e6089cb347d74
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/28/2018
ms.locfileid: "4239229"
---
# SMB ダイレクト

>適用対象: Windows Server 2012 R2、Windows Server 2012、Windows Server 2016

Windows Server 2012 R2、Windows Server 2012、および Windows Server 2016 には、リモート ダイレクト メモリ アクセス (RDMA) 機能を持つネットワーク アダプターの使用をサポートする SMB ダイレクトと呼ばれる機能が含まれています。 RDMA のネットワーク アダプターは、ほとんどの CPU の使用中に非常に低遅延で、完全な速度で機能できます。 ワークロードの場合、HYPER-V や Microsoft SQL Server など、これにより、ローカル記憶域と同じようにリモート ファイル サーバーになります。 SMB ダイレクトが含まれます。

- スループットを向上させる: 高速ネットワークのネットワーク アダプターが大量の行の速度でのデータの転送を座標の完全なスループットを活用します。
- 低待機時間: ネットワーク要求に対する応答を非常に高速を提供し、その結果、により、直接接続されているブロック記憶域である場合のように感じリモートのファイル記憶域。
- 低 CPU 使用率: 残されて詳しくは、ネットワーク経由でデータを転送電源サーバー アプリケーションに利用できると CPU サイクルの数が減少を使用します。

SMB ダイレクトが自動的に構成されている Windows Server 2012 R2 と Windows Server 2012 でします。

## SMB マルチ チャネルと SMB ダイレクト

SMB マルチ チャネルは、担当 SMB ダイレクトを有効にするのには、ネットワーク アダプターの RDMA 機能を検出するための機能です。 SMB マルチ チャネルなし SMB は (すべてのネットワーク アダプターは、新しい RDMA スタックと共に TCP/IP スタックを提供)、RDMA 対応のネットワーク アダプターと標準の TCP/IP を使います。

SMB マルチ チャネルとは、SMB は、ネットワーク アダプターは RDMA 機能を備えてし、(インターフェイスあたり 2) その 1 つのセッションで複数の RDMA 接続を作成するかどうかを検出します。 これにより、高スループットを使用するには、低待機時間、および RDMA 対応のネットワーク アダプターで提供されている CPU 使用率が低い SMB できます。 また、複数の RDMA インターフェイスを使用している場合のフォールト トレランスを提供します。

>[!NOTE]
>ネットワーク アダプターの RDMA 機能を使用する場合にない、RDMA 対応のネットワーク アダプターをチームする必要があります。 チームと、ネットワーク アダプターは RDMA をサポートしていません。
>少なくとも 1 つの RDMA のネットワーク接続を作成した後、元のプロトコルのネゴシエーションに使用される TCP/IP 接続は使用されません。 ただし、RDMA のネットワーク接続が失敗する場合に、TCP/IP 接続は保持されます。

## 要件

SMB ダイレクト要件は次の。

- Windows Server 2012 R2 または Windows Server 2012 を実行している少なくとも 2 つのコンピューター
- 1 つまたは複数 RDMA 機能を持つネットワーク アダプター。

### SMB ダイレクトを使用した場合の考慮事項

- フェールオーバー クラスターで SMB ダイレクトを使用することができます。ただし、クライアント アクセスに使用するクラスター ネットワークが SMB ダイレクト十分対応であることを確認する必要があります。 フェールオーバー クラスターのクライアント アクセス用の複数のネットワークの使用をサポートして、ネットワーク アダプターと共に、RSS (Receive Side Scaling) に対応し、RDMA 対応します。
- SMB ダイレクト HYPER-V 管理オペレーティング システムで使用できるは over SMB、HYPER-V の使用をサポートし、HYPER-V の記憶域スタックを使用して仮想マシンに記憶域を提供します。 ただし、RDMA 対応のネットワーク アダプターは、HYPER-V クライアントに直接は公開されません。 RDMA 対応のネットワーク アダプターを仮想スイッチに接続する場合は、スイッチから仮想ネットワーク アダプターは RDMA 対応できません。
- SMB マルチ チャネルを無効にすると、SMB ダイレクトも無効になります。 SMB マルチ チャネルがネットワーク アダプターの機能を検出、ネットワーク アダプターは RDMA 対応するかどうかを決定しますので、SMB ダイレクトで使用できないクライアント SMB マルチ チャネルを無効にした場合。
- SMB ダイレクトでサポートされていません Windows RT SMB ダイレクト サポートが必要です RDMA 対応のネットワーク アダプターは Windows Server 2012 R2 および Windows Server 2012 でのみ利用できます。
- SMB ダイレクトは、下位レベルのバージョンの Windows Server ではサポートされません。 これは、Windows Server 2012 R2 および Windows Server 2012 でのみサポートされます。

## 有効にして、SMB ダイレクトを無効にします。

SMB ダイレクトは、既定で有効に Windows Server 2012 R2 または Windows Server 2012 がインストールされている場合。 SMB クライアントは自動的に検出し、適切な構成が識別された場合は、複数のネットワーク接続を使用します。

### 直接 SMB を無効にします。

通常、SMB ダイレクトを無効にする必要はありません、ただし、次の Windows PowerShell スクリプトを実行して、無効することができます。

特定のインターフェイスの RDMA 無効にして、次のように入力します。

```PowerShell
Disable-NetAdapterRdma <name>
```

すべてのインターフェイスの RDMA 無効にして、次のように入力します。

```PowerShell
Set-NetOffloadGlobalSetting -NetworkDirect Disabled
```

クライアントまたはサーバーで RDMA を無効にすると、システムは使用できません。 *Direct ネットワーク*は RDMA インターフェイスの基本的なネットワーク機能を Windows Server 2012 R2 および Windows Server 2012 の内部名です。

### 再ダイレクト SMB を有効にします。

RDMA を無効にした後できます再度有効にすることによって、次の Windows PowerShell スクリプトを実行しています。

特定のインターフェイスの RDMA を再度有効に、次のように入力します。

```PowerShell
Enable-NetAdapterRDMA <name>
```

すべてのインターフェイスの RDMA を再度有効に、次のように入力します。

```PowerShell
Set-NetOffloadGlobalSetting -NetworkDirect Enabled
```

クライアントとサーバーがもう一度使用することで RDMA を有効にする必要があります。

## SMB ダイレクトのパフォーマンスをテストします。

次の手順のいずれかを使用してパフォーマンスを操作する方法をテストすることができます。

### ファイルのコピーと SMB ダイレクトを使用したなしの比較します。

SMB ダイレクトのスループットを向上させるを測定する方法を次に示します。

1. SMB ダイレクトを構成します。
2. SMB ダイレクトを使用した大規模なファイル コピーを実行する時間の長さを測定します。
3. ネットワーク アダプターで RDMA を無効にすると、表示[の有効化および SMB ダイレクトを無効にします](#enabling-and-disabling-smb-direct)。
4. SMB ダイレクトを使用せずに大きなファイルのコピーを実行する時間の長さを測定します。
5. 再度、ネットワーク アダプターで RDMA を有効にして、2 つの結果を比較します。
6. キャッシュの影響を回避するには、次の操作を行う必要があります。
    1. 大量のデータ (より多くのデータのよりもメモリ処理) をコピーします。
    2. 演習 2 番目のコピーをタイミングと最初のコピーを 2 回、データをコピーします。
    3. サーバーと同様の条件下で動作するかどうかを確認する各テストの前に、クライアントの両方を再起動します。

### SMB ダイレクト ファイル コピー中に複数のネットワーク アダプターのいずれかが失敗します。

SMB ダイレクトのフェールオーバー機能を確認する方法を次に示します。

1. 複数のネットワーク アダプター構成で SMB ダイレクトが機能していることを確認します。
2. 大きなファイルのコピーを実行します。 コピーを実行すると、ケーブルのいずれかを切断して (またはいずれかのネットワーク アダプターを無効にして)、ネットワーク パスのいずれかのエラーをシミュレートします。
3. ファイルのコピーが引き続きされる残りのネットワーク アダプターのいずれかを使用して、ファイル コピーのエラーがないことを確認します。

>[!NOTE]
>SMB ダイレクトを使用しないワークロードのエラーを回避するために切断されたネットワーク パスを使用して、その他のワークロードがないになっていることを確認します。

## 詳細

- [サーバー メッセージ ブロックの概要](file-server-smb-overview.md)
- [サーバー、ストレージ、およびネットワークの可用性を向上: シナリオの概要](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831437(v%3dws.11)>)
- [Hyper-V over SMB の展開](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134187(v%3dws.11)>)
