---
title: AD フォレストの回復 - 最初の回復を実行します。
description: ''
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.date: 08/09/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.assetid: 5a291f65-794e-4fc3-996e-094c5845a383
ms.technology: identity-adds
ms.openlocfilehash: 8e05043d029636ddeb3a24349897ac61a713b2a7
ms.sourcegitcommit: 21165734a0f37c4cd702c275e85c9e7c42d6b3cb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/03/2019
ms.locfileid: "65034111"
---
# <a name="perform-initial-recovery"></a>最初の回復を実行します。  

>適用先:Windows Server 2016、Windows Server 2012 および 2012 R2、Windows Server 2008 および 2008 R2

このセクションには、次の手順が含まれています。  

- [各ドメイン内の最初の書き込み可能ドメイン コント ローラーを復元します。](#restore-the-first-writeable-domain-controller-in-each-domain)  
- [各復元された書き込み可能なドメイン コントローラがネットワークに再接続します。](#reconnect-each-restored-writeable-domain-controller-to-a-common-network)  
- [フォレスト ルート ドメインのドメイン コント ローラーにグローバル カタログを追加します。](#add-the-global-catalog-to-a-domain-controller-in-the-forest-root-domain)  

## <a name="restore-the-first-writeable-domain-controller-in-each-domain"></a>各ドメイン内の最初の書き込み可能ドメイン コント ローラーを復元します。  

以降、フォレスト ルート ドメインに書き込み可能な DC では、最初の DC を復元するにはこのセクションの手順を完了します。 Schema Admins と Enterprise Admins グループが格納されるため、フォレスト ルート ドメインが重要です。 フォレストの信頼階層を維持することもできます。 さらに、フォレスト ルート ドメインでは、通常は DNS ルート サーバーのフォレストの DNS 名前空間を保持します。 その結果、そのドメインの Active Directory 統合 DNS ゾーンには、(これは、レプリケーションに必要な) フォレストとグローバル カタログの DNS リソース レコード内の他のすべての Dc のエイリアス (CNAME) リソース レコードが含まれています。 
  
フォレスト ルート ドメインを回復した後は、フォレスト内の残りのドメインを回復する同じ手順を繰り返します。 1 つ以上のドメインを同時に回復します。ただし、信頼階層または DNS 名前解決が中断を防ぐために子を回復する前に常に親ドメインを回復します。 
  
回復するドメインごとに 1 つだけの書き込み可能 DC をバックアップから復元します。 これは、DC は失敗するフォレストの原因で影響されていないデータベースがある必要なため、回復の最も重要な一部です。 運用環境に導入される前に徹底的にテストする、信頼されているバックアップに重要です。 
  
次の手順を実行します。 特定の手順を実行するための手順が[AD フォレストの回復 - プロシージャ](AD-Forest-Recovery-Procedures.md)します。 
  
1. 物理サーバーを復元する場合は、DC がアタッチされていないと、そのため、実稼働ネットワークに接続されていないターゲットのネットワーク ケーブルを確認します。 仮想マシン、ネットワーク アダプターを削除するか、別のネットワークに接続されているネットワーク アダプターを使用して、運用ネットワークから分離されたときに、回復プロセスをテストすることができます。 
  
2. これは、ドメイン内の最初の書き込み可能な DC であるため、AD DS の権限のない状態の復元と SYSVOL の authoritative restore を実行する必要があります。 復元操作は、Active Directory 対応のバックアップを使用して完了する必要があり、Windows Server バックアップなどのアプリケーションの復元 (つまり、復元しないで、DC VM スナップショットの復元などのサポートされていないメソッドを使用して)。 
   - SYSVOL の authoritative restore が必要です、SYSVOL のレプリケーションがレプリケートされるため、障害から回復した後、フォルダーを開始する必要があります。 ドメインに追加されるそれ以降のすべての Dc には、権限のあるフォルダーを提供する前に選択されているフォルダーのコピーで、SYSVOL フォルダーが再同期する必要があります。 

   > [!CAUTION]
   > のみのフォレスト ルート ドメインで復元する最初の DC の SYSVOL の権限のある (または主) の復元操作を実行します。 SYSVOL データのレプリケーションの競合により、SYSVOL の主な復元操作の他の Dc 上で実行します。 

   - 2 つのオプションで AD DS の権限のない状態の復元と SYSVOL の authoritative restore を実行します。  
   - サーバーの完全回復を実行し、権限のない SYSVOL 同期を強制します。 詳細な手順については、次を参照してください。[サーバー全体の回復を実行する](AD-Forest-Recovery-Perform-a-Full-Recovery.md)と[DFSR でレプリケートされた SYSVOL の権限のある同期を実行](AD-Forest-Recovery-Authoritative-Recovery-SYSVOL.md)します。 
   - システム状態の復元後にサーバーの完全回復を実行します。 このオプションは、事前に両方の種類のバックアップを作成することが必要です。 サーバーの完全バックアップとシステム状態のバックアップ。 詳細な手順については、次を参照してください。[サーバー全体の回復を実行する](AD-Forest-Recovery-Perform-a-Full-Recovery.md)と[Active Directory Domain Services の権限のない状態の復元を実行する](AD-Forest-Recovery-Nonauthoritative-Restore.md)します。 
  
3. 復元して、書き込み可能 DC を再起動した後は、問題が発生しなかった、DC 上のデータに影響しないことを確認します。 DC のデータが破損している場合は、別のバックアップと手順 2. を繰り返します。 
   - 復元されたドメイン コント ローラーは、操作マスターの役割をホストしている場合は、中、書き込み可能なディレクトリ パーティションのレプリケーションが完了するまで、使用可能な AD DS を回避するためには、次のレジストリ エントリを追加する必要があります。  

      **HKLM\System\CurrentControlSet\Services\NTDS\Parameters\Repl Perform Initial Synchronizations**  
  
      データ型で、エントリを作成**REG_DWORD**の値と**0**します。 フォレストは完全に復旧した後にこのエントリの値をリセットできます**1**、ドメイン コント ローラーを再起動する必要があるとの保留操作マスターの役割が正常に AD DS の受信と送信のレプリケーションで、ドメイン コント ローラーとして自身をアドバタイズしてクライアントにサービスの提供を開始する前に、レプリカ パートナーを知られています。 サポート技術情報の記事を参照してください、初期同期要件の詳細については[305476](https://support.microsoft.com/kb/305476)します。 
  
      復元して、データを確認後にのみ、実稼働ネットワークにこのコンピューターを参加させる前に、次の手順に進みます。 
  
4. フォレスト全体の障害に関連したネットワーク不正侵入または悪意のある攻撃することが疑われる場合は、Enterprise Admins、Domain Admins、Schema Admins、Server Operators、アカウントのメンバーを含むすべての管理アカウントのアカウントのパスワードをリセットします。演算子のグループ、という具合です。 管理アカウントのパスワードのリセットは、追加のドメイン コント ローラーはフォレストの回復の次のフェーズ中にインストールする前に完了する必要があります。 
5. フォレスト ルート ドメインの最初の復元された DC 上には、すべてのドメイン全体およびフォレスト全体の操作マスターの役割を強制します。 フォレスト全体の操作マスターの役割を強制するのには、Enterprise Admins および Schema Admins の資格情報が必要です。 
  
     各子ドメインのドメイン全体の操作マスターの役割を強制します。 これらの役割を強制する場合、一時的にのみ復元された DC 上の操作マスターの役割を残した場合により、フォレスト回復のプロセスでこの時点でそれらの DC をに関するホストします。 後の復旧プロセスの一環として、必要に応じてで、操作マスターの役割を再配布することができます。 操作マスターの役割を強制する場合の詳細については、次を参照してください。[操作マスターの役割の強制](AD-forest-recovery-seizing-operations-master-role.md)します。 操作マスターの役割を配置する場所に関する推奨事項について、次を参照してください。[操作マスターとは?](https://technet.microsoft.com/library/cc779716.aspx)します。 
  
6. (この最初の DC を除くドメイン内のすべて書き込み可能 Dc) のバックアップから復元しないフォレスト ルート ドメインの他のすべての書き込み可能な Dc のメタデータをクリーンアップします。 後で、メタデータのクリーンアップが自動的に実行 DC オブジェクトを削除すると、Active Directory ユーザーとコンピューターまたは Active Directory サイトとサービスに含まれている Windows Server 2008 以降または Windows Vista 用の RSAT のバージョンを使用する場合。 さらに、サーバー オブジェクトと、削除された DC のコンピューター オブジェクトも自動的に削除されます。 詳細については、次を参照してください。[書き込み可能 Dc を削除するメタデータのクリーニング](AD-Forest-Recovery-Cleaning-Metadata.md)します。 
  
     別のサイトの dc の AD DS がインストールされている場合、メタデータのクリーンアップ、NTDS 設定オブジェクトが重複ができないようにします。 場合によっては、これも保存でした知識整合性チェッカー (KCC) Dc 自体は存在できない場合があります、レプリケーション リンクを作成するプロセス。 さらに、メタデータのクリーンアップの一部として、ドメイン内の他のすべての Dc の DC ロケーター DNS リソース レコードを DNS から削除されます。 
  
     ドメイン内の他のすべての Dc のメタデータを削除すると、するまでこのドメイン コント ローラーは RID マスターの役割を想定は、回復する前に、RID マスターの場合、そのため、新しい Rid を発行できませんが。 このエラーが発生するイベント ビューアーでシステム ログでイベント ID 16650 を表示してもありますが、16648 成功を示す少しメタデータをクリーンアップした後のイベント ID が表示されます。 
  
7. AD DS に格納されている DNS ゾーンがある場合は、ローカルの DNS サーバー サービスがインストールされ、復元した DC で実行されていることを確認します。 このドメイン コント ローラーがフォレストの障害発生前に DNS サーバーでない場合は、インストールし、DNS サーバーを構成する必要があります。 
  
    > [!NOTE]
    > 復元された DC では、Windows Server 2008 を実行する場合、サポート技術情報の記事では、修正プログラムをインストールする必要があります[975654](https://support.microsoft.com/kb/975654)または DNS サーバーをインストールするために一時的に分離されたネットワークにサーバーを接続します。 修正プログラムは、他のバージョンの Windows Server の必要はありません。 
  
     フォレスト ルート ドメインでは、優先 DNS サーバーとして独自の IP アドレス (またはループバック アドレスを 127.0.0.1 など) で、復元された DC を構成します。 ローカル エリア ネットワーク (LAN) アダプターの TCP/IP プロパティでは、この設定を構成することができます。 これは、フォレスト内の最初の DNS サーバーです。 詳細については、次を参照してください。 [DNS を使用するには、TCP/IP の構成](https://technet.microsoft.com/library/cc779282\(WS.10\).aspx)します。 
  
     各子ドメイン内には、優先 DNS サーバーとして、フォレスト ルート ドメインの最初の DNS サーバーの IP アドレスで、復元された DC を構成します。 LAN アダプターの TCP/IP のプロパティでは、この設定を構成することができます。 詳細については、次を参照してください。 [DNS を使用するには、TCP/IP の構成](https://technet.microsoft.com/library/cc779282\(WS.10\).aspx)します。 
  
     _Msdcs とドメインの DNS ゾーンでは、メタデータのクリーンアップ後に存在しなくなった Dc の NS レコードを削除します。 クリーンアップの Dc の SRV レコードが削除されたかどうかを確認します。 DNS SRV レコードの削除を高速化するには、次のコマンドを実行します。  
  
    ```  
    nltest.exe /dsderegdns:server.domain.tld  
    ```  
  
8. 使用可能な RID プールの値を 100,000 によって発生します。 詳細については、次を参照してください。[使用可能な RID プールの値を上げる](AD-Forest-Recovery-Raise-RID-Pool.md)します。 100,000 RID プールの発生が不十分である特定の状況と信じる理由があればが使用する安全な最下位の増加を確認する必要があります。 Rid は、有限のリソースでの不必要には使用できません。 
  
     新しいセキュリティ プリンシパルは、復元操作に使用するバックアップの時刻より後に、ドメインで作成された、これらのセキュリティ プリンシパルは、特定のオブジェクトに対するアクセス権があります。 これらのセキュリティ プリンシパルが存在しない復旧後ため、回復は、バックアップに戻されましたただし、そのアクセス権を取得される可能性があります。 使用可能な RID プールは、復元後に発生せず新しいユーザーはオブジェクトと同じセキュリティ Id (Sid) を取得、フォレストの回復後に作成されると、当初の意図しないが、これらのオブジェクトにアクセスします。 
  
     説明のため、石川さんも導入に記載されているという名前の新しい従業員の例を検討してください。 石川さんものユーザー オブジェクトは、ドメインの復元に使用したバックアップの後に作成されたために、復元操作後に存在しません。 ただし、復元操作後にそのユーザー オブジェクトに割り当てられていたすべてのアクセス権になる可能性があります。 そのユーザー オブジェクトの SID を復元操作後に新しいオブジェクトに再割り当てする場合、新しいオブジェクトは、これらのアクセス権を入手します。 
  
9. 現在の RID プールを無効にします。 システム状態の復元後に、現在の RID プールが無効にします。 現在の RID プールが、復元された DC が、バックアップの作成時に割り当てられた、RID プールから Rid を再発行することを防ぐために無効にする必要がシステム状態の復元が実行されていない場合ある。 詳細については、次を参照してください。[現在の RID プールを無効化](AD-Forest-Recovery-Invaildate-RID-Pool.md)します。 
  
    > [!NOTE]
    > 初めての RID プールを無効にした後、SID を持つオブジェクトを作成しようとした、エラーが表示されます。 オブジェクトを作成する試みは、新しい RID プール要求をトリガーします。 新しい RID プールが割り当てられるために、操作の再試行が成功します。 
  
10. 2 回、この DC のコンピューター アカウントのパスワードをリセットします。 詳細については、次を参照してください。[ドメイン コント ローラーのコンピューター アカウントのパスワードをリセットする](AD-Forest-Recovery-Reset-Computer-Account-DC.md)します。 
  
11. 2 回 krbtgt パスワードをリセットします。 詳細については、次を参照してください。 [krbtgt パスワードをリセットする](AD-Forest-Recovery-Resetting-the-krbtgt-password.md)します。 
  
     Krbtgt パスワードの履歴は、2 つのパスワードであるために、パスワードの履歴から元の (初期不良な) パスワードを削除するには、2 回のパスワードをリセットします。 
  
    > [!NOTE]
    > フォレストの回復がセキュリティ侵害への応答である場合は、信頼のパスワードをリセットすることもできます。 詳細については、次を参照してください。[信頼関係の 1 つの側での信頼のパスワードをリセットする](AD-Forest-Recovery-Reset-Trust.md)します。 
  
12. 場合は、フォレストに複数のドメインがあり、ユーザーが、復元された DC が、障害発生前にグローバル カタログ サーバーは、オフ、**グローバル カタログ**DC からグローバル カタログを削除する NTDS 設定プロパティのチェック ボックス。 このルールの例外は、1 つだけのドメインとフォレストの一般的なケースです。 この場合は、グローバル カタログを削除する必要はありません。 詳細については、次を参照してください。[グローバル カタログを削除する](AD-Forest-Recovery-Remove-GC.md)します。 
  
     詳細については、バックアップからグローバル カタログを復元することによって他のドメイン内の Dc を復元に使用されるその他のバックアップよりも新しい生じるかもしれない残留オブジェクト。 次の例を検討してください。 ドメイン A で、DC1 は時間 T1 で作成されたバックアップから復元されます。 ドメイン B、DC2 は、T2 の時点で取得されたグローバル カタログのバックアップから復元されます。 T2、T1 よりも新しいと、T1 と T2 の間にいくつかのオブジェクトが作成されたとします。 これらの Dc が復元されると、DC2 で、グローバル カタログには、新しいデータを保持してドメイン A の部分的なレプリカ ドメイン A の保留より自体。 DC2 は、これらのオブジェクトが dc1 に存在しないため、この場合、残留オブジェクトを保持します。 
  
     残留オブジェクトの存在は、問題につながります。 たとえば、電子メール メッセージをドメイン間で移動されたユーザー オブジェクトがユーザーに配信可能性があります。 期限切れの DC またはグローバル カタログ サーバーをオンラインに戻すを表示すると、グローバル カタログにユーザー オブジェクトの両方のインスタンスが表示されます。 両方のオブジェクトがある同じ電子メール アドレス。そのため、電子メール メッセージを配信できません。 
  
     2 つ目の問題は、存在しなくなったユーザー アカウントがグローバル アドレス一覧に引き続き表示されることです。 3 番目の問題は、存在しなくなったユニバーサル グループがユーザーのアクセス トークンに表示可能性がありますもことです。 
  
     かどうかは、グローバル カタログ DC を復元するでした — いずれかが誤ってまたは信頼している単独のバックアップであったためです: は、復元操作後にすぐには、グローバル カタログを無効にして残留オブジェクトの発生をできないようにすることをお勧めします。完了します。 グローバル カタログのフラグを無効にすると、すべての部分のレプリカ (パーティション) が失われると、定期的な DC の状態を relegating 自体のコンピューターが発生します。 
  
13. Windows タイム サービスを構成します。 フォレスト ルート ドメインでは、外部のタイム ソースから時刻を同期する、PDC エミュレーターを構成します。 詳細については、次を参照してください。[フォレスト ルート ドメインの PDC エミュレーターで Windows タイム サービスを構成する](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731191%28v=ws.10%29)します。 
  
## <a name="reconnect-each-restored-writeable-domain-controller-to-a-common-network"></a>共通のネットワークに各復元された書き込み可能ドメイン コント ローラーを再接続します。

この段階で、フォレスト ルート ドメインとの残りのドメインのそれぞれで、1 つの DC を復元 (および回復の手順を実行) が必要です。 これらの Dc を共通の環境の残りの部分から分離されたネットワークに参加し、フォレストの正常性とレプリケーションを検証するために、次の手順を完了します。

> [!NOTE]
> 物理 Dc を分離されたネットワークに参加すると、その IP アドレスを変更する必要があります。 その結果、DNS レコードの IP アドレスは、問題になります。 グローバル カタログ サーバーが利用できないために、DNS の安全な動的更新は失敗します。 仮想 Dc は、その IP アドレスを変更することがなく、新しい仮想ネットワークに参加させるため、ここでより便利です。 これは、フォレストの回復中に復元する最初のドメイン コント ローラーとして仮想 Dc をお勧めなぜ理由の 1 つです。 
  
検証後、Dc を実稼働ネットワークに参加させるし、フォレスト レプリケーションの正常性を確認する手順を完了します。

- 名前解決を解決するには、DNS 委任レコードを作成し、DNS 転送やルート ヒントに応じてを構成します。 実行**repadmin/replsum** Dc 間のレプリケーションを確認します。 
- 復元された DC は直接のレプリケーション パートナーではない場合、レプリケーションの回復はそれらの間の一時的な接続オブジェクトを作成してにずっと速くなります。 
- メタデータのクリーンアップを検証するには、次のように実行します。 **Repadmin/viewlist \*** フォレスト内のすべての Dc の一覧についてはします。 実行**Nltest/DCList:** *< ドメイン\>* ドメイン内のすべての Dc の一覧についてはします。 
- DC および DNS の正常性を確認するには、フォレスト内のすべての Dc でエラーを報告する DCDiag/v を実行します。 

## <a name="add-the-global-catalog-to-a-domain-controller-in-the-forest-root-domain"></a>フォレスト ルート ドメインのドメイン コント ローラーにグローバル カタログを追加します。

グローバル カタログは、これらおよびその他の理由は必要です。  
  
- ユーザーのログオンを有効にします。 
- 登録およびルート ドメインの DNS サーバーでレコードを削除するそれぞれの子ドメインの Dc で実行されている Net Logon サービスを有効にするには 
  
推奨されますが、フォレスト ルート DC はグローバル カタログになると、することは、復元された Dc がグローバル カタログのいずれかを選択します。 
  
> [!NOTE]
> フォレスト内のすべてのディレクトリ パーティションの完全な同期が完了するまで、DC はグローバル カタログ サーバーとしてアドバタイズされません。 そのため、各フォレストで復元された Dc にレプリケートする DC を強制する必要があります。 
>
> ディレクトリ サービス イベント ログを監視イベント ビューアーでイベント ID 1119、この DC がグローバル カタログ サーバーであることを示す、または、次のレジストリ キーが 1 の値を確認します。  
>
> **HKLM\System\CurrentControlSet\Services\NTDS\Parameters\Global Catalog Promotion Complete**  
  
詳細については、次を参照してください。[グローバル カタログを追加する](AD-Forest-Recovery-Add-GC.md)します。 
  
この段階では、フォレストのドメインごとに 1 つの dc の安定したフォレスト、1 つのグローバル カタログが必要です。 各 Dc を復元したばかりの新しいバックアップをする必要があります。 AD DS をインストールすることによって、フォレスト内の他の Dc を再デプロイする準備が整いました。 

## <a name="next-steps"></a>次の手順

- [AD フォレストの回復 - 前提条件](AD-Forest-Recovery-Prerequisties.md)  
- [AD フォレストの回復 - カスタム フォレスト回復の計画を立てる](AD-Forest-Recovery-Devising-a-Plan.md)  
- [AD フォレストの回復の問題の特定](AD-Forest-Recovery-Identify-the-Problem.md)
- [AD フォレストの回復に回復する方法を決定](AD-Forest-Recovery-Determine-how-to-Recover.md)
- [AD フォレストの回復 - 最初の回復を実行します。](AD-Forest-Recovery-Perform-initial-recovery.md)  
- [AD フォレストの回復 - 手順](AD-Forest-Recovery-Procedures.md)  
- [AD フォレストの回復 - よく寄せられる質問](AD-Forest-Recovery-FAQ.md)  
- [AD フォレストの回復 - Multidomain フォレスト内の 1 つのドメインを回復します。](AD-Forest-Recovery-Single-Domain-in-Multidomain-Recovery.md)  
- [AD フォレストの回復 - Windows Server 2003 ドメイン コント ローラーとフォレストの回復](AD-Forest-Recovery-Windows-Server-2003.md)  
