---
title: Active Directory Domain Services (AD DS) の安全な仮想化
description: Active Directory の USN ロールバックと安全な仮想化
ms.topic: article
ms.prod: windows-server
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 03/22/2019
ms.technology: identity-adds
ms.assetid: 7a3114c8-bda8-49bb-83a8-4e04340ab221
ms.openlocfilehash: 67e35a47467b1f5f66bfd073c6f9db06094ea3f9
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71391027"
---
# <a name="safely-virtualizing-active-directory-domain-services-ad-ds"></a>Active Directory Domain Services (AD DS) の安全な仮想化

>適用先:Windows Server

Windows Server 2012 以降、AD DS では、仮想化セーフな機能を導入することにより、ドメインコントローラーの仮想化のサポートが強化されています。 この記事では、ドメインコントローラーのレプリケーションにおける Usn と InvocationIDs の役割について説明し、発生する可能性のある問題について説明します。

## <a name="update-sequence-number-and-invocationid"></a>シーケンス番号と InvocationID の更新

論理クロック ベースのレプリケーション スキーマに依存する分散ワークロードに、仮想環境は特異な課題をもたらします。 AD DS レプリケーションは、たとえば各ドメイン コントローラー上でトランザクションに割り当てられる、単調に増加する値 (USN や Update Sequence Number と呼ばれる) を使用します。 各ドメインコントローラーのデータベースインスタンスにも、InvocationID と呼ばれる id が割り当てられます。 ドメイン コントローラーの InvocationID と USN が組み合わされて 1 つの一意の識別子となり、この識別子が各ドメイン コントローラー上で実行される各書き込みトランザクションに関連付けられます。この識別子はフォレスト内で一意である必要があります。

AD DS レプリケーションは、各ドメイン コントローラー上の InvocationID と USN を使用し、どの変更を他のドメイン コントローラーにレプリケートする必要があるかを判断します。 ドメインコントローラーがドメインコントローラーの認識の外部でロールバックされ、まったく異なるトランザクションのために USN が再利用された場合、他のドメインコントローラーが既に更新を受信していると見なされるため、レプリケーションは収束されません。InvocationID のコンテキストで、再利用された USN に関連付けられています。

たとえば、次の図は USN ロールバックが VDC2 で検出された場合に Windows Server 2008 R2 以前のオペレーティング システムで発生する一連のイベントを示しています。VDC2 は、仮想マシンで実行されているレプリケート先ドメイン コントローラーです。 この図では、レプリケーションパートナーが、以前にレプリケーションパートナーによって検出された最新の USN 値を VDC2 が送信したことを検出すると、VDC2 で USN ロールバックの検出が発生します。これは、Vdc2 データベースが時間内にロールバックされたことを示します。だ.

![USN ロールバックが検出されたときのイベントのシーケンス](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_Exampleofhowreplicationcanbecomeinconsistent.png)

仮想マシン (VM) を使用すると、ハイパーバイザー管理者はドメインコントローラーの Usn (その論理クロック) を簡単にロールバックできます。たとえば、ドメインコントローラーの認識の外部にスナップショットを適用することができます。 USN と USN ロールバックの詳細については、「 [USN and USN Rollback (USN と USN ロールバック)](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx#usn_and_usn_rollback)」を参照してください (このページには検出されない USN ロールバック インスタンスを示した他の図もあります)。

Windows Server 2012 以降では、VM 生成 ID と呼ばれる識別子を公開するハイパーバイザープラットフォームでホストされる仮想ドメインコントローラー AD DS、仮想マシンがロールされている場合に AD DS 環境を保護するために必要な安全性対策を検出して採用できます。VM スナップショットの適用によって時間が戻されます。 VM-GenerationID 設計では、ハイパーバイザー ベンダーに依存しないメカニズムを使用して、ゲスト仮想マシンのアドレス空間でこの識別子を公開します。このため、VM-GenerationID をサポートするあらゆるハイパーバイザーで、安全な仮想化が一貫して実現されます。 仮想マシン内で稼働しているサービスとアプリケーションでこの識別子を抽出することにより、仮想マシンが適時にロールバックされたかを調べることができます。

## <a name="effects-of-usn-rollback"></a>USN ロールバックの影響

USN ロールバックが発生した場合、オブジェクトと属性に対する変更は、以前に USN が表示されていた宛先ドメインコントローラーによってレプリケートされることはありません。

これらの移行先ドメインコントローラーは最新の状態であると見なされるため、レプリケーションエラーは、ディレクトリサービスのイベントログまたは監視と診断ツールで報告されません。

USN ロールバックは、任意のパーティション内の任意のオブジェクトまたは属性のレプリケーションに影響を与える可能性があります。 最もよく観察される副作用は、ロールバックドメインコントローラーで作成されたユーザーアカウントとコンピューターアカウントが、1つまたは複数のレプリケーションパートナーに存在しないことです。 または、ロールバックドメインコントローラーで発生したパスワードの更新がレプリケーションパートナーに存在しません。

USN ロールバックを使用すると、Active Directory パーティション内のオブジェクトの種類がレプリケートされないようにすることができます。 これらのオブジェクトの種類には、次のものが含まれます。

* Active Directory レプリケーショントポロジとスケジュール
* フォレスト内のドメインコントローラーの存在と、これらのドメインコントローラーによって保持される役割
* フォレスト内のドメインおよびアプリケーションパーティションの存在
* セキュリティグループとその現在のグループメンバーシップの存在
* Active Directory 統合 DNS ゾーンでの DNS レコードの登録

USN ホールのサイズは、ユーザー、コンピューター、信頼、パスワード、およびセキュリティグループに何百、何千もの変更を加える可能性があります。 USN の穴は、復元されたシステム状態のバックアップが作成されたときに存在していた最大の USN 値と、オフラインになる前にロールバックされたドメインコントローラーで作成された変更の発生回数の差によって定義されます。

## <a name="detecting-a-usn-rollback"></a>USN ロールバックの検出

USN ロールバックの検出は困難であるため、ドメインコントローラーは、ソースドメインコントローラーが以前に確認された USN 番号を宛先ドメインコントローラーに送信したときに、その呼び出し ID に対応する変更を行わずにイベント2095を記録します。

正しく復元されていないドメインコントローラーで Active Directory が生成された一意の更新を防止するために、Net Logon サービスが一時停止しています。 Net Logon サービスが一時停止されている場合、ユーザーアカウントとコンピューターアカウントは、このような変更を送信しないドメインコントローラーのパスワードを変更することはできません。 同様に、Active Directory 管理ツールは、Active Directory 内のオブジェクトを更新するときに、正常なドメインコントローラーを優先します。

ドメインコントローラーでは、次のようなイベントメッセージが記録されます。

* ソースドメインコントローラーは、事前に確認された USN 番号を宛先ドメインコントローラーに送信します。
* 呼び出し ID に対応する変更はありません。

これらのイベントは、ディレクトリサービスのイベントログに記録されます。 ただし、管理者によって確認される前に上書きされる可能性があります。

USN ロールバックが発生したが、イベントログに対応するイベントが表示されていないと思われる場合は、レジストリに DSA Not 書き込み可能エントリがないかどうかを確認します。 このエントリは、USN ロールバックが発生したことを示す法廷証拠を提供します。

```
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\NTDS\Parameters
Registry entry: Dsa Not Writable
Value: 0x4
```

> [!WARNING]
> Dsa Not 書き込み可能レジストリエントリの値を削除または手動で変更すると、ロールバックドメインコントローラーが完全にサポートされていない状態になります。 そのため、このような変更はサポートされていません。 具体的には、値を変更すると、USN ロールバック検出コードによって追加された検疫動作が削除されます。 ロールバックドメインコントローラーの Active Directory のパーティションは、同じ Active Directory フォレスト内の直接および推移的なレプリケーションパートナーと完全には一貫性がありません。

このレジストリキーと解決手順の詳細については、サポート記事 [Active Directory レプリケーションエラー8456または8457を参照してください。"Source |移行先サーバーは、現在、レプリケーション要求を拒否しています "](https://support.microsoft.com/help/2023007/active-directory-replication-error-8456-or-8457-the-source-destination)。

## <a name="virtualization-based-safeguards"></a>仮想化ベースのセーフガード

ドメインコントローラーのインストール時に、AD DS は、最初に Vm-generationid 属性の一部として VM Vm-generationid 識別子をデータベース内のドメインコントローラーのコンピューターオブジェクト (ディレクトリ情報ツリーまたは DIT と呼ばれます) に格納します。 VM GenerationID は、仮想マシン内部の Windows ドライバーによって単独に追跡されます。

管理者が以前のスナップショットから仮想マシンを復元する際には、仮想マシン ドライバー内の VM GenerationID の現在値が DIT 内の値と比較されます。

これら 2 つの値が異なる場合、invocationID がリセットされ、RID プールが破棄されます。この結果、USN の再使用が防止されます。 値が同じ場合、トランザクションは通常どおりコミットされます。

AD DS は、ドメイン コントローラーが再起動されるときにも毎回仮想マシンの VM GenerationID の現在値と DIT 内の値を比較します。それらの値が異なると、invocationID をリセットして RID プールを破棄し、新しい値を使用して DIT を更新します。 AD DS は、安全に復元する対策として、SYSVOL フォルダーの権限のない同期も実行します。 この結果、シャットダウンされた VM 上のスナップショットのアプリケーションまでセーフガードの範囲が広がります。 Windows Server 2012 で導入されたこれらのセーフガードにより、AD DS 管理者は、仮想化された環境でドメインコントローラーを展開および管理するという固有の利点を活用できます。

次の図は、Vm-generationid をサポートするハイパーバイザー上で Windows Server 2012 を実行する仮想化ドメインコントローラーで同じ USN ロールバックが検出された場合に、仮想化セーフガードがどのように適用されるかを示しています。

![同じ USN ロールバックが検出されたときに適用されるセーフガード](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_VDC_Exampleofhowsafeguardswork.gif)

この場合、ハイパーバイザーが VM-GenerationID 値の変化を検知した時点で仮想化セーフガードがトリガーされます。この結果、仮想化 DC の InvocationID がリセットされる (上の例では A から B にリセットされる) と共に、ハイパーバイザーによって保存された新しい値 (G2) と一致するように VM 上に保存されている VM-GenerationID 値が更新されます。 これらのセーフガードにより、レプリケーション時には両方のドメイン コントローラーが確実に収束されます。

Windows Server 2012 では、AD DS は、Vm-generationid を認識するハイパーバイザーでホストされている仮想ドメインコントローラー上でセーフガードを使用して、仮想マシンやその他のハイパーバイザー対応メカニズムを誤って適用し、コンピューターの状態によって AD DS 環境が中断されることはありません (USN バブルや残留オブジェクトなどのレプリケーションの問題を防ぐことができます)。

ドメインコントローラーをバックアップするための代替手段として、仮想マシンのスナップショットを適用してドメインコントローラーを復元することはお勧めしません。 引き続き Windows Server バックアップまたは他の VSS ライター ベース バックアップ ソリューションを使用することをお勧めします。

> [!CAUTION]
> 実稼働環境のドメインコントローラーが誤ってスナップショットに戻された場合は、次のようなプログラムの状態を確認するためのガイダンスとして、アプリケーションのベンダーと、その仮想マシンでホストされているサービスを参照することをお勧めします。スナップショットの復元。

詳細については、「[仮想化ドメイン コントローラーの安全な復元アーキテクチャ](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch)」を参照してください。

## <a name="recovering-from-a-usn-rollback"></a>USN ロールバックからの回復

USN ロールバックから回復するには、次の2つの方法があります。

* ドメインからドメインコントローラーを削除する
* 正常なバックアップのシステム状態を復元する

### <a name="remove-the-domain-controller-from-the-domain"></a>ドメインからドメインコントローラーを削除する

1. ドメインコントローラーから Active Directory を削除して、強制的にスタンドアロンサーバーにします。
2. 降格されたサーバーをシャットダウンします。
3. 正常なドメインコントローラーで、降格されたドメインコントローラーのメタデータをクリーンアップします。
4. 不適切に復元されたドメインコントローラーが操作マスターの役割をホストしている場合は、これらの役割を正常なドメインコントローラーに転送します。
5. 降格されたサーバーを再起動します。
6. が必要な場合は、スタンドアロンサーバーに Active Directory をもう一度インストールします。
7. ドメインコントローラが以前はグローバルカタログである場合は、ドメインコントローラをグローバルカタログとして構成します。
8. 以前にドメインコントローラーが操作マスターの役割をホストしていた場合は、操作マスターの役割をドメインコントローラーに転送し直します。

### <a name="restore-the-system-state-of-a-good-backup"></a>正常なバックアップのシステム状態を復元する

このドメインコントローラに対して有効なシステム状態のバックアップが存在するかどうかを評価します。 ロールバックドメインコントローラーが誤って復元される前に有効なシステム状態のバックアップが作成され、そのバックアップにドメインコントローラーで行われた最近の変更が含まれている場合は、最新のバックアップからシステム状態を復元します。

また、バックアップのソースとしてスナップショットを使用することもできます。 または、[適切なシステム状態データバックアップが使用できない場合の仮想ドメインコントローラーの復元](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553%28v%3dws.10%29#restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available)に関するセクションの手順に従って、データベース自体に新しい呼び出し ID を指定するように設定することもできます。

## <a name="next-steps"></a>次の手順

* 仮想化ドメイン コントローラーのトラブルシューティングにの詳細については、「 [Virtualized Domain Controller Troubleshooting](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md)」を参照してください。
* [Windows タイムサービス (W32Time) の詳細情報](../../networking/windows-time-service/windows-time-service-top.md)
