---
Title: HYPER-V を使用してドメイン コント ローラーの仮想化
description: Windows Server Active Directory ドメイン コント ローラー、HYPER-V で仮想化する場合の考慮事項
author: MicrosoftGuyJFlo
ms.author: joflore
ms.date: 04/19/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.openlocfilehash: 8a1775a40761e4a489cc39535514d75174edffa5
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/31/2019
ms.locfileid: "66442991"
---
# <a name="virtualizing-domain-controllers-using-hyper-v"></a>HYPER-V を使用してドメイン コント ローラーの仮想化

> 適用対象:Windows Server 2016

このトピックでは、ガイダンスを Windows Server 2016 に適用できるようにするために更新されます。 Windows Server 2012 には、仮想化ドメイン コント ローラー (Dc) の仮想 Dc の USN のロールバックと仮想 Dc の複製機能しないようにするための保護を含む多くの改良が導入されています。 これらの機能強化の詳細については、次を参照してください。 [Active Directory Domain Services (AD DS) Virtualization (Level 100) の概要](../../introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100.md)します。

HYPER-V では、1 台の物理コンピューター上に別のサーバー ロールを統合します。 このガイドでは、32 ビットまたは 64 ビットのゲスト オペレーティング システムとして実行中のドメイン コント ローラーについて説明します。

## <a name="planning-to-virtualize-domain-controllers"></a>ドメイン コント ローラーを仮想化の計画

ここでは、hyper-v サーバーのハードウェア要件、HYPER-V サーバーと仮想マシン、およびセキュリティとパフォーマンスに関する意思決定の構成の適切な種類を選択すると、障害の 1 つの点を回避する方法。

## <a name="hyper-v-requirements"></a>HYPER-V の要件

インストールして、HYPER-V ロールを使用して、次が必要です。

   - **X64 プロセッサ**
      - HYPER-V は、x64 ベース バージョンの Windows Server 2008 以降で使用できます。  
   - **ハードウェア依存の仮想化**
      - この機能は、仮想化オプションは、具体的には、Intel Virtualization Technology (Intel VT) または AMD Virtualization (AMD-V) プロセッサで使用できます。  
   - **ハードウェア データ実行防止 (DEP)**
      - ハードウェア DEP は、有効になっていますである必要があります。 具体的には、Intel XD ビットが有効にする必要があります (execute disable bit) または AMD NX ビット (no execute bit)。  

## <a name="avoid-creating-single-points-of-failure"></a>単一障害点を作成しないでください。

仮想ドメイン コント ローラーの展開を計画するときに、潜在的な単一障害点を作成しないようにしようとする必要があります。 システムの冗長性を実装することで潜在的な単一障害点の概要を回避できます。 たとえば、管理コストの増加が発生する可能性を念頭に置きながら、次の推奨事項を考慮してください。

1. ドメインごとに少なくとも 2 つの仮想化ドメイン コント ローラーを 1 つの仮想化ホストが失敗した場合は、すべてのドメイン コント ローラーを失うことのリスクを軽減する別の仮想化ホストで実行します。  
2. その他のテクノロジの推奨されるようにドメイン コント ローラーが実行されている (異なる Cpu、マザーボード、ネットワーク アダプター、またはその他のハードウェアを使用して)、ハードウェアを分散します。 ハードウェアの多様化では、仕入先の構成、ドライバー、または 1 つまたはハードウェアの種類に固有の障害によって発生する可能性のある損害を制限します。  
3. 可能であれば、ドメイン コント ローラーは、世界のさまざまな地域に配置されているハードウェアで実行する必要があります。 これにより、災害や位置のドメイン コント ローラーがホストされているサイトに影響を与える障害の影響を軽減します。  
4. 各ドメインで、物理ドメイン コント ローラーを維持します。 これは、そのプラットフォームを使用するすべてのホスト システムに影響を与える仮想化プラットフォームの障害のリスクを軽減します。  

## <a name="security-considerations"></a>セキュリティの考慮事項

仮想ドメイン コント ローラーが実行されているホスト コンピューターは、場合でも、そのコンピューターがドメインに参加しているか、ワークグループ コンピューターのみを書き込み可能なドメイン コント ローラーとして慎重に管理する必要があります。 これは、重要なセキュリティの考慮事項です。 不適切な管理ホストでは、特権の昇格攻撃では、悪意のあるユーザーがアクセスすると発生して正規に割り当てられているまたは承認されなかったシステム特権に対して脆弱です。 悪意のあるユーザーがこの種の攻撃を使用して、すべての仮想マシンをドメインを侵害することができ、フォレストをこのコンピューターがホストされます。

必ず、ドメイン コント ローラーを仮想化を計画しているときに、次のセキュリティに関する考慮事項を留意してください。

   - 仮想マシン、書き込み可能のドメイン コント ローラーは、のすべてのドメインとフォレストに属しているドメイン コント ローラーを既定のドメイン管理者の資格情報と同じ考慮する必要がありますをホストするコンピューターのローカル管理者です。  
   - セキュリティとパフォーマンスの問題を回避するために推奨される構成では、HYPER-V 以外のアプリケーションなしの Windows Server 2008 以降の Server Core インストールを実行するホストです。 この構成では、アプリケーションと、パフォーマンスが向上しより少ないアプリケーションとコンピューターまたはネットワークの攻撃に悪用悪意のあるサービスでする必要があります、サーバーにインストールされているサービスの数を制限します。 この種類の構成の効果は、攻撃対象が少ないと呼ばれます。 ブランチ オフィスまたは他の場所に対して十分なセキュリティ保護することはできませんが、読み取り専用ドメイン コント ローラー (RODC) の使用をお勧めします。 個別の管理ネットワークが存在する場合は、管理ネットワークにのみ、ホストが接続されていることをお勧めします。  
   - Bitlocker を使用するには、ドメイン コント ローラーで、Windows Server 2016 以降、システム ボリュームのロックを解除するゲストのキー マテリアルも付与する仮想 TPM 機能を使用することができます。
   - [保護され、ファブリックとシールドされた Vm](/it-server/WindowsServerDocs/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms.md)ドメイン コント ローラーを保護するその他のコントロールを提供することができます。

Rodc の詳細については、次を参照してください。[読み取り専用ドメイン コント ローラーの計画と展開ガイド](../../deploy/rodc/read-only-domain-controller-updates.md)します。

ドメイン コント ローラーのセキュリティ保護に関する詳細については、次を参照してください。 [Active Directory のインストールをセキュリティで保護するためのベスト プラクティス ガイド](../../plan/security-best-practices/best-practices-for-securing-active-directory.md)します。

## <a name="security-boundaries-for-different-host-and-guest-configurations"></a>別のホストとゲスト構成のセキュリティの境界

仮想マシンを使用すると、ドメイン コント ローラーのさまざまな構成を含めることは可能になります。 仮想マシンが境界と、Active Directory トポロジ内の信頼関係に影響する方法を慎重に検討を指定する必要があります。 Active Directory のドメイン コント ローラーとホスト (HYPER-V サーバー) とそのゲスト コンピューター (仮想マシンが HYPER-V サーバーで実行されている) の可能な構成については、次の表で説明します。

|コンピューター|構成 1|Configuration 2|
|-------|---------------|---------------|
|Host|ワークグループまたはメンバーのコンピューター|ワークグループまたはメンバーのコンピューター|
|Guest|ドメイン コントローラー|ワークグループまたはメンバーのコンピューター|

![](media/virtualized-domain-controller-architecture/Dd363553.f44706fd-317e-4f0b-9578-4243f4db225f(WS.10).gif)

   - ホスト コンピューターの管理者では、書き込み可能なドメイン コント ローラーのゲストには、ドメイン管理者と同じアクセス許可を持つし、として扱う必要があります。 RODC ゲストは、ホスト コンピューターの管理者は、ゲスト RODC 上のローカル管理者と同じアクセスを持っています。   
   - 仮想マシンのドメイン コント ローラーは、ホストが同じドメインに参加している場合、ホストで管理者権限を持ちます。 悪意のあるユーザーが最初に仮想マシン 1 へのアクセスを取得した場合は、すべての仮想マシンを侵害する悪意のあるユーザーの機会があります。 これは、攻撃ベクトルと呼ばれます。 複数のドメインまたはフォレストのドメイン コント ローラーがある場合は、これらのドメインが 1 つのドメインの管理者がすべてのドメインで信頼されて一元管理に必要です。  
   - RODC として仮想マシン 1 がインストールされている場合でも、仮想マシンの 1 からの攻撃の機会が存在します。 RODC の管理者がドメイン管理者権限を明示的に必要ありませんが、ホスト コンピューターにポリシーを送信する、RODC を使用できます。 これらのポリシーには、スタートアップ スクリプトが含まれます。 この操作が成功した場合は、ホスト コンピューターが侵害される可能性が、ホスト コンピューター上の他の仮想マシンを侵害し、使用できます。  

## <a name="security-of-vhd-files"></a>VHD ファイルのセキュリティ

仮想ドメイン コント ローラーの VHD ファイルは、物理ドメイン コント ローラーの物理ハード ドライブと同じです。 そのため、同じ量の物理ドメイン コント ローラーのハード ドライブをセキュリティで保護することに注意を保護する必要があります。 信頼性の高い、信頼された管理者のみがドメイン コント ローラーの VHD ファイルへのアクセスを許可されることを確認します。

## <a name="rodcs"></a>Rodc

Rodc の利点の 1 つ、物理的なセキュリティ保証できないなどでブランチ オフィスの場所に配置する機能があります。 Windows BitLocker ドライブ暗号化を使用して VHD ファイル自体を保護することができます (ファイル システムではなくそこ) から、ホストの物理ディスクの盗難による侵害を防止します。 
<!-- Removed link to Windows Server 2008 Hyper-V and BitLocker Drive Encryption (http://go.microsoft.com/fwlink/?linkid=123534). Link is dead. -->

## <a name="performance"></a>パフォーマンス

マイクロ カーネルの新しい 64 ビット アーキテクチャは、以前の仮想化プラットフォームから、HYPER-V のパフォーマンスの大幅な向上があります。 最適なホストのパフォーマンスをホストの Windows Server 2008 以降の Server Core インストールをする必要があり、HYPER-V がインストールされている以外のサーバーの役割は必要ありません。

仮想マシンのパフォーマンスは、具体的には、ワークロードに依存します。 Active Directory 満足のいくパフォーマンスを保証するには、特定のトポロジをテストします。 現在のワークロードを信頼性およびパフォーマンス モニター (Perfmon.msc) などのツールを使用して、期間にわたって評価または[Microsoft Assessment and Planning (MAP) toolkit](https://go.microsoft.com/fwlink/?linkid=137077)します。 マップ ツールも、すべてのサーバーと、ネットワークに現在存在するサーバーの役割のインベントリを作成する場合に役立ちます。

仮想化ドメイン コント ローラーのパフォーマンスの一般的な考えを取得するには、次のパフォーマンス テストを実行したで、 [Active Directory のパフォーマンス テスト ツール (ADTest.exe)](https://go.microsoft.com/fwlink/?linkid=137088)します。

ライトウェイト ディレクトリ アクセス プロトコル (LDAP) のテストは、物理ドメイン コント ローラーと同じサーバーで ADTest.exe、物理ドメイン コント ローラーし、次がホストされている仮想マシンに実行されました。 物理コンピューターで、1 つだけの論理プロセッサが使用され、1 つだけの仮想プロセッサは、仮想マシンの CPU 使用率が 100% を簡単に使用されました。 文字および各テストの後のかっこ内の数字は、次の表で ADTest.exe、特定のテストを指定します。 このデータが示すように仮想化ドメイン コント ローラーのパフォーマンスは物理ドメイン コント ローラーのパフォーマンスの 88 に 98% にしました。

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>測定</th>
<th>テスト</th>
<th>運動能力</th>
<th>仮想</th>
<th>デルタ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1 秒あたりの検索</p></td>
<td><p>基本スコープ (L1) の共通名の検索</p></td>
<td><p>11508</p></td>
<td><p>10276</p></td>
<td><p>-10.71%</p></td>
</tr>
<tr class="even">
<td><p>1 秒あたりの検索</p></td>
<td><p>一連の基本スコープ (L2) の属性の検索</p></td>
<td><p>10123</p></td>
<td><p>9005</p></td>
<td><p>-11.04%</p></td>
</tr>
<tr class="odd">
<td><p>1 秒あたりの検索</p></td>
<td><p>基本スコープ (L3) のすべての属性の検索</p></td>
<td><p>1284</p></td>
<td><p>1242</p></td>
<td><p>-3.27%</p></td>
</tr>
<tr class="even">
<td><p>1 秒あたりの検索</p></td>
<td><p>サブツリーのスコープ (L6) の共通名の検索</p></td>
<td><p>8613</p></td>
<td><p>7904</p></td>
<td><p>-8.23%</p></td>
</tr>
<tr class="odd">
<td><p>1 秒あたりに正常にバインドします</p></td>
<td><p>高速バインド (B1) を実行します。</p></td>
<td><p>1438</p></td>
<td><p>1374</p></td>
<td><p>-4.45%</p></td>
</tr>
<tr class="even">
<td><p>1 秒あたりに正常にバインドします</p></td>
<td><p>単純なバインド (B2) の実行します。</p></td>
<td><p>611</p></td>
<td><p>550</p></td>
<td><p>-9.98%</p></td>
</tr>
<tr class="odd">
<td><p>1 秒あたりに正常にバインドします</p></td>
<td><p>実行する NTLM を使用してバインド (B5)</p></td>
<td><p>1068</p></td>
<td><p>1056</p></td>
<td><p>-1.12%</p></td>
</tr>
<tr class="even">
<td><p>書き込み数/秒</p></td>
<td><p>複数の属性 (W2) の書き込み</p></td>
<td><p>6467</p></td>
<td><p>5885</p></td>
<td><p>-9.00%</p></td>
</tr>
</tbody>
</table>

満足のいくパフォーマンスを確実には、統合コンポーネント (IC) は、「啓発」またはハイパーバイザーに対応した合成のドライバーを使用するゲスト オペレーティング システムにインストールされました。 インストール プロセス中には、エミュレートされた Integrated Drive Electronics (IDE) またはネットワーク アダプターのドライバーを使用するために必要な場合があります。 運用環境では、パフォーマンスを向上させる統合ドライバーでこれらのエミュレートされたドライバーを置き換える必要があります。

信頼性とパフォーマンスのマネージャー (Perfmon.msc) を使ってバーチャル マシンのパフォーマンスを監視すると、仮想マシン内で CPU 情報されません物理プロセッサの仮想 CPU がスケジュールされている方法は、結果として完全に正確です。 HYPER-V サーバーで実行されている仮想マシンの CPU 情報を取得する場合は、パーティション ホストで HYPER-V ハイパーバイザーの論理プロセッサ カウンターを使用します。

パフォーマンスの詳細については AD DS と、HYPER-V の両方のチューニングを参照してください[パフォーマンス チューニング ガイドラインの Windows Server 2016](../../../../administration/performance-tuning/index.md)します。
<!-- Updated to 2016 perf guidance -->

また、差分ディスクを VHD には、パフォーマンスが低下するために、ドメイン コント ローラーとして構成されている仮想マシンで差分ディスク VHD を使用する予定は。 差分ディスクを含む、HYPER-V ディスクの種類の詳細についてを参照してください。[新しい仮想ハード_ディスクの作成ウィザード](http://go.microsoft.com/fwlink/?linkid=137279)します。
<!-- Couldn't find an equivalent WS 2016 Hyper-V article. -->

仮想ホスト環境で AD DS の詳細については、次を参照してください。[仮想ホスト環境で Active Directory ドメイン コント ローラーをホストする場合の考慮事項](https://go.microsoft.com/fwlink/?linkid=141292)マイクロソフト サポート技術情報でします。

## <a name="deployment-considerations-for-virtualized-domain-controllers"></a>仮想化ドメイン コント ローラーの展開に関する考慮事項

これには、ドメイン コント ローラーと時刻の同期とストレージに関する注意事項を展開するときに避ける必要のあるいくつかの一般的な仮想マシン プラクティスがあります。

## <a name="virtualization-deployment-practices-to-avoid"></a>仮想化展開のプラクティスを回避するには

など、HYPER-V の仮想化プラットフォームでは、さまざまな管理、保守、バックアップ、およびコンピュータを簡単に移行する便利な機能を提供します。 ただし、次の一般的な展開のプラクティスと機能は適していない仮想ドメイン コント ローラー。

- Active Directory の書き込みの耐久性を確実に展開しないでください仮想ドメイン コント ローラーのデータベース ファイル (Active Directory データベース (NTDS します。DIT)、ログ、SYSVOL) 仮想 IDE ディスクにします。 代わりに、仮想 SCSI コント ローラーに接続された 2 つ目の VHD を作成し、データベース、ログ、および SYSVOL をドメイン コント ローラーのインストール時の仮想マシンの SCSI ディスクに配置がいることを確認します。  
- ドメイン コント ローラーとして構成している仮想マシンでは、差分ディスク仮想ハード ディスク (Vhd) を実装しません。 これにより、以前のバージョンに戻すには簡単すぎるとパフォーマンスも低下します。 VHD の種類の詳細については、次を参照してください。[新しい仮想ハード_ディスクの作成ウィザード](https://go.microsoft.com/fwlink/?linkid=137279)します。  
- 新しい Active Directory ドメインとフォレスト システム準備ツール (Sysprep) を使用してにまず準備されていない Windows Server オペレーティング システムのコピーでは展開しないでください。 Sysprep を実行する方法の詳細については、次を参照してください[Sysprep (システム準備) の概要。](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview)

   > [!WARNING]
   > ドメイン コント ローラーで Sysprep を実行することはできません。

- 潜在的な更新シーケンス番号 (USN) ロールバック状況を防ぐために、追加のドメイン コント ローラーをデプロイ、既にデプロイされているドメイン コント ローラーを表す VHD ファイルのコピーを使用しないでください。 USN ロールバックの詳細については、 [USN および USN ロールバックに関するページ](#usn-and-usn-rollback)をご覧ください。
   - Windows Server 2012 以降では、管理者は追加のドメイン コント ローラーをデプロイするときに、適切に準備する場合は、ドメイン コント ローラーのイメージを複製するには
- ドメイン コント ローラーを実行している仮想マシンをエクスポートする HYPER-V のエクスポート機能を使わないでください。
  - Windows Server 2012 以降で、エクスポートとインポートのドメイン コント ローラーの仮想ゲストは非 authoritative restore のようなとして処理生成 ID の変更を検出して、複製用に構成されていません。
  - もはやにエクスポートしたゲストを使用していないことを確認します。
    - HYPER-V レプリケーションを使用して、ドメイン コント ローラーの 2 つ目の非アクティブなコピーを保持することがあります。 レプリケートされたイメージを起動する場合は、DC のゲスト イメージをエクスポートした後、ソースを使用するいないと同じ理由から、適切にクリーンアップを実行する必要があります。

## <a name="physical-to-virtual-migration"></a>物理-バーチャル移行

System Center Virtual Machine Manager (VMM) 2008 では、物理マシンと仮想マシンの統合の管理を提供します。 仮想マシンに物理マシンを移行する機能も提供します。 このプロセスは、物理-バーチャル マシン変換 (P2V 変換) と呼ばれます。 P2v 変換中に、新しい仮想マシンと移行される、物理ドメイン コント ローラーを実行しないでください」の説明に従って、USN ロールバックのような状況を回避するために、同時に[USN および USN ロールバック](#usn-and-usn-rollback)します。

ドメイン コント ローラーがオンに戻るときに、ディレクトリ データの整合性がオフライン モードを使用して P2V 変換を実行する必要があります。 オフライン モードのオプションが提供され、物理サーバー変換ウィザードでお勧めします。 オンライン モードとオフライン モードの違いについては、次を参照してください[P2V:。VMM での物理コンピュータからバーチャル マシンへの変換](https://go.microsoft.com/fwlink/?linkid=155072)」を参照してください。 P2V 変換中には、ネットワークに、仮想マシンを接続されていない必要があります。 P2V 変換プロセスが完了し確認された後にのみ、仮想マシンのネットワーク アダプターを有効にする必要があります。 この時点では、物理ソース マシンがオフになります。 いないを持ち込みますネットワークを物理ソース マシン再びハード ディスクを再フォーマットする前に。

> [!NOTE]
> 新しい仮想 Dc の USN のロールバックを作成するリスクを実行しないを作成するより安全なオプションがあります。 少なくとも 1 つの仮想 DC が既にある場合、正規の昇格、ドメイン コント ローラーの複製を使用してメディア (IfM) からのインストールから昇格によって新しい仮想 DC をセットアップする可能性があります。
これにより、ハードウェアに関する問題の回避または仮想ゲストの P2V 変換のプラットフォームに関連する問題が発生する可能性があります。

> [!WARNING]
> Active Directory のレプリケーションに関する問題を回避するには、1 つのインスタンス (物理または仮想) を確認します。 そのドメイン コント ローラー上に存在する任意の時点で、特定のネットワーク時間。
> 古い複製中に問題が発生する可能性を下げることができます。
> 
> - 新しい仮想 DC を実行しているときに 2 回を使用して、コンピューター アカウントのパスワードを変更する: netdom resetpwd/Server: < ドメイン コント ローラー >.
> - エクスポートおよびインポートに設定し、新しい生成 ID になる場合は、新しい仮想ゲストし、そのため、データベース呼び出しの id。
> 

## <a name="using-p2v-migration-to-create-test-environments"></a>P2V の移行を使用して、テスト環境を作成するには

VMM での P2V 移行を使用すると、テスト環境を作成します。 物理マシンから完全に運用環境のドメイン コント ローラーを停止せず、テスト環境を作成する仮想マシンを運用環境のドメイン コント ローラーを移行できます。 ただし、テスト環境は、同じドメイン コント ローラーの 2 つのインスタンスに存在する場合、運用環境から別のネットワークである必要があります。 細心は、P2V の移行で、テスト環境の作成時に、テストおよび運用環境に影響を与える USN のロールバックを回避するために実行する必要があります。 P2V でテスト環境を作成するために使用できるメソッドを次に示します。

各ドメインからの 1 つの運用環境でのドメイン コント ローラーは、P2V を使用して、物理-バーチャル移行セクションに記載されているガイドラインに従って、テスト仮想マシンに移行されます。 運用環境の物理マシンと、テスト仮想マシンは、オンラインに戻すときに別のネットワークでなければなりません。 テスト環境で USN のロールバックを避けるためには、物理マシンから仮想マシンに移行するのには、すべてのドメイン コント ローラー オフラインにします。 (することができますかこの ntds サービスを停止してディレクトリ サービス復元モード (DSRM) でコンピューターを再起動します。)ドメイン コント ローラーがオフラインにした後、環境に新しい更新プログラムを導入する必要がありますはいません。 コンピューターの; P2V の移行中にオフラインままする必要があります。コンピューターの [なし] を移動するオンラインに戻すまで、すべてのコンピューターが完全に移行されています。 USN ロールバックに関する詳細については、USN および USN ロールバックを参照してください。

後続のテストのドメイン コント ローラーは、テスト環境でのレプリカとして昇格する必要があります。

## <a name="time-service"></a>タイム サービス

ドメイン コント ローラーとして構成されている仮想マシンの場合は、ドメイン コント ローラーとして機能するホスト システムとゲスト オペレーティング システム間の時刻同期を無効にすることをお勧めします。 これにより、ゲスト ドメイン コント ローラーに、ドメインの階層からの時間を同期できます。

HYPER-V の時刻同期プロバイダーを無効にするには、VM をシャット ダウンし、Integration Services の下の時刻同期のチェック ボックスをオフします。

> [!NOTE]
> このガイダンスは部分的に、ホスト間の時刻同期を無効にする前の推奨事項ではなく、ドメインの階層からゲストのドメイン コント ローラーの時刻を同期する現在の推奨事項を反映するために最近更新されました。システムとゲストのドメイン コント ローラー。

## <a name="storage"></a>ストレージ

ドメイン コント ローラー仮想マシンのパフォーマンスを最適化し、Active Directory の書き込みの耐久性、するには、オペレーティング システム、Active Directory、および VHD ファイルを格納するため、次の推奨事項を使用します。

- **ゲスト記憶域**します。 Active Directory データベース ファイル (Ntds.dit)、ログ ファイル、およびオペレーティング システムのファイルから別の仮想ディスク上の SYSVOL のファイルを格納します。 仮想 SCSI コント ローラーに接続された 2 つ目の VHD を作成し、仮想マシンの仮想 SCSI ディスク上のデータベース、ログ、および SYSVOL を格納します。 仮想 SCSI ディスクが仮想 IDE と比較してパフォーマンスの向上を提供し、強制 Unit Access (FUA) をサポートします。 FUA により、オペレーティング システムが書き込むし、すべてのキャッシュ メカニズムをバイパスして、メディアから直接データを読み取ります。

  > [!NOTE]
  > 仮想 DC のゲストに Bitlocker を使用しようとしている場合は、追加のボリュームが「自動ロックを解除」用に構成されているかどうかを確認する必要があります。
  > 自動構成の詳細についてはロック解除で見つかる[有効にする BitLockerAutoUnlock](https://docs.microsoft.com/powershell/module/bitlocker/enable-bitlockerautounlock)

- **VHD ファイルの記憶域ホスト**します。 推奨事項:VHD ファイルの記憶域の推奨事項アドレス記憶域をホストするには。 パフォーマンスを高めるためには、他のサービスや、ホストの Windows オペレーティング システムがインストールされているシステム ディスクなどのアプリケーションで頻繁に使用されるディスクに VHD ファイルを格納しないでください。 ホストのオペレーティング システムから別のパーティションには、各 VHD ファイルとその他の VHD ファイルを格納します。 理想的な構成では、別の物理ドライブ上の各 VHD ファイルを格納します。  

  ホストの物理ディスク システムが満たす必要がありますも**に少なくとも 1 つ**の仮想化されたワークロード データの整合性の要件を満たすために、次の条件。  

   - システムでは、サーバー クラスのディスク (SCSI、ファイバー チャネル) を使用します。  
   - システムは、バッテリ バックアップ キャッシュ ホスト バス アダプター (HBA) に、ディスクが接続されていることを確認します。  
   - システムでは、記憶装置として記憶域コント ローラー (たとえば、RAID システムなど) を使用します。  
   - システムにより、ディスクの電源が無停電電源装置 (UPS) によって保護されていることを確認します。  
   - システムにより、ディスクの書き込みキャッシュ機能が無効になっていることを確認します。  

- **パススルー ディスクと VHD を固定**します。 ストレージ仮想マシンを構成する方法はたくさんあります。 VHD ファイルを使用している場合が作成されるときに、固定サイズの Vhd のメモリが割り当てられているため、固定サイズの Vhd は動的 Vhd よりも効率的です。 パススルー ディスクをどの仮想マシンは、物理記憶域メディアへのアクセスに使用できるよりでパフォーマンスを最適化します。 パススルー ディスクは、物理ディスクまたは仮想マシンにアタッチされている論理ユニット番号 (Lun) では本質的にします。 パススルー ディスクでは、スナップショット機能はサポートされません。 したがって、パススルー ディスクは、ドメイン コント ローラーとスナップショットの使用は推奨されませんので、推奨されるハード_ディスクの構成です。  

Active Directory データの破損の可能性を減らすためには、仮想 SCSI コント ローラーを使用します。

   - 仮想ドメイン コント ローラーをホストする HYPER-V サーバーの物理ディスク ドライブ (ドライブ) ではなく SCSI を使用します。 SCSI ドライブを使用できない場合は、仮想ドメイン コント ローラーをホストする ATA/IDE ドライブで書き込みキャッシュが無効になっていることを確認します。 詳細については、次を参照してください。[イベント ID 1539 – データベースの整合性](https://go.microsoft.com/fwlink/?linkid=162419)します。
   - Active Directory の持続性を保証するために書き込み、Active Directory データベース、ログ、SYSVOL は、仮想 SCSI ディスクに配置する必要があります。 仮想 SCSI ディスクでは、強制 Unit Access (FUA) をサポートします。 FUA により、オペレーティング システムが書き込むし、すべてのキャッシュ メカニズムをバイパスして、メディアから直接データを読み取ります。  

## <a name="operational-considerations-for-virtualized-domain-controllers"></a>仮想化ドメイン コント ローラーの運用に関する考慮事項

仮想マシンで実行されているドメイン コント ローラーでは、物理マシンで実行されているドメイン コント ローラーに適用されない運用上の制限があります。 仮想化ドメイン コント ローラーを使用すると、仮想化ソフトウェアの機能とプラクティスを使用しないでください。

   - 一時停止、停止、またはフォレストの廃棄 (tombstone) の有効期間より長い時間間隔の仮想マシンにドメイン コント ローラーの保存された状態を格納してしない一時停止または保存済み状態から再開し。 これは、レプリケーションに干渉ことができます。 フォレストの廃棄 (tombstone) の有効期間を決定する方法については、次を参照してください。[フォレストの廃棄 (tombstone) の有効期間を決定](https://go.microsoft.com/fwlink/?linkid=137177)します。  
   - コピーしたり、仮想ハード_ディスク (Vhd) を複製しないでください。 ゲスト VM 用の保護機能を使用しても個々 の Vhd はコピーでき、USN ロールバックが発生します。
   - 実行したり、仮想ドメイン コント ローラーのスナップショットを使用しないでください。 技術的には Windows Server 2012 でサポートされているし、新しいないそして良いバックアップ戦略に代わるものです。 DC のスナップショットを作成またはスナップショットの復元に関するいくつかの理由があります。
   - ドメイン コント ローラーとして構成されている仮想マシンで差分ディスク VHD を使わないでください。 これにより、簡単すぎると、以前のバージョンに戻すと、パフォーマンスも低くなります。  
   - ドメイン コント ローラーを実行している仮想マシン上のエクスポート機能を使わないでください。  
   - ドメイン コント ローラーを復元したり、サポートされているバックアップを使用する以外の方法で、Active Directory データベースの内容をロールバックしようとしてください。 しないでください。 詳細については、次を参照してください。[バックアップと復元のドメイン コント ローラーの仮想化に関する考慮事項](#backup-and-restore-practices-to-avoid)します。  

これらすべての推奨事項は、更新シーケンス番号 (USN) ロールバックの可能性を避けるために加えられます。 USN ロールバックの詳細については、USN および USN ロールバックを参照してください。

## <a name="backup-and-restore-considerations-for-virtualized-domain-controllers"></a>バックアップおよび仮想化ドメイン コント ローラーの復元に関する考慮事項

ドメイン コント ローラーのバックアップは、すべての環境の重要な要件です。 バックアップは、ドメイン コント ローラーの障害や管理者によるエラーが発生した場合、データの損失から保護します。 このようなイベントが発生する場合は、ドメイン コント ローラーのシステム状態ポイントにロールバックを時間で、障害やエラーの前に必要なは。 ドメイン コント ローラーの正常な状態に復元のサポートされているメソッドは、Windows Server バックアップなどの Active Directory と互換性のあるバックアップ アプリケーションを使用して、ドメインの現在のインストールから発生したシステム状態のバックアップを復元するにはコント ローラー。 詳細については、Active Directory Domain Services (AD DS) と Windows Server バックアップを使用して、次を参照してください。、 [AD DS のバックアップと復元のステップ バイ ステップ ガイド](https://go.microsoft.com/fwlink/?LinkId=138501)します。

仮想マシン テクノロジでは、Active Directory の特定の要件は、有意性の追加の操作に時間を復元します。 たとえば、仮想ハード_ディスク (VHD) ファイルのコピーを使用して、ドメイン コント ローラーを復元する場合は、復元した後、ドメイン コント ローラーのデータベースのバージョンの更新の重要なステップをバイパスします。 ドメイン コント ローラーのレプリカ間で一貫性のないデータベースでその結果、不適切な追跡番号でレプリケーションが続行されます。 ほとんどの場合、この問題は、レプリケーション システムによって検出されませんし、エラーが報告されていない、ドメイン コント ローラーの間の不整合に関係なく。

仮想化ドメイン コント ローラーのバックアップと復元を実行する 1 つのサポートされている方法があります。

1. ゲスト オペレーティング システムでは、Windows Server バックアップを実行します。  

Windows Server 2012 と新しい HYPER-V ホストとゲストの場合は、スナップショット、ゲスト VM のエクスポートとインポートおよび HYPER-V レプリケーションを使用してドメイン コント ローラーのサポートされているバックアップを実行できます。 ただしこれらすべてはゲスト VM のエクスポートのわずかな例外で、適切なバックアップ履歴を作成するために最適ではありません。

Windows Server 2016 HYPER-V は「運用環境のスナップショット」のサポート、HYPER-V サーバーは、ゲストの VSS ベースのバックアップをトリガーし、さらに、スナップショットを使用して、ゲストの処理が完了したら、ホストは、Vhd をフェッチし、バックアップの場所に保存します。

これは、Windows Server 2012 以降には、Bitlocker で非互換性があります。

- VSS スナップ ショットを行うと、AD データベースをマークまたは RODC の IFM ソースを準備する場合、バックアップから予定されている、データベースから資格情報を削除するスナップショット後のタスクを実行しようとします。
- HYPER-V がこのタスクのスナップショットのボリュームをマウントするときは暗号化されていないアクセスのボリュームのロックを解除する機能はありません。 AD データベース エンジンはデータベースへのアクセスに失敗し、スナップショットを最終的に失敗します。

> [!NOTE]
> 説明したようにシールドされた VM プロジェクトでは、HYPER-V ホストがゲスト VM の最大のデータ保護のための非目標としてバックアップ ドリブン以前にします。

## <a name="backup-and-restore-practices-to-avoid"></a>バックアップと復元のプラクティスを回避するには

前述のように、仮想マシンで実行されているドメイン コント ローラーによって物理マシンで実行されているドメイン コント ローラーに適用されない制限があります。 バックアップ、仮想ドメイン コント ローラーを復元または復元するときに、特定の仮想化ソフトウェアの機能と使用しないようにする方法はあります。

   - コピーしたり、定期的なバックアップを実行する代わりにドメイン コント ローラーの VHD ファイルを複製しないでください。 彼は VHD ファイルをコピーまたは複製すると場合、は、古くなった。 次に、VHD が通常モードで開始されると、USN ロールバックが発生します。 など、Windows Server バックアップ機能を使用して Active Directory Domain Services (AD DS) でサポートされている適切なバックアップ操作を実行する必要があります。  
   - ドメイン コント ローラーとして構成された仮想マシンを復元するのにバックアップとスナップショット機能を使用できません。 Windows Server 2008 r2 と以前の以前の状態に仮想マシンを元に戻すレプリケーションの問題が発生します。 詳細については、 [USN および USN ロールバックに関するページ](#usn-and-usn-rollback)をご覧ください。 読み取り専用ドメイン コント ローラー (RODC) を復元するスナップショットを使用して、レプリケーションの問題がない原因が、復元のこのメソッドは引き続き推奨されません。  

## <a name="restoring-a-virtual-domain-controller"></a>仮想ドメイン コント ローラーの復元

失敗した場合は、ドメイン コント ローラーを復元するには、定期的にシステム状態をバックアップする必要があります。 システム状態には、Active Directory のデータとログ ファイル、レジストリ、システム ボリューム (SYSVOL フォルダー)、およびオペレーティング システムのさまざまな要素が含まれています。 この要件は、物理および仮想ドメイン コント ローラーと同じです。 Active Directory と互換性のあるバックアップ アプリケーションを実行するシステム状態の復元手順がレプリケーションを通知など、復元プロセスの後にローカルおよびレプリケートされた Active Directory データベースの一貫性を確保するように設計します。呼び出し ID のパートナーをリセットします。 ただし、仮想ホスティング環境とディスクまたはオペレーティング システムのイメージング アプリケーションを使用できるようなります管理者のチェックを回避するため、ドメイン コント ローラーのシステム状態の場合に通常発生する検証の復元します。

ドメイン コント ローラーの仮想マシンに失敗し、更新シーケンス番号 (USN) ロールバックが発生していない仮想マシンを復元するための 2 つのサポートされている状況がある場合。

   - 障害を復帰させる方が有効なシステム状態データのバックアップが存在する場合は、バックアップを作成するために使用するバックアップの復元オプションを使用してシステム状態を復元できます。 システム状態データのバックアップする必要がありますが作成されて個 180 日間は、既定では、廃棄 (tombstone) の有効期間の範囲内で Active Directory と互換性のあるバックアップ ユーティリティを使用しています。 少なくとも半分廃棄 (tombstone) の有効期間をドメイン コント ローラーをバックアップする必要があります。 フォレストの特定の廃棄 (tombstone) の有効期間を決定する方法については、次を参照してください。[フォレストの廃棄 (tombstone) の有効期間を決定](https://go.microsoft.com/fwlink/?linkid=137177)します。  
   - VHD ファイルの作業コピーが使用可能なシステム状態バックアップがない場合、既存の仮想マシンを削除できます。 以前の VHD のコピーを使用して既存の仮想マシンの復元がディレクトリ サービス復元モード (DSRM) で起動し、次のセクションの説明に従って適切にレジストリを構成してください。 次に、通常モードでドメイン コント ローラーを再起動します。

次の図に、プロセスを使用して、仮想化ドメイン コント ローラーを復元する最善の方法を決定します。

![](media/virtualized-domain-controller-architecture/Dd363553.85c97481-7b95-4705-92a7-006e48bc29d0(WS.10).gif)

Rodc で、復元処理と意思決定は簡単です。

![](media/virtualized-domain-controller-architecture/Dd363553.4c5c5eda-df95-4c6b-84e0-d84661434e5d(WS.10).gif)

## <a name="restoring-the-system-state-backup-of-a-virtual-domain-controller"></a>仮想ドメイン コント ローラーのシステム状態バックアップを復元します。

安全にバックアップで規定されている復元手順を実行して、バックアップを復元することができます、ドメイン コント ローラーの仮想マシンの有効なシステム状態のバックアップが存在する場合、VHD ファイルをバックアップするために使用するツール。

> [!IMPORTANT]
> ドメイン コント ローラーを正しく復元するには、DSRM で起動する必要があります。 通常モードで起動するドメイン コント ローラーは許可できません。 システムの起動時に DSRM を入力する機会がない場合は、通常モードで完全に開始する際に、ドメイン コント ローラーの仮想マシンをオフにします。 ドメイン コント ローラーを起動 DSRM でその Usn は、通常モードの単位でのドメイン コント ローラーを開始するため、ドメイン コント ローラーがネットワークから切断されている場合でも重要です。 USN ロールバックの詳細については、USN および USN ロールバックを参照してください。 

## <a name="to-restore-the-system-state-backup-of-a-virtual-domain-controller"></a>仮想ドメイン コント ローラーのシステム状態のバックアップを復元するには

1. ドメイン コント ローラーの仮想マシンを起動し、f5 キーを押して Windows ブート マネージャの画面にアクセスします。 接続の資格情報を入力する必要がある場合はクリックして直後、**一時停止**起動が続行しないように、仮想マシンでボタンをクリックします。 接続の資格情報を入力し をクリックし、**再生**仮想マシン上のボタンをクリックします。 仮想マシンのウィンドウ内をクリックし、F5 キーを押します。

   ドメイン コント ローラーが通常モードで起動する開始して、Windows ブート マネージャの画面が表示されない、仮想マシンの起動を完了するをオフにします。 Windows ブート マネージャの画面にアクセスすることができるまでは、必要な回数だけこの手順を繰り返します。 DSRM は、Windows エラーの回復 メニューからアクセスすることはできません。 そのため、仮想マシンをオフにして、Windows エラーの回復 メニューが表示された場合は、もう一度やり直してください。

2. Windows ブート マネージャー画面には、詳細ブート オプションにアクセスする F8 キーを押します。
3. **詳細ブート オプション**画面で、**ディレクトリ サービス復元モード**、し、ENTER キーを押します。 これにより、ドメイン コント ローラーが DSRM で起動します。
4. システム状態のバックアップを作成するために使用するツールの適切な復元メソッドを使用します。 Windows Server バックアップを使用した場合は、次を参照してください。 [AD DS の権限のない状態の復元を実行する](https://go.microsoft.com/fwlink/?linkid=132637)します。

## <a name="restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available"></a>適切なシステム状態データのバックアップが利用できない場合は、仮想ドメイン コント ローラーを復元します。

仮想マシンのエラーを復帰させる方システム状態データのバックアップがない場合、は、仮想マシンで実行されているドメイン コント ローラーを復元する以前の VHD ファイルを使用できます。 可能な場合は、コピーした VHD を再度試行できる場合は、処理中に問題が発生した場合、またはステップがないように、VHD のコピーを作成します。

> [!IMPORTANT]
> - 定期的な計画とスケジュールされたバックアップの代わりとして、次の手順を使用するとは考えないでください。
> - **次の手順を使用して実行される復元は Microsoft によってサポートされていませんし、他の手段がない場合にのみ使用する必要があります。**
> - 復元しようとしている VHD のコピーは、任意の仮想マシンを通常モードで開始された場合は、この手順を使用しないでください。

## <a name="to-restore-a-previous-version-of-a-virtual-domain-controller-vhd-without-system-state-data-backup"></a>システム状態データのバックアップなし仮想ドメイン コント ローラー VHD の以前のバージョンを復元するには

1. 前のセクションに従って、DSRM で仮想ドメイン コント ローラーを開始する前の VHD を使用して、します。 通常モードで起動するドメイン コント ローラーは許可されません。 ドメイン コント ローラーが通常モードで起動する開始して、Windows ブート マネージャの画面が欠落する、仮想マシンの起動を完了するをオフにします。 DSRM を入力するための詳細な手順については、前のセクションを参照してください。
2. レジストリ エディターを開きます。 レジストリ エディターを開くには、次のようにクリックします。**開始**、 をクリック**実行**、型**regedit**、ok をクリックします。 **[ユーザー アカウント制御]** ダイアログ ボックスが表示されたら、表示された操作が正しいことを確認し、 **[はい]** をクリックします。 レジストリ エディターでは、次のパスを展開します。**HKEY\_ローカル\_マシン\\システム\\CurrentControlSet\\サービス\\NTDS\\パラメーター**します。 という名前の値を探して**DSA 以前の復元数**します。 値が存在する場合は、設定のメモしてをおきます。 値がない場合は、設定は、既定値は、ゼロにします。 表示されない 1 つある場合は、値を追加しないでください。
3. 右クリックし、**パラメーター**キー**新規**、順にクリックします**DWORD (32 ビット) 値**します。
4. 新しい名前を入力**バックアップから復元されたデータベース**、し、ENTER キーを押します。
5. 開きます作成した値をダブルクリックして、**編集 DWORD (32 ビット) 値**ダイアログ ボックスと入力し、 **1**で、**値データ**ボックス。 **エントリのバックアップから復元されたデータベース**オプションは、Windows 2000 Server Service Pack 4 (SP4)、Windows Server 2003 に含まれている更新プログラムを実行しているドメイン コント ローラーで使用可能な[を検出する方法Windows Server 2003、Windows Server 2008、および Windows Server 2008 R2 で USN ロールバックから回復し、](https://go.microsoft.com/fwlink/?linkid=137182)インストールされている、マイクロソフト サポート技術情報と Windows Server 2008 でします。
6. 通常モードでは、ドメイン コント ローラーを再起動します。
7. ドメイン コント ローラーを再起動すると、イベント ビューアーを開きます。 イベント ビューアーを開くには、 **[スタート]** ボタンをクリックし、 **[コントロール パネル]** をクリックします。次に、 **[管理ツール]** をダブルクリックし、 **[イベント ビューアー]** をダブルクリックします。
8. 展開**アプリケーションとサービス ログ**、 をクリックし、 **Directory Services**ログ。 詳細ウィンドウでイベントが表示されることを確認します。
9. 右クリックし、 **Directory Services**ログ、クリックして**検索**します。 **検索**、型**1109**、 をクリックし、**次を検索**します。
10. 少なくとも 1 つのイベント ID 1109 エントリが表示されます。 このエントリが表示されない場合は、次の手順に進みます。 それ以外の場合、エントリをダブルクリックし、InvocationID を更新が行われたことを確認するテキストを確認します。

    ```
    Active Directory has been restored from backup media, or has been configured to host an application partition. 
    The invocationID attribute for this directory server has been changed. 
    The highest update sequence number at the time the backup was created is <time>

    InvocationID attribute (old value):<Previous InvocationID value>
    InvocationID attribute (new value):<New InvocationID value>
    Update sequence number:<USN>

    The InvocationID is changed when a directory server is restored from backup media or is configured to host a writeable application directory partition.
    ```

11. イベント ビューアーを閉じます。
12. 値をことを確認するレジストリ エディターを使用して**DSA 以前の復元数**が 1 を足した前の値と等しい。 これは、適切な値ではありません、イベント ビューアーでイベント ID 1109 のエントリが見つからない場合は、ドメイン コント ローラーのサービス パックが現在ことを確認します。 同じ VHD でもう一度、この手順を試行することはできません。 VHD または手順 1 で最初からやり直して通常モードで開始されていない別の VHD のコピーを再実行することができます。
13. レジストリ エディターを閉じます。

## <a name="usn-and-usn-rollback"></a>USN と USN ロールバック

このセクションでは、Active Directory データベースの仮想マシンの以前のバージョンでの正しくない復元の結果として発生する可能性がレプリケーションの問題について説明します。 Active Directory のレプリケーション処理の詳細については、次を参照してください[Active Directory レプリケーションの概念。](../replication/active-directory-replication-concepts.md)

<!-- Replaced this link with 2016 article: [How the Active Directory Replication Model Works](http://go.microsoft.com/fwlink/?linkid=27636) (http://go.microsoft.com/fwlink/?LinkID=27636). -->

## <a name="usns"></a>Usn

Active Directory Domain Services (AD DS) の使用は、シーケンス番号 (Usn) のドメイン コント ローラー間のデータのレプリケーションを追跡するを更新します。 ディレクトリ内のデータが変更されるたびに変更が作成されていることを示す、USN がインクリメントされます。

移行先ドメイン コント ローラーを格納する各ディレクトリ パーティションの Usn を使用して、ドメイン コント ローラーの導入のレプリカを格納するその他のすべてのドメイン コントローラの状態と同様に、そのデータベースを最新のオリジナルの更新を追跡するために、ディレクトリ パーティション。 ドメイン コント ローラーは、互いに変更をレプリケートするとき、Usn をドメイン コント ローラーは、各パートナーから受信した最後の変更の USN を超えると変更のレプリケーション パートナーを照会します。

次の 2 つのレプリケーション メタデータ テーブルには、Usn が含まれます。 元とコピー先のドメイン コント ローラーでは、それらを使用して、宛先ドメイン コントローラが必要な更新プログラムをフィルター処理します。

1. **最新のベクター**:すべてのソース ドメイン コント ローラーから受信した元の更新プログラムを追跡するため、移行先ドメイン コント ローラーを保持するテーブル。 移行先ドメイン コント ローラーの要求が変更されたときのディレクトリ パーティション、ソース ドメイン コント ローラーを最新のベクターを提供します。 ソース ドメイン コント ローラーは、この値を使用して、移行先ドメイン コント ローラーに送信される更新プログラムをフィルター処理します。 ソース ドメイン コント ローラーに成功したレプリケーション サイクルの完了時に、変換先にすべてのドメイン コント ローラーと同期されている変換先のドメイン コント ローラーを知っていることを保証するために最新のベクターを送信します。元の更新プログラムおよび更新プログラムは、ソースと同じレベルでです。  
2. **高基準**:宛先ドメイン コントローラが特定のパーティションの特定のソース ドメイン コント ローラーから受信した最新の変更を追跡するのには保持する値。 ハイ ウォーターマークは、ソース ドメイン コント ローラーを宛先ドメイン コントローラでは、そこから既に受信変更を送信することを防ぎます。  

## <a name="directory-database-identity"></a>ディレクトリ データベースの id

Usn に加えてドメイン コント ローラーをソース レプリケーション パートナーのディレクトリ データベースの追跡を保持します。 サーバーで実行されているディレクトリ データベースの id は、サーバー オブジェクト自体の id とは別に保持されます。 各ドメイン コント ローラーで、ディレクトリ データベースの id が格納されている、 **invocationID**次のライトウェイト ディレクトリ アクセス プロトコル (LDAP) パスの下にある NTDS 設定オブジェクトの属性: cn = NTDS設定]、[cn = ServerName, cn = Servers, cn =*SiteName*、cn = Sites, cn = 構成では、dc =*フォレスト ルート ドメイン*します。 サーバー オブジェクトの id が格納されている、 **objectGUID** NTDS 設定オブジェクトの属性です。 サーバー オブジェクトの id は変更できません。 ただし、ディレクトリ データベースの変更の id ではシステム状態の復元手順は、サーバーで発生したとき、またはアプリケーション ディレクトリ パーティションが追加されたときに、削除して、後で、サーバーから再度追加します。 (その他のシナリオ: ゲストがさらに、独自の VSS ライター (上記のバックアップ/復元で使用される同じメカニズム) をトリガー HyperV インスタンスには、仮想 DC の VHD を格納しているパーティション上の VSS ライターがトリガーされたときにその結果、invocationID は別の手段リセット)

その結果、 **invocationID**元のドメイン コント ローラーで、ディレクトリ データベースの特定のバージョンに更新プログラムのセットを効果的に関連します。 最新のベクターと高い水位マークのテーブルの使用、 **invocationID**データベースのレプリケーション情報をそのドメイン コント ローラーは、Active Directory のコピーから得るためにそれぞれ DC の GUID が予定されているとします。

**InvocationID**コマンドを実行した後に、出力の上部に表示されているグローバル一意識別子 (GUID) 値は、 **repadmin/showrepl**します。 次のテキストは、コマンドからの出力例を表します。

   ```
   Repadmin: running command /showrepl against full DC local host
   Default-First-Site-Name\VDC1
   DSA Options: IS_GC
   DSA object GUID: 966651f3-a544-461f-9f2c-c30c91d17818
   DSA invocationID: b0d9208b-8eb6-4205-863d-d50801b325a9
   ```

ドメイン コント ローラーで、AD DS が正しく復元されたら、 **invocationID**はリセットされます。 この変更の結果にはレプリケートされているパーティションのサイズを基準とする時間は、– レプリケーション トラフィックの増加が発生します。

たとえば、VDC1 と DC2 が同じドメイン内の 2 つのドメイン コント ローラーであるとします。 次の図は、invocationID 値が適切な復元のような状況でリセットされると、DC2 VDC1 についての認識を示します。

![](media/virtualized-domain-controller-architecture/Dd363553.ca71fc12-b484-47fb-991c-5a0b7f516366(WS.10).gif)

## <a name="usn-rollback"></a>USN のロールバック

Usn の通常の更新プログラムを回避し、ドメイン コント ローラーは最新の更新プログラムよりも小さい USN を使用しようとしています、USN ロールバックが発生します。 USN ロールバックが検出され、ほとんどの場合、フォレスト内の分岐が作成される前に、レプリケーションは停止されます。 

USN ロールバック可能性があります、さまざまな方法で、古い仮想ハード_ディスク (VHD) ファイルの使用など、物理-バーチャル変換 (P2V 変換) が、物理マシンはオフラインのまま永続的に、変換後に確認せずに実行されるときに。 USN ロールバックが発生しないことを確認するのには次の予防措置を実行するには。

   - 2012 以降、Windows Server を実行していないとき、実行およびはありません、ドメイン コント ローラーの仮想マシンのスナップショットを使用します。
   - ドメイン コント ローラーの VHD ファイルをコピーしないでください。  
   - 2012 以降、Windows Server を実行していないときでは、ドメイン コント ローラーを実行している仮想マシンはエクスポートされません。  
   - ドメイン コント ローラーを復元したり、Windows Server バックアップなどのサポートされているバックアップ ソリューションよりも他の方法で、Active Directory データベースの内容をロールバックしようとしてください。 しないでください。  

場合によってで USN ロールバックが検出されない可能性があります移動します。 それ以外の場合は、その他のレプリケーション エラーをしまう可能性があります。 このような場合は、問題の程度を特定し、適切なタイミングで処理する必要があります。 USN ロールバックの結果として発生する可能性があります残留オブジェクトを削除する方法については、次を参照してください。[期限切れの Active Directory オブジェクトは、Windows Server 2003 でイベント ID 1988 を生成](https://go.microsoft.com/fwlink/?linkid=137185)マイクロソフト サポート技術情報でします。

## <a name="usn-rollback-detection"></a>USN ロールバックの検出

ほとんどの場合、対応することがなく、USN ロールバックの設定に戻す、 **invocationID**プロシージャが検出された不適切な復元によって発生します。 Windows Server 2008 は、不適切なドメイン コント ローラーを復元操作後に、不適切なレプリケーションに対する保護を提供します。 このような保護は、パートナーが既に表示されているレプリケーションのことの変更は元の下の Usn で不適切な復元操作が結果のファクトによってトリガーされます。

Windows Server 2008 および Windows Server 2003 SP1 では、以前に使用された USN を使用して、移行先ドメイン コント ローラーの要求変更されたときにソース レプリケーション パートナーによる応答によって解釈されます、レプリケーションのことを意味する移行先ドメイン コント ローラーメタデータが切れています。 これは、ソース ドメイン コント ローラーで Active Directory データベースがロールバックされることを以前の状態を示します。 たとえば、仮想マシンの VHD ファイルがロールバックされましたを以前のバージョン。 この場合、宛先ドメイン コントローラは、不適切な復元が行われてもとして識別されているドメイン コント ローラーで、次の検疫メジャーを開始します。

   - AD DS には、ユーザー アカウントとコンピューター アカウントがアカウントのパスワードを変更することを防止する Net Logon サービスが一時停止します。 このアクションでは、不適切な復元後に出現する場合、このような変更の損失ができないようにします。  
   - AD DS には、着信および発信の Active Directory レプリケーションが無効にします。  
   - AD DS には、状態を示すディレクトリ サービス イベント ログでイベント ID 2095 が生成されます。  

次の図は、USN ロールバックが VDC2、仮想マシンで実行されている変換先のドメイン コント ローラーで検出されたときに発生するイベントの順序を示します。 この図で USN ロールバックの検出 VDC2 で検出すると発生レプリケーション パートナー VDC2 が VDC2 のデータベースがロールバックすることを示します宛先ドメイン コントローラに以前に表示された最新の USN 値を送信します。時間で不適切です。

![](media/virtualized-domain-controller-architecture/Dd363553.373b0504-43fc-40d0-9908-13fdeb7b3f14(WS.10).gif)

ディレクトリ サービス イベント ログでは、イベント ID 2095 を報告する場合は、すぐに、次の手順を完了します。

## <a name="to-resolve-event-id2095"></a>イベント ID 2095 を解決するのには

1. ネットワークからのエラーを記録する仮想マシンを分離します。
2. 変更はすべてがこのドメイン コント ローラーから発信され、他のドメイン コント ローラーに反映されるかどうかを判断しようとしてください。 イベントがスナップショットの結果または開始されている仮想マシンのコピーである場合は、USN ロールバックが発生した時間を決定してください。 以来、レプリケーションが発生したかどうかを確認するドメイン コントローラのレプリケーション パートナーから確認できます。

   Repadmin ツールを使用して、この判断を行うことができます。 Repadmin を使用する方法については、次を参照してください。[監視とトラブルシューティング Active Directory レプリケーションを使用して Repadmin](https://go.microsoft.com/fwlink/?linkid=122830)します。 自分で判断されない場合にお問い合わせください。 [Microsoft サポート](https://support.microsoft.com)ください。

3. ドメイン コント ローラーを強制的に降格します。 これには、ドメイン コント ローラーのメタデータをクリーンアップし、操作マスター (とも呼ばれますフレキシブル シングル マスター操作または FSMO) の役割の強制が含まれます。 詳細については、の「USN ロールバックから復旧する」セクションを参照してください。[検出し、、Windows Server 2003、Windows Server 2008、および Windows Server 2008 R2 で USN ロールバックから回復する方法](https://go.microsoft.com/fwlink/?linkid=137182)マイクロソフト サポート技術情報でします。
4. ドメイン コント ローラーの元の VHD ファイルをすべてを削除します。

## <a name="undetected-usn-rollback"></a>検出されない USN ロールバック

USN のロールバックは、2 つの状況のいずれかで検出されない可能性があります。

1. VHD ファイルは、同時に複数の場所で実行されている別の仮想マシンにアタッチされます。  
2. 復元されたドメイン コント ローラーの USN は、過去の他のドメイン コント ローラーが受信した最後の USN 増加しました。  

最初の状況で他のドメイン コント ローラーは、仮想マシンのいずれかでレプリケート場合があり、変更せずに、レプリケートされているいずれかの仮想マシンで発生する可能性です。 フォレストのこの相違は、検出を困難にし、ディレクトリの予期しない応答が発生します。 この状況は、物理と仮想マシンの両方が同じネットワーク上で実行されている場合 P2V の移行後に発生する可能性があります。 これは、複数の仮想ドメイン コント ローラーが同じ物理ドメイン コント ローラーから作成され、同じネットワーク上で実行し、場合にも発生する可能性があります。

2 番目の状況では、Usn の範囲は 2 つのさまざまな変更セットに適用されます。 これは、検出されることがなく長時間にわたって続行できます。 その時間中に作成されたオブジェクトが変更されるたびに、残留オブジェクトが検出され、イベント ビューアーでイベント ID 1988 として報告します。 次の図は、USN ロールバックがこのような状況での検出をされていない可能性がある方法を示します。

![](media/virtualized-domain-controller-architecture/Dd363553.63565fe0-d970-4b4e-b5f3-9c76bc77e2d4(WS.10).gif)

## <a name="read-only-domain-controllers"></a>読み取り専用ドメイン コント ローラー

Rodc は、Active Directory データベース内のパーティションの読み取り専用のコピーをホストするドメイン コント ローラーです。 Rodc は、他のドメイン コント ローラーに変更をレプリケートしないため、USN ロールバックのほとんどの問題を回避します。 ただし、USN ロールバックによる影響のある書き込み可能なドメイン コント ローラーから RODC にレプリケートされます、RODC にも反映されます。

スナップショットを使用して、RODC を復元することは推奨されません。 Active Directory と互換性のあるバックアップ アプリケーションを使用して、RODC を復元します。 また、書き込み可能なドメイン コント ローラーと注意が必要廃棄 (tombstone) の有効期間を超えてオフラインにする RODC を許可しないようにします。 RODC に残留オブジェクトは、この状態の可能性があります。

Rodc の詳細については、次を参照してください。、[読み取り専用ドメイン コント ローラーの計画と展開ガイド](../../deploy/rodc/read-only-domain-controller-updates.md)します。
