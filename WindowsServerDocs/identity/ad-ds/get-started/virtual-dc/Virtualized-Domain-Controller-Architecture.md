---
ms.assetid: 341614c6-72c2-444f-8b92-d2663aab7070
title: "仮想化ドメイン コント ローラーのアーキテクチャ"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: ac8b190df065547d82aa431761eb5c00c94a2ad6
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/12/2017
---
# <a name="virtualized-domain-controller-architecture"></a>仮想化ドメイン コント ローラーのアーキテクチャ

>適用対象: Windows Server 2016、Windows Server 2012 R2、Windows Server 2012

このトピックでは、仮想化ドメイン コント ローラーの複製と安全な復元のアーキテクチャについて説明します。 複製プロセスとフローチャートで安全な復元を示していて、プロセスの各ステップの詳細な説明を提供します。  
  
-   [仮想化ドメイン コント ローラーの複製のアーキテクチャ](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneArch)  
  
-   [仮想化ドメイン コント ローラーの安全な復元アーキテクチャ](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch)  
  
## <a name="BKMK_CloneArch"></a>仮想化ドメイン コント ローラーの複製のアーキテクチャ  
  
### <a name="overview"></a>概要  
仮想化ドメイン コント ローラーの複製と呼ばれる識別子を公開するハイパーバイザー プラットフォームに依存しています**Vm-generation ID**仮想マシンの作成を検出します。 AD DS が最初にこの識別子の値を格納自身のデータベース (NTDS します。DIT) ドメイン コント ローラーの昇格中にします。 仮想マシンを起動するときに、バーチャル マシンから VM 生成 ID の現在の値は、データベース内の値と比較されます。 2 つの値が異なる場合、ドメイン コント ローラーは起動 ID をリセットし、USN の再利用、または重複するセキュリティ プリンシパルの潜在的な作成できないようにすること、RID プールを破棄します。 手順 3 で呼び出されますし、ドメイン コント ローラー、場所に DCCloneConfig.xml ファイルが検索[複製プロセスの詳細](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneProcessDetails)します。 DCCloneConfig.xml ファイルが検出されると、あるデプロイされている、複製として再する昇格する既存の NTDS を使用して追加のドメイン コント ローラーとしてプロビジョニング自体に複製を開始するようにを終了します。DIT および SYSVOL の内容は、ソース メディアからコピーされます。  
  
ここで、Vm-generationid をサポートするハイパーバイザーとないもの混在環境では、複製メディアが誤って、Vm-generationid をサポートしないハイパーバイザーでデプロイされる可能性があります。 DCCloneConfig.xml ファイルの存在は、DC の複製管理上の意図を示します。 そのため、ブートが VM GenerationID の中に DCCloneConfig.xml ファイルが見つかった場合はから提供されていない、ホストにディレクトリ サービス復元モード (DSRM) を環境内の残りの部分に影響を与えずを防ぐために、複製 DC がブートします。 Vm-generationid をサポートするハイパーバイザーに複製メディアを後で移動することができ、し、複製を再試行することができます。  
  
Vm-generationid をサポートするハイパーバイザーに複製メディアが展開されている場合は、DCCloneConfig.xml ファイルが指定されていない DC にその DIT と新しい VM から 1 つの間での VM GenerationID の変更が検出されると、USN の再利用できないようにして、Sid が重複を避けるためにセーフガードがトリガーされます。 ただし、複製が開始されない、セカンダリ DC は引き続きソース DC と同じ id で実行するようにします。 このセカンダリ DC は、できるだけ早くを環境での不整合を避けるために、ネットワークから削除する必要があります。 更新プログラムが出力方向にレプリケート、Microsoft サポート技術情報を参照していることを確認中に、このセカンダリ DC を再利用する方法の詳細については、記事[2742970](https://support.microsoft.com/kb/2742970)します。  
  
### <a name="BKMK_CloneProcessDetails"></a>複製プロセスの詳細  
次の図は、初期の複製操作および複製再試行操作のアーキテクチャを示しています。 これらのプロセスは、このトピックで後で詳しく説明します。  
  
**初期の複製操作**  
  
![仮想化 DC のアーキテクチャ](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_InitialCloningProcess.png)  
  
**複製再試行操作**  
  
![仮想化 DC のアーキテクチャ](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_CloningRetryProcess.png)  
  
次の手順では、さらに詳しくプロセスについて説明します。  
  
1.  VM 生成 id。 をサポートするハイパーバイザーで既存のバーチャル マシンのドメイン コント ローラーが起動します。  
  
    1.  この VM がありません既存の VM GENERATION-ID 値セットの AD DS コンピューター オブジェクト上の昇格後。  
  
    2.  Null である場合でも、次のコンピューターの作成ことを意味にまだ複製が行われるように、新しい VM GENERATION-ID が一致しなくなります。  
  
    3.  VM Generation ID は、dc を次回再起動後に設定されており、レプリケートされません。  
  
2.  仮想マシンは、VMGenerationCounter ドライバーによって提供される VM 生成 ID を読み取ります。 2 つの Vm-generation Id を比較します。  
  
    1.  Id が一致する場合は、これは、新しいバーチャル マシンではありませんし、複製は行われません。 DCCloneConfig.xml ファイルが存在する場合、ドメイン コント ローラーを複製を防ぐために時間/日付スタンプを使用してファイルの名前を変更します。 サーバーは、通常の起動は続行されます。 これは、Windows Server 2012 で任意の仮想ドメイン コント ローラーのすべての再起動の動作です。  
  
    2.  2 つの Id が一致しない場合は、NTDS を含む新しいバーチャル マシンです。以前のドメイン コント ローラーから DIT (または復元されたスナップショットである)。 DCCloneConfig.xml ファイルが存在する場合は、ドメイン コント ローラーは複製操作を続行します。 ない場合は、スナップショット復元操作を続行します。 参照してください[仮想ドメイン コント ローラーの安全な復元アーキテクチャ](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch)します。  
  
    3.  ハイパーバイザーが比較のため、VM 生成 ID を提供しない、DCCloneConfig.xml ファイルが存在する場合は、ゲストは、ファイルの名前を変更し、し、DSRM でブートされる重複ドメイン コント ローラーからネットワークを保護するします。 Dccloneconfig.xml ファイルがない場合は、ゲストは、通常どおり (ネットワーク上の重複ドメイン コント ローラーの潜在的な) でブートします。 この重複ドメイン コント ローラー、Microsoft サポート技術情報を参照資料を再利用する方法について[2742970](https://support.microsoft.com/kb/2742970)します。  
  
3.  NTDS サービスは、(hkey_local_machine \system\currentcontrolset\services\ntds\parameters の) VDCisCloning DWORD レジストリ値の名前の値を確認します。  
  
    1.  存在しない場合は、このバーチャル マシンの複製の最初の試行になります。 ゲストが、ローカル RID プールを無効にして、ドメイン コント ローラーの新しいレプリケーション起動 ID を設定の VDC オブジェクト重複セーフガードを実装します。  
  
    2.  既に 0x1 に設定されている場合、これは、「再試行」複製を行おうと以前の複製操作が失敗しました。 VDC オブジェクト重複の安全対策は採られていませんが不必要に見えなくゲスト複数回が既に一度実行する必要があります。  
  
4.  IsClone DWORD レジストリ値の名前が (hkey_local_machine \system\currentcontrolset\services\ntds\parameters の) 書き込まれます  
  
5.  NTDS サービスは、再起動の DS 修復モードで起動するゲスト ブート フラグを変更します。  
  
6.  NTDS サービスは、次の 3 つ指定できる場所 (DSA 作業ディレクトリ、windir%\NTDS、またはリムーバブル読み取り/書き込みメディア、ドライブのルートにある、ドライブ文字の順序で) のいずれかに DcCloneConfig.xml を読み取ろうとします。  
  
    1.  有効な場所にファイルが存在しない場合、ゲストは IP アドレスが重複を確認します。 IP アドレスが重複していない場合、サーバーは正常に起動します。 重複する IP アドレスがある場合、コンピューター DSRM でブートされる重複ドメイン コント ローラーからネットワークを保護します。  
  
    2.  有効な場所にファイルが存在する場合、NTDS サービスは、その設定を検証します。 ファイルが空白 (または特定の設定が空白だった) 場合、NTDS はそれらの設定の値が自動的を構成します。  
  
    3.  DcCloneConfig.xml が存在するが、無効なエントリが含まれて、読み取ることができない場合に、ディレクトリ サービス復元モード (DSRM) に複製に失敗し、ゲストが起動します。  
  
7.  ゲストは、移行元コンピューター名と IP アドレスの誤って乗っ取られないようにする DNS 自動登録を無効にします。  
  
8.  ゲストをアドバタイズまたはクライアントからのネットワーク AD DS の要求の回答を防ぐために、Netlogon サービスを停止します。  
  
9. NTDS は、サービスまたはプログラムがインストールされている、DefaultDCCloneAllowList.xml または CustomDCCloneAllowList.xml に含まれていないことがないことを検証します。  
  
    1.  サービスが既定の除外されていないプログラムがインストールされて許可リストまたはカスタムの除外許可リスト、複製に失敗し、ゲスト DSRM でブートされる重複ドメイン コント ローラーからネットワークを保護します。  
  
    2.  ないかどうかの非互換性、複製は続行されます。  
  
10. ブランクの DCCloneConfig.xml ネットワーク設定が原因で IP アドレスの自動割り当てが使用される場合、ゲストは、IP アドレスのリース、ネットワークのルーティング、および名前解決に関する情報を取得するネットワーク アダプターで DHCP を有効します。  
  
11. ゲストを検索して、PDC エミュレーター FSMO 役割を実行しているドメイン コント ローラーを接続します。 これは、DNS および DCLocator プロトコルを使用します。 RPC 接続し、ドメイン コント ローラー コンピューター オブジェクトを複製する IDL_DRSAddCloneDC メソッドを呼び出します。  
  
    1.  ゲストのソース コンピューター オブジェクトがのドメイン ヘッド拡張アクセス許可を保持するかどうかは"' DC にそれ自身の複製の作成を許可する"し、複製は続行します。  
  
    2.  場合は、ゲストのソース コンピューター オブジェクトは、複製に失敗し、ゲストの拡張アクセス許可が重複ドメイン コント ローラーからネットワークを保護する dsrm でブートするを保持しません。  
  
12. AD DS コンピューター オブジェクト名は、PDCE で自動的に生成されるか、または、DCCloneConfig.xml で指定した場合、任意の名前に一致するように設定されます。 NTDS は、適切な Active Directory 論理サイトの適切な NTDS 設定オブジェクトを作成します。  
  
    1.  これが PDC 場合、複製、ゲスト、ローカル コンピューターの名前を変更し、再起動します。 再起動後は、もう一度、手順 1 ~ 10 を通過し、手順 13. に進みます。  
  
    2.  これがレプリカ DC 場合、複製がないこの段階で再起動します。  
  
13. ゲストが昇格を開始する、DS 役割サーバー サービスに昇格の設定を提供します。  
  
14. DS 役割サーバー サービスは、すべての AD DS 関連サービス (NTDS、NTFRS/DFSR、KDC、DNS) を停止します。  
  
15. ゲスト強制的に NT5DS (Windows NTP) 時間同期を別のドメイン コント ローラーを (既定の Windows タイム サービス階層、つまり、PDCE を使用して)。 ゲストは、PDCE に接続します。 すべての既存の Kerberos チケットをフラッシュします。  
  
16. ゲストは、自動的に実行する、DFSR または NTFRS サービスを構成します。 ゲストがすべての既存 DFSR および NTFRS データベース ファイルを削除 (既定: c:\windows\ntfrs と c:\system ボリューム information\dfsr\\*< database_GUID >*)、次回サービスが開始されたときに権限のない SYSVOL 同期が強制的に実行します。 ゲストは SYSVOL をプレシード同期を後で起動したときに、SYSVOL のファイルの内容を削除しません。  
  
17. ゲストが変更されます。 ゲスト上の DS 役割サーバー サービスは、既存の NTDS を使用して AD DS 構成 (昇格) を開始します。販売促進が通常は同じように c:\windows\system32 に含まれているテンプレート データベースではなく、ソースとして DIT のデータベース ファイル。  
  
18. ゲストは、新しい RID プール割り当てを取得する、RID マスター FSMO の役割所有者を接続します。  
  
19. 昇格プロセスは、新しい起動 ID を作成し、複製されたドメイン コント ローラーの NTDS 設定オブジェクトを再作成 (、複製に関係なく、これはドメイン昇格の一環既存の NTDS を使用する場合です。DIT のデータベースの場合)。  
  
20. NTDS は、またはするオブジェクトが見つからないか、それ以降、パートナー ドメイン コント ローラーから新しいバージョンにレプリケートされます。 NTDS します。DIT にソース ドメイン コント ローラーがオフラインになったときからオブジェクトが既に含まれているし、レプリケーション トラフィックを最小限に抑えるに限り使用されるもの受信します。 グローバル カタログ パーティションが設定されます。  
  
21. DFSR または FRS サービスが起動し、存在しないため、SYSVOL データベース権限のない入力方向の同期をレプリケーション パートナーからします。 このプロセスは、既存のデータを SYSVOL フォルダーで、ネットワーク レプリケーション トラフィックを最小限に抑えるに再度使用します。  
  
22. ゲストは、これで、コンピューターが一意にという名前し、ネットワーク、DNS クライアントの登録を再度有効にします。  
  
23. ゲストが、DefaultDCCloneAllowList.xml で指定された SYSPREP モジュールを実行<SysprepInformation>、以前のコンピューター名と SID をスクラブするための要素。  
  
24. 昇格の複製が完了します。  
  
    1.  次に再起動されるため、通常、ゲストは DSRM ブート フラグを削除します。  
  
    2.  ゲストは、それが再度読み取られなく次回の起動時にできるように、追加された日付と時刻スタンプに DCCloneConfig.xml を変更します。  
  
    3.  ゲストが、hkey_local_machine \system\currentcontrolset\services\ntds\parameters の VdcIsCloning DWORD レジストリ値の名前を削除します。  
  
    4.  ゲスト設定"VdcCloningDone"DWORD レジストリ値の名前を hkey_local_machine \system\currentcontrolset\services\ntds\parameters 0x1。 Windows では、この値を使用しないが、代わりに、サード パーティのマーカーとして提供されます。  
  
25. ゲストが、現在のゲスト Vm-generation id。 と一致する独自の複製されたドメイン コント ローラー オブジェクトの Msds-generationid 属性を更新します。  
  
26. ゲストが再起動します。 これが、通常のアドバタイズ ドメイン コント ローラーです。  
  
## <a name="BKMK_SafeRestoreArch"></a>仮想化ドメイン コント ローラーの安全な復元アーキテクチャ  
  
### <a name="overview"></a>概要  
AD DS と呼ばれる識別子を公開するハイパーバイザー プラットフォームに依存しています**Vm-generation ID**を仮想マシンのスナップショットの復元を検出します。 AD DS が最初にこの識別子の値を格納自身のデータベース (NTDS します。DIT) ドメイン コント ローラーの昇格中にします。 管理者は、以前のスナップショットから仮想マシンを復元、ときに、バーチャル マシンから VM 生成 ID の現在の値は、データベース内の値と比較されます。 2 つの値が異なる場合、ドメイン コント ローラーは起動 ID をリセットし、USN の再利用、または重複するセキュリティ プリンシパルの潜在的な作成できないようにすること、RID プールを破棄します。 2 つのシナリオの安全な復元が発生することがあります。  
  
-   シャット ダウン中にスナップショットが復元された後に仮想ドメイン コント ローラーが起動したとき  
  
-   実行中の仮想ドメイン コント ローラーでスナップショットが復元されたとき  
  
    スナップショットの仮想化ドメイン コント ローラーがシャット ダウンではなく、一時停止状態である場合は、新しい RID プール要求をトリガーする AD DS サービスを再起動する必要があります。 サービス スナップインまたは Windows PowerShell を使用して、AD DS サービスを再起動することができます (Restart-service NTDS-強制)。  
  
次のセクションでは、安全な復元の各シナリオの詳細を説明します。  
  
### <a name="safe-restore-detailed-processing"></a>安全な復元の詳細なプロセス  
次のフローチャートに、表示する方法の安全な復元がシャット ダウン中にスナップショットが復元された後、仮想ドメイン コント ローラーが起動したときに発生します。  
  
![仮想化 DC のアーキテクチャ](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_VirtualizationSafeguardsDuringNormalBoot.png)  
  
1.  仮想マシンをスナップショットの復元後に起動するときに、スナップショットの復元のために、ハイパーバイザー ホストによって提供される新しい Vm-generation ID があります。  
  
2.  バーチャル マシンから新しい Vm-generation ID は、データベース内の Vm-generation ID と比較されます。 2 つの Id が一致しないため、仮想化セーフガードが (手順 3 で、前のセクションを参照してください)。 完了すると、復元を適用する、Vm-generationid の AD DS コンピューター オブジェクトに設定が更新、新しい ID は、ハイパーバイザー ホストによって提供されます。  
  
3.  ゲスト仮想化セーフガードがで。  
  
    1.  ローカル RID プールを無効にします。  
  
    2.  ドメイン コント ローラー データベースに対して新しい起動 ID を設定します。  
  
> [!NOTE]  
> 安全な復元のこの部分は、複製プロセスと重複しています。 このプロセスは、次のスナップショットの復元を起動した後、仮想ドメイン コント ローラーの安全な復元については、同じ手順は、複製プロセス中に発生します。  
  
次の図は、仮想化セーフガードが実行中の仮想ドメイン コント ローラーでスナップショットが復元されたときに、USN ロールバックによる相違を防ぐ方法を示します。  
  
![仮想化 DC のアーキテクチャ](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_VirtualizationSafeguardsDuringSnapShotRestore.png)  
  
> [!NOTE]  
> 上の図は、概念を説明する単純化されます。  
  
1.  Time T1、時は、ハイパーバイザー管理者は仮想 DC1 のスナップショットを取得します。 この時点で DC1 が USN 値 (**highestCommittedUsn**実習で) の A の 100、InvocationId (この図で ID として表される) の値 (実際にこのなります GUID)。 SavedVMGID 値は、DC の DIT ファイルの Vm-generationid (という名前の属性の DC のコンピューター オブジェクトに対して格納**Msds-generationid**)。 VMGID は、仮想マシン ドライバーから使用できる Vm-generationid の現在の値です。 この値は、ハイパーバイザーによって提供されます。  
  
2.  Time T2 で、100 人のユーザーがこの DC に追加 (検討ユーザー間では、この DC で実行した更新プログラムの例として、time T1 と T2 これらの更新プログラムとユーザーの作成、グループの作成、パスワードの更新、属性の更新の組み合わせである実際にあります。)。 この例では、各更新プログラムは、(ただし、実際にユーザーの作成は、1 つ以上の USN を消費する可能性があります) に 1 つの一意の USN を消費します。 これらの更新プログラムをコミットする前に、DC1 は、そのデータベース (savedVMGID) 内の VM GenerationID の値は、現在の値 (VMGID) ドライバーから使用できると同じかどうかを確認します。 同じ場合は、ロールバックがまだ行われていないため、更新はコミットされ、USN は 200 には、次の更新で USN 201 が使用できることを示すようにします。 InvocationId、savedVMGID、または VMGID に変更はありません。 これらの更新プログラムは、次のレプリケーション サイクルで DC2 にレプリケートします。 DC2 が高位警告値を更新する (および**UptoDatenessVector**) 表されるここでは単に dc1 (a) として@USN= 200 します。 つまり、DC2 は、DC1 からを USN 200 を介した Nvocationid A のコンテキスト内のすべての更新の対応です。  
  
3.  一度に T3 では、time T1 で取得されたスナップショットが DC1 に適用されます。 DC1 がロールバックされた、その USN は 100 にロールバックを使用して Usn 101 からの後続の更新に関連付けることを示すようにします。 ただし、この時点で、VMGID の値になります、Vm-generationid をサポートするハイパーバイザーによって異なります。  
  
4.  その後、DC1 は、更新プログラムを実行するときに確認自身のデータベース (savedVMGID) が VM GenerationId の値は、仮想マシン ドライバー (VMGID) からの値と同じかどうか。 ここでは、同じ DC1 がロールバックが行われたと推測このため、; の仮想化セーフガードがトリガーつまり、その InvocationId をリセット (ID = B) し、(この図で示されていません) RID プールを破棄します。 VMGID の新しい値をそのデータベースに保存し、それらの更新 (USN 101 - 250) を新しい InvocationId B のコンテキストでコミット次のレプリケーション サイクルで DC2 を一切把握できません DC1 から InvocationId B のコンテキストでため、InvocationID B. に関連付けられている DC1 からすべての要求その結果、スナップショットの適用後に DC1 で実行される更新は安全に収束します。 さらに、(これは、スナップショットの復元後に DC1 で失われた) t2 の時点で DC1 上で実行された更新のセットでは、レプリケートされていた DC2 に (によって示されている dc1 の点線) ため次のスケジュールされたレプリケーションで DC1 にレプリケートします。  
  
ゲスト仮想化セーフガードが、NTDS レプリケーション Active の Directory オブジェクト差分の受信権限のない入力パートナー ドメイン コント ローラーからされます。 宛先ディレクトリ サービスの最新のベクターがそれに応じて更新します。 ゲストは SYSVOL を同期します。  
  
-   FRS を使用する場合、ゲストは NTFRS サービスを停止し、D2 BURFLAGS レジストリ値を設定します。 権限のない入力方向を再利用して既存変更されていない SYSVOL データ可能な場合のレプリケーションを行います NTFRS サービスを開始します。  
  
-   DFSR を使用している場合、ゲストは DFSR サービスを停止し、DFSR データベース ファイルを削除 (既定の場所: %systemroot%\system ボリューム information\dfsr\\*<database GUID>*)。 権限のない入力方向を再利用して既存変更されていない SYSVOL データ可能な場合のレプリケーションを行います DFSR サービスを開始します。  
  
> [!NOTE]  
> -   ハイパーバイザーが比較のための Vm-generation ID が提供されていない場合、ハイパーバイザーが仮想化セーフガードをサポートしていないと、ゲストは Windows Server 2008 R2 を実行する仮想化ドメイン コント ローラーのように動作以前のバージョン。 過去の最後パートナー DC から見た最大 USN 高度ないない Usn でレプリケーションを開始しようとした場合、ゲストは USN ロールバック検疫保護を実装します。 USN ロールバック検疫保護の詳細については、次を参照してください[USN および USN のロールバック。](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx)  
  


