---
title: SQL の微調整や AD FS での待機時間に関する問題をアドレス指定
description: このドキュメントでは、AD FS を使用した SQL を微調整する方法について説明します。
author: billmath
ms.author: billmath
manager: daveba
ms.date: 06/20/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: fb699a1f92013f5657d2fbb48b203f96a5e5a5ba
ms.sourcegitcommit: 6b6c3601fb7493ab145ccff02db26d7123df9a3d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/21/2019
ms.locfileid: "67322849"
---
# <a name="fine-tuning-sql-and-addressing-latency-issues-with-ad-fs"></a>SQL の微調整や AD FS での待機時間に関する問題をアドレス指定
更新プログラムで[AD FS 2016](https://support.microsoft.com/help/4503294/windows-10-update-kb4503294)クロス データベース待機時間を削減する次の機能強化が導入されています。 AD FS 2019 の今後の更新プログラムは、これらの機能強化が含まれます。

## <a name="in-memory-cache-update-in-background-thread"></a>バック グラウンド スレッドでメモリ内キャッシュの更新 
いずれかの可用性 (AoA) の展開に常時前に待機時間が存在していた「読み取り」操作として、マスター ノードは別のデータ センターで見つけることができます。 2 つの異なるデータ センター間の呼び出しの待機時間が発生しました。  

AD FS の最新の更新で、AD FS 構成のキャッシュと更新期間を設定する設定を更新するバック グラウンド スレッドの追加により待機時間を削減することが対象とします。 データベース キャッシュの更新プログラムがバック グラウンド スレッドに移動すると、要求スレッドで、データベースの検索に費やされた時間が大幅に削減します。  

ときに、`backgroundCacheRefreshEnabled`に設定されている場合は true、AD FS が有効にするキャッシュの更新を実行するバック グラウンド スレッドです。 設定時刻値にキャッシュからデータをフェッチする場合の頻度をカスタマイズできます`cacheRefreshIntervalSecs`します。 既定値は 300 秒に設定と`backgroundCacheRefreshEnabled`設定を true にします。 セット値、期間後に AD FS は、そのキャッシュの更新を開始し、更新が進行中ですが、古いキャッシュ データは引き続き使用します。  

>[!NOTE]
> 外部キャッシュのデータが更新されます、 `cacheRefreshIntervalSecs` ADFS から SQL データベースの変更が発生したことを示す通知を受信する場合の値します。 この通知では、キャッシュが更新をトリガーします。 

### <a name="recommendations-for-setting-the-cache-refresh"></a>キャッシュの更新を設定するための推奨事項 
キャッシュの更新の既定値は**5 分**します。 設定することをお勧め**1 時間**SQL 変更が発生した場合に、キャッシュ データが更新されますので、AD FS によって、不要なデータ更新を削減します。  

AD FS が SQL の変更のコールバックを登録し、ADFS は、変更時に通知を受信します。 このメソッドが発生するとすぐに、ADFS は SQL から各変更を受信します。 

SQL notification、不足している AD FS では、その結果 AD FS は、キャッシュで指定された間隔で更新がネットワークの不具合が発生した場合、値を更新します。 AD FS と SQL の間の接続性の問題は可能性がある場合は、1 時間未満にキャッシュの更新値を設定することをお勧めします。  

### <a name="configuration-instructions"></a>構成の手順 
構成ファイルには、複数のキャッシュ エントリがサポートしています。 次に、次のすべてを構成できます、組織のニーズに基づいています。 

次の例では、バック グラウンドのキャッシュの更新を有効にし、1800 秒、または 30 分間のキャッシュの更新間隔を設定します。 これは、ADFS の各ノードで実行する必要があり、後で、ADFS サービスを再起動する必要があります。 変更しない他のノードに影響を与えるようにし、すべてのノードで、変更を加える前に、最初のノードをテストします。 

  1. AD FS の構成ファイルに移動"Microsoft.IdentityServer.Service"セクションの下で、追加のエントリの下。  
  
  - `backgroundCacheRefreshEnabled`  -バック グラウンドのキャッシュ機能が有効になっているかどうかを指定します。 "true または false"の値。
  - `cacheRefreshIntervalSecs` -ADFS がキャッシュを更新する秒単位の値します。 SQL の変更がある場合、AD FS はキャッシュを更新します。 AD FS は SQL の通知を受け取るし、キャッシュを更新します。  
 
 >[!NOTE]
 > 構成ファイル内のすべてのエントリは、大文字小文字を区別します。  
 &lt;cache cacheRefreshIntervalSecs="1800" backgroundCacheRefreshEnabled="true" /&gt; 
 
追加には、構成可能な値がサポートされています。 

   - **maxRelyingPartyEntries**最大 - AD FS がメモリに保持されますが、証明書利用者のパーティ エントリの数。 この値は、oAuth アプリケーションの権限キャッシュによっても使用されます。 RPs とすべてがメモリに格納されるかどうかよりも多くのアプリケーションのアクセス許可がある場合は、この値はアプリケーションのアクセス許可の数をする必要があります。 既定値は、1000 です。
   - **maxIdentityProviderEntries** - この要求の最大数は、プロバイダーのエントリが AD FS がメモリに保持されます。 既定値は、200 です。 
   - **maxClientEntries** -これは、AD FS がメモリに保持は、OAuth クライアント エントリの最大数。 既定値は 500 です。 
   - **maxClaimDescriptorEntries** - 最大メモリに保持は AD FS の要求記述子エントリの数。 既定値は 500 です。 
   - **maxNullEntries** -負のキャッシュとして使用されます。 AD FS は、データベース内のエントリを探しますが見つからないときは、AD FS が負のキャッシュに追加します。 これは、そのキャッシュの最大サイズです。 オブジェクトの種類ごとに負のキャッシュは、すべてのオブジェクトの 1 つのキャッシュではありません。 既定値は、50,0000 です。 

## <a name="multiple-artifact-db-support-across-datacenters"></a>データ センター間で複数の成果物 DB をサポートします。 
複数のデータ センターの以前の構成、AD FS がのみサポートされて 1 つの成果物データベース取得の呼び出し中にクロス center データ センターの待機時間の原因します。  

データ センターの間の待機時間を減らすためには、AD FS 管理者は複数の成果物 DB インスタンスをデプロイするようになりましたし、しにさまざまな成果物 DB インスタンスをポイントして、AD FS ノードの構成ファイルを変更できます。 成果物のデータベース接続文字列は、ノードごとの成果物 DB を許可する構成ファイルで指定できます。 接続文字列が構成ファイル内に存在しない場合は、ノードが構成 DB に存在するは成果物のデータベースを使用する前のデザインに戻る分類されます。  
ハイブリッド環境は、この構成もサポートされます。  

### <a name="requirements"></a>要件: 
成果物の複数のデータベースのサポートをセットアップする前に、すべてのノードで更新プログラムを実行し、この機能で複数ノードの呼び出しが行われるために、バイナリを更新します。 
  1. 成果物の DB を作成する配置スクリプトを生成します。複数の成果物 DB インスタンスを展開するには、管理者は成果物の DB の SQL 展開スクリプトを生成する必要があります。 この更新により、既存の一部として`Export-AdfsDeploymentSQLScript`AD FS データベース用の SQL 展開スクリプトの生成を指定するパラメーターのオプションを取得するコマンドレットが更新されました。 
 
 たとえば、成果物の DB だけの配置スクリプトを生成する指定、`-DatabaseType`パラメーターと値の「アイテム」を渡します。 省略可能な`-DatabaseType`パラメーターは、AD FS データベース型を指定しに設定することができます。すべて (既定)、成果物、または構成します。 ない場合は`-DatabaseType`パラメーターを指定すると、スクリプトは、成果物と構成スクリプトを構成します。  

   ```PowerShell
   PS C:\> Export-AdfsDeploymentSQLScript -DestinationFolder <script folder where scripts will be created> -ServiceAccountName <domain\serviceaccount> -DatabaseType "Artifact" 
   ```
必要なデータベースを作成し、AD FS サービス アカウント、SQL SA これらのデータベース アクセス許可を付与するように SQL マシンは、生成されるスクリプトを実行してください。

 2. 配置スクリプトを使用して成果物の DB を作成します。 新しく生成された CreateDB.sql と SetPermissions.sql 配置スクリプトを SQL server コンピューターにコピーし、実行して、ローカルの成果物の DB を作成します。 
 
 3. 成果物の DB 接続を追加する構成ファイルを変更します。 
 AD FS ノードの構成ファイル、および"Microsoft.IdentityServer.Service"セクションの下を移動し、新しく構成された ArtifactDB にエントリ ポイントを追加します。 

 >[!NOTE] 
 > artifactStore と connectionString は、大文字と小文字の値です。 正しく構成されていることを確認します。 &lt;artifactStore connectionString ="データ ソース = \SQLInstance; Integrated Security = True; Initial Catalog = AdfsArtifactStore"/。&gt; 
>
>Sql の接続に一致するデータ ソースの値を使用します。



 4. 変更を反映するための AD FS サービスを再起動します。 
 
 >[!NOTE] 
 > SQL レプリケーションまたは成果物のデータベース間の同期を使用することは推奨されません。 データ センターごとに 1 つの成果物データベースを設定することをお勧めします。 
 
### <a name="cross-datacenter-failover-and-database-recovery"></a>データ センターのフェールオーバーとデータベースの復旧をクロスします。  
成果物の master データベースと同じデータ センターにフェールオーバーの成果物のデータベースを作成することをお勧めします。 フェールオーバーが発生した場合は、待機時間の増加されません。 データ センター間でデータベースをフェールオーバーの成果物は推奨されません。 次は、OAuth、SAML、ESL、およびトークンへの呼び出しが成果物の複数のデータベースの検出機能を再生する方法について詳しく説明します。 
 - **OAuth と SAML** 

   OAuth および SAML 成果物の要求、ノードは作成、成果物 DB 成果物の構成ファイル内に存在します。 構成ファイルに成果物のデータベース接続が含まれていない場合は、DB の一般的な成果物が使用されます。 成果物をフェッチする、次の要求は、別のノードには、ときに、その他のノードは、成果物 DB から成果物をフェッチする最初のノードに rest API を加えます。 成果物のさまざまなデータベースを別のノードがあり、ノードについてわからないように必要です。 最初のノードがダウンしている場合は、アーティファクト解決は失敗します。 設計のため、成果物 DB のデータ センターにレプリケートする必要はありません。 1 つのデータ センター全体がダウンしている場合は、ほとんどの場合、成果物を作成するノードもダウン、つまりもうその成果物を解決することはできません。  

 - **エクストラネットのロックアウト** 

    構成ファイル内に参照されている成果物のデータベースは、エクストラネットのロックアウトのデータに使用されます。 ただし、ESL 機能は、AD FS は成果物の DB にデータを書き込むマスターを選択します。 すべてのノードでは、REST API を取得および設定の各ユーザーについての最新のマスター ノードへの呼び出しを作成します。 複数の成果物 DB を使用している場合、管理者は各成果物 DB またはデータ センターのマスター ノードを選択してください。 

    ESL マスターにするには、ADFS ノードの構成ファイル、および"Microsoft.IdentityServer.Service"セクションの下に移動する 1 つのノードを選択するには、次のように追加します。       
    
    マスターで次のエントリを追加します。 3 つのキーは大文字小文字が区別ことに注意してください。 

    &lt;useractivityfarmrole masterFQDN = [選択したプライマリの FQDN] isMaster ="true"/&gt;
    
    他のノードで次のエントリを追加します。

   &lt;useractivityfarmrole masterFQDN = [選択したプライマリの FQDN] isMaster ="false"/&gt;
 
    >[!NOTE] 
    >成果物の複数のデータベースでは、データを同期しないために、ESL 値は成果物の Db 間で同期されません。
    ユーザーは達する可能性があります、要求を異なるデータ センターそのため、ExtranetLockoutThreshold を成果物の Db、ExtranetLockoutThreshold の数に依存させること * 成果物の Db の数。 
 
  - **トークン リプレイ検出** 
    
    トークン リプレイ検出データは中央の成果物のデータベースから常に呼び出されます。 AD FS は、同じトークンを再生できないことを確認要求プロバイダー信頼からトークンを保存します。 攻撃者が、同じトークンを再生しようとすると、AD FS は、トークンが、成果物の db が存在するかどうかを検証します。 トークンが存在する場合は、要求は拒否されます。 成果物の中央のデータベースが使用されるセキュリティを成果物の DB のデータがレプリケートされないため攻撃者別のデータ センターに要求を送信し、トークンを再生します。 ArtifactDB の追加の読み取り専用コピーを作成できなくなるこのシナリオでのデータ センターの間の待機時間、サーバーの全体の成果物データベースのみに使用されているためです。    
 
 