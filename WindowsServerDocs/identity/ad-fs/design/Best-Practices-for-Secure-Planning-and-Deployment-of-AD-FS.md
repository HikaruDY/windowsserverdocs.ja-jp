---
ms.assetid: 963a3d37-d5f1-4153-b8d5-2537038863cb
title: AD FS のセキュリティを考慮した設計と展開のベスト プラクティス
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 4a2fb188bd0a46ebd54ae068e8e4eeb63788aaa0
ms.sourcegitcommit: cd12ace92e7251daaa4e9fabf1d8418632879d38
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/04/2019
ms.locfileid: "66501575"
---
# <a name="best-practices-for-secure-planning-and-deployment-of-ad-fs"></a>AD FS のセキュリティを考慮した設計と展開のベスト プラクティス


このトピックでは、計画し、Active Directory フェデレーション サービス (AD FS) の展開を設計するときに、セキュリティを評価するのに役立つベスト プラクティス情報を提供します。 このトピックでは、開始点を確認し、AD FS の使用の全体的なセキュリティに影響する考慮事項を評価します。 このトピックの情報は、既存のセキュリティ計画と他の設計のベスト プラクティスを補完および強化することを意図しています。  
  
## <a name="core-security-best-practices-for-ad-fs"></a>AD FS のセキュリティの主要ベスト プラクティス  
以下の主要ベスト プラクティスは、設計または展開のセキュリティを改善または強化させたいすべての AD FS のインストールに共通です。  

-   **「階層 0」システムとして AD FS をセキュリティで保護します。** 

    AD FS は基本的には、認証システムです。  したがって、ネットワーク上の他の id システムのような「階層 0」システムとして扱われますする必要があります。  [Microsoft Docs](https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material) Active Directory 管理階層モデルの詳細についてはします。 


-   **セキュリティの構成ウィザードを使用して、フェデレーション サーバーとフェデレーション サーバー プロキシ コンピューターに AD FS 固有のセキュリティのベスト プラクティスを適用するには**  
  
    セキュリティ構成ウィザード (SCW) とは、すべての Windows Server 2008、Windows Server 2008 R2 および Windows Server 2012 コンピューターにプレインストールされているツールです。 このウィザードは、インストールするサーバーの役割に基づいて、サーバーが攻撃を受ける機会を削減するのに役立つセキュリティのベスト プラクティスを適用するのに使用できます。  
  
    AD FS をインストールすると、セットアップ プログラムによって役割拡張ファイルが作成されます。このファイルは、セットアップ時に選択する特定の AD FS サーバーの役割 (フェデレーション サーバーまたはフェデレーション サーバー プロキシ) に適用されるセキュリティ ポリシーを作成するために SCW で使用できます。  
  
    インストールされるそれぞれの役割拡張ファイルは、各コンピューターに構成される役割とサブ役割の種類を表します。 次の役割拡張ファイルは、C:WindowsADFSScw ディレクトリにインストールされます。  
  
    -   Farm.xml  
  
    -   SQLFarm.xml  
  
    -   StandAlone.xml  
  
    -   Proxy.xml (このファイルはコンピューターをフェデレーション サーバー プロキシの役割に構成した場合にのみ存在します)  
  
    AD FS の役割の拡張を SCW で適用するには、次の手順を順番に実行してください。  
  
    1.  AD FS をインストールし、そのコンピューターに適したサーバーの役割を選択します。 詳細については、次を参照してください。[フェデレーション サービス プロキシ役割サービスをインストール](../../ad-fs/deployment/Install-the-Federation-Service-Proxy-Role-Service.md)AD FS Deployment guide の「します。  
  
    2.  Scwcmd コマンドライン ツールを使用して適切な役割拡張ファイルを登録します。 下記の表で、コンピューターに構成される役割でこのツールを使用する方法の詳細を参照してください。  
  
    3.  WindowssecurityMsscwLogs ディレクトリにある SCWRegister_log.xml ファイルを調べることで、コマンドが正常に完了したことを確認します。  
  
    AD FS ベースの SCW セキュリティ ポリシーを適用するフェデレーション サーバーまたはフェデレーション サーバー プロキシ コンピューターごとに、これらの手順をすべて実行する必要があります。  
  
    次の表では、AD FS をインストールしたコンピューターで選択する AD FS サーバーの役割に基づいて、適切な SCW の役割の拡張を登録する方法について説明します。  
  
    |AD FS サーバーの役割|使用する AD FS 構成データベース|コマンド プロンプトで入力するコマンド|  
    |---------------------|-------------------------------------|---------------------------------------------------|  
    |スタンドアロン フェデレーション サーバー|Windows Internal Database|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwStandAlone.xml"`|  
    |ファームに加わったフェデレーション サーバー|Windows Internal Database|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwFarm.xml"`|  
    |ファームに加わったフェデレーション サーバー|SQL Server|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwSQLFarm.xml"`|  
    |フェデレーション サーバー プロキシ|なし|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwProxy.xml"`|  
  
    AD FS に使用できるデータベースの詳細については、「[AD FS 構成データベースの役割](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md)」を参照してください。  
  
-   **セキュリティの非常に重要な懸念事項では、たとえば、キオスクを使用する場合の状況でトークン リプレイ検出を使用します。**  
    トークン リプレイ検出は、AD fs フェデレーション サービスに対して行われたトークンの要求をリプレイするあらゆる試みを検出して、要求が破棄されるようにする機能です。 トークン リプレイ検出は既定で有効になっています。 この機能は、同じトークンが複数回使用されないようにすることで、WS-Federation パッシブ プロファイルと Security Assertion Markup Language (SAML) WebSSO プロファイルの両方に対して機能します。  
  
    フェデレーション サービスが開始されると、サービスが対応するすべてのトークンの要求のキャッシュを構築し始めます。 時間と共に、キャッシュに後続のトークンの要求が追加されると、フェデレーション サービスにおいて、トークンの要求を複数回リプレイしようとする試みをより一層検出できるようになります。 トークン リプレイ検出を無効にして、後で再度有効にする場合は、リプレイ キャッシュがコンテンツを再構築するのに十分な時間が経過するまで、フェデレーション サービスは以前に使用された可能性のあるトークンを一定期間受け入れることに留意してください。 詳細については、「 [The Role of the AD FS Configuration Database](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md)」を参照してください。  
  
-   **SAML アーティファクト解決のサポートを使用している場合に特にトークンの暗号化を使用します。**  
  
    トークンの暗号化は、AD FS の展開に対してされる可能性がある潜在的な男性、中間 (MITM) 攻撃に対するセキュリティと保護を向上させる強くお勧めします。 暗号化の使用はスループットに多少影響する可能性がありますが、認識されることは通常なく、多くの展開においてセキュリティの強化のメリットはサーバーのパフォーマンスの点であらゆるコストに勝ります。  
  
    トークンの暗号化を有効にするには、最初に証明書利用者信頼の暗号化証明書を設定して追加します。 暗号化証明書は、証明書利用者信頼の作成時または後で構成できます。 既存の証明書利用者信頼に暗号化証明書を後で追加するを使用する証明書を設定できます、**暗号化**AD FS スナップインを使用しているときに、信頼プロパティ内のタブ。 AD FS コマンドレットを使用して、既存の信頼の証明書を指定するには、いずれかの EncryptionCertificate パラメーターを使用して、**セット ClaimsProviderTrust**または**セット RelyingPartyTrust**コマンドレット。 トークン復号化するときに使用するフェデレーション サービスの証明書を設定するには、使用、 **Set-adfscertificate**コマンドレットを指定し、"`Token-Encryption`"用、 *CertificateType*パラメーター。 特定の証明書利用者信頼に対する暗号化を有効または無効にするには、 *Set-RelyingPartyTrust* コマンドレットの **EncryptClaims** パラメーターを使用します。  
  
-   **認証の拡張保護を利用します。**  
  
    デプロイをセキュリティで保護するには、設定を AD FS と認証機能の拡張保護を使用することができます。 この設定では、フェデレーション サーバーでサポートされる認証の拡張保護のレベルを指定します。  
  
    認証に対する保護の強化は、攻撃者がクライアントの資格情報を傍受してサーバーに転送する man-in-the-middle (MITM) 攻撃に対する保護に役立ちます。 このような攻撃に対する保護は、チャネル バインディング トークン (CBT) を使用することで可能になります。サーバーでは、クライアントと通信を確立するときに CBT を必須、許容、または不要のいずれかにできます。  
  
    保護を強化する機能を有効にするには、**ExtendedProtectionTokenCheck** パラメーターを **Set-ADFSProperties** コマンドレットで使用します。 次の表に、この設定で使用できる値と、値によって指定されるセキュリティのレベルを示します。  
  
    |パラメーター値|セキュリティ レベル|保護設定|  
    |-------------------|------------------|----------------------|  
    |Require|サーバーは完全にセキュリティで保護されます。|保護の強化が適用され常時必須です。|  
    |許可|サーバーは部分的にセキュリティで保護されます。|保護の強化は、関係するシステムでパッチによってサポートされている場合に適用されます。|  
    |なし|サーバーは保護されていません。|保護の強化は適用されません。|  
  
-   **ログ記録とトレースを使用している場合は、機密情報のプライバシーを確認します。**  
  
    AD FS は、既定では、公開またはフェデレーション サービスまたは通常の操作の一部として直接個人を特定できる情報 (PII) を追跡します。 AD FS では、イベント ログとデバッグ トレース ログが有効な場合、ただし、要求ポリシーが一部の要求を構成することによって型と関連付けられた値可能性があります PII が含まれている AD FS イベントまたはトレース ログに記録される可能性があります。  
  
    そのため、AD FS の構成とログ ファイルに対するアクセス制御を実施は強くお勧めします。 このような情報を参照できないようにするには、ログを無効にするか、他のユーザーとログを共有する前にログのすべての PII や機密情報をフィルター処理する必要があります。  
  
    以下のヒントは、意図せずにログ ファイルの内容が公開されるのを防ぐのに役立ちます。  
  
    -   AD FS イベント ログとトレース ログ ファイルがそれらへのアクセスを必要とする信頼された管理者のみへのアクセスを制限するアクセス制御リスト (ACL) によって保護されていることを確認します。  
  
    -   Web 要求を使用して簡単に処理できるファイル拡張子やパスを使用してログ ファイルをコピーしたりアーカイブしたりしないでください。 たとえば、ファイル名の拡張子として .xml を選択するのは安全ではありません。 インターネット インフォメーション サービス (IIS) の管理ガイドで、処理できる拡張子の一覧を確認できます。  
  
    -   ログ ファイルのパスを変更する場合は、ログ ファイルのある場所への絶対パスを指定するようにしてください。この場所は、部外者が Web ブラウザーを使用してアクセスできないように、Web ホストの仮想ルート (vroot) パブリック ディレクトリの外部にする必要があります。  

-   **AD FS のエクストラネット ソフト ロックアウトと AD FS エクストラネット ロックアウト保護をスマートします。**  
    
    Web アプリケーション プロキシを介して invalid(bad) パスワードによる認証要求の形式で攻撃が発生した場合は、AD FS のエクストラネット ロックアウトを使用すると、アカウントのロックアウトが AD FS からユーザーを保護できます。 アカウントのロックアウト、AD FS からユーザーを保護するだけでなく、AD FS のエクストラネット ロックアウトは、ブルート フォース パスワード推測攻撃からも保護されます。  
    
    Windows Server 2012 R2 で AD FS の論理的なエクストラネットのロックアウトを参照してください。 [AD FS エクストラネット ソフト ロックアウト保護](../../ad-fs/operations/Configure-AD-FS-Extranet-Soft-Lockout-Protection.md)します。  

     Windows Server 2016 での AD FS のエクストラネットのスマート ロックアウトを参照してください。 [AD FS エクストラネット スマート ロックアウト保護](../../ad-fs/operations/Configure-AD-FS-Extranet-Smart-Lockout-Protection.md)します。  
  
## <a name="sql-serverspecific-security-best-practices-for-ad-fs"></a>SQL Server 特有の AD FS のセキュリティに関するベスト プラクティス  
次のセキュリティのベスト プラクティスは、これらのデータベース テクノロジを使用して AD FS の設計と展開でデータを管理する Microsoft SQL Server® または Windows Internal Database (WID) の使用に固有です。  
  
> [!NOTE]  
> これらの推奨事項は SQL Server 製品のセキュリティ ガイダンスを強化するためのものであって、取って代わるものではありません。 セキュリティで保護された SQL Server のインストール計画の詳細については、次を参照してください。[セキュリティで保護された SQL インストールにおけるセキュリティの考慮事項](https://go.microsoft.com/fwlink/?LinkID=139831)(https://go.microsoft.com/fwlink/?LinkID=139831)します。  
  
-   **常に物理的にセキュリティで保護されたネットワーク環境でファイアウォールの背後にある SQL Server をデプロイします。**  
  
    SQL Server のインストールを直接インターネットに公開しないでください。 データ センター内のコンピューターのみでは、AD FS をサポートする、SQL server のインストールに到達できる必要があります。 詳細については、次を参照してください。[セキュリティのベスト プラクティスのチェックリスト](https://go.microsoft.com/fwlink/?LinkID=189229)(https://go.microsoft.com/fwlink/?LinkID=189229)します。  
  
-   **組み込みの既定のシステム サービス アカウントを使用する代わりにサービス アカウントには、SQL Server を実行します。**  
  
    SQL Server は既定で、LocalSystem や NetworkService アカウントなど、サポートされているビルトイン システム アカウントの 1 つを使用するようインストールおよび構成されることがよくあります。 AD FS 用の SQL Server のインストールのセキュリティ強化のため、任意の場所、別の使用可能な限り、SQL Server サービスにアクセスするためのサービス アカウントとでは、このアカウントのセキュリティ プリンシパル名 (SPN) を登録することで Kerberos 認証を有効にする、Active Directory のデプロイ。 これによってクライアントとサーバー間で相互認証ができるようになります。 別のサービス アカウントの SPN を登録しないと、SQL Server は Windows ベースの認証で NTLM を使用するので、クライアントのみが認証されます。  
  
-   **SQL Server のアクセス領域を最小限に抑えます。**  
  
    必要な SQL Server エンドポイントのみを有効にしてください。 SQL Server では、既定で組み込みの TCP エンドポイント (削除不可) が 1 つ提供されています。 AD FS、Kerberos 認証の場合は、この TCP エンドポイントを有効にする必要があります。 現状の TCP エンドポイントを確認してユーザー定義の別の TCP ポートが SQL のインストールに追加されていないか調べるには、Transact-SQL (T-SQL) セッションで "SELECT * FROM sys.tcp_endpoints" クエリ ステートメントを使用できます。 SQL Server エンドポイントの構成の詳細については、次を参照してください[How To:。複数の TCP ポートでリッスンするようにデータベース エンジンの構成](https://go.microsoft.com/fwlink/?LinkID=189231)(https://go.microsoft.com/fwlink/?LinkID=189231)します。  
  
-   **SQL ベースの認証を使用しないでください。**  
  
    ネットワークでパスワードをクリア テキストとして転送したり、構成設定にパスワードを保存したりすることを避けるために、SQL Server インストールで Windows 認証のみを使用してください。 SQL Server 認証は以前の認証モードです。 SQL Server 認証の使用時に構造化照会言語 (SQL) ログイン資格証明書 (SQL ユーザー名とパスワード) を保存することは推奨されません。 詳細については、次を参照してください。[認証モード](https://go.microsoft.com/fwlink/?LinkID=189232)(https://go.microsoft.com/fwlink/?LinkID=189232)します。  
  
-   **SQL のインストールで追加のチャネルのセキュリティの必要性を慎重に評価します。**  
  
    Kerberos 認証が有効でも、SQL Server セキュリティ サポート プロバイダー インターフェイス (SSPI) ではチャネル レベルのセキュリティは提供されません。 ただし、サーバーがファイアウォールで保護されたネットワークに安全に配置されているインストールでは、SQL 通信の暗号化は必要でない場合があります。  
  
    暗号化はセキュリティの確保に役立つ重要なツールですが、すべてのデータや接続について考慮する必要はありません。 暗号化を実装するか判断する際は、ユーザーがデータにアクセスする方法を考慮してください。 ユーザーが公衆ネットワークを介してデータにアクセスする場合は、セキュリティを強化するためにデータの暗号化が必要になるかもしれません。 ただし、AD FS による SQL データのすべてのアクセスには、セキュリティで保護されたイントラネット構成が含まれている場合は、暗号化は必要ないです。 暗号化を使用する場合はパスワード、キー、証明書の保守方法も組み込む必要があります。  
  
    ネットワークで何らかの SQL データの参照または改ざんの可能性が懸念される場合は、インターネット プロトコル セキュリティ (IPsec) または Secure Sockets Layer (SSL) を使用して SQL 接続をセキュリティで保護してください。 ただし、状況によっては AD FS のパフォーマンスを制限したりに影響を与える可能性があります SQL Server のパフォーマンスに悪影響を及ぼすこれがあります。 たとえば、SQL ベースの属性ストアからの属性参照がトークンを発行するための重要な場合に、トークンの発行で AD FS パフォーマンスが低下する可能性があります。 SQL の改ざんの脅威は、境界セキュリティの構成を強固にすることでより確実に排除することができます。 たとえば、SQL Server のインストールをセキュリティで保護するためのより良いソリューションは、SQL Server に対して、インターネット ユーザーとコンピューターはアクセスできない状態にし、データセンター環境内のユーザーとコンピューターのみがアクセスできる状態にすることです。  
  
    詳細については、次を参照してください。 [SQL Server への接続の暗号化](https://go.microsoft.com/fwlink/?LinkID=189234)または[SQL Server の暗号化](https://go.microsoft.com/fwlink/?LinkID=189233)します。  
  
-   **AD FS の SQL で保存されたデータですべての SQL ベースの参照を実行するストアド プロシージャを使用して安全に設計されたアクセスを構成します。**  
  
    サービスとデータの分離をより確実にするために、すべての属性ストア参照コマンドのためにストアド プロシージャを作成できます。 次に、ストアド プロシージャを実行する権限を付与するデータベースの役割を作成できます。 このデータベース ロールには、AD FS Windows サービスのサービス id を割り当てます。 AD FS Windows サービスは、属性参照に使用される適切なストアド プロシージャ以外の他の SQL ステートメントを実行する必要がありますできません。 このような方法で SQL Server データベースへのアクセスをロックダウンすることで、特権の昇格攻撃のリスクが低減されます。  
  
## <a name="see-also"></a>関連項目
[Windows Server 2012 での AD FS 設計ガイド](AD-FS-Design-Guide-in-Windows-Server-2012.md)
