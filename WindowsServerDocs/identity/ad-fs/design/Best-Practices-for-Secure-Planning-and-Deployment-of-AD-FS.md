---
ms.assetid: 963a3d37-d5f1-4153-b8d5-2537038863cb
title: "セキュリティで保護の計画と AD FS の展開のベスト プラクティス"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: ed8c36d4bec455879ffd00ad40b72fd5e90484ab
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/12/2017
---
# <a name="best-practices-for-secure-planning-and-deployment-of-ad-fs"></a>セキュリティで保護の計画と AD FS の展開のベスト プラクティス

>適用対象: Windows Server 2016、Windows Server 2012 R2、Windows Server 2012

このトピックでは、計画し、Active Directory フェデレーション サービス (AD FS) の展開を設計するあたってセキュリティを評価するためのベスト プラクティスの情報を示します。 このトピックでは開始点を確認し、AD FS の使用の全体的なセキュリティに影響する考慮事項を評価します。 このトピックの情報は、補完し、既存のセキュリティ計画やその他の設計に関するベスト プラクティスを拡張します。  
  
## <a name="core-security-best-practices-for-ad-fs"></a>AD FS の主要なセキュリティのベスト プラクティス  
次の主要ベスト プラクティスは、改善または、設計または展開のセキュリティを強化するすべての AD FS のインストールに共通です。  
  
-   **セキュリティの構成ウィザードを使用してフェデレーション サーバーとフェデレーション サーバー プロキシ コンピューターに AD FS 固有のセキュリティのベスト プラクティスを適用するには**  
  
    セキュリティ構成ウィザード (SCW) は、すべての Windows Server 2008、Windows Server 2008 R2 および Windows Server 2012 コンピューターにプレインストールされているツールです。 役立つベスト プラクティスをインストールするサーバーの役割に基づいて、サーバーの攻撃を軽減するセキュリティを適用するのにには、それを使用できます。  
  
    AD FS をインストールするときに、セットアップ プログラムは、特定 AD FS サーバーの役割 (フェデレーション サーバーまたはフェデレーション サーバー プロキシ) のセットアップ時に選択したに適用するセキュリティ ポリシーを作成する、SCW で使用できる拡張ファイルの役割を作成します。  
  
    各役割拡張ファイルがインストールされている役割とサブの各コンピューターが構成されている役割の種類を表します。 次の役割拡張ファイルは、C:WindowsADFSScw ディレクトリにインストールされます。  
  
    -   Farm.xml  
  
    -   SQLFarm.xml  
  
    -   StandAlone.xml  
  
    -   Proxy.xml (このファイルは、フェデレーション サーバー プロキシの役割で、コンピューターを構成した場合にのみ存在です)。  
  
    適用するには、SCW の AD FS の役割の拡張機能の順序で、次の手順を完了します。  
  
    1.  AD FS をインストールし、そのコンピューターに適切なサーバーの役割を選択します。 詳細については、次を参照してください。[フェデレーション サービス プロキシ役割サービスをインストール](../../ad-fs/deployment/Install-the-Federation-Service-Proxy-Role-Service.md)AD FS 展開ガイドにします。  
  
    2.  Scwcmd コマンド ライン ツールを使用して適切な役割拡張ファイルを登録します。 コンピューターが構成されている役割でこのツールの使用に関する詳細については、次の表を参照してください。  
  
    3.  WindowssecurityMsscwLogs ディレクトリに格納されて SCWRegister_log.xml ファイルが調べられ、コマンドが正常に完了したことを確認します。  
  
    各フェデレーション サーバーまたはフェデレーション サーバー プロキシ コンピューターが AD FS ベースの SCW セキュリティ ポリシーを適用するのには、これらすべての手順を行う必要があります。  
  
    次の表では、AD FS をインストールしたコンピューターで選択する AD FS サーバー役割に基づいて、適切な SCW の役割拡張を登録する方法について説明します。  
  
    |AD FS サーバーの役割|AD FS 構成データベースの使用|コマンド プロンプトで次のコマンドを入力します。|  
    |---------------------|-------------------------------------|---------------------------------------------------|  
    |スタンドアロン フェデレーション サーバー|Windows Internal Database|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwStandAlone.xml"`|  
    |ファームに参加しているフェデレーション サーバー|Windows Internal Database|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwFarm.xml"`|  
    |ファームに参加しているフェデレーション サーバー|SQL Server|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwSQLFarm.xml"`|  
    |フェデレーション サーバー プロキシ|該当なし|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwProxy.xml"`|  
  
    AD FS で使用できるデータベースの詳細については、次を参照してください。[AD FS 構成データベースの役割](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md)します。  
  
-   **セキュリティがで非常に重要な懸念事項では、たとえば、キオスクを使用する場合の状況でトークン リプレイ検出を使用します。**  
    トークン リプレイ検出は、フェデレーション サービスに対するトークンの要求をリプレイするあらゆる試みを検出して、要求が破棄されるようにする AD FS の機能です。 トークン リプレイ検出は既定で有効にします。 これは、同じトークンが複数回使用がないことを確認して Ws-federation パッシブ プロファイルと Security Assertion Markup Language (SAML) WebSSO プロファイルの両方に機能します。  
  
    フェデレーション サービスが開始されるときにが実現されている任意のトークン要求のキャッシュを作成を開始します。 時間の経過と共に、キャッシュに後続のトークン要求が追加されると、複数回トークンの要求をリプレイするすべての試みを検出する機能の設定は、フェデレーション サービスに増加します。 トークン リプレイ検出を無効にし、後でもう一度有効にするように選択する場合は、フェデレーション サービスがまだ受け入れられることトークンが使用されている以前は、リプレイ キャッシュが許可された十分な時間をその内容を再構築するまでに長時間にわたって注意してください。 詳細については、次を参照してください。[AD FS 構成データベースの役割](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md)します。  
  
-   **SAML アーティファクト解決のサポートを使用している場合は特に、トークンの暗号化を使用します。**  
  
    トークンの暗号化は、AD FS の展開に対して実行される可能性が潜在的なの中間に (MITM) 攻撃に対するセキュリティと保護を増やす強くお勧めします。 暗号化の使用可能性があります多少影響全体でが、一般に、これは通常、通知されないことがあり、多くの展開においてセキュリティ強化のメリットがサーバーのパフォーマンスの面であらゆるコストに勝ります。  
  
    トークンの暗号化を有効にするのには、最初のセットは、証明書利用者信頼の暗号化証明書を追加します。 信頼をパーティいずれか、証明書利用者の作成時に暗号化証明書を構成するまたはそれ以降。 暗号化証明書を後で、既存の証明書利用者信頼のパーティーに追加するに使用する証明書を設定することができます、**暗号化**] タブの [AD FS スナップインを使用しているときに、信頼プロパティ内でします。 AD FS のコマンドレットを使用して、既存の信頼の証明書を指定するには、いずれかの EncryptionCertificate パラメーターを使用して、**セット ClaimsProviderTrust**または**セット RelyingPartyTrust**コマンドレット。 トークンを復号化するときに使用するフェデレーション サービスの証明書を設定するには、使用、**Set-adfscertificate**コマンドレットを指定"`Token-Encryption`"用、*CertificateType*パラメーター。 有効にして、特定の証明書利用者のパーティの暗号化を無効にするとの信頼を使用して行うことができます、*EncryptClaims*のパラメーター、**セット RelyingPartyTrust**コマンドレット。  
  
-   **認証の拡張保護を利用します。**  
  
    展開をセキュリティで保護するには、設定して、AD FS による認証機能の拡張保護を使用することができます。 この設定は、フェデレーション サーバーでサポートされる認証に対する保護の強化のレベルを指定します。  
  
    認証の拡張保護で、攻撃者がクライアントの資格情報を傍受し、サーバーに転送する、中間の (MITM) 攻撃に対する保護されます。 このような攻撃に対する保護が可能にを通じて、チャネル バインディング トークン (CBT) するか、ために必要な許可、またはクライアントとの通信を確立するとき、サーバーが要求しないことができます。  
  
    拡張保護機能を有効にするには、**ExtendedProtectionTokenCheck**パラメーターを**Set-adfsproperties**コマンドレット。 この設定し、値を提供するセキュリティのレベルで使用できる値は、次の表で説明します。  
  
    |パラメーターの値|セキュリティ レベル|保護設定|  
    |-------------------|------------------|----------------------|  
    |必要|サーバーは完全にセキュリティで保護します。|拡張保護が適用され、常に必要なします。|  
    |許可します。|サーバーは部分的にセキュリティで保護します。|ここで関係するシステムをサポートするように適用されていない、拡張保護が適用されます。|  
    |[なし]|サーバーは、脆弱です。|拡張保護は適用されません。|  
  
-   **ログおよびトレースを使用している場合は、機密情報のプライバシーを確認します。**  
  
    AD FS は、既定では、公開またはフェデレーション サービスや通常の操作の一部として直接個人を特定できる情報 (PII) を追跡します。 AD FS では、イベント ログとデバッグ トレース ログが有効な場合、ただし、いくつかの信頼性情報を構成した要求ポリシーによっての種類とその関連値可能性があります PII が含まれている AD FS イベントまたはトレース ログに記録される可能性があります。  
  
    そのため、AD FS の構成とログ ファイルでアクセス制御を適用することを強くお勧めします。 このような情報を表示したくない場合は、無効にするか、または他のユーザーと共有する前に、ログにすべての PII や機密データをフィルター処理する必要があります。  
  
    次のヒントは、ログ ファイルの内容が誤って公開されないことを防ぐのに役立ちます。  
  
    -   AD FS イベント ログとトレース ログ ファイルがそれらにアクセスする必要がある信頼された管理者のみにアクセスを制限するアクセス制御リスト (ACL) によって保護されていることを確認します。  
  
    -   コピー、ファイル拡張子や Web 要求を使用して簡単に処理できるパスを使用してログ ファイルをアーカイブしたりしないでください。 たとえば、.xml ファイル名拡張子は、安全な選択肢ではありません。 処理可能な拡張機能の一覧を表示するインターネット インフォメーション サービス (IIS) 管理ガイドを確認することができます。  
  
    -   ログ ファイルへのパスを変更する場合を Web ブラウザーを使用して外部のパーティによってアクセスされるを防ぐために Web のホスト仮想ルート (vroot) パブリック ディレクトリの外部である必要があります、ログ ファイルの場所の絶対パスを指定することを確認します。  

-   **AD FS のエクストラネット ロックアウト保護**  
    
    Web アプリケーション プロキシを通過 invalid(bad) パスワードの認証要求の形式で攻撃には、発生した場合は、AD FS のエクストラネット ロックアウトを使用すると、AD FS アカウントのロックアウトからユーザーを保護できます。 アカウント ロックアウトの AD FS からのユーザーの保護に加えて、AD FS のエクストラネット ロックアウトもブルート フォース パスワード推測攻撃から保護します。  詳細については、次を参照してください。[AD FS のエクストラネット ロックアウト保護](../../ad-fs/operations/Configure-AD-FS-Extranet-Lockout-Protection.md)します。  
  
## <a name="sql-serverspecific-security-best-practices-for-ad-fs"></a>AD FS の SQL Server – 特定のセキュリティのベスト プラクティス  
AD FS 設計と展開のデータを管理するデータベース テクノロジを使用する場合は、次のセキュリティのベスト プラクティスを Microsoft SQL Server® または Windows Internal Database (WID) の使用に固有です。  
  
> [!NOTE]  
> これらの推奨事項を拡張するが、置き換えられることは、SQL Server 製品のセキュリティ ガイダンスをするものです。 セキュリティで保護された SQL Server のインストールの計画に関する詳細については、次を参照してください。[セキュリティで保護された SQL のインストールのセキュリティに関する考慮事項](https://go.microsoft.com/fwlink/?LinkID=139831)(https://go.microsoft.com/fwlink/?LinkID=139831)。  
  
-   **常に物理的にセキュリティで保護されたネットワーク環境でのファイアウォールの背後にある SQL Server を展開します。**  
  
    SQL Server のインストールことはありません、インターネットに直接公開されている必要があります。 データ センター内のコンピューターのみを AD FS をサポートしている SQL server のインストールに到達できないことがあります。 詳細については、次を参照してください。[セキュリティ ベスト プラクティスのチェックリスト](https://go.microsoft.com/fwlink/?LinkID=189229)(https://go.microsoft.com/fwlink/?LinkID=189229)。  
  
-   **既定のビルトイン システム サービス アカウントを使用する代わりにサービス アカウントで SQL Server を実行します。**  
  
    既定では、SQL Server が多くの場合インストールされ、LocalSystem または NetworkService アカウントなど、サポートされているビルトイン システム アカウントのいずれかを使用するように構成します。 SQL Server のインストールの AD FS のセキュリティを強化するには、すべての場所で可能な SQL Server サービスへのアクセスに別のサービス アカウントを使用し、とこのアカウントのセキュリティ プリンシパル名 (SPN) を Active Directory の展開に登録することで Kerberos 認証を有効にします。 これにより、クライアントとサーバー間の相互認証できます。 別のサービス アカウントの SPN を登録しない SQL Server は、クライアントのみが認証されるを NTLM for Windows ベースの認証に使用します。  
  
-   **SQL Server のサーフェスの領域を最小限に抑えます。**  
  
    必要な SQL Server エンドポイントのみを有効にします。 既定では、SQL Server は、削除することができない 1 つの組み込み TCP エンドポイントを提供します。 AD FS、Kerberos 認証のためには、この TCP エンドポイントを有効にする必要があります。 ユーザー定義の追加の TCP ポートが SQL のインストールに追加して現在の TCP エンドポイントを確認するを使用することができます、"選択 * FROM sys.tcp_endpoints"クエリ ステートメント TRANSACT-SQL (T-SQL) セッションでします。 SQL Server エンドポイントの構成の詳細については、次を参照してください。[How To: 複数の TCP ポートでリッスンするデータベース エンジンを構成する](https://go.microsoft.com/fwlink/?LinkID=189231)(https://go.microsoft.com/fwlink/?LinkID=189231)。  
  
-   **SQL ベースの認証を使用しないでください。**  
  
    パスワードをクリア テキストとして構成設定にパスワードを保存、ネットワーク経由で転送することを避けるために、SQL Server のインストールでのみ、Windows 認証を使用します。 SQL Server 認証は、以前の認証モードです。 (SQL ユーザー名とパスワード) の Structured Query Language (SQL) ログイン資格情報の格納を使用しているときに SQL Server 認証は推奨されません。 詳細については、次を参照してください。[認証モード](https://go.microsoft.com/fwlink/?LinkID=189232)(https://go.microsoft.com/fwlink/?LinkID=189232)。  
  
-   **SQL のインストールで追加のチャネルのセキュリティのニーズを慎重に評価します。**  
  
    Kerberos 認証であっても実際には、SQL Server のセキュリティ サポート プロバイダー インターフェイス (SSPI) は提供されませんチャネル レベルのセキュリティ。 ただし、サーバーを安全にファイアウォールで保護されたネットワークに配置をインストールする場合、SQL 通信の暗号化は必要ありません。  
  
    暗号化はセキュリティを確保するために重要なツールが、すべてのデータや接続のない考慮してください。 暗号化を実装するかどうかを決定するときは、ユーザーがデータにアクセスする方法を検討してください。 パブリック ネットワーク経由でデータをユーザーにアクセスする場合は、セキュリティを強化するデータの暗号化を必要可能性があります。 ただし場合は、AD FS による SQL データのすべてのアクセスがセキュリティで保護されたイントラネット構成では、暗号化しない必要あります。 暗号化を使用するには、パスワード、キー、および証明書の保守戦略する必要があります。  
  
    何らかの SQL データに見られるまたはインターネット プロトコル セキュリティ (IPsec) またはセキュリティで保護された Sockets Layer (SSL) を使用して、ネットワーク経由で改ざん、SQL 接続をセキュリティで保護することで問題がある場合。 ただし、いくつかの状況での AD FS のパフォーマンスを制限したり、影響を与える可能性があります SQL Server のパフォーマンスに悪影響を及ぼすこれがあります。 たとえば、SQL ベースの属性ストアからの属性参照がトークンの発行の重要な場合に、トークンの発行で AD FS パフォーマンスが低下する可能性があります。 強力な境界セキュリティの構成によって改ざんの脅威 SQL より確実に排除することができます。 たとえば、SQL Server のインストールを保護するための最適なソリューションにアクセスできない状態にインターネット ユーザーがそのままし、そのまま、ユーザーや、データ センター環境内のコンピューターのみにアクセスできるコンピューターです。  
  
    詳細については、次を参照してください。[SQL Server への接続の暗号化](https://go.microsoft.com/fwlink/?LinkID=189234)または[SQL Server の暗号化](https://go.microsoft.com/fwlink/?LinkID=189233)します。  
  
-   **安全に設計されたアクセスを構成するには、AD FS の SQL で保存されたデータがすべての SQL ベースの検索を実行するストアド プロシージャを使用します。**  
  
    サービスの向上とデータの分離を提供するには、すべての属性ストア参照コマンドのストアド プロシージャを作成できます。 ストアド プロシージャを実行するアクセス許可を付与したし、データベースの役割を作成することができます。 このデータベースの役割には、AD FS Windows サービスのサービス ID を割り当てます。 AD FS Windows サービスは、属性参照に使用される適切なストアド プロシージャ以外、他の SQL ステートメントを実行できません必要があります。 この方法で、SQL Server データベースへのアクセスをロックダウン、特権の昇格攻撃のリスクが軽減されます。  
  
## <a name="see-also"></a>参照してください。
[Windows Server 2012 で AD FS 設計ガイドします。](AD-FS-Design-Guide-in-Windows-Server-2012.md)
