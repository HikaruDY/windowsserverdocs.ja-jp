---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: ADFS 構成データベースの役割
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 40f1f4952730fad0749a173fdc968714d043b1c1
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/24/2019
ms.locfileid: "66188512"
---
# <a name="the-role-of-the-ad-fs-configuration-database"></a>ADFS 構成データベースの役割
AD FS 構成データベースを Active Directory フェデレーション サービスの 1 つのインスタンスを表すすべての構成データを格納する\(AD FS\) \(フェデレーション サービスは、\)します。 AD FS 構成データベースで定義される一連のパラメーターは、フェデレーション サービスがパートナー、証明書、属性ストア、要求、およびこれらの関連エンティティに関するさまざまなデータを識別する際に必要となります。 Microsoft SQL Server® データベースまたは Windows Internal Database のいずれかでこの構成データを格納する\(WID\) Windows Server® 2008、Windows Server 2008 R2 および Windows Server® 2012 に含まれている機能です。  
  
> [!NOTE]  
> AD FS 構成データベースの内容全体は、WID のインスタンスまたは SQL Server データベースのインスタンスのいずれかに保存できますが、これらの両方に保存することはできません。 つまり、AD FS 構成データベースの同じインスタンスで、WID を使用するフェデレーション サーバーと SQL Server データベースを使用するフェデレーション サーバーを同時に使用することはできません。  
  
このトピックの以下の情報に加えて、「[AD FS 展開トポロジに関する考慮事項](https://technet.microsoft.com/library/gg982489.aspx)」を参照すると、AD FS 構成データベースの保存に WID または SQL Server を選択した場合のそれぞれの利点と欠点を理解できます。  
  
WID リレーショナル データ ストアを使用し、管理ユーザー インターフェイスを持たない \(UI\)します。 いずれかの AD FS 管理スナップインを使用して、管理者が、AD FS 構成データベースの内容を変更する代わりに、\-で、Fsconfig.exe、または Windows PowerShell™ コマンドレット。  
  
## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>WID を使用して AD FS 構成データベースを保存する  
いずれかを使用して、ストアとして WID を使用して AD FS 構成データベースを作成すると、Fsconfig.exe コマンド\-ライン ツールまたは AD FS フェデレーション サーバー構成ウィザード。 これらのツールを使用する場合、フェデレーション サーバー トポロジを作成するために次のいずれかのオプションを選択できます。 これらのオプションでは、AD FS 構成データベースの保存に WID を使用します。  
  
-   作成、スタンド\-だけでフェデレーション サーバー  
  
-   フェデレーション サーバー ファーム内に最初のフェデレーション サーバーを作成する  
  
-   フェデレーション サーバー ファームにフェデレーション サーバーを追加する  
  
スタンドを選択した場合\-AD FS 構成データベースの 1 つのインスタンスを格納するだけでオプション、WID を使用します。 このインスタンスを複数のフェデレーション サーバーで共有することはできません。 これはテスト ラボ環境向けのオプションです。 スタンドアロンの詳細については\-単独で、フェデレーション サーバーのオプションまたはいずれかを設定する方法を参照してください。 [WID を使用してフェデレーション サーバーをスタンドアロン](https://technet.microsoft.com/library/gg982486.aspx) または [スタンドアロン フェデレーション サーバーを作成](https://technet.microsoft.com/library/ee913579.aspx)します。  
  
フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成するオプションを選択した場合、後からファームに別のフェデレーション サーバーを追加できるように、WID でスケーラビリティが構成されます。 WID ファームの展開に関する詳細とセットアップ方法については、「[WID を使用したフェデレーション サーバー ファーム](https://technet.microsoft.com/library/gg982492.aspx)」または「[フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成する](https://technet.microsoft.com/library/dd807070.aspx)」を参照してください。  
  
フェデレーション サーバーを追加するオプションを選択した場合、指定した間隔で構成データベースの変更点が新しいフェデレーション サーバーにレプリケートされるように WID が構成されます。 WID ファームにフェデレーション サーバーを追加する方法の詳細については、次を参照してください。 [WID フェデレーション サーバー ファームを使用して](https://technet.microsoft.com/library/gg982492.aspx) または [をフェデレーション サーバー ファームにフェデレーション サーバーを追加](https://technet.microsoft.com/library/ee913575.aspx)します。  
  
> [!NOTE]  
> WID を使用するフェデレーション サーバー ファームを展開するときに AD FS の一部の機能は利用できません。 サーバー ファームを構成する際にすべての機能セットにアクセスできるようにするには、WID の代わりに Microsoft SQL Server を使用して AD FS 構成データベースを保存することを検討してください。 詳細については、次を参照してください。 [AD FS 展開トポロジに関する考慮事項](https://technet.microsoft.com/library/gg982489(v=ws.11).aspx)します。  
  
### <a name="how-a-wid-federation-server-farm-works"></a>WID フェデレーション サーバー ファームの動作  
このセクションでは、WID フェデレーション サーバー ファームのプライマリおよびセカンダリ フェデレーション サーバー間でデータがレプリケートされる仕組みを理解する上で重要な概念を説明します。 .  
  
#### <a name="primary-federation-server"></a>プライマリ フェデレーション サーバー  
プライマリ フェデレーション サーバーは、Windows Server 2008、Windows Server 2008 R2 または Windows Server® 2012 AD FS フェデレーション サーバー構成ウィザードで、フェデレーション サーバーの役割で構成されていると、AD FS の読み取り/書き込みコピーが実行されているコンピューター構成データベース。 AD FS フェデレーション サーバー構成ウィザードを使用して、新しいフェデレーション サービスを作成し、そのコンピューターに、ファーム内の最初のフェデレーション サーバーを作成するオプションを選択すると、プライマリ フェデレーション サーバーは常に作成されます。 このファーム内の他のすべてのフェデレーション サーバー (セカンダリ フェデレーション サーバーと呼ばれます) は、プライマリ フェデレーション サーバーに対して行われた変更を、ローカルに保存されている AD FS 構成データベースのコピーに同期させる必要があります。  
  
#### <a name="secondary-federation-servers"></a>セカンダリ フェデレーション サーバー  
セカンダリ フェデレーション サーバー、プライマリ フェデレーション サーバーから AD FS 構成データベースのコピーを保存するが、これらのコピーは読み取り専用\-のみです。 セカンダリ フェデレーション サーバーは、ファーム内のプライマリ フェデレーション サーバーに接続し、一定間隔でサーバーをポーリングしてデータが変更されたかどうかをチェックすることにより、プライマリとデータを同期します。 セカンダリ フェデレーション サーバーの存在を読み込むには、機能している間、プライマリ フェデレーション サーバーにフォールト トレランスを提供する\-ネットワーク環境のさまざまなサイトで行われるアクセス要求を分散します。  
  
> [!NOTE]  
> プライマリ フェデレーション サーバーがクラッシュしてオフラインになった場合でも、すべてのセカンダリ フェデレーション サーバーは通常どおり要求を処理し続けます。 ただし、プライマリ フェデレーション サーバーがオンライン状態に戻るまで、フェデレーション サービスに新たに変更を加えることはできません。 Windows PowerShell を使用して、セカンダリ フェデレーション サーバーをプライマリ フェデレーション サーバーとして指定することもできます。 詳細については、次を参照してください。、 [Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
#### <a name="how-the-adfs-configuration-database-is-synchronized"></a>AD FS 構成データベースの同期方法  
により、AD FS 構成データベースが果たす重要な役割が利用できるようにする、ネットワーク内のすべてのフェデレーション サーバーでフォールト トレランスと負荷を提供する\-要求を処理するときに、分散機能\(ときネットワーク負荷\-バランサーが使用\)します。 ただし、セカンダリ フェデレーション サーバーがこれらの機能を提供するためには、プライマリ フェデレーション サーバーに保存されている AD FS 構成データベースと同期している必要があります。  
  
ファームにフェデレーション サーバーを追加する場合、セカンダリ フェデレーション サーバーになる新しいコンピューターは、プライマリ フェデレーション サーバーに接続して AD FS 構成データベースのコピーをレプリケートします。 これ以降、新しいフェデレーション サーバーは、次の図に示すように定期的にプライマリ フェデレーション サーバーから更新を取得し続けます。  
  
![AD FS の役割](media/adfs2_WID.png)  
  
各セカンダリ フェデレーション サーバーは、変更を確認するために 5 分おきにプライマリ フェデレーション サーバーをポーリングします。 この既定値 5 を調整する\-値を分単位または強制的に即時同期はいつでも Windows PowerShell コマンドレットを使用しています。 これを行う方法の詳細については、次を参照してください。 [Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
WID の同期プロセスでは、中程度の変更をより効率的に転送できるように増分転送もサポートされています。 増分転送プロセスでは、必要なネットワーク トラフィックを大幅に削減でき、転送が完了するまでの時間を大幅に短縮できます。  
  
> [!NOTE]  
> AD FS 構成データベースの WID から SQL Server のインスタンスへの移行がサポートされています。 これを行う方法の詳細については、次を参照してください[AD FS:。SQL Server への AD FS 構成データベースの移行](https://go.microsoft.com/fwlink/?LinkId=192232)TechNet Wiki サイトにします。  
  
## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>SQL Server を使用して AD FS 構成データベースを保存する  
Fsconfig.exe コマンドを使用して、ストアとして 1 つの SQL Server データベース インスタンスを使用して AD FS 構成データベースを作成する\-ライン ツール。 SQL Server データベースを AD FS 構成データベースとして使用すると、WID を使用する場合に比べて次のような利点があります。  
  
-   管理者は SQL Server の高可用性機能を活用できます  
  
-   高トラフィック時のパフォーマンスがさらに向上します  
  
-   SAML アーティファクト解決および SAML/WS の機能がサポートされます\-フェデレーション トークン リプレイ検出\(以下に示す\)します。  
  
“プライマリ フェデレーション サーバー” という用語は、AD FS 構成データベースが SQL Server データベースのインスタンスに保存される場合は適用されません。次の図に示すように、すべてのフェデレーション サーバーは、クラスター化された同じ SQL Server インスタンスを使用する AD FS 構成データベースを均等に読み書きできるためです。  
  
![AD FS の役割](media/adfs2_SQL.png)  
  
AD FS は着信クライアント要求をサービスに高度に提供されていることを確認するのにサーバー クラスターとして連携するのに 2 つ以上のサーバーを構成するのには、SQL Server を使用することができます。 高可用性を提供するスケール\-アウト アーキテクチャの他のサーバーを追加することによってサーバー容量を増やすことができます。 単一障害点は自動的なクラスター フェールオーバーによって軽減されます。  
  
ネットワーク負荷を使用して高可用性を実現できます\-SQL クラスタ リング テクノロジを提供する分散とフェールオーバーのサービスです。 高可用性 SQL Server を構成する方法の詳細については、次を参照してください。[高可用性ソリューションの概要](https://go.microsoft.com/fwlink/?LinkId=179853)します。  
  
### <a name="saml-artifact-resolution"></a>SAML アーティファクト解決  
Security Assertion Markup Language \(SAML\) アーティファクト解決は、要求プロバイダーから直接、証明書利用者がトークンを取得する方法について説明する SAML 2.0 プロトコルの一部に基づいたエンドポイントです。 解決プロセスの最初の段階では、ブラウザー クライアントがリソース フェデレーション サーバーに接続してアーティファクトを提供します。 第 2 段階では、リソース フェデレーション サーバーが、アカウント パートナー組織でホストされている SAML アーティファクト エンドポイント URL にアーティファクトを送信して、アーティファクト メッセージを解決します。 最終段階では、アカウント フェデレーション サーバーがブラウザー クライアントの代わりにトークンをフェデレーション サーバーに発行します。  
  
> [!NOTE]  
> アカウント パートナー組織の管理者の場合は、必ず割り当てまたは、Windows ルート証明書プログラム メンバーのルート証明書にチェーン、SSL 証明書を IIS でフェデレーション パッシブ Web サイトにバインド\( <ComputerName>\\サイト\\既定の Web サイト\\adfs\\%.*ls\)ファーム内のすべてのアカウント フェデレーション サーバー。 これは、リソース フェデレーション サーバーで SSL 証明書を [ローカル コンピューター] の [信頼されたユーザー] 証明書ストアに手動で追加する必要が生じたり、組織で公開されているアーティファクトを解決できなくなったりすることを避けるために重要です。  
  
### <a name="samlws---federation-token-replay-detection"></a>SAML WS/フェデレーション トークン リプレイ検出  
用語 *トークン リプレイ* 、アカウント パートナー組織内のブラウザー クライアントがリソース フェデレーション サーバーを認証に複数回、アカウント フェデレーション サーバーから受け取った同じトークンを送信しよう動作を指します。  ユーザーがクリックすると、この動作が発生した、 **戻る** 認証ページを再送信するために、ブラウザーのボタンをクリックします。  
  
AD FS の*トークン リプレイ検出*という機能を使用すると、同じトークンを使用する複数のトークン要求を検出して破棄することができます。 トークン リプレイ検出が、両方の WS で認証要求の整合性を保護するこの機能を有効にすると、\-フェデレーション パッシブ プロファイルと同じトークンが複数回使用されることを確認することによって、SAML WebSSO プロファイル。 キオスクを使用する場合など、セキュリティが非常に重要な懸念事項になる状況では、この機能を有効にする必要があります。  
  
キオスクの場合、ユーザーがすべての Web サイトからログオフした後で、悪意のあるユーザーがブラウザーの履歴を使用して前のユーザーが読み込んだフェデレーション認証ページを再送信しようとすることが考えられます。 トークン リプレイ検出機能は、アカウント パートナー組織で正常に完了した認証に関する追加情報を保存することで、後続のトークンのリプレイを検出して複数回の認証試行が成功しないようにして、この問題を軽減します。  
  

