---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: "AD FS 構成データベースの役割"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 3372e1f051ba7f900753a4961d948ddabdef6f4d
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/12/2017
---
>適用対象: Windows Server 2016、Windows Server 2012 R2、Windows Server 2012

# <a name="the-role-of-the-ad-fs-configuration-database"></a>AD FS 構成データベースの役割
AD FS 構成データベースは、Active Directory フェデレーション サービス \(AD FS\) \(that is, the Federation Service\) の単一のインスタンスを表すすべての構成データを格納します。 AD FS 構成データベースでは、パートナー、証明書、属性ストア、信頼性情報、およびこれらの関連エンティティに関するさまざまなデータを識別する、フェデレーション サービスに必要なパラメーターのセットを定義します。 Microsoft SQL Server® データベースまたは Windows Server® 2008、Windows Server 2008 R2 および Windows Server® 2012 に含まれている Windows Internal Database \(WID\) 機能のいずれかでこの構成データを格納することができます。  
  
> [!NOTE]  
> WID のインスタンスまたは SQL データベースのインスタンスに保存されているが、両方ではなく、AD FS 構成データベースの内容全体ができます。 つまりする一部のフェデレーション サーバーを WID と AD FS 構成データベースの同じインスタンスの SQL Server データベースを使用して他のユーザーを使用することはできません。  
  
このトピックの「で提供されるコンテンツとともに、次の情報を使用する[AD FS 展開トポロジに関する考慮事項](https://technet.microsoft.com/library/gg982489.aspx)については、の長所と短所、AD FS 構成データベースの保存に WID または SQL Server を選択します。  
  
WID 使用リレーショナル データを保存していない、独自の管理ユーザーはインターフェイス \(UI\) です。 代わりに、管理者は、snap\ 内のAD FSの管理、Fsconfig.exe、またはWindows PowerShell™ コマンドレットを使用して、AD FS構成データベースの内容を変更することができます。  
  
## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>WID を使用して、AD FS 構成データベースを格納するには  
Fsconfig.exe コマンド ライン ツールまたは AD FS フェデレーション サーバー構成ウィザードを使用して、ストアとして WID を使用して AD FS 構成データベースを作成することができます。 これらのツールのいずれかを使用する場合は、フェデレーション サーバーのトポロジを作成するのには、次のオプションのいずれかを選択できます。 これらの各オプションでは、WID を使用して、AD FS 構成データベースを格納するため。  
  
-   スタンドアロンのフェデレーション サーバーを作成します。  
  
-   フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成します。  
  
-   フェデレーション サーバー ファームにフェデレーション サーバーを追加します。  
  
スタンドアロンのオプションを選択すると、AD FS 構成データベースの単一インスタンス ストアに WID が使用されます。 このインスタンスは、複数のフェデレーション サーバーで共有することはできません。 テスト ラボ環境のみで説明したものです。 スタンドアロンのフェデレーション サーバーのオプションまたはいずれかを設定する方法の詳細については、次を参照してください。[スタンドアロン フェデレーション サーバーを使用して WID](https://technet.microsoft.com/library/gg982486.aspx)または[スタンドアロン フェデレーション サーバーを作成](https://technet.microsoft.com/library/ee913579.aspx)します。  
  
最初のフェデレーション サーバーをフェデレーション サーバー ファームのオプションを選択する場合は後で、ファームに追加する別のフェデレーション サーバーによって、スケーラビリティの WID が構成されています。 WID ファームまたはいずれかを設定する方法の展開に関する詳細については、次を参照してください[WID フェデレーション サーバー ファームを使用して](https://technet.microsoft.com/library/gg982492.aspx)または[フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成します。。](https://technet.microsoft.com/library/dd807070.aspx)  
  
追加のフェデレーション サーバーのオプションを選択すると、新しいフェデレーション サーバーに設定した間隔で構成データベースの変更をレプリケートする WID が構成されます。 WID ファームにフェデレーション サーバーを追加する方法の詳細については、次を参照してください。[WID フェデレーション サーバー ファームを使用して](https://technet.microsoft.com/library/gg982492.aspx)または[フェデレーション サーバー ファームにフェデレーション サーバーを追加](https://technet.microsoft.com/library/ee913575.aspx)します。  
  
> [!NOTE]  
> WID を使用するフェデレーション サーバー ファームを展開するときに AD FS の一部の機能は利用できません。 設定、サーバー ファームを構成するときに、完全な機能にアクセスするには、代わりに、AD FS 構成データベースを格納する Microsoft SQL Server を使用してを検討してください。 詳細については、次を参照してください。[AD FS 展開トポロジに関する考慮事項](https://technet.microsoft.com/library/gg982489(v=ws.11).aspx)します。  
  
### <a name="how-a-wid-federation-server-farm-works"></a>WID フェデレーション サーバー ファームのしくみ  
このセクションでは、WID フェデレーション サーバー ファームがプライマリ フェデレーション サーバーとセカンダリ フェデレーション サーバーの間でデータをレプリケートする方法について説明する重要な概念について説明します。 .  
  
#### <a name="primary-federation-server"></a>プライマリ フェデレーション サーバー  
プライマリ フェデレーション サーバーは、Windows Server 2008、Windows Server 2008 R2 または Windows Server® 2012 AD FS フェデレーション サーバー構成ウィザードで、フェデレーション サーバーの役割で構成されていると、AD FS 構成データベースの読み取り/書き込みコピーを持つを実行しているコンピューターです。 AD FS フェデレーション サーバー構成ウィザードを使用して、新しいフェデレーション サービスを作成し、そのコンピューターに、ファーム内の最初のフェデレーション サーバーを作成するオプションを選択すると、プライマリ フェデレーション サーバーは常に作成します。 セカンダリ フェデレーション サーバーとも呼ばれるこのファーム内の他のすべてのフェデレーション サーバーは、ローカルに保存されている AD FS 構成データベースのコピーをプライマリ フェデレーション サーバーに対して行われた変更を同期する必要があります。  
  
#### <a name="secondary-federation-servers"></a>セカンダリ フェデレーション サーバー  
セカンダリ フェデレーション サーバーは、プライマリ フェデレーション サーバーから AD FS 構成データベースのコピーを保存しますが、これらのコピーは読み取り専用です。 セカンダリ フェデレーション サーバーに接続し、データが変更されているかどうかを確認する一定間隔でポーリングすることによって、プライマリ フェデレーション サーバー ファームでデータを同期させます。 セカンダリ フェデレーション サーバーは、ネットワーク環境全体にわたって、異なるサイトで作成される load\ 残高アクセス要求に動作している間、プライマリ フェデレーション サーバーのフォールト トレランスを提供する存在します。  
  
> [!NOTE]  
> プライマリ フェデレーション サーバーがクラッシュしてオフラインになって場合、すべてのセカンダリ フェデレーション サーバーは通常どおり要求の処理に進みます。 ただし、新しい変更できるようなしにフェデレーション サービスに、プライマリ フェデレーション サーバーがオンライン状態に戻ったまでです。 セカンダリ フェデレーション サーバーを Windows PowerShell を使用して、プライマリ フェデレーション サーバーもとして指定できます。 詳細については、次を参照してください。、[Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
#### <a name="how-the-ad-fs-configuration-database-is-synchronized"></a>AD FS 構成データベースの同期方法  
ため、AD FS 構成データベースを再生する重要な役割を使用できるように、ネットワーク内のすべてのフェデレーション サーバー上のフォールト トレランスおよび load\ 分散を提供する要求を処理するときの機能 \ (ネットワークの load\ バランサーされる used\)。 ただし、この機能を提供するためにセカンダリ フェデレーション サーバーでは、プライマリ フェデレーション サーバーに格納されている AD FS 構成データベースを同期する必要があります。  
  
ファームにフェデレーション サーバーを追加すると、セカンダリ フェデレーション サーバーになる新しいコンピューターは、AD FS 構成データベースのコピーをレプリケートするプライマリ フェデレーション サーバーに接続します。 これ以降は、新しいフェデレーション サーバーは引き続き、定期的にプライマリ フェデレーション サーバーから更新を取得、次の図に示すようにします。  
  
![AD FS の役割](media/adfs2_WID.png)  
  
各セカンダリ フェデレーション サーバーは、変更が 5 分ごとに、プライマリ フェデレーション サーバーをポーリングします。 この既定 five\ 分の値を調整するか、または強制的に即時同期はいつでも Windows PowerShell コマンドレットを使用しています。 これを行う方法の詳細については、次を参照してください。[Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。  
  
WID の同期処理より効率的に転送中程度の変更の増分転送もサポートします。 増分転送プロセスが大幅に削減でき、ネットワーク トラフィックを必要とし、転送がはるかに速く完了します。  
  
> [!NOTE]  
> WID から SQL Server のインスタンスに、AD FS 構成データベースの移行がサポートされています。 これを行う方法の詳細については、次を参照してください。[AD FS: AD FS 構成データベースを SQL Server に移行](https://go.microsoft.com/fwlink/?LinkId=192232)TechNet Wiki サイトにします。  
  
## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>SQL Server を使用して、AD FS 構成データベースを格納するには  
Fsconfig.exe コマンド ライン ツールを使用して、ストアとして 1 つの SQL Server データベース インスタンスを使用して AD FS 構成データベースを作成することができます。 AD FS 構成データベースとして SQL Server データベースを使用すると、WID 経由で次の利点があります。  
  
-   管理者は、SQL Server の高可用性機能を活用できます。  
  
-   高トラフィックの他のパフォーマンス向上を提供します。  
  
-   SAML アーティファクト解決およびフェデレーション/WS\ SAML トークン リプレイ検出 \(described below\) の機能のサポートを提供します。  
  
「プライマリ フェデレーション サーバー」という用語は、すべてのフェデレーション サーバー均等に読み書きできるが、同じクラスター化された SQL Server インスタンスを使用している AD FS 構成データベースを次の図に示すようにあるために、SQL データベース インスタンスで、AD FS 構成データベースが格納されている場合に適用されません。  
  
![AD FS の役割](media/adfs2_SQL.png)  
  
SQL Server を使用して、確実に AD FS が行わようにサービス着信クライアント要求への高可用性サーバー クラスターとして連携動作する 2 つ以上のサーバーを構成することができます。 高可用性では、追加のサーバーを追加することでサーバーの容量を増やすことができます、scale\ アウト アーキテクチャを提供します。 単一障害点は、自動的なクラスター フェールオーバーによって軽減されます。  
  
ネットワーク load\ 分散とフェールオーバー サービスを SQL クラスタ リング技術を使用して、高可用性を実現できます。 高可用性の SQL Server を構成する方法の詳細については、次を参照してください。[高可用性ソリューションの概要](https://go.microsoft.com/fwlink/?LinkId=179853)します。  
  
### <a name="saml-artifact-resolution"></a>SAML アーティファクト解決  
Security Assertion Markup Language \(SAML\) アーティファクト解決は、証明書利用者が要求プロバイダーから直接、トークンを取得する方法について説明する SAML 2.0 プロトコルの一部に基づいたエンドポイントです。 解決プロセスの最初のステージでは、ブラウザー クライアントがリソース フェデレーション サーバーに接続し、アーティファクトを提供します。 2 番目のステージでは、リソース フェデレーション サーバー アーティファクトを送信して、アーティファクト メッセージを解決するために、アカウント パートナー組織のどこかにホストされている SAML アーティファクト エンドポイント URL。 最終段階では、アカウント フェデレーション サーバーは、フェデレーション サーバーをブラウザー クライアントの代わりトークンを発行します。  
  
> [!NOTE]  
> アカウント パートナー組織の管理者の場合は、必ずを割り当てる、または Windows ルート証明書プログラム メンバーのルート証明書にチェーン、SSL 証明書を IIS のフェデレーション パッシブ Web サイトにバインド \ (<ComputerName>\\Sites\\Default WebSite\\adfs\\ls\)、ファーム内のすべてのアカウント フェデレーション サーバー。 これは、ローカル コンピューターの信頼されたユーザー証明書ストアに SSL 証明書を手動で追加することや、組織内で公開されているアーティファクトを解決することができませんからは、リソース フェデレーション サーバーを防ぐために重要です。  
  
### <a name="samlws---federation-token-replay-detection"></a>SAML WS/フェデレーション トークン リプレイ検出  
用語*トークン リプレイ*、アカウント パートナー組織内のブラウザー クライアントがリソース フェデレーション サーバーに認証を複数回、アカウント フェデレーション サーバーから受け取った同じトークンを送信しよう動作を指します。  ユーザーがクリックしたときにこの動作が発生した、**戻る**認証ページを再送信するために、ブラウザーのボタンをクリックします。  
  
AD FS と呼ばれる機能を提供する*トークン リプレイ検出*する複数のトークン要求によって、同じトークンを使用してを検出およびは破棄されます。 この機能を有効にすると、トークン リプレイ検出は、同じトークンが複数回使用がないことを確認することによって WS\ フェデレーション パッシブ プロファイルと SAML WebSSO プロファイルの両方で認証要求の整合性を保護します。 セキュリティが非常に高い問題などの状況で、この機能を有効にする必要がありますキオスクを使用する場合。  
  
例では、キオスク、ユーザーはすべての Web サイトからログオフ後で悪意のあるユーザーできますしようし、以前のユーザーによって読み込まれたフェデレーション認証ページを再送信するために、ブラウザーの履歴を使用します。 この機能は、後続のトークンのリプレイを検出し、複数の認証試行が成功するを防止するために、アカウント パートナー組織によって行われる認証に成功した各に関する追加情報を保存することによってこの問題を軽減します。  
  

