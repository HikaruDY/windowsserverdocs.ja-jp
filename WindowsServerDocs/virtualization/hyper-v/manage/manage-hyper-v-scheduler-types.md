---
title: 理解して、HYPER-V ハイパーバイザーのスケジューラのタイプを使用します。
description: モードの HYPER-V のスケジューラの使用、HYPER-V ホスト管理者向けの情報を提供します
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 6cb13f84-cb50-4e60-a685-54f67c9146be
ms.openlocfilehash: 7af6d68b02367d349580eacb27405c6f37e97ff8
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59871993"
---
# <a name="managing-hyper-v-hypervisor-scheduler-types"></a>HYPER-V ハイパーバイザーのスケジューラの種類を管理します。

>適用先:Windows 10、Windows Server 2016、Windows Server、バージョン 1709、Windows Server、バージョン 1803 では、Windows Server 2019

この記事では、Windows Server 2016 で初めて導入されたロジックをスケジュール設定の仮想プロセッサの新しいモードについて説明します。 これらのモード、またはスケジューラのタイプは、HYPER-V ハイパーバイザーが割り当てられ、ゲストの仮想プロセッサ間で作業を管理する方法を決定します。 HYPER-V ホストの管理者では、ゲスト仮想マシン (Vm) に最も適しているし、スケジュールのロジックを活用するために Vm を構成するハイパーバイザー スケジューラ型を選択できます。

>[!NOTE]
>このドキュメントで説明されているハイパーバイザー スケジューラ機能を使用するには、更新プログラムが必要です。 詳細については、次を参照してください。[必須の更新プログラム](#required-updates)します。

## <a name="background"></a>背景

説明、ロジックと、HYPER-V 仮想プロセッサのスケジュールの背後にあるコントロールでは、前に、この記事で説明する基本的な概念を確認することをお勧めします。

### <a name="understanding-smt"></a>SMT を理解します。

同時マルチ スレッド、または、SMT は、最新のプロセッサの設計で使用されるプロセッサのリソースを別に、独立した実行のスレッドによって共有できるようにする手法です。 命令のスループットの増加可能であれば、計算を並列化によって、中程度のパフォーマンスを改善するほとんどのワークロードを提供しています、間の競合がスレッドの場合にも、パフォーマンスを得るまたはパフォーマンスにわずかに低下が発生する通常の SMTプロセッサの共有リソースに発生します。
SMT をサポートしているプロセッサは Intel と AMD の両方から利用できます。 Intel は、Intel ハイパー スレッド テクノロジ、または Intel HT としてその SMT オファリングを参照します。

この記事の目的で、SMT および HYPER-V での利用方法の説明は Intel と AMD のシステムに等しく適用されます。

* Intel HT テクノロジの詳細についてを参照してください[Intel ハイパー スレッディング テクノロジ](https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html)

* AMD SMT の詳細についてを参照してください["Zen"コア アーキテクチャ](https://www.amd.com/en/technologies/zen-core)

## <a name="understanding-how-hyper-v-virtualizes-processors"></a>HYPER-V はプロセッサを仮想化する方法を理解します。

スケジューラの種類、ハイパーバイザーを検討する前に、HYPER-V のアーキテクチャを理解しておいてはもします。 一般的な概要を検索する[HYPER-V テクノロジの概要](https://docs.microsoft.com/windows-server/virtualization/hyper-v/hyper-v-technology-overview)します。 この記事の重要な概念を次に示します。

* HYPER-V では、作成し、リソースの割り当てし、ハイパーバイザーの管理下にある、共有のどのコンピューティングの間で仮想マシンのパーティションを管理します。 パーティションは、ゲスト Vm と、ルート パーティション間のすべてのゲスト仮想マシン間で強固な分離境界を提供します。

* ルート パーティション自体が、仮想マシンのパーティションが固有のプロパティとゲスト仮想マシンよりも多くの大きい特権です。 ルート パーティションは、すべてのゲスト仮想マシンを制御する管理サービスを提供、ゲストの場合、仮想デバイスのサポートを提供し、ゲスト仮想マシン用のすべてのデバイス I/O を管理します。 Microsoft では、ルート パーティションで、アプリケーション ワークロードを実行していない強くお勧めします。

* ルート パーティションの各仮想プロセッサ (VP) は、基になる論理プロセッサ (LP) にマップされた 1:1 です。 ホストの担当副社長は常に同じ基になる LP の実行 – ルート パーティションの Vp の移行はありません。

* 既定では、ホスト Vp を実行する LPs はゲスト Vp も実行できます。

* ゲスト担当副社長は、使用可能な論理プロセッサ上で実行するハイパーバイザーによってスケジュールされる可能性があります。 ハイパーバイザー スケジューラ ゲスト担当副社長をスケジュールするときに一時的なキャッシュの局所性、NUMA のトポロジ、およびその他の多くの要因を考慮する、処理中に最終的に、担当副社長を任意のホスト LP スケジュールでした。

## <a name="hypervisor-scheduler-types"></a>ハイパーバイザーのスケジューラのタイプ

Windows Server 2016 以降、HYPER-V ハイパーバイザーは、ハイパーバイザーが基になる論理プロセッサ上の仮想プロセッサをスケジュールする方法を決定するスケジューラのロジックのいくつかのモードをサポートします。 これらのスケジューラの種類があります。

- [従来、公平スケジューラ](#the-classic-scheduler)
- [スケジューラ コア](#the-core-scheduler)
- [ルートのスケジューラ](#the-root-scheduler)

### <a name="the-classic-scheduler"></a>クラシックのスケジューラ

クラシックのスケジューラは、誕生以来、Windows Server 2016 の HYPER-V を含む、Windows、HYPER-V ハイパーバイザーのすべてのバージョンの既定値をしました。 クラシックのスケジューラには、公平のゲストの仮想プロセッサの preemptive のラウンドロビン スケジューリング モデルが用意されています。

クラシック スケジューラ型は、最も適切な大部分の従来の HYPER-V の使用-プライベート クラウドやホスティング プロバイダーは、です。 パフォーマンス特性がよく理解され、最も幅広い LPs、異種の多くの Vm とワークロードを同時に実行される、高い大規模なスケールを実行するのには Vp の過剰サブスクリプションなどの仮想化シナリオをサポートするために最適化されました。完全な機能をサポートしている Vm のパフォーマンスは、制限なしには、HYPER-V、およびその他の設定。

### <a name="the-core-scheduler"></a>スケジューラ コア

ハイパーバイザーの中核となるスケジューラは、クラシック スケジューラ ロジックは、Windows Server 2016 および Windows 10 バージョン 1607 で導入された新しい代替です。 Core スケジューラには、ゲストのワークロードの分離のための強力なセキュリティ境界と、SMT が有効な仮想化ホストで実行されている Vm の内部のワークロードの変動のパフォーマンスの低下が用意されています。 Core スケジューラは、SMT と非 SMT の両方の仮想マシンを同じ SMT が有効な仮想化ホストで同時に実行できます。

Core スケジューラは、仮想化ホストの SMT のトポロジを利用し、必要に応じて SMT ペアは、SMT の論理プロセッサのグループに同じ仮想マシンからゲストの仮想マシンとゲストの仮想プロセッサのスケジュール グループを公開します。 これは、対称的 LPs がいる場合、2 つの Vp のグループをスケジュールする、2 つのグループにしてコアは Vm 間で共有しないようにします。
SMT なしの仮想マシンの担当副社長がスケジュールされているときに有効な場合、実行時に、担当副社長が全体のコアを使用します。

Core のスケジューラの全体的な結果が表示されます。

* 物理コアのペアを基になる、プロセッサ コアの境界に VM を分離する、悪意のある Vm からのサイド チャネル、スヌーピング攻撃に対する脆弱性を減らす上で実行するゲスト Vp が制限されます。

* 変動のスループットが大幅に減少します。

* アイドル状態のまま、その他の中に実行される命令ストリーム、core での 1 つだけのみ Vp のグループのいずれかで実行できる場合ため、パフォーマンスが低下可能性があります。

* OS とゲストの仮想マシンで実行されているアプリケーションは、SMT の動作とプログラミング インターフェイス (Api) を制御し、非仮想化が実行される場合と同様に、SMT のスレッド間で作業を分散させるを利用できます。

* ゲスト ワークロードの分離 - ゲスト Vp の強力なセキュリティ境界は、基になる物理コアのペア、サイド チャネル スヌーピング攻撃に対する脆弱性を減らすことで実行に制限されます。

Core スケジューラは、既定の Windows Server 2019 以降で使用されます。 、Windows Server 2016 では、コア スケジューラはオプションであり、HYPER-V ホストの管理者によって明示的に有効にする必要があり、クラシックの scheduler は、既定値。

#### <a name="core-scheduler-behavior-with-host-smt-disabled"></a>SMT を無効になっているホストとコア スケジューラの動作

ハイパーバイザーが主要なスケジューラのタイプを使用するよう構成 SMT 機能が無効か、仮想化ホスト上に存在しない場合、ハイパーバイザーは、ハイパーバイザー スケジューラの種類の設定に関係なく、従来のスケジューラの動作を使用します。

### <a name="the-root-scheduler"></a>ルートのスケジューラ

ルートのスケジューラは、Windows 10 バージョン 1803 で導入されました。 スケジューラのルート型が有効にすると、ハイパーバイザーはルート パーティションに作業のスケジュール設定の制御を渡します。 ルート パーティションの OS インスタンスで NT スケジューラは、システム LPs に作業をスケジュール設定のすべての側面を管理します。

ルートのスケジューラは、Windows Defender Application Guard (WDAG) で使用されるため、強力なワークロードの分離を提供するユーティリティのパーティションをサポートするいると本質的な固有の要件に対処します。 このシナリオでは、いくつかの利点を提供ルート OS に責任をスケジュール設定のままです。 たとえば、コンテナー シナリオに適用可能な CPU リソースの管理は、管理と展開を簡素化する、ユーティリティのパーティションで使用できます。 さらに、ルート OS のスケジューラがワークロード、コンテナー内の CPU 使用率についてメトリックを収集すぐに、し、システム内の他のすべてのワークロードに適用される同じのスケジューリング ポリシーへの入力としてこのデータを使用できます。 これらの同じメトリック属性は、アプリケーション コンテナーのホスト システムでの作業にも役立ちます明確にします。 これらのメトリックを追跡が難しく、従来の仮想マシンのワークロードで、実行中の VM のすべての代わりに、いくつか作業が行われるルート パーティションにします。

#### <a name="root-scheduler-use-on-client-systems"></a>クライアント システム上でルート スケジューラの使用

Windows 10 バージョン 1803 以降では、ルート スケジューラが既定で使用クライアント システムでのみ、仮想化ベースのセキュリティおよび WDAG ワークロードの分離をサポートし、今後のシステムで正しく動作するために、ハイパーバイザーを有効に可能性があります、異種のコア アーキテクチャ。 これは、クライアント システムのスケジューラ構成をのみサポートされているハイパーバイザーです。 管理者は、Windows 10 クライアントのシステムで既定のハイパーバイザー スケジューラの種類をオーバーライドしないようにします。

#### <a name="virtual-machine-cpu-resource-controls-and-the-root-scheduler"></a>バーチャル マシンの CPU リソースの制御、スケジューラがルート

ルート オペレーティング システムのスケジューラのロジックは、グローバル規模でのホスト リソースを管理して、仮想マシンの情報を持っていませんとハイパーバイザー ルート スケジューラが有効にすると、HYPER-V によって提供される仮想マシンのプロセッサ リソース制御はサポートされていません特定の構成設定。 HYPER-V VM あたりのプロセッサ リソースなどのコントロール、caps、重み、および予約、は、ハイパーバイザーが間接的に担当副社長のスケジュール設定などのクラシック デプロイ モデルとコアのスケジューラの型と同様に制御する場合にのみ適用します。

#### <a name="root-scheduler-use-on-server-systems"></a>サーバー システムでルート スケジューラの使用

ルートのスケジューラは、そのパフォーマンス特性がまだ完全に特徴および調整された、幅広いの多くのサーバー仮想化展開の一般的なワークロードに対応するために、この時点で、Hyper-v を使用したサーバーでの使用は推奨されません。

## <a name="enabling-smt-in-guest-virtual-machines"></a>ゲスト仮想マシンでの SMT を有効にします。

仮想化ホストのハイパーバイザーの中核となるスケジューラの型を使用する構成が済んだら、必要な場合は、SMT を利用するゲスト仮想マシンを構成できます。 Vp がゲスト仮想マシンにハイパー スレッドであることを公開すると、スケジューラは、ゲスト オペレーティング システムおよび検出し、独自の作業のスケジュール設定、SMT のトポロジを使用する VM で実行されているワークロードができます。 、Windows Server 2016 では、ゲスト SMT が既定で構成されていないと、HYPER-V ホストの管理者によって明示的に有効にする必要があります。 Windows Server 2019 以降、ホスト上に作成された新しい Vm は、既定では、ホストの SMT のトポロジを継承することが。  つまり、バージョン 9.0 の VM コアあたり 2 つの SMT スレッドを持つホストに作成のコアあたり 2 つの SMT スレッドも確認します。

PowerShell を使用して、ゲスト仮想マシンでは; での SMT を有効にする必要があります。HYPER-V マネージャーで提供されるユーザー インターフェイスはありません。
SMT をゲスト仮想マシンを有効にするには、十分なアクセス許可、および種類と PowerShell ウィンドウを開きます。

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <n>
```

場所<n>コアあたりの SMT スレッドの数は、ゲスト VM が表示されます。  
なお<n>= core 値ごとのホストの SMT スレッドの数と一致する HwThreadCountPerCore 値が 0 に設定されます。

>[!NOTE] 
>HwThreadCountPerCore 設定 = 0 には、Windows Server 2019 以降はサポートされています。

次に、2 つの仮想プロセッサと仮想マシンで実行されているゲスト オペレーティング システムから取得したシステム情報の例と SMT を有効にします。 ゲスト オペレーティング システムが同じコアに属する 2 つの論理プロセッサを検出しています。

![ゲスト VM で有効になっている SMT msinfo32 を示すスクリーン ショット](media/Hyper-V-CoreScheduler-VM-Msinfo32.png)

## <a name="configuring-the-hypervisor-scheduler-type-on-windows-server-2016-hyper-v"></a>Windows Server 2016 HYPER-V ハイパーバイザーのスケジューラの種類を構成します。

Windows Server 2016 の HYPER-V では、既定では、クラシックのハイパーバイザーのスケジューラのモデルを使用します。 ハイパーバイザーはゲスト Vp、対応する物理 SMT ペアで実行して、そのゲスト Vp の SMT のスケジュール設定を持つ仮想マシンの使用をサポートするために制限することでセキュリティを強化するコアのスケジューラを使用する必要に応じて構成できます。

>[!NOTE]
>Windows Server 2016 の HYPER-V を実行しているすべてのお客様が、仮想化ホストが可能性のある悪意のあるゲスト Vm に対して最適に保護されていることを確認する主要なスケジューラを選択することをお勧めします。

## <a name="windows-server-2019-hyper-v-defaults-to-using-the-core-scheduler"></a>Windows Server 2019 の HYPER-V の既定値は、コアのスケジューラを使用します。

HYPER-V ホストが最適なセキュリティ構成で展開されていることを確認するには、Windows Server 2019 HYPER-V は主要なハイパーバイザーのスケジューラのモデルを既定で使用する、ようになりました。 ホストの管理者は、クラシック レガシ scheduler を使用してホストを必要に応じて構成可能性があります。 管理者を読み取る必要がありますは十分に理解し、スケジューラの種類ごとでは、セキュリティとスケジューラの種類の既定の設定を上書きする前に仮想化ホストのパフォーマンスに影響を検討してください。 は。  参照してください[HYPER-V スケジューラの種類の選択](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/understanding-hyper-v-scheduler-type-selection)詳細についてはします。

### <a name="required-updates"></a>必要な更新プログラム

>[!NOTE]
>このドキュメントで説明されているハイパーバイザー スケジューラ機能を使用する次の更新プログラムが必要です。 これらの更新プログラムには、ホストの構成に必要な新しい 'hypervisorschedulertype' BCD オプションをサポートするために変更が含まれます。

| バージョン | リリース  | 更新が必要です。 | サポート技術情報記事 |
|--------------------|------|---------|-------------:|
|Windows Server 2016 | 1607 | 2018.07 C | [KB4338822](https://support.microsoft.com/help/4338822/windows-10-update-kb4338822) |
|Windows Server 2016 | 1703 | 2018.07 C | [KB4338827](https://support.microsoft.com/help/4338827/windows-10-update-kb4338827) |
|Windows Server 2016 | 1709 | 2018.07 C | [KB4338817](https://support.microsoft.com/help/4338817/windows-10-update-kb4338817) |
|Windows Server 2019 | 1804 | なし | なし |

## <a name="selecting-the-hypervisor-scheduler-type-on-windows-server"></a>Windows Server でハイパーバイザー スケジューラの種類の選択

ハイパーバイザーのスケジューラの構成は hypervisorschedulertype BCD のエントリを使用して制御されます。

スケジューラの型を選択するには、管理者特権でコマンド プロンプトを開きます。

``` command
     bcdedit /set hypervisorschedulertype type
```

場所`type`の 1 つです。

* クラシック
* Core

変更を有効にするハイパーバイザー スケジューラ型をシステムを再起動する必要があります。

>[!NOTE]
>ハイパーバイザーのルートのスケジューラでは、この時点での Windows Server HYPER-V ではサポートされていません。 HYPER-V 管理者は、サーバー仮想化シナリオを使用するためのルートのスケジューラを構成しないようにします。

## <a name="determining-the-current-scheduler-type"></a>現在のスケジューラの種類を決定します。

ハイパーバイザーの起動時に構成されているハイパーバイザー スケジューラの種類のレポートが最新のハイパーバイザー起動イベント ID が 2、イベント ビューアーのシステム ログを調べることで使用中では、現在のハイパーバイザー スケジューラ型を指定できます。 ハイパーバイザーの起動イベントは、Windows イベント ビューアー、または PowerShell を使用して取得できます。

ハイパーバイザーの起動イベント ID 2 は、ハイパーバイザー スケジューラ型を示す場所。

    1 = Classic scheduler, SMT disabled

    2 = Classic scheduler

    3 = Core scheduler

    4 = Root scheduler

![スクリーン ショット ハイパーバイザー起動イベント ID が 2 の詳細の表示](media/Hyper-V-CoreScheduler-EventID2-Details.png)

![ハイパーバイザーの起動イベント ID が 2 を表示するイベント ビューアーを示すスクリーン ショット](media/Hyper-V-CoreScheduler-EventViewer.png)

### <a name="querying-the-hyper-v-hypervisor-scheduler-type-launch-event-using-powershell"></a>PowerShell を使用して、HYPER-V ハイパーバイザー スケジューラ型起動イベントのクエリを実行します。

クエリにハイパーバイザー イベント ID が 2 の PowerShell を使用して、次のコマンド プロンプトから入力 PowerShell。

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Hypervisor"; ID=2} -MaxEvents 1
```

![PowerShell クエリとハイパーバイザーの起動イベント ID が 2 の結果を示すスクリーン ショット](media/Hyper-V-CoreScheduler-PowerShell.png)
