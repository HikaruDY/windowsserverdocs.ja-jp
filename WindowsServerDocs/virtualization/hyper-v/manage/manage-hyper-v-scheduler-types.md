---
title: 理解し、HYPER-V ハイパーバイザー スケジューラ型を使用して
description: モードの HYPER-V のスケジューラの使用 HYPER-V ホスト管理者向けの情報を提供します
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 6cb13f84-cb50-4e60-a685-54f67c9146be
ms.openlocfilehash: 7af6d68b02367d349580eacb27405c6f37e97ff8
ms.sourcegitcommit: 3883eebbba70bfea0221e510863ee1a724a5f926
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/29/2018
ms.locfileid: "5783694"
---
# HYPER-V ハイパーバイザー スケジューラの種類を管理します。

>適用対象: Windows 10、Windows Server 2016、Windows Server バージョン 1709、Windows Server バージョン 1803、Windows Server 2019

この記事では、新しい Windows Server 2016 で初めて導入されたロジックをスケジュール仮想プロセッサ モードについて説明します。 これらのモードでは、またはスケジューラ タイプの場合は、HYPER-V ハイパーバイザーが割り当てられ、ゲスト仮想プロセッサの間で作業を管理する方法を決定します。 HYPER-V ホスト管理者は、ハイパーバイザー スケジューラの種類ゲスト仮想マシン (Vm) に最適ですが、スケジュール設定ロジックを活用するために Vm の構成を選択できます。

>[!NOTE]
>このドキュメントで説明されているハイパーバイザー スケジューラ機能を使用する更新プログラムが必要です。 詳細については、[必須の更新プログラム](#required-updates)を参照してください。

## Background

説明ロジックと HYPER-V 仮想プロセッサのスケジュールの背後にあるコントロールでは、前に、この記事で説明する基本的な概念を確認すると便利です。

### SMT についての理解

同時に、マルチ スレッドまたは SMT は、最新のプロセッサの設計で使用できるように、プロセッサのリソースを別に、独立した実行スレッドによって共有できる手法です。 SMT が一般に命令スループットを向上可能な限り、計算を並列化によって、ほとんどのワークロードに適度なパフォーマンスを向上を提供する、ないパフォーマンス ハンドル獲得やもわずかにパフォーマンスが低下するための間の競合スレッドする場合に発生プロセッサの共有リソースが発生します。
SMT をサポートするプロセッサ Intel と AMD の両方から利用できます。 Intel は Intel ハイパースレッディング テクノロジー、または Intel HT として、SMT 製品を表します。

この記事の目的上、SMT および HYPER-V によって利用方法の説明は Intel と AMD の両方のシステムに均等に適用されます。

* Intel ハイパースレッディング ・ テクノロジーの詳細については、 [Intel ハイパースレッディング テクノロジ](https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html)を参照してください。

* AMD SMT の詳細については、 [「全角」コアのアーキテクチャ](https://www.amd.com/en/technologies/zen-core)を参照してください。

## HYPER-V のプロセッサの仮想化する方法を理解します。

スケジューラ タイプでハイパーバイザーを検討する前に、HYPER-V のアーキテクチャを理解すると便利ですも。 [HYPER-V テクノロジの概要](https://docs.microsoft.com/windows-server/virtualization/hyper-v/hyper-v-technology-overview)では、一般的な概要を確認できます。 この記事の重要な概念を次に示します。

* HYPER-V を作成および、どのコンピューティング間でリソースの割り当てられているし、ハイパーバイザーの管理下で、共有、仮想マシンのパーティションを管理します。 パーティションは、すべてのゲスト仮想マシン間およびゲスト Vm とルート パーティションの強力な分離境界を提供します。

* ルート パーティション自体は仮想マシンのパーティションでは、固有のプロパティとゲスト仮想マシンよりも大きいより特権がありますがです。 ルート パーティションは、すべてのゲスト仮想マシンを制御する管理サービスを提供、ゲストの仮想デバイスのサポートを提供し、ゲスト仮想マシンのすべてのデバイス I/O を管理します。 Microsoft では、ルート パーティションで、アプリケーション ワークロードを実行していないことを強くお勧めします。

* ルート パーティションの仮想プロセッサ (VP) は、基になる論理プロセッサ (LP) にマップされた 1:1 です。 ホスト VP は常に同じ基になる LP の実行: ルート パーティションの Vp の移行はありません。

* 既定では、ホスト Vp を実行する Lp は、ゲスト Vp にも実行できます。

* ゲスト VP は、使用可能な論理プロセッサ上で実行する、ハイパーバイザーによってスケジュールことができます。 ハイパーバイザー スケジューラ ゲスト VP をスケジュールするときに一時的なキャッシュ局面、NUMA トポロジ、およびその他の多くの要因を考慮する、処理中に最終的に VP は任意のホスト LP スケジュール可能性があります。

## ハイパーバイザー スケジューラ タイプ

Windows Server 2016 以降、HYPER-V ハイパーバイザーは、ハイパーバイザーが基になる論理プロセッサ上で仮想プロセッサをスケジュールする方法を決定する、スケジューラ ロジックのいくつかのモードをサポートします。 これらのスケジューラ型は次のとおりです。

- [従来、公平スケジューラ](#the-classic-scheduler)
- [コア スケジューラ](#the-core-scheduler)
- [ルート スケジューラ](#the-root-scheduler)

### 従来のスケジューラ

従来のスケジューラ以来、Windows Server 2016 の HYPER-V を含むすべてのバージョンの Windows の HYPER-V ハイパーバイザーの既定値をされました。 従来のスケジューラは、公平のゲストの仮想プロセッサのプリエンプティブのラウンド ロビン スケジュール モデルを提供します。

従来のスケジューラ型は、最も適切な – プライベート クラウド、ホスティング プロバイダー、およびなどの従来の HYPER-V の使用の大部分を防ぐ。 パフォーマンス特性について理解を深めるとは、最適なさまざまな LPs, 異種の多くの Vm とワークロードを同時に実行されている、もっと規模高を実行する Vp の過剰なサブスクリプションなどの仮想化シナリオをサポートするために最適化されていますフル機能をサポートしている Vm のパフォーマンスは、制限なしで HYPER-V の設定。

### コア スケジューラ

ハイパーバイザーのコア スケジューラは、Windows Server 2016 および Windows 10 バージョン 1607 で導入された、従来のスケジューラ ロジックに新しい代替です。 コア スケジューラは、ゲスト ワークロードの分離の強力なセキュリティ境界と SMT が有効な仮想化ホスト上で実行されている Vm 内でのワークロードのパフォーマンスが低下変動を提供します。 コア スケジューラは、同じ SMT が有効な仮想化ホストに SMT と SMT 以外の両方の仮想マシンを同時に実行できます。

コア スケジューラは、仮想化ホストの SMT トポロジを利用し、必要に応じて SMT の論理プロセッサのグループに同じ仮想マシンから、ゲスト仮想マシンとゲストの仮想プロセッサのスケジュールのグループに SMT ペアを公開します。 これは、対称ように Lp がいる場合、2 つのグループで、2 つの Vp のグループがスケジュールされてし、コアが Vm 間で共有されることはありません。
SMT ことがなく仮想マシンの VP をスケジュールする場合、有効に副社長も、実行時に、全体のコアが消費されます。

コア スケジューラの全体的な結果は。

* ゲスト Vp は物理コアのペアを基になる、プロセッサ コアの境界に VM を分離する、悪意のある Vm から覗き見攻撃のサイド チャネルの脆弱性を抑える上で実行に制限されます。

* スループットの変動が大幅に削減されます。

* アイドル状態のまま、その他の中に実行されるコアで命令ストリームの 1 つだけ Vp のグループのいずれかを実行できますが、だけの場合ため、パフォーマンスが低下可能性があります。

* OS と、ゲスト仮想マシンで実行されているアプリケーションは、SMT の動作とプログラミング インターフェイス (Api) を制御し、仮想化されていないことをいつ実行と同様、SMT スレッド間で作業を分散を利用できます。

* ゲスト ワークロードの分離のゲスト Vp の強力なセキュリティ境界を制約すると、基になる物理コア ペアのサイド チャネル覗き見攻撃に対して脆弱性を減らすことで実行します。

コア スケジューラは、Windows Server 2019 で以降は既定で使用されます。 Windows Server 2016 では、コア スケジューラはオプションであり、HYPER-V ホスト管理者によって明示的に有効にする必要があります、従来スケジューラ既定値。

#### ホストとスケジューラ動作の core SMT 無効になります

コア スケジューラ型を使用して、ハイパーバイザーが構成されている、SMT 機能が無効または仮想化ホスト上に存在しない場合、ハイパーバイザーでは、ハイパーバイザー スケジューラの種類の設定に関係なく、従来のスケジューラの動作が使用されます。

### ルート スケジューラ

ルート スケジューラは、Windows 10 バージョン 1803 で導入されました。 ルート スケジューラ型が有効にすると、ハイパーバイザーはルート パーティションに作業をスケジュールの制御を渡します。 ルート パーティションの OS のインスタンスで NT スケジューラは、システムの Lp に作業をスケジュール設定のすべての側面を管理します。

ルート スケジューラは、Windows Defender Application Guard (WDAG) を使用する強力なワークロードの分離を提供するサポート ユーティリティ パーティションで見られる固有の要件を説明します。 このシナリオでは、OS のルートに責任をスケジュール設定から離れることと、いくつかの利点が提供します。 たとえば、管理と展開を簡略化ユーティリティ パーティションと CPU リソース コントロールのコンテナーのシナリオに適用可能なが使用できます。 さらに、ルート OS スケジューラすぐに、コンテナー内の CPU 使用率のワークロードに関するメトリックを収集でき、システムで他のすべてのワークロードに当てはまります同じスケジュール ポリシーへの入力としてこのデータを使用できます。 これらの同じメトリック属性は、アプリケーションのコンテナーがホスト システムでの作業にも役立ちます明確にします。 これらのメトリックを追跡はより困難従来の仮想マシンのワークロードで実行中の VM のすべての代理としての作業が行われるルート パーティションでです。

#### クライアント システム上でルート スケジューラの使用

Windows 10 バージョン 1803 以降では、ルート スケジューラ使用される既定クライアント システムでのみ、場所と今後のシステムで適切な操作の仮想化ベースのセキュリティと WDAG ワークロードの分離をサポートするため、ハイパーバイザーを有効に可能性があります。混在したコアのアーキテクチャ。 これは、クライアント システムのサポートされている唯一のハイパーバイザー スケジューラ構成です。 管理者は、Windows 10 クライアント システムで既定のハイパーバイザー スケジューラ タイプを優先するデバイスしないでください。

#### 仮想マシンの CPU リソース コントロールとルート スケジューラ

ハイパーバイザーのルート スケジューラを有効にすると、ルート オペレーティング システムのスケジューラ ロジックは、グローバルにホストのリソースを管理して、VM の知識がないように HYPER-V によって提供される仮想マシンのプロセッサ リソース コントロールはサポートされていません特定の構成設定します。 HYPER-V VM あたりプロセッサ リソースなどのコントロール、大文字、太さ、および、予約は、ハイパーバイザー VP スケジューリングなどと同様に、従来型およびコア スケジューラ型を直接管理する場合にのみ適用できます。

#### サーバーのシステム上でルート スケジューラの使用

パフォーマンス特性まだ完全に特徴付けられますされ、さまざまなサーバー仮想化配置の多くの一般的なワークロードに合わせて調整と、ルート スケジューラはサーバーで Hyper-v を使用して、この時点での使用をお勧めしません。

## ゲスト仮想マシンで SMT を有効にします。

コア スケジューラ型を使用して、仮想化ホストのハイパーバイザーを構成すると、必要な場合は、SMT を利用するゲスト仮想マシンを構成することがあります。 Vp がハイパースレッディングをゲスト仮想マシンであることを公開すると、ゲスト オペレーティング システムとを検出し、作業のスケジューリング、独自の SMT トポロジを利用して VM で実行されているワークロードのスケジューラができます。 Windows Server 2016 では、ゲスト SMT が既定で構成されていないと、HYPER-V ホスト管理者によって明示的に有効にする必要があります。 Windows Server 2019 以降、ホストで作成された新しい Vm は既定ではホストの SMT トポロジが継承されます。  つまり、9.0 VM がコアあたり 2 つの SMT スレッドを持つホストで作成されたバージョンのコアあたり 2 つの SMT スレッドも確認します。

PowerShell を使用して、ゲスト仮想マシンで SMT を有効にする必要があります。HYPER-V マネージャーで提供されるユーザー インターフェイスはありません。
SMT をゲスト仮想マシンを有効にするには、十分なアクセス許可、および種類と、PowerShell ウィンドウを開きます。

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <n>
```

場所<n>コアごとの SMT スレッドの数は、ゲスト VM が表示されます。  
注意<n>= 0 core 値ごとのホストの SMT スレッド カウントと一致する HwThreadCountPerCore 値が設定されます。

>[!NOTE] 
>設定 HwThreadCountPerCore = 0 は Windows Server 2019 以降ではサポートされています。

2 つの仮想プロセッサを搭載したバーチャル マシンで実行されているゲスト オペレーティング システムから取得したシステム情報の例を次に示し、SMT が有効にします。 ゲスト オペレーティング システムが同じコアに属している 2 つの論理プロセッサを検出しています。

![ゲスト VM を有効になっている SMT msinfo32 を示すスクリーン ショット](media/Hyper-V-CoreScheduler-VM-Msinfo32.png)

## [Windows Server 2016 HYPER-V ハイパーバイザー スケジューラ タイプの設定

Windows Server 2016 の HYPER-V では、既定では、従来のハイパーバイザー スケジューラ モデルを使用します。 ハイパーバイザーは、必要に応じて、対応する物理 SMT ペアで実行して、ゲスト Vp SMT スケジュール設定による仮想マシンの使用をサポートするために、ゲスト Vp を制限することでセキュリティを強化する、コア スケジューラを使用する構成できます。

>[!NOTE]
>Windows Server 2016 の HYPER-V を実行しているすべてのユーザーが、仮想化ホストが悪意のある可能性のあるゲスト Vm に対して最適な保護を確実に core スケジューラを選択することをお勧めします。

## Windows Server 2019 の HYPER-V の既定値は、コア スケジューラを使用します。

を最適なセキュリティ configuaration では HYPER-V ホストでは展開を確保するため、Windows Server 2019 の HYPER-V は既定で、コア ハイパーバイザー スケジューラ モデルをできるようになりました使用されます。 ホスト管理者は、従来の従来のスケジューラを使用してホストを必要に応じて構成可能性があります。 管理者慎重に読み取り、理解し、スケジューラの種類ごとにはセキュリティとスケジューラ型の既定の設定を上書きする前に、仮想化ホストのパフォーマンスに影響を検討してください。  詳細については[理解 HYPER-V スケジューラの種類の選択](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/understanding-hyper-v-scheduler-type-selection)を参照してください。

### 必要な更新プログラム

>[!NOTE]
>このドキュメントで説明されているハイパーバイザー スケジューラ機能を使用するには、次の更新プログラムが必要です。 これらの更新プログラムには、ホストの構成のために必要な新しい 'hypervisorschedulertype' BCD オプションをサポートするために変更が含まれます。

| バージョン | Release  | 更新プログラムが必要 | サポート技術情報の記事 |
|--------------------|------|---------|-------------:|
|Windows Server 2016 | 1607 | 2018.07 C | [KB4338822](https://support.microsoft.com/help/4338822/windows-10-update-kb4338822) |
|Windows Server 2016 | 1703 | 2018.07 C | [KB4338827](https://support.microsoft.com/help/4338827/windows-10-update-kb4338827) |
|Windows Server 2016 | 1709 | 2018.07 C | [KB4338817](https://support.microsoft.com/help/4338817/windows-10-update-kb4338817) |
|Windows Server 2019 | 1804 | なし | なし |

## Windows Server ではハイパーバイザー スケジューラの種類を選択します。

ハイパーバイザー スケジューラ構成は hypervisorschedulertype BCD エントリによって制御されます。

スケジューラの種類を選択するには、管理者特権でコマンド プロンプトを開きます。

``` command
     bcdedit /set hypervisorschedulertype type
```

場所`type`の 1 つです。

* クラシック
* Core

変更をハイパーバイザー スケジューラ型を有効にするには、システムを再起動する必要があります。

>[!NOTE]
>ハイパーバイザーのルート スケジューラでは、この時点での Windows Server HYPER-V ではサポートされていません。 HYPER-V 管理者は、サーバー仮想化のシナリオで使用するためのルート スケジューラを構成するデバイスしないでください。

## 現在のスケジューラの種類を決定します。

ハイパーバイザーの起動時に構成されているハイパーバイザー スケジューラ タイプが、最新のハイパーバイザー起動イベント ID 2 では、イベント ビューアーでのシステム ログを調べることによって使用中で現在のハイパーバイザー スケジューラの種類を決定できます。 Windows イベント ビューアーで、または PowerShell では、ハイパーバイザー起動イベントを取得できます。

ハイパーバイザーのキックオフ イベント ID 2 表しますハイパーバイザー スケジューラの種類、場所。

    1 = Classic scheduler, SMT disabled

    2 = Classic scheduler

    3 = Core scheduler

    4 = Root scheduler

![スクリーン ショット ハイパーバイザー起動イベント ID 2 の詳細を示す](media/Hyper-V-CoreScheduler-EventID2-Details.png)

![ハイパーバイザーのキックオフ イベント ID 2 を表示するイベント ビューアーを示すスクリーン ショット](media/Hyper-V-CoreScheduler-EventViewer.png)

### PowerShell を使用して HYPER-V ハイパーバイザー スケジューラ型起動イベントの照会

クエリをハイパーバイザー イベント ID 2 の PowerShell を使用して次のコマンドを入力、PowerShell プロンプトからです。

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Hypervisor"; ID=2} -MaxEvents 1
```

![PowerShell のクエリとハイパーバイザーのキックオフ イベント ID 2 の結果を示すスクリーン ショット](media/Hyper-V-CoreScheduler-PowerShell.png)
