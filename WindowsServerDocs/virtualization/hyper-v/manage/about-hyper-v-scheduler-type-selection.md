---
title: HYPER-V ハイパーバイザー スケジューラの種類の選択について
description: モードの HYPER-V のスケジューラの HYPER-V ホスト管理者は、情報を提供します
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 5fe163d4-2595-43b0-ba2f-7fad6e4ae069
ms.openlocfilehash: c5360d8e2fdc23f8b05c6be0f665407eebedeba2
ms.sourcegitcommit: 546229d6b5fa7e16f725c6c35f4dcc272711b811
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/18/2018
ms.locfileid: "4905129"
---
# HYPER-V ハイパーバイザー スケジューラの種類の選択について

適用対象。

* Windows Server 2016
* Windows Server バージョン 1709
* Windows Server バージョン 1803
* Windows Server 2019

このドキュメントでは、HYPER-V の既定の重要な変更について説明し、スケジューラ タイプ ハイパーバイザーの使用をお勧めします。 これらの変更は、両方のシステムのセキュリティと仮想化のパフォーマンスに影響します。 確認し、変更と、このドキュメントで説明されているへの影響を理解し、影響、推奨される展開ガイダンスと最適な展開および管理する方法を理解するために必要なリスクの要因を慎重に評価する必要があります仮想化ホスト管理者は、HYPER-V ホストでは今日のセキュリティの頻繁に変更します。

>[!IMPORTANT]
>現在の既知のサイド チャネルのセキュリティと同時にホスト上で実行レガシ ハイパーバイザー クラシック スケジューラ型のスケジュールの動作を介して悪意のあるゲスト VM で複数のプロセッサ アーキテクチャに見えるの脆弱性が悪用される可能性がマルチ (SMT) 有効になっています。  悪用、悪意のあるワークロードは、パーティションの境界外のデータを監視可能性があります。 ハイパーバイザーの主要なスケジューラ タイプと再構成ゲスト Vm を利用する HYPER-V ハイパーバイザーを構成することによってこのクラスの攻撃を軽減できます。 コア スケジューラとは、ハイパーバイザーは、そのため、実行する物理コアの境界をデータにアクセスする VM の機能を分離することを強く、同じ物理プロセッサ コアで実行する、ゲスト VM の Vp を制限します。  これは、VM がかどうか、その他のパーティションからのすべてのアイテムを監視することを防止するこれらのサイド チャネルの攻撃に対して非常に効果的な軽減策のルートまたは別のゲスト パーティション。  そのため、Microsoft では、既定値を変更して、仮想化ホストとゲスト Vm の構成設定をお勧めします。

## Background

Windows Server 2016 以降、HYPER-V には、スケジュール設定して、ハイパーバイザー スケジューラ タイプと呼ばれる、仮想プロセッサを管理するためのいくつかのメソッドがサポートされています。  ハイパーバイザー スケジューラ種類のすべての詳細については、[について理解し HYPER-V ハイパーバイザー スケジューラ型を使用して](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types)参照することができます。

>[!NOTE]
>新しいハイパーバイザー スケジューラ タイプは、Windows Server 2016 で導入された最初と、以前のリリースでは使用できません。 すべてのバージョンの Windows Server 2016 の前に、HYPER-V では、従来のスケジューラのみをサポートします。 コア スケジューラのサポートは最近公開されました。

## ハイパーバイザー スケジューラの種類について

この記事では、従来の「従来」スケジューラと新しいハイパーバイザー core スケジューラ型の使用は、マルチ スレッド対称または SMT の使用をこれらのスケジューラ型の交差重点的に焦点を当てています。  コアとクラシック スケジューラし、基になるシステムのプロセッサでゲスト Vm から作業を配置の各方法の違いを理解する重要です。

### 従来のスケジューラ

従来のスケジューラは、公平、ラウンド ロビン方式のルート Vp のゲスト Vm に属する Vp などのシステム全体の仮想プロセッサ (Vp) の作業をスケジュール設定を表します。 従来のスケジューラは、既定のスケジューラの種類 (Windows Server 2019、ここに記載されたとして) まで、すべてのバージョンで HYPER-V の使用をされています。  従来のスケジューラのパフォーマンス特性について理解を深めると従来のスケジューラはまさにのワークロードの過剰なサブスクリプションは、適切な余白をホストの VP:LP 比の過剰なサブスクリプションをサポートするために、説明 (異なります、種類の仮想化されているワークロード、全体的なリソースの使用率などです。)。

実行と仮想化ホストに SMT が有効になっていると、従来のスケジューラはいないコアを個別に属する各 SMT スレッドで任意の VM からゲスト Vp をスケジュールします。 そのため、同時 (1 つの VM が別の VM の他のスレッドで実行中に、コアの 1 つのスレッドで実行されている場合) にするには、同じコアのさまざまな Vm を実行します。

### コア スケジューラ

コア スケジューラは、セキュリティとシステム パフォーマンスの影響を与えますゲストのワークロードの分離を提供する SMT のプロパティを活用します。 コア スケジューラは、VM から Vp が兄弟 SMT スレッドでスケジュールされていることを確認します。 これは、対称できるように、Lp いる場合、2 つの Vp のグループは、2 つのグループでスケジュールし、システムの CPU コアが Vm 間で共有されることはありません。

基になる SMT ペアでゲスト Vp をスケジュールすることによっては、コア スケジューラは、ワークロードの分離の強力なセキュリティ境界を提供し、待機時間の機密性の高いワークロードのパフォーマンスの変動を減らすためにも使用できます。

注意 VP が有効になっている、SMT せず、仮想マシンのスケジュールされているとき、実行し、コアの兄弟 SMT スレッドはアイドル状態のままにする場合、副社長に全体のコアを消費します。  これにより、適切なワークロードの分離を提供する必要しますですが、特にシステム Lp になる過剰にサブスクライブしているは、合計 VP:LP 比が 1:1 を超えたときに、システム全体のパフォーマンスに影響を与えます。 そのため、ゲスト Vm のコアごとに複数のスレッドなしで構成を実行しているは最適構成です。

### コア スケジューラを使用するメリット

コア スケジューラには、次の利点が用意されています。

* ゲスト ワークロードの分離のゲスト Vp の強力なセキュリティ境界を制約すると、基になる物理コア ペアのサイド チャネル覗き見攻撃に対して脆弱性を減らすことで実行します。

* ワークロードの一貫性を向上を提供する、割引ワークロード変動 - ゲスト ワークロードのスループット変動が大幅に削減します。

* ゲスト Vm の OS とゲスト仮想マシンで実行されているアプリケーションで SMT の使用は、SMT の動作を利用できるし、プログラミング インターフェイス (Api) を制御および実行する場合と同様に、SMT スレッド間で作業を配布する非仮想化します。

コア スケジューラは、強力なセキュリティ境界とワークロードが少ない variabilty を活用するには、具体的には、Azure の仮想化ホストで使用されています。 Microsoft では、コア スケジューラ型が必要があり、ほとんどの仮想化シナリオの種類のスケジュール既定ハイパーバイザーは引き続きと考えています。  そのため、お客様は既定ではセキュリティで保護されたためには、Microsoft がこの変更を行う Windows Server 2019 のようになりました。

### ゲストのワークロードでコア スケジューラ パフォーマンスに影響

効果的に特定のクラスの脆弱性の軽減するために必要なときに core スケジューラでパフォーマンスが低下も可能性がある可能性があります。 お客様には、全体的なワークロードの容量に、仮想化ホストが Vm とへの影響を使ってパフォーマンス特性に違いが表示されます。 の場合、コア スケジューラが SMT VP を実行する必要がありますが、他の必要がありますがアイドル状態になったときに基になる論理コアで命令ストリームの 1 つだけ実行されます。 これにより、ゲスト ワークロードのホストの合計容量が制限されます。

このドキュメントで配置ガイダンスに従って、これらのパフォーマンスの影響を最小化できます。 ホスト管理者は、特定の仮想化の展開シナリオを検討してください慎重をその許容最大ワークロード密度、仮想化ホストなどの過剰な統合する必要性とセキュリティ リスクのバランスをとる必要があります。

## 既定および Windows Server 2016 および Windows Server 2019 で推奨される構成の変更

最大セキュリティ体制を持つ HYPER-V ホストを展開するには、ハイパーバイザー core スケジューラ タイプを使用する必要があります。 お客様は既定ではセキュリティで保護されたためには、Microsoft は次の既定値を変更して、推奨される設定します。

>[!NOTE]
>スケジューラ タイプのハイパーバイザーの内部のサポートは、Windows Server 2016、Windows Server 1709 および Windows Server 1803 の初期リリースに含まれていた、更新プログラムが選択できる構成コントロールにアクセスするために必要なハイパーバイザー スケジューラの種類。  これらの更新プログラムの詳細については、[理解し HYPER-V ハイパーバイザー スケジューラ型を使用して](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types)参照してください。

### 仮想化ホストの変更

* ハイパーバイザーは Windows Server 2019 以降では既定でコア スケジューラを使用します。

* Microsoft reccommends が Windows Server 2016 core スケジューラを構成します。 ハイパーバイザーの主要なスケジューラ タイプは、既定値は、従来のスケジューラが、Windows Server 2016 でサポートされます。 コア スケジューラはオプションであり、HYPER-V ホスト管理者によって明示的に有効にする必要があります。

### 仮想マシンの構成の変更

* Windows Server 2019 で既定の VM バージョン 9.0 を使用して作成された新しい仮想マシンが自動的に継承 SMT プロパティ (有効または無効) の仮想化ホストします。 SMT を有効にしている場合、SMT が有効にする必要があります、新しく作成された Vm の物理ホストされ、既定では、基になるシステムと同じコアごとのハードウェア スレッド数の vm ホストの SMT トポロジが継承されます。 これは、HwThreadCountPerCore と VM の構成に反映 = 0, 0 が VM がホストの SMT の設定を継承する必要がありますを示します。

* 8.2 またはそれ以前はの VM バージョンの既存の仮想マシンが HwThreadCountPerCore、用の元の VM プロセッサの設定を保持し、各 8.2 VM バージョンのゲストの既定値は HwThreadCountPerCore = 1 です。 これらのゲストは、Windows Server 2019 ホストで実行するときに、次のように扱われますされます。

    1. VM に小さい LP コアの数の副社長カウントがある場合は、VM 扱われます SMT 以外の VM として core スケジューラします。 ゲスト VP を 1 つの SMT スレッドで実行するとき、コアの兄弟 SMT スレッドがアイドリングされます。 これは非最適であり、パフォーマンスの全体的な損失が発生します。

    2. コアの LP より詳しく Vp を VM には、その VM は core スケジューラによって SMT VM として扱われます。 ただし、VM はない SMT VM であるその他の兆候を確認します。 たとえば、OS またはアプリケーションによって CPU トポロジを照会する CPUID 命令または Windows Api の使用では、SMT が有効になっているは示しません。

* 既存の VM は明示的にから更新 eariler VM バージョン バージョン 9.0 Update VM の操作を VM は HwThreadCountPerCore の現在の値に保持されます。  VM には、強制的に対応した SMT はありません。

* Windows Server 2016 では、ゲスト Vm の SMT の有効化をお勧めします。  明示的に変更されない限り、既定では、SMT を無効には、Windows Server 2016 で作成した Vm HwThreadCountPerCore が 1 に設定されます。

>[!NOTE]
>Windows Server 2016 では、0 に設定 HwThreadCountPerCore はサポートしません。

#### 仮想マシンの SMT 構成を管理します。

ゲスト仮想マシンの SMT 構成は、VM ごとの単位で設定されます。 ホスト管理者は、検査し、次のオプションから選択するには、VM の SMT の構成します。

    1. SMT 対応として、必要に応じてホスト SMT トポロジを自動的に継承を実行する Vm を構成します。

    2. 非 SMT として実行する Vm を構成します。

VM の SMT configuaration は、HYPER-V Manager コンソールで [概要] ウィンドウに表示されます。  VM 設定または PowerShell を使用して VM の SMT の設定の構成を行うことがあります。

#### PowerShell を使用して VM SMT 設定を構成します。

ゲスト仮想マシンの SMT 設定を構成するには、十分なアクセス許可と型を持つ PowerShell ウィンドウを開きます。

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <0, 1, 2>
```

この場合

    0 = Inherit SMT topology from the host (this setting of HwThreadCountPerCore=0 is not supported on Windows Server 2016)

    1 = Non-SMT

    Values > 1 = the desired number of SMT threads per core. May not exceed the number of physical SMT threads per core.

ゲスト仮想マシンの SMT 設定を読み取り、十分なアクセス許可と種類、PowerShell ウィンドウを開きます。

``` powershell
(Get-VMProcessor -VMName <VMName>).HwThreadCountPerCore
```

そのゲスト HwThreadCountPerCore で構成されている Vm に注意してください = 0 SMT は、ゲストを有効化して、通常 2 基になる仮想化ホスト上にあるように、同じ数のゲストの SMT スレッドを公開します。

### ゲスト Vm は VM mobility シナリオの間で CPU トポロジの変更を監視することがあります。

OS と VM 内のアプリケーションは、VM のライフ サイクル イベントなど、ライブ マイグレーションまたは保存、復元操作後に、ホストと前に、VM 設定の両方に変更を表示します。 状態の保存および復元する VM の操作中には、VM の HwThreadCountPerCore 設定と、実体化された値 (仮想マシンの設定とソース ホストの構成の計算組み合わせ) の両方を移行します。 VM には、これらの設定と宛先のホストでの実行は引き続きします。 時点で VM シャット ダウン、再起動の可能な実体化された値が観察 VM では変更されます。 これは特に問題ありません、OS とアプリケーションとして、ソフトウェアのレイヤーが CPU トポロジについては、通常の起動と初期化コード フローの一部として見てする必要があります。 ただし、これらブート時に初期化シーケンスはライブの移行または保存/復元の操作中に、これらの状態遷移を生じない Vm スキップを読み取る可能性があるため当初計算シャット ダウンされるまでの値を実体化し、再開始します。  

### 非最適の VM の構成に関するアラート

仮想マシンが最適ではない構成での物理コアにホストの結果がよりも詳しく Vp で構成されています。 ハイパーバイザー スケジューラは、SMT に対応しているかのように、これらの Vm を扱います。 ただし、OS と VM のアプリケーション ソフトウェアは、SMT が無効になっていることを示す CPU トポロジ表示されます。 HYPER-V ワーカー プロセスは警告では、VM の構成は最適なと、SMT を推奨することをホスト管理者は、仮想化ホスト上のイベント ログに記録この状態が検出されると、VM に対して有効にします。

#### 非最適に識別する方法には、Vm が構成されています。

以外の SMT Vm HYPER-V ワーカー プロセス イベント ID 3498、イベント ビューアーで、システム ログを調べることによって Vp VM の数が物理コアの数より大きい場合に、VM のトリガーを識別することができます。 イベント ビューアー、または PowerShell で、ワーカー プロセスのイベントを取得できます。

#### PowerShell を使用して HYPER-V ワーカー プロセスの VM イベントの照会

クエリに HYPER-V ワーカー プロセス イベント ID 3498 の PowerShell を使用して、次のコマンドを入力 PowerShell プロンプトからです。

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Worker"; ID=3498}
```

### ゲスト オペレーティング システム用のハイパーバイザー スピンロックの使用方法のゲスト SMT configuaration の影響

Microsoft ハイパーバイザーは複数のスピンロックまたはゲスト VM で実行されている OS 可能性がありますを照会して、パフォーマンスが向上するか、それ以外の場合を実行しているときにさまざまな状況の処理を向上させる可能性があるものなどの最適化をトリガーするヒントを提供します。仮想化します。 最近導入された啓蒙の 1 つは、仮想プロセッサのスケジュールの処理と SMT を利用したサイド チャネルの攻撃の OS の軽減策の使用に関するものです。

>[!NOTE]
>Microsoft では、ホスト管理者は、SMT のワークロードのパフォーマンスを最適化するために、ゲスト Vm を有効にすることをお勧めします。

このゲスト啓蒙の詳細が以下には、ただし重要ポイントの仮想化ホスト管理者は、仮想マシンはホストの物理 SMT 構成と一致するように構成 HwThreadCountPerCore である必要があります提供されます。 これにより、非アーキテクチャのコアがないことを報告するハイパーバイザーを共有します。 そのため、啓蒙を必要とゲスト OS サポート最適化を有効にすることがあります。 Windows Server 2019 では、新しい Vm を作成して、HwThreadCountPerCore (0) の既定値のままにします。 Windows Server 2016 から移行された古い Vm ホストは、Windows Server 2019 の構成バージョンに更新することができます。 その後、HwThreadCountPerCore の設定をお勧め = 0 を。  Windows Server 2016 では、Microsoft は、ホストの構成 (通常 2) と一致する HwThreadCountPerCore の設定をお勧めします。

### NoNonArchitecturalCoreSharing 啓蒙の詳細

Windows Server 2016 以降は、ハイパーバイザーは VP スケジュールし、ゲスト OS に配置の処理を記述する新しい啓蒙を定義します。 この啓蒙は、[ハイパーバイザー上のレベルの仕様 v5.0c](https://docs.microsoft.com/virtualization/hyper-v-on-windows/reference/tlfs)で定義されます。

ハイパーバイザー合成 CPUID リーフ CPUID.0x40000004.EAX:18[NoNonArchitecturalCoreSharing = 1] 仮想プロセッサは兄弟 SMT として報告される仮想プロセッサを除く、別の仮想プロセッサを搭載した物理コアを共有しないことを示しますスレッドします。 たとえば、ゲスト VP はことはありませんで実行ルート VP と共に、SMT スレッド兄弟同じプロセッサ コアの SMT スレッドで同時に実行されています。 この状態は、仮想化を実行しているときにのみ可能、したがって重大なセキュリティの影響は、非アーキテクチャ SMT 動作を表します。 ゲスト OS が NoNonArchitecturalCoreSharing を使うことは安全 STIBP の設定のパフォーマンスのオーバーヘッドを避けるために役立つの最適化を有効にすることを示す値として 1 を = します。

特定の構成で、ハイパーバイザーを示していないはその NoNonArchitecturalCoreSharing = 1 です。 たとえば、ホストが有効になっている SMT とハイパーバイザーのクラシック スケジューラを使用するように構成 NoNonArchitecturalCoreSharing 0 になります。 これにより、対応ゲストで特定の最適化を有効化されないことがあります。 そのため、Microsoft は、ホスト管理者は、SMT の使用がハイパーバイザーのコア スケジューラに依存し、最適なワークロードのパフォーマンスを確認する、ホストからの SMT 構成を継承する仮想マシンが構成されていることを確認をお勧めします。

## 要約

セキュリティの脅威は、進化し続けます。 お客様は既定ではセキュリティで保護された、Microsoft が、ハイパーバイザーと仮想マシンで Windows Server 2019、HYPER-V の起動の既定の構成を変更する、Windows を実行しているユーザーの推奨事項とガイダンスが更新を提供することを確認するにはServer 2016 Hyper-v を使用します。 仮想化ホスト管理者は、次のとおりです。

* 読み取りし、このドキュメントで説明されている方法を理解します。

* 慎重に評価し、セキュリティ、パフォーマンス、仮想化の密度とワークロードの応答性の目標の独自の要件を満たしていることを確認する、仮想化の展開を調整します。

* ハイパーバイザーのコア スケジューラによって提供される強力なセキュリティ上のメリットを活用する既存の Windows Server 2016 の HYPER-V ホストを構成し直してを検討してください。

* 既にある非-SMT Vm ハードウェア セキュリティの脆弱性に対処 VP 分離による制約をスケジュール設定から、パフォーマンスに影響を軽減する更新します。
