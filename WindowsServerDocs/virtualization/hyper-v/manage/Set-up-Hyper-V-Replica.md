---
title: Hyper-V レプリカを設定する
ms.technology: compute-hyper-v
description: レプリカのセットアップ、テスト フェールオーバー、および最初のレプリケーションを実行する方法について説明します。
ms.prod: windows-server-threshold
ms.service: na
manager: dongill
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
author: KBDAzure
ms.author: kathydav
ms.date: 10/10/2016
ms.openlocfilehash: 04066c5b645c0be641c2ba76fadac032d5a91420
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59843213"
---
# <a name="set-up-hyper-v-replica"></a>Hyper-V レプリカを設定する

>適用先:Windows Server 2016

Hyper-V レプリカは、Hyper-V ロールの重要な一部です。 使用可能なワークロードを維持するための 1 つの HYPER-V ホスト サーバーから仮想マシンをレプリケートすることにより、災害復旧戦略につながります。  HYPER-V レプリカでは、レプリカのオフライン仮想マシンへのライブ仮想マシンのコピーを作成します。 次のことを考慮してください。  

-   **HYPER-V ホスト**:プライマリとセカンダリのホスト サーバーでは、物理的に共存したり、WAN 経由のレプリケーションを別の地理的な場所にリンクすることができます。 HYPER-V ホストには、クラスター化されているスタンドアロンまたは両方の組み合わせを指定できます。 サーバー間に Active Directory の依存関係がないと、ドメイン メンバーである必要はありません。  

-   **レプリケーションと変更の追跡**:特定のバーチャル マシンの HYPER-V レプリカを有効にすると、初期レプリケーションは、セカンダリ ホスト サーバー上、同一のレプリカ仮想マシンを作成します。 操作を行った後、HYPER-V レプリカの変更の追跡を作成し、バーチャル マシン VHD に変更をキャプチャするログ ファイルを保持します。 ログ ファイルは、VHD ベースのレプリケーション頻度の設定、レプリカに逆の順序で再生されます。 これは、最新の変更が格納され、非同期的にレプリケートすることを意味します。 レプリケーションは、HTTP または HTTPS 経由で実行できます。  

-   **拡張 (チェーン) レプリケーション**:これにより、セカンダリをホストする 3 つ目のホスト、セカンダリのホストと、レプリケートするプライマリ ホストから仮想マシンをレプリケートできます。 2 番目と 3 番目に直接プライマリ ホストからレプリケートすることはできないことに注意してください。  

    この機能により、HYPER-V レプリカ災害復旧のためより堅牢なため、障害が発生した場合は、プライマリと拡張の両方のレプリカから回復することができます。  プライマリとセカンダリの場所がダウンした場合は、拡張レプリカにフェールオーバーすることができます。 注拡張レプリカがアプリケーションの整合性レプリケーションをサポートしていないし、セカンダリ レプリカを使用している同じ Vhd を使用する必要があります。  

-   **フェールオーバー**:プライマリで障害が発生した (またはセカンダリの場合の拡張) 場合、の計画、テストを手動で開始する場所または非計画的フェールオーバーします。  

    ||テスト|計画されています|予想外|  
    |-|--------|-----------|-------------|  
    |ときに実行する必要がありますか。|仮想マシンがフェールオーバーおよびセカンダリ サイトにスタートすることを確認します。<br /><br />テスト セットとトレーニングに便利です。|計画されたダウンタイムとシステム停止時に|予期しないイベント時に|  
    |複製のバーチャル マシンの作成|〇|X|いいえ|  
    |ここでは、開始するでしょうか。|レプリカ バーチャル マシンで|プライマリで開始され、セカンダリで完了する|レプリカ バーチャル マシンで|  
    |どのくらいの頻度で実行すればでしょうか。|テスト用の月に 1 回をお勧め|6 か月に 1 回またはコンプライアンスのニーズに合わせて|プライマリ バーチャル マシンが利用できない場合に障害が発生した場合のみ|  
    |プライマリ仮想マシンは、レプリケーションを続行しますか。|〇|[はい]。 停止するときは、プライマリとセカンダリが同期されるように、その変更が、プライマリ サイトに戻すレプリケーションの反転のレプリケートを解決します。|X|  
    |データの損失はありますか。|なし|なし。 フェールオーバー後に、HYPER-V レプリカは、プライマリへのデータの損失を確実に最新の変更履歴のセットをレプリケートします。|イベントおよび回復ポイントに依存します|  
    |ダウンタイムは発生するか|なし。 運用環境に影響しません。 フェールオーバー中に、重複のテスト仮想マシンを作成します。 フェールオーバーが完了すると選択した後に **フェールオーバー** レプリカ仮想マシンが自動的にクリーンアップおよび削除します。|計画された停止の期間|予期しない停止の期間|  

-   **回復ポイント**:仮想マシンのレプリケーション設定を構成するときに、そこから保存する回復ポイントを指定します。 回復ポイントは、スナップショットを表しますに仮想マシンを回復することができます。 ごく最近の回復ポイントから回復する場合、明らかに低いデータは失われます。 回復ポイントをアクセスする最大 24 時間以上前です。  

## <a name="deployment-prerequisites"></a>展開の前提条件  
ここでは確認してください開始する前に。  

-   **Vhd でレプリケートする必要があるか**します。 具体的には、Vhd データを含む急速に変化して、ネットワーク帯域幅を節約するためにレプリケーションから除外するページ ファイル ディスクなどのフェールオーバー後にレプリカ サーバーによって使用されません。 Vhd の除外をメモしてをおきます。  

-   **データを同期する必要があるどのくらいの頻度を決定**:レプリカ サーバー上のデータが同期される (30 秒、5 分間、または 15 分) を構成するレプリケーション頻度に従って更新します。 選択した頻度に、次を検討してください。仮想マシンは低い RPO でクリティカルなデータを実行してでしょうか。 帯域幅を考慮するものですか。  高度に不可欠な仮想マシンより頻繁にレプリケーションを明らかに必要があります。  

-   **データを回復する方法を決定する**:既定では、HYPER-V レプリカはプライマリからセカンダリに送信された最新のレプリケーションとなる 1 つの復旧ポイントのみを格納します。 ただしに以前の時点へのデータを回復するオプションの場合、(最大 24 時間のポイント) に追加の復旧ポイントを保存するかを指定できます。 追加の復旧ポイントは必要な場合は、多くのオーバーヘッドの処理とストレージ リソースが必要である注意してください。  

-   **どのワークロードをレプリケートする**:標準の HYPER-V レプリカ レプリケーションは、仮想マシンで実行されているが、フェールオーバー後は、仮想マシンのオペレーティング システムの状態、アプリケーションの状態の一貫性を維持します。 復旧できるようにする場合、作業負荷状態をアプリケーション整合性の復旧を作成することができますがポイントされます。 そのアプリケーションの整合性の復旧を使用できない拡張レプリカ サイトの拡張 (チェーン) レプリケーションを使用している場合に注意してください。  

-   **仮想マシンのデータの初期レプリケーションを行う方法を決定する**:仮想マシンの現在の状態を転送する必要がありますを転送することによって、レプリケーションが開始されます。 この初期状態は、直ちにまたは構成した時間に、既存のネットワーク経由で直接送信できます。 使えばの既存の復元された仮想マシン (たとえば、レプリカ サーバー上にバーチャル マシンの以前のバックアップを復元した) 場合、初期コピーとしてできます。 または、初期コピーを外部メディアにコピーし、そのメディアを物理的にレプリカ サイトに運ぶことで、ネットワーク帯域幅を節約できます。  既存の使用する場合、仮想マシンは関連付けられているすべての以前のスナップショットを削除します。  

## <a name="deployment-steps"></a>展開の手順  

### <a name="step-1-set-up-the-hyper-v-hosts"></a>手順 1:HYPER-V ホストを設定します。  
各サーバー上の 1 つまたは複数のバーチャル マシンとの 2 つ以上の HYPER-V ホストを必要があります。 [HYPER-V を使ってみる](../get-started/Get-started-with-Hyper-V-on-Windows.md)します。 仮想マシンを複製し、ホスト サーバーは、レプリカ サーバーとしてセットアップする必要があります。  

1.  サーバーの HYPER-V の設定で、仮想マシンをレプリケートする **レプリケーション構成**,  **レプリカ サーバーとしてこのコンピューターを有効にする**です。  

2.  HTTP または HTTPS の暗号化をレプリケートすることができます。 選択 **Kerberos (HTTP) を使用する** または **証明書ベースの認証を使用して (HTTPS**)。 既定で HTTP 80 および 443 の HTTPS がレプリカ HYPER-V サーバー上のファイアウォールの例外として有効にします。 既定のポート設定を変更する場合も、ファイアウォールの例外を変更する必要があります。 HTTPS 経由でレプリケートするには、証明書を選択する必要があり、証明書の認証設定を持つ必要があります。  

3.  承認、選択 **認証済みの任意のサーバーからレプリケーションを許可する** が正常に認証するプライマリ サーバーから仮想マシンのレプリケーション トラフィックを許可するレプリカ サーバーを許可するようにします。 選択 **、指定したサーバーからレプリケーションを許可する** を具体的に選択したプライマリ サーバーからのみトラフィックを受け入れるようにします。  

    両方のオプションのレプリカの HYPER-V サーバー上のレプリケートされた Vhd の格納場所を指定できます。  

4.  **[OK]** または **[適用]** をクリックします。  

### <a name="step-2-set-up-the-firewall"></a>手順 2:ファイアウォールの設定  
プライマリとセカンダリ サーバー間のレプリケーションを許可するようにトラフィックを Windows ファイアウォール (またはその他のサードパーティ製のファイアウォール) を取得する必要があります。 HTTP (80) の既定の例外でのサーバー上で HYPER-V の役割をインストールしたと HTTPS (443) が作成されます。 これらの標準ポートを使用している場合は、単にルールを有効にする必要があります。  

-  スタンドアロンのホスト サーバー上の規則を有効にします。  

    1. セキュリティが強化された Windows ファイアウォールを開き、をクリックして **受信の規則**します。  

    2. HTTP (Kerberos) 認証を有効にするを右クリックして **HYPER-V レプリカ HTTP リスナー (TCP 受信)** >**規則の有効化します。** HTTPS 証明書ベース認証を有効にするを右クリックして **HYPER-V レプリカ HTTPS リスナー (TCP 受信)** > E**有効にするルール**します。  

-  HYPER-V クラスターでのルールを有効にするを使用して Windows PowerShell セッションを開く **管理者として実行**, 、これらのコマンドのいずれかを実行します。  

    -   HTTP:  `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`  

    -   HTTPS: `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`  

### <a name="enable-virtual-machine-replication"></a>仮想マシン レプリケーションの有効化  
レプリケートする各仮想マシンでは、次の操作を行います。  

1.  **詳細** HYPER-V マネージャーのウィンドウをクリックして仮想マシンを選択します。  
    選択したバーチャル マシンを右クリックし、クリックして **レプリケーションの有効化** レプリケーションの有効化ウィザードを開きます。  

2.  **[開始する前に]** ページで、 **[次へ]** をクリックします。  

3.  **レプリカ サーバーの指定** ] ページの [レプリカ サーバーのボックスに、NetBIOS またはレプリカ サーバーの FQDN を入力します。 レプリカ サーバーがフェールオーバー クラスターの一部である場合は、HYPER-V レプリカ ブローカーの名前を入力します。 **[次へ]** をクリックします。  

4.  **接続パラメーターの指定**  ページで、HYPER-V レプリカが自動的にレプリカ サーバーに構成した認証とポートの設定を取得します。 値はされている場合は、サーバーがレプリカ サーバーとして構成されていること、および DNS に登録されている確認を取得します。 設定の種類を必要な場合は手動でします。  

5.  **レプリケーション Vhd の選択**  ページで、レプリケートする Vhd が選択されていると、レプリケーションから除外したい vhd のチェック ボックスをオフにされていることを確認します。 **[次へ]** をクリックします。  

6.  **レプリケーションの頻度を構成する**  ページで、どのくらいの頻度を指定の変更は、プライマリからセカンダリに同期する必要があります。 **[次へ]** をクリックします。  

7.  **構成する追加の復旧ポイント** ページで、最新の復旧ポイントのみを維持するために、またはその他のポイントを作成するかどうかを選択します。    一貫してアプリケーションを回復することをお勧め独自の VSS ライターがあるワークロード選択する場合 **ボリューム シャドウ コピー サービス (VSS) frequenc**y し、アプリケーション整合性スナップショットを作成する頻度を指定します。 プライマリとセカンダリの両方の HYPER-V サーバーに HYPER-V で VMM の要求元サービスを実行する必要があることに注意してください。 **[次へ]** をクリックします。  

8.  **初期レプリケーションの選択** ページで、使用する初期レプリケーションの方法を選択します。  ネットワーク接続経由で選択した既定の設定を送信する、ネットワーク経由での初期コピーがプライマリ仮想マシン構成ファイル (VMCX) と仮想ハード ディスク ファイル (VHDX と VHD) にコピーされます。 このオプションを使用しようとしている場合は、ネットワーク帯域幅の可用性を確認します。 プライマリ仮想マシンが複製のバーチャル マシンとセカンダリ サイトに既に構成されている場合に役に立ちます選択  **レプリケーション サーバーで既存のバーチャル マシンを使用して初期コピーとして**します。 HYPER-V でエクスポートするエクスポート プライマリ バーチャル マシンを使用して、セカンダリ サーバー上のレプリカ仮想マシンとしてインポートできます。 できる大規模な仮想マシンまたは帯域幅の制限の選択は後で発生して、オフピークの時間を構成、ネットワーク経由での初期レプリケーションを持っているか、オフラインのメディアとして最初のレプリケーション情報を送信します。  

    オフライン レプリケーションを行う場合は、ハード ディスクや USB ドライブなど、外部ストレージ メディアを使用して、セカンダリ サーバーへの初回コピーをトランスポートします。 外部に接続する必要がありますこれを行うにストレージをプライマリ サーバー (またはクラスターの所有者ノード) し、選択した場合は、初期コピーを格納する場所を指定するには、ローカルまたは外部メディア上で外部メディアを使用して初期コピーを送信します。  レプリカ サイトのプレース ホルダーの仮想マシンが作成されます。 初期レプリケーションが完了した後、外部ストレージがレプリカ サイトに発送されます。 セカンダリ サーバーまたはセカンダリのクラスターの所有者のノードに外部メディアを接続します。 最初のレプリカを指定した場所にインポートして、プレース ホルダーの仮想マシンにマージします。  

9. **を有効にするレプリケーションを完了する**  ページで、概要情報を確認してをクリックして **を終了します。** します。 仮想マシンのデータは、選択した設定に従って転送されます。 レプリケーションが正常に有効になっていることを示すダイアログ ボックスが表示されます。  

10. 拡張 (チェーン) レプリケーションを構成する場合は、レプリカ サーバーを開きをレプリケートする仮想マシンを右クリックします。 クリックして **レプリケーション** > **レプリケーションの拡張** 、レプリケーション設定を指定します。  

## <a name="run-a-failover"></a>フェールオーバーを実行する  
これらの展開手順が完了したら、複製された環境が稼働しています。 必要に応じてフェールオーバーを実行できます。  

**テスト フェールオーバー**:テスト フェールオーバーの右クリックして、プライマリ仮想マシンを実行し、選択する場合**レプリケーション** > **テスト フェールオーバーの**します。 構成されている場合、またはその他の最新の回復ポイントを選択します。 新しいテスト仮想マシンが作成され、セカンダリ サイトで開始します。 テストが完了したら、選択  **テスト フェールオーバーの中止** クリーンアップするレプリカ仮想マシンにします。 のみ実行することにより、仮想マシンを一度にのフェールオーバー テストすることに注意してください。 [詳細](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx)します。  

**計画されたフェールオーバー**:計画されたフェールオーバーの右クリックして、プライマリ仮想マシンを実行し、選択する**レプリケーション** > **計画されたフェールオーバー**します。 計画されたフェールオーバーでは、データの損失を確実に前提条件チェックを実行します。 プライマリ バーチャル マシンがフェールオーバーを開始する前にシャット ダウンすることを確認します。 仮想マシンがフェールオーバー後がある場合は、プライマリ サイトに再び変更内容をレプリケートを開始します。 メモこれが機能するプライマリ サーバーにセカンダリ サーバーまたはプライマリ クラスターの場合、HYPER-V レプリカ ブローカーから受信レプリケーションを構成する必要があります。 フェールオーバーの送信、最後に変更履歴の設定を計画します。 [詳細](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx)します。  

**計画外フェールオーバー**:計画外のフェールオーバーを実行するには、レプリカ仮想マシンで右クリックして**レプリケーション** > **計画外フェールオーバー** HYPER-V マネージャーまたはフェールオーバー クラスター マネージャーから。 このオプションが有効になっている場合は、最新の回復ポイントまたは以前の回復ポイントを復元できます。 フェールオーバー後、確認、障害が発生したで期待どおりに、すべてが動作する仮想マシンをクリックし、 **完了** レプリカ バーチャル マシンでします。 [詳細](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx)します。  
