---
title: Windows シールドされた VM テンプレート ディスクを作成します。
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 9c8b84e8-1f5a-47a1-83ca-b1dbd801cb0b
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 01/29/2019
ms.openlocfilehash: d9f07d2e6e93d4f8d198c2fc3b62c28c940bdefb
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/31/2019
ms.locfileid: "66447512"
---
# <a name="create-a-windows-shielded-vm-template-disk"></a>Windows シールドされた VM テンプレート ディスクを作成します。

>適用対象:Windows Server 2019、Windows Server (半期チャネル)、Windows Server 2016

通常の Vm と VM テンプレートを作成すると (たとえば、 [VM テンプレートを Virtual Machine Manager (VMM) で](https://technet.microsoft.com/system-center-docs/vmm/manage/manage-library-add-vm-templates)) テナントと管理者がテンプレート ディスクを使用して、ファブリックで新しい Vm をデプロイするは簡単になります。 シールドされた Vm はセキュリティ上重要な資産であるため、シールドをサポートする VM テンプレートを作成する追加の手順があります。 このトピックでは、VMM でのシールドされたテンプレート ディスクと VM テンプレートを作成する手順について説明します。

このトピックがシールドされた Vm の展開の全体的なプロセスがどのように適合するしくみを理解するのを参照してください。[保護されたホストとシールドされた Vm のサービス プロバイダーの構成手順をホストしている](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)します。

## <a name="prepare-an-operating-system-vhdx"></a>オペレーティング システム VHDX を準備します。

まず、シールドされたテンプレート ディスクの作成ウィザードを実行する OS ディスクを準備します。 このディスクは、テナントの Vm で OS ディスクとして使用されます。 既存のツールを使用してなど Microsoft Desktop イメージ サービス マネージャー (DISM)、このディスクを作成または手動で vhdx フォーマットの空白を使用して VM をセットアップし、そのディスクに OS をインストールすることができます。 ディスクを設定する場合はジェネレーション 2 に固有のものや、シールドされた Vm を次の要件に従う必要があります。 

| VHDX の要件 | Reason |
|-----------|----|
|GUID パーティション テーブル (GPT) ディスクにする必要があります。 | UEFI をサポートするために第 2 世代仮想マシンに必要な|
|ディスクの種類である必要があります**基本的な**ではなく**動的**します。 <br>注:これは、「可変」VHDX 機能ではありません、HYPER-V でサポートされている、論理ディスクの種類を指します。 | BitLocker は、ダイナミック ディスクをサポートしていません。|
|ディスクでは、少なくとも 2 つのパーティションがあります。 1 つのパーティションには、Windows がインストールされているドライブを含める必要があります。 これは、BitLocker が暗号化するドライブです。 もう一方のパーティションは、アクティブ パーティションがブートローダーを含まれておりは、コンピューターを起動できるように暗号化されていません。|BitLocker に必要な|
|ファイル システムは NTFS です。 | BitLocker に必要な|
|VHDX にインストールされているオペレーティング システムは、次のいずれか。<br>Windows Server 2016、Windows Server 2012 R2、または Windows Server 2012 <br>Windows 10、Windows 8.1、Windows 8| 第 2 世代仮想マシンと Microsoft セキュア ブート テンプレートをサポートするために必要|
|オペレーティング システムが一般化された (実行 sysprep.exe) をする必要があります。 | 専門テンプレート プロビジョニングでは、特定のテナントのワークロード用の Vm| 

> [!NOTE]
> VMM を使用する場合はコピーしませんテンプレート ディスクを VMM ライブラリにこの段階で。 

## <a name="run-windows-update-on-the-template-operating-system"></a>テンプレートのオペレーティング システムで Windows Update を実行します。

テンプレート ディスク上には、オペレーティング システムがすべての最新の Windows 更新プログラムがインストールされていることを確認します。 最近リリースされた更新プログラムがエンド ツー エンドのシールド プロセスの信頼性を向上させる - プロセスが失敗する場合は、完全にテンプレートのオペレーティング システムが最新ではありません。

## <a name="prepare-and-protect-the-vhdx-with-the-template-disk-wizard"></a>準備してテンプレート ディスク ウィザードを使用して VHDX を保護します。

でシールドされた Vm をテンプレート ディスクを使用するには、ディスクを準備し、シールドされたテンプレート ディスクの作成ウィザードを使用して、BitLocker で暗号化する必要があります。 このウィザードでは、ディスクのハッシュを生成し、ボリューム シグネチャ カタログ (VSC) に追加します。 VSC を指定し、プロビジョニング プロセス中にテナントの展開されているディスクが変更またはテナントによって信頼されていないディスクと交換されていないことを確認するために使用する証明書を使用して署名されます。 最後に、BitLocker が VM のプロビジョニング中の暗号化にディスクを準備するれる (これがまだ存在しない) 場合、ディスクのオペレーティング システムにインストールします。

> [!NOTE]
> テンプレート ディスク ウィザードでは、インプレースを指定するテンプレート ディスクを変更します。 後で、ディスクを更新するウィザードを実行する前に、保護されていない VHDX のコピーを作成することがあります。 テンプレート ディスク ウィザードを使用して保護されているディスクを変更することはできません。

(保護されたホストまたは VMM サーバーにするは必要ありません)、Windows Server 2016 を実行するコンピューターで、次の手順に従います。

1. コピーで作成された一般化された VHDX [VHDX オペレーティング システムを準備する](#prepare-an-operating-system-vhdx)がない場合は、サーバーにします。

2. ローカル サーバーを管理するには、インストール、**シールドされた VM ツール**機能**リモート サーバー管理ツール**サーバー。

        Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart
        
    インストールされているクライアント コンピューターからサーバーを管理することも、 [Windows 10 リモート サーバー管理ツール](https://www.microsoft.com/en-us/download/details.aspx?id=45520)します。

3. 取得または新しいシールドされた Vm のテンプレート ディスクになる VHDX の VSC を署名する証明書を作成します。 シールド データ ファイルを作成し、により、信頼済みのディスクでは、この証明書の詳細をテナントに表示されます。 したがって、この証明書を取得して、テナントによって相互に信頼された証明機関から重要なは。 ホスト側とテナントの両方がエンタープライズ シナリオでは、PKI からこの証明書を発行することを検討する可能性があります。

    テスト環境を設定し、テンプレート ディスクを準備する自己署名証明書を使用する場合は、次のようなコマンドを実行します。

        New-SelfSignedCertificate -DnsName publisher.fabrikam.com

4. 開始、**テンプレート ディスク ウィザード**から、**管理ツール**フォルダーの [スタート] メニューまたは」と入力して**TemplateDiskWizard.exe**コマンド プロンプトにします。

5. **証明書**] ページで [**参照**証明書の一覧を表示します。 ディスクのテンプレートを準備するために証明書を選択します。 [**OK**] をクリックし、[**次へ**] をクリックします。

6. 仮想ディスク ページで、次のようにクリックします。**参照**準備した VHDX を選択する をクリックし、**次**します。

7. 署名カタログ ページで、提供、わかりやすい**ディスク名**と**バージョン。** これらのフィールドは、準備された後に、ディスクを識別するために存在します。

    たとえば、**ディスク名**入力_WS2016_および**バージョン**、 _1.0.0.0_

8. ウィザードの [設定の確認] ページで選択内容を確認します。 クリックすると**生成**ウィザードがテンプレート ディスク上の BitLocker を有効にする、ディスクのハッシュを計算および VHDX メタデータに格納されているボリューム署名カタログを作成します。

    マウントまたはテンプレート ディスクを移動する前に、準備プロセスが完了するまで待機します。 このプロセスが、ディスクのサイズによっては、完了にかかる可能性があります。

    > [!IMPORTANT]
    > テンプレート ディスクは、セキュリティで保護されたシールドされた VM のプロビジョニング プロセスでのみ使用できます。
    > テンプレート ディスクを使用して、正規表現 (シールド) VM を起動しようとしてください。 可能性 stop エラー (ブルー スクリーン) と、サポートされていません。

9. **概要**ページで、ディスクのテンプレートを VSC の署名に使用される証明書に関する情報と証明書の発行者が表示されます。 **[閉じる]** をクリックしてウィザードを終了します。

VMM を使用する場合は VMM でのシールドされた VM テンプレートにテンプレート ディスクを組み込むには、このトピックの残りのセクションの手順に従います。 

## <a name="copy-the-template-disk-to-the-vmm-library"></a>VMM ライブラリにテンプレート ディスクをコピーします。

テンプレート ディスクを作成した後に、VMM を使用する場合は、ホストはダウンロードして、新しい Vm をプロビジョニングするときに、ディスクを使用して、VMM ライブラリ共有にコピーする必要があります。 VMM ライブラリにテンプレート ディスクをコピーし、ライブラリを更新するには、次の手順を使用します。

1. VHDX ファイルを VMM ライブラリ共有のフォルダーにコピーします。 既定の VMM 構成を使用した場合にテンプレート ディスクをコピー  _\\ <vmmserver>\MSSCVMMLibrary\VHDs_します。

2. ライブラリ サーバーを更新します。 開く、**ライブラリ** ワークスペースで、展開**ライブラリ サーバー**を更新するには、ライブラリ サーバーを右クリックし、をクリックして、**更新**します。

3. 次に、テンプレート ディスクにインストールされているオペレーティング システムに関する情報を VMM を提供します。

    a. ライブラリ サーバーに、新しくインポートされたテンプレート ディスクを見つけ、**ライブラリ**ワークスペース。

    b. ディスクを右クリックし、をクリックし、**プロパティ**します。

    c. **オペレーティング システム**一覧を展開し、ディスクにインストールされているオペレーティング システムを選択します。 オペレーティング システムの選択を VMM に示して、VHDX が空でないこと。

    d. プロパティを更新したら、[**OK**] をクリックします。

ディスクの名前の横にある小さな盾のアイコンは、シールドされた Vm の準備済みのテンプレート ディスクとしてディスクを意味します。 また右クリックして、列ヘッダーと切り替え、**シールド**ディスクが正規表現またはシールドされた VM のデプロイの対象として かどうかを示すテキスト表現を表示する列。

![シールドされた vm テンプレートのディスク](../media/Guarded-Fabric-Shielded-VM/shielded-vm-template-disk.png)

## <a name="create-the-shielded-vm-template-in-vmm-using-the-prepared-template-disk"></a>準備済みのテンプレート ディスクを使用して VMM でのシールドされた VM テンプレートを作成します。

VMM ライブラリ内の準備済みのテンプレート ディスクを使用してシールドされた Vm の VM テンプレートを作成する準備が完了したら。 シールドされた Vm の VM テンプレートは従来の VM テンプレートから若干異なることで、特定の設定を修正しました (世代 2 の VM、UEFI、セキュア ブートが有効になってとに) 他のユーザーは利用できません (テナントのカスタマイズでは、VM のプロパティをいくつか選択に制限されます). VM テンプレートを作成するには、次の手順を実行します。

1. **ライブラリ** ワークスペースで、をクリックして**VM テンプレートの作成**上部にある ホーム タブにします。

2. [**ソースの選択**] ページで、[ライブラリに保管された既存の VM テンプレートまたはバーチャル ハード **ディスクを使用する**] をクリックし、[**参照**] をクリックします。

3. ウィンドウが表示されたら、VMM ライブラリから準備済みのテンプレート ディスクを選択します。 どのディスクが準備を簡単に識別するには、列ヘッダーを右クリックし、有効にする、**シールド**列。 をクリックして**OK**し**次**。

4. VM テンプレートの名前と必要に応じて説明を指定し、クリックして**次**します。

5. **ハードウェアの構成** ページで、このテンプレートから作成された Vm の機能を指定します。 少なくとも 1 つの NIC が使用可能で、VM テンプレートで構成されていることを確認します。 シールドされた VM に接続するテナントの唯一の方法では、リモート デスクトップ接続、Windows リモート管理、またはその他のネットワーク プロトコルで動作する事前構成済みのリモート管理ツールを使用します。

    VMM での静的 IP プールを活用して、テナント ネットワークで DHCP サーバーを実行する代わりに選択した場合は、テナントはこの構成のアラートを生成する必要があります。 テナントは、vmm は、無人セットアップ ファイルが含まれています、自分のシールド データ ファイルを指定するとは、静的 IP プールの情報の特殊なプレース ホルダーの値を指定する必要があります。 テナントの無人セットアップ ファイル内の VMM のプレース ホルダーの詳細については、次を参照してください。[応答ファイルを作成](guarded-fabric-tenant-creates-shielding-data.md#create-an-answer-file)です。 

6. **オペレーティング システムの構成** ページで、VMM はシールドされた vm では、プロダクト キー、タイム ゾーン、およびコンピューター名を含むいくつかのオプションを表示してはのみです。 管理者パスワード、ドメイン名など、いくつかのセキュリティで保護された情報は、シールド データ ファイルをテナントで指定された (します。PDK ファイル)。 

    > [!NOTE]
    > このページでプロダクト キーを指定する場合は、それが有効では、テンプレート ディスク上のオペレーティング システムを確認します。 不適切なプロダクト キーを使用する場合は、VM の作成は失敗します。

テンプレートを作成すると、後にテナント使用できます、新しい仮想マシンを作成します。 VM テンプレートが、テナント管理者ユーザー ロールで使用できるリソースの 1 つあることを確認する必要があります (VMM では、ユーザーのロールが、**設定**ワークスペース)。

## <a name="prepare-and-protect-the-vhdx-using-powershell"></a>準備して PowerShell を使用して VHDX を保護します。

テンプレート ディスク ウィザードを実行する代わりに、RSAT を実行しているコンピューターにコピーして、テンプレート ディスクと証明書と実行[保護 TemplateDisk](https://docs.microsoft.com/powershell/module/shieldedvmtemplate/protect-templatedisk?view=win10-ps
)署名プロセスを開始します。
次の例で指定した名前とバージョン情報を使用して、 _TemplateName_と_バージョン_パラメーター。
提供する VHDX、`-Path`パラメーターが更新されたテンプレート ディスクを使用して上書きされるため、必ずコマンドを実行する前にコピーを作成します。

```powershell
# Replace "THUMBPRINT" with the thumbprint of your template disk signing certificate in the line below
$certificate = Get-Item Cert:\LocalMachine\My\THUMBPRINT

Protect-TemplateDisk -Certificate $certificate -Path "WindowsServer2019-ShieldedTemplate.vhdx" -TemplateName "Windows Server 2019" -Version 1.0.0.0
```

テンプレート ディスクは、Vm のシールドされたプロビジョニングするために使用する準備ができました。
System Center Virtual Machine Manager を使用して VM をデプロイする場合、VMM ライブラリに VHDX を今すぐコピーできます。

また、VHDX からボリューム署名カタログを抽出する可能性があります。
このファイルは、ユーザーは、テンプレートを使用する VM の所有者に、署名証明書、ディスクの名前とバージョンに関する情報を提供に使用されます。
これを作成する、署名証明書を所有しているテンプレートの作成者であることを承認するシールド データ ファイル ウィザードにこのファイルをインポートする必要がありますが、将来テンプレートは、それらのディスクします。

ボリューム署名カタログを抽出するには、PowerShell で、次のコマンドを実行します。

```powershell
Save-VolumeSignatureCatalog -TemplateDiskPath 'C:\temp\MyLinuxTemplate.vhdx' -VolumeSignatureCatalogPath 'C:\temp\MyLinuxTemplate.vsc'
```


## <a name="next-step"></a>次の手順

> [!div class="nextstepaction"]
> [シールド データ ファイルを作成します。](guarded-fabric-tenant-creates-shielding-data.md)

## <a name="see-also"></a>関連項目

- [保護されたホストとシールドされた Vm のサービス プロバイダーの構成手順をホストしています。](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [保護されたファブリックとシールドされた VM](guarded-fabric-and-shielded-vms-top-node.md)
