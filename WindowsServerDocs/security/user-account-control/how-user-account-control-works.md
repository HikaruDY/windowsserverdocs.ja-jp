---
title: ユーザー アカウント制御のしくみ
description: Windows Server のセキュリティ
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: security-tpm
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: da83ddb2-6182-417c-aa8e-0b47b2e17d13
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/12/2016
ms.openlocfilehash: 7f5ad234959ebfe0687b8bc10f9e43f2092252f2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59823553"
---
# <a name="how-user-account-control-works"></a>ユーザー アカウント制御のしくみ

>適用先:Windows Server 2016 の Windows Server (半期チャネル)

ユーザー アカウント制御 (UAC) は、悪意のあるソフトウェア (マルウェアとも呼ばれます) からコンピューターの被害と、組織に管理されたデストップを展開するのに役立ちます。 UAC では、管理者が具体的には、システムへの管理者レベルのアクセスを承認しない限り、アプリケーションとタスクは常に管理者以外のアカウントのセキュリティ コンテキストで実行します。 UAC は、未承認のアプリケーションの自動インストールをブロックし、システムの設定によって不注意による変更を防止できます。

## <a name="uac-process-and-interactions"></a>UAC のプロセスと相互作用
管理者のアクセス トークンを必要とする各アプリケーションは、管理者に同意を求める必要があります。 1 つの例外は、親プロセスと子プロセスの間に存在する関係です。 子プロセスは、親プロセスからユーザーのアクセス トークンを継承します。 ただし、親と子の両方のプロセスは、同じ整合性レベルを持つ必要があります。 Windows Server 2012 では、その整合性レベルをマークすることでプロセスを保護します。 整合性レベルは、信頼性の測定値です。 "高" 整合性アプリケーションはディスク パーティション アプリケーションなどのシステム データを変更するタスクを実行するアプリケーションで、"低" 整合性アプリケーションは Web ブラウザーなどのオペレーティング システムを危険にさらす可能性があるタスクを実行するアプリケーションです。 整合性レベルが低いアプリケーションには、アプリケーションをより高い整合性レベルでのデータを変更できません。 標準ユーザーが管理者アクセス トークンを必要とするアプリケーションを実行しようとすると、UAC では、ユーザーが有効な管理者の資格情報を提供することが必要です。

このプロセスがそれを処理する方法をより深く理解するためには、Windows Server 2012 のログオン プロセスの詳細を確認する重要なのです。

### <a name="windows-server-2012-logon-process"></a>Windows Server 2012 のログオン プロセス
次の図は、管理者のログオン プロセスが標準ユーザーのログオン プロセスを異なる方法を示しています。

![管理者のログオン プロセスが標準ユーザーのログオン プロセスを異なる方法を示す図](../media/How-User-Account-Control-Works/UACWindowsLogonProcess.gif)

既定では、標準ユーザーと管理者はリソースにアクセスし、標準ユーザーのセキュリティ コンテキストでアプリケーションを実行します。 ユーザーがコンピューターにログオンすると、そのユーザーのアクセス トークンがシステムにより作成されます。 アクセス トークンには、固有のセキュリティ識別子 (SID) や Windows 特権などの、ユーザーが許可されるアクセスのレベルについての情報が含まれています。

管理者がログオンするときは、2 つの異なるアクセス トークンがユーザー用に作成されます。標準ユーザー アクセス トークンと、管理者アクセス トークンです。 標準ユーザー アクセス トークンには管理者アクセス トークンと同じユーザー固有の情報が含まれていますが、管理用の Windows 特権と SID は削除されます。 標準ユーザーのアクセス トークンは (標準ユーザー アプリケーション) の管理タスクを実行しないアプリケーションを起動するために使用します。 標準ユーザーのアクセス トークンは、デスクトップ (Explorer.exe) を表示するために使用します。 explorer.exe は、他のすべてのユーザー側から開始されるプロセスのアクセス トークンの継承元となる親プロセスです。 その結果、しない限り、ユーザーが同意するか、完全な管理者アクセス トークンを使用するアプリケーションを承認する資格情報をすべてのアプリケーションは標準ユーザーとして実行します。

Administrators グループのメンバーであるユーザーは、標準ユーザー アクセス トークンを使って、ログオン、Web の閲覧、電子メールの読み取りを行うことができます。 管理者が自動的に管理者アクセス トークン、Windows Server 2012 を必要とするタスクを実行する必要がある場合に、ユーザーに承認するように求められます。 これは昇格時のプロンプトと呼ばれ、ローカル セキュリティ ポリシー スナップイン (Secpol.msc) またはグループ ポリシーを使って動作を構成することができます。

> [!NOTE]
> ユーザーに同意を要求したり、完全な管理者アクセス トークンを使用する資格情報を Windows Server 2012 では、プロセスを参照する、用語「昇格」が使用されます。

### <a name="the-uac-user-experience"></a>UAC ユーザー エクスペリエンス
UAC を有効にしている場合、標準ユーザーのユーザー エクスペリエンスと管理者承認モードでの管理者のユーザー エクスペリエンスは異なります。 推奨されるより安全な Windows Server 2012 を実行する方法は、プライマリのユーザーが標準ユーザー アカウントのアカウントには。 標準ユーザーとして実行することは、管理環境のセキュリティを最大化するために役立ちます。 組み込みの UAC 昇格コンポーネントにより、標準ユーザーはローカル管理者アカウントの有効な資格情報を入力することで、簡単に管理タスクを実行できます。 既定では、標準ユーザーの組み込みの UAC 昇格コンポーネントは、資格情報プロンプトです。

標準ユーザーとして実行するための別の方法は、管理者承認モードで管理者として実行することです。 組み込みの UAC 昇格コンポーネントにより、ローカルの Administrators グループのメンバーは承認を提供することで管理タスクを簡単に実行できます。 既定では、管理者承認モードでの管理者アカウント用の組み込みの UAC 昇格コンポーネントは、同意のプロンプトと呼ばれます。 UAC の昇格のプロンプトを表示する動作は、ローカル セキュリティ ポリシー スナップイン (Secpol.msc) またはグループ ポリシーを使用して構成できます。

**同意と資格情報プロンプト**

Uac を有効にすると、Windows Server 2012 は、同意メッセージが表示または、プログラムまたは完全な管理者アクセス トークンを必要とするタスクを開始する前に有効なローカル管理者アカウントの資格情報を要求します。 このプロンプトにより、悪意のあるソフトウェアが警告なしにインストールされないようになります。

**同意プロンプト**

ユーザーがユーザーの管理アクセス トークンを必要とするタスクを実行しようとした場合、同意のプロンプトが表示されます。 UAC の同意プロンプトのスクリーン ショットを次に示します。

![UAC の同意プロンプトのスクリーン ショット](../media/How-User-Account-Control-Works/UACConsentPrompt.gif)

**資格情報プロンプト**

標準ユーザーがユーザーの管理者アクセス トークンを必要とするタスクを実行しようとすると、資格情報プロンプトが表示されます。 この標準ユーザーの既定のプロンプト動作は、ローカル セキュリティ ポリシー スナップイン (Secpol.msc) またはグループ ポリシーを使用して構成できます。 管理者は、ユーザー アカウント制御を設定して、資格情報を入力する必要もあることができます。資格情報のプロンプトに値を設定する管理者承認モード ポリシーでの管理者に対する昇格時のプロンプトの動作です。

次のスクリーン ショットでは、UAC の資格情報プロンプトの例を示します。

![UAC 資格情報のプロンプトの例を示すスクリーン ショット](../media/How-User-Account-Control-Works/UACCredentialPrompt.gif)

**UAC の昇格時のプロンプト**

UAC の昇格時のプロンプトは色分けされ、アプリケーションの潜在的なセキュリティ上のリスクを即座に有効にすると、アプリケーションによって異なります。 アプリケーションが管理者のフル アクセス トークンで実行しようとすると、Windows Server 2012 はまず、発行元を決定する実行可能ファイルを分析します。 アプリケーションは、実行可能ファイルの発行元に基づいて 3 つのカテゴリに分類されます最初。Windows Server 2012、発行元検証済み (署名付き)、および発行元未検証 (符号なし)。 次の図は、Windows Server 2012 で、ユーザーにどの色昇格時のプロンプトを決定する方法を示します。

昇格のプロンプトの色分けは、次のように行われます。

-   赤の背景の赤い盾アイコン:アプリケーションでは、グループ ポリシーによってブロックされますかがブロックされているパブリッシャーから。

-   青色の背景青と金色の盾アイコン:アプリケーションは、コントロール パネル項目などの Windows Server 2012 管理アプリケーションです。

-   青の盾アイコンが青色の背景:アプリケーションでは、Authenticode を使用して、署名され、ローカル コンピューターによって信頼されます。

-   黄色の背景に黄色のシールド アイコン:アプリケーションが署名されていない、または署名しますが、ローカル コンピューターによって信頼されていません。

**盾のアイコン**

**[日付と時刻のプロパティ]** などの一部のコントロール パネル項目には、管理者と標準ユーザーの操作の組み合わせが含まれています。 標準ユーザーは時計を表示しタイム ゾーンを変更することができますが、ローカル システム時刻を変更するには完全な管理者アクセス トークンが必要です。 **[日付と時刻のプロパティ]** コントロール パネル項目のスクリーン ショットを次に示します。

![スクリーン ショットが表示された、* * 日付と時刻のプロパティ * * コントロール パネル項目](../media/How-User-Account-Control-Works/UACShieldIcon.gif)

シールド アイコンを**日付と時刻を変更する** ボタンを示します、プロセスは、完全な管理者アクセス トークンが必要し、UAC の昇格時のプロンプトが表示されます。

**昇格時のプロンプトをセキュリティで保護します。**

昇格プロセスは、プロンプトをセキュリティで保護されたデスクトップに誘導することでより保護されます。 同意と資格情報プロンプトは、既定では Windows Server 2012 で保護されたデスクトップに表示されます。 Windows プロセスのみがセキュリティで保護されたデスクトップにアクセスできます。 高いレベルのセキュリティを管理することお勧め、**ユーザー アカウント制御。昇格のプロンプト時にセキュリティで保護されたデスクトップに切り替える**ポリシー設定を有効にします。

実行可能ファイルが昇格を要求するときは、ユーザー デスクトップとも呼ばれる対話機能を持つデスクトップがセキュリティで保護されたデスクトップに切り替わります。 セキュリティで保護されたデスクトップではユーザー デスクトップが暗くなり、続行する前に応答する必要がある昇格時のプロンプトが表示されます。 ユーザーが [はい] をクリックして、デスクトップがユーザーのデスクトップに切り替えるいいえ、または場合。

マルウェアが偽のセキュリティで保護されたデスクトップがユーザー アカウント制御を提示できます。ポリシー設定は、同意のプロンプトに設定が管理者承認モードでの管理者に対する昇格時のプロンプトの動作は、クリックすると、偽の場合、マルウェアは昇格を利用できないしません。 資格情報のプロンプトに、ポリシー設定を設定すると、資格情報プロンプトを偽装するマルウェアがユーザーから資格情報を収集できる場合があります。 ただし、マルウェアが管理者特権を持つことはなく、収集されたパスワードが使われた場合でも、システムにはマルウェアによるユーザー インターフェイスの制御を軽減する別の保護があります。

マルウェアが偽のセキュリティで保護されたデスクトップ、中に、ユーザーは、コンピューター上のマルウェアを以前インストールされていない場合にこの問題が発生することはできません。 UAC が有効になっている場合、管理者アクセス トークンを必要とするプロセスを警告なしにインストールすることはできないため、ユーザーは **[はい]** をクリックするか、管理者の資格情報を提供して明示的に同意する必要があります。 UAC の昇格時のプロンプトの特定の動作は、グループ ポリシーに依存します。

## <a name="uac-architecture"></a>UAC のアーキテクチャ
次の図は、UAC のアーキテクチャの詳細を示しています。

![UAC のアーキテクチャの詳細を示す図](../media/How-User-Account-Control-Works/UACArchitecture.gif)

各コンポーネントをより深く理解するには、次の表を確認してください。

|Component|説明|
|-------|--------|
|**User**||
|ユーザーが特権を必要とする操作を行う|操作によりファイル システムやレジストリが変更される場合は、仮想化が呼び出されます。 その他のすべての操作では ShellExecute が呼び出されます。|
|ShellExecute|ShellExecute は CreateProcess を呼び出します。 ShellExecute では、CreateProcess から ERROR_ELEVATION_REQUIRED エラーを検索します。 エラーを受け取った場合、ShellExecute はアプリケーション情報サービスを呼び出し、管理者特権のプロンプトで要求されたタスクの実行を試みます。|
|CreateProcess|アプリケーションは、昇格を必要とする場合、CreateProcess は ERROR_ELEVATION_REQUIRED の呼び出しを拒否します。|
|**システム**||
|アプリケーション情報サービス|スタート アプリケーションを 1 つ以上の高度な特権またはなど、ローカルの管理タスクを実行するユーザーの権限を必要としてより高い整合性レベルを必要とするアプリケーションに役立つシステム サービスです。 昇格が必要な場合、(グループ ポリシー) によって、管理者ユーザーの完全なアクセス トークンを使用して、アプリケーションの新しいプロセスを作成してこのようなアプリケーションの同意アプリケーション情報サービスにより開始は、そのために、ユーザーが付与されます。|
|ActiveX インストールの昇格|ActiveX がインストールされていない場合、システムは UAC スライダー レベルをチェックします。 ActiveX がインストールされている場合、**ユーザー アカウント制御。昇格のプロンプト時にセキュリティで保護されたデスクトップに切り替える**グループ ポリシー設定を確認します。|
|UAC スライダー レベルのチェック|UAC では、4 つのレベルの通知から選択して、スライダーを使用して、通知レベルを選択できるようになりました。<br /><br /><ul><li>高<br /><br />    スライダーが **[常に通知する]** に設定されている場合、システムはセキュリティで保護されたデスクトップが有効になっているかどうかをチェックします。</li><li>中<br /><br />    スライダーに設定されている場合**既定通知プログラムがコンピューターに変更を加えるとする場合にのみ me**、**ユーザー アカウント制御。署名され検証された実行可能ファイルの昇格のみ**ポリシー設定がチェックされます。<br /><br /><ul><li>ポリシー設定が有効になっている場合は、実行が許可される前に、指定された実行可能ファイルの公開キー基盤 (PKI) 証明書パスの検証が適用されます。</li><li>ポリシーの設定がない場合 (既定)、有効になっている、指定された実行可能ファイルの実行が許可される前に PKI 証明書パスの検証が適用されません。 **ユーザー アカウント制御。昇格のプロンプト時にセキュリティで保護されたデスクトップに切り替える**グループ ポリシー設定を確認します。</li></ul></li><li>低<br /><br />    スライダーに設定されている場合**加えようプログラムがコンピューターに変更を加えるしようとする場合 (デスクトップを暗転しない)**、CreateProcess が呼び出されます。</li><li>通知しない<br /><br />    スライダーに設定されている場合**通知しない と**、UAC プロンプトは、通知しない場合、プログラムをインストールしようとしています。 または、コンピューター上の変更は実行しようとしています。 概要   この設定はお勧めできません。 この設定は、設定と同じ、**ユーザー アカウント制御。管理者承認モードでの管理者に対する昇格時のプロンプトの動作**ポリシーの設定を**メッセージを表示せずに昇格**します。</li></ul>|
|セキュリティで保護されたデスクトップが有効|**ユーザー アカウント制御。昇格のプロンプト時にセキュリティで保護されたデスクトップに切り替える**ポリシー設定がチェックされます。<br /><br />-セキュリティで保護されたデスクトップが有効になっている場合、すべての昇格の要求は、管理者と標準ユーザー プロンプト動作ポリシー設定に関係なく、セキュリティで保護されたデスクトップに移動します。<br />-セキュリティで保護されたデスクトップが有効でない場合は、すべての昇格要求が対話型のユーザーのデスクトップに移動され、管理者と標準ユーザーのユーザーごとの設定が使用されます。|
|CreateProcess|CreateProcess を呼び出す AppCompat、Fusion の場合、インストーラーの検出機能をアプリケーションには、昇格が必要な場合に評価します。 実行可能ファイルを実行可能ファイルのアプリケーション マニフェストに格納されている、要求実行レベルを決定し、検証されます。 CreateProcess は、マニフェストで指定された要求実行レベルがアクセス トークンと一致しない場合は失敗し、shellexecute (ERROR_ELEVATION_REQUIRED) エラーが返されます。 |
|AppCompat|AppCompat データベースには、アプリケーションのアプリケーション互換性修正エントリの情報が保存されます。|
|Fusion|Fusion データベースには、アプリケーションを記述するアプリケーション マニフェストからの情報が保存されます。 マニフェスト スキーマが更新されて、新しい要求実行レベル フィールドが追加されます。|
|インストーラーの検出|インストーラーの検出では、セットアップの実行可能ファイル、ユーザーの知識と同意せず実行されてからのインストールの防止を検出します。|
|**カーネル**||
|仮想化|仮想化テクノロジにより非対応のアプリケーションは失敗しないようにサイレント モードで実行または原因を特定できない方法で失敗するようになります。 UAC もファイルとレジストリの仮想化と、保護された領域への書き込みを行うアプリケーションのログ記録を提供します。|
|ファイル システムとレジストリ|ユーザーごとのファイルとレジストリの仮想化は、コンピューターごとのレジストリとファイルの書き込み要求を、ユーザーごとの同等の場所にリダイレクトします。 読み取り要求はまず仮想化されたユーザーごとの場所にリダイレクトされ、次にコンピューターごとの場所にリダイレクトされます。|

Windows の以前のバージョンから Windows Server 2012 の UAC の変更があります。 新しいスライダー決して UAC 完全にできなくなります。 新しい設定を行います。

-   UAC サービスが実行され続けます。

-   管理者によって開始されたすべての昇格要求が、UAC プロンプトを表示せずに自動的に承認されるようにします。

-   標準ユーザーのすべての昇格要求を自動的に拒否します。

> [!IMPORTANT]
> 完全に UAC を無効にするには、ポリシーを無効にする必要があります**ユーザー アカウント制御。すべての管理者を管理者承認モードで実行**します。

> [!WARNING]
> カスタマイズされたアプリケーションは、UAC を無効にする Windows Server 2012 では機能しません。

### <a name="virtualization"></a>仮想化
エンタープライズ環境のシステム管理者はシステムをセキュリティで保護しようとするとため、多くの基幹業務 (LOB) アプリケーションは標準ユーザー アクセス トークンのみを使うように設計されています。 その結果、IT 管理者は、uac を有効になっている Windows Server 2012 を実行するときに、アプリケーションの大部分を置き換える必要はありません。

 Windows Server 2012 には、UAC 準拠ではないと正常に実行する管理者のアクセス トークンを必要とするアプリケーションのファイルおよびレジストリの仮想化テクノロジが含まれています。 仮想化によって、UAC 準拠ではないアプリケーションが Windows Server 2012 と互換性があります。 管理アプリケーションを UAC 準拠ではありませんが、プログラム ファイルなどの保護されたディレクトリに書き込もうと UAC は、変更しようとして、リソースの仮想化されたビューをアプリケーションに提供します。 この仮想化コピーは、ユーザーのプロファイル内に保持されます。 この方法は、非対応のアプリケーションを実行するユーザーごとの仮想化されたファイルの個別のコピーを作成します。

仮想化機能を使用して、ほとんどのアプリケーションが正常に動作します。 仮想化ではほとんどのアプリケーションを実行できますが、これは短期的な修正であり、長期的なソリューションではありません。 アプリケーション開発者は、ファイル、フォルダー、およびレジストリの仮想化に証明書利用者のではなく、できるだけ早く、Windows Server 2012 ロゴ プログラムに準拠するようにアプリケーションを変更する必要があります。

仮想化は、オプションでは、次のシナリオではありません。

1.  仮想化は、昇格され、完全な管理者アクセス トークンで実行されるアプリケーションには適用されません。

2.  仮想化では、唯一の 32 ビット アプリケーションをサポートします。 非管理者特権での 64 ビット アプリケーションには、単に、アクセス拒否メッセージを Windows オブジェクトへのハンドル (一意の識別子) の取得を試みるときに表示されます。 ネイティブの Windows の 64 ビット アプリケーションは、UAC と互換性があると、適切な場所にデータを書き込む必要があります。

3.  アプリケーションに要求実行レベル属性を持つアプリケーション マニフェストが含まれている場合、アプリケーションの仮想化が無効にします。

### <a name="request-execution-levels"></a>要求実行レベル
アプリケーション マニフェストは、XML ファイルについて説明し、アプリケーションは実行時にバインドする必要があります共有とプライベートのサイド バイ サイド アセンブリを指定します。 Windows Server 2012 では、アプリケーション マニフェストに UAC アプリケーション互換性のためのエントリが含まれています。 アプリケーション マニフェストにエントリが含まれる管理アプリケーションを求めるユーザーのアクセス トークンをアクセスするアクセス許可。 アプリケーション マニフェスト内のエントリを持っていないものがほとんどの管理アプリケーションは、アプリケーション互換性修正プログラムを使用して、変更しなくても実行できます。 アプリケーション互換性修正プログラムは、Windows Server 2012 で正しく動作する UAC 準拠でないアプリケーションを実現するデータベースのエントリを示します。

UAC 準拠のすべてのアプリケーションには、アプリケーション マニフェストに追加する要求実行レベルを必要があります。 アプリケーションには、システム管理者のアクセスに必要なかどうかは、「管理者必要があります」の要求実行レベルでアプリケーションをマークすることにより、システムが管理アプリケーションとしてこのプログラムを識別し、実行、昇格のために必要な手順を実行します。 要求の実行のレベルは、アプリケーションに必要な権限を指定します。

### <a name="installer-detection-technology"></a>インストーラ検出テクノロジ
インストール プログラムは、アプリケーション ソフトウェアを展開するように設計します。 ほとんどのインストール プログラムは、システム ディレクトリとレジストリ キーに書き込みます。 これらの保護されたシステムの場所は、通常、インストーラー検出テクノロジで管理者だけが書き込むことができます。これは、標準ユーザーにはプログラムをインストールするための十分なアクセス権がないことを意味します。 Windows Server 2012 では、アクセス特権で実行するには、インストール プログラムと管理者の資格情報を要求または管理者ユーザーの承認がヒューリスティックによっては検出します。 Windows Server 2012 は、ヒューリスティックによっても、更新プログラムとアプリケーションのアンインストール プログラムを検出します。 UAC の設計上の目標の 1 つは、インストール プログラムがファイル システムとレジストリの保護されている領域に書き込むことで、ユーザーの知らない間に、またはユーザーの同意なくインストールが実行されないようにすることです。

インストーラー検出は次の対象にのみ適用されます。

-   32 ビット実行可能ファイル。

-   要求実行レベル属性を持たないアプリケーション。

-   UAC が有効になった標準ユーザーとして実行されている対話型プロセス。

32 ビット プロセスが作成される前に、インストーラーであるかどうかを判断するため、次の属性が確認されます。

-   ファイル名に "install"、"setup"、"update" などのキーワードが含まれているかどうか。

-   バージョン管理リソース フィールドには、次のキーワードが含まれています。仕入先、会社名、製品名、ファイルの説明、元のファイル名、Internal Name、およびエクスポートの名前。

-   サイド バイ サイド マニフェスト内のキーワードが実行可能ファイルに埋め込まれているかどうか。

-   特定の StringTable エントリのキーワードが実行可能ファイルでリンクされているかどうか。

-   リソース スクリプト データのキー属性が実行可能ファイルでリンクされているかどうか。

-   実行可能ファイル内に対象となるバイトのシーケンスがあるかどうか。

> [!NOTE]
> キーワードとバイトのシーケンスは、さまざまなインストーラー テクノロジから確認された共通の特徴から取得されました。

> [!NOTE]
> ユーザー アカウント制御:アプリケーションのインストールを検出し、インストール プログラムを検出するインストーラーの検出の昇格ポリシー設定を有効にする必要がありますの入力を求めます。 この設定は既定で有効になっていると、ローカル セキュリティ ポリシー スナップイン (Secpol.msc) を使用してローカルで構成されているまたはグループ ポリシー (Gpedit.msc) で、ドメイン、OU、または特定のグループ用に構成することができます。


