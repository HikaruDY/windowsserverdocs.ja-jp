---
title: 認証の問題のトラブルシューティング
description: このトピックでは、ガイド Windows Server 2016 での OTP 認証を使用したリモート アクセスの展開の一部です。
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology:
- networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 71307757-f8f4-4f82-b8b3-ffd4fd8c5d6d
ms.author: pashort
author: shortpatti
ms.openlocfilehash: ff1dd94db3e433235a87fd6809459283fc439d0d
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59855743"
---
# <a name="troubleshooting-authentication-issues"></a>認証の問題のトラブルシューティング

>適用先:Windows Server 2016 の Windows Server (半期チャネル)

このトピックでには、問題に関連する問題のトラブルシューティングの情報ユーザーが OTP 認証を使用して DirectAccess に接続するときに必要がありますにはが含まれています。 DirectAccerss OTP 関連のイベント ビューアーでクライアント コンピューターのイベントがログに記録**アプリケーションとサービス ログ/Microsoft/Windows/OtpCredentialProvider**します。 DirectAccess OTP に関する問題のトラブルシューティングを行うときにこのログが有効になっていることを確認します。  
  
## <a name="failed-to-access-the-ca-that-issues-otp-certificates"></a>OTP 証明書を発行した CA にアクセスできませんでした。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 OTP 証明書の登録ユーザー <username> CA サーバー < CA_name > で失敗した、失敗した、考えられる原因を要求します。CA サーバー名を解決することはできません、CA サーバーは、最初の DirectAccess トンネル経由でアクセスできない、または CA サーバーへの接続を確立することはできません。  
  
**原因**  
  
ユーザーが有効な 1 回限りのパスワードを指定し、DirectAccess サーバー署名証明書の要求ただし、クライアント コンピューターは、登録プロセスを完了する OTP 証明書を発行した CA に接続できません。  
  
**ソリューション**  
  
DirectAccess サーバーで、次の Windows PowerShell コマンドを実行します。  
  
1.  構成されている OTP を発行する Ca の一覧を取得し、'CAServer' の値をチェックします。 `Get-DAOtpAuthentication`  
  
2.  管理サーバーとして、Ca が構成されていることを確認します。 `Get-DAMgmtServer -Type All`  
  
3.  クライアント コンピューターで、インフラストラクチャ トンネルが確立されていることを確認します。コンソールのセキュリティが強化された Windows ファイアウォール の順に展開**監視/セキュリティ アソシエーション**、 をクリックして**メイン モード**、IPsec セキュリティ アソシエーションが適切なリモートで表示されることを確認してDirectAccess の構成のアドレス。  
  
## <a name="directaccess-server-connectivity-issues"></a>DirectAccess サーバーの接続の問題  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)  
  
次のエラーのいずれか:  
  
-   基本パス < OTP_authentication_path > と < OTP_authentication_port > のポートを使用してリモート アクセス サーバー < DirectAccess_server_hostname > に接続を確立することはできません。 エラー コード: < internal_error_code >。  
  
-   基本パス < OTP_authentication_path > と < OTP_authentication_port > のポートを使用してリモート アクセス サーバー < DirectAccess_server_hostname > には、ユーザーの資格情報を送信できません。 エラー コード: < internal_error_code >。  
  
-   基本パス < OTP_authentication_path > と < OTP_authentication_port > のポートを使用してリモート アクセス サーバー < DirectAccess_server_hostname > からは、応答は受信ができません。 エラー コード: < internal_error_code >。  
  
**原因**  
  
クライアント コンピューターは、いずれかのネットワークの問題により、または DirectAccess サーバーで正しく構成されていない IIS サーバーには、インターネット経由で DirectAccess サーバーにアクセスできません。  
  
**ソリューション**  
  
クライアント コンピューターのインターネット接続が動作しているかどうかを確認し、DirectAccess サービスで、インターネット経由で実行され、アクセスをかどうかを確認します。  
  
## <a name="failed-to-enroll-for-the-directaccess-otp-logon-certificate"></a>DirectAccess OTP ログオン証明書の登録に失敗しました  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 < CA_name > の CA から証明書の登録に失敗しました。 OTP の署名証明書に、期待どおりに、要求が署名されていない、またはユーザーには、登録する権限はありません。  
  
**原因**  
  
ユーザーによって提供される 1 回限りのパスワードは正しいが、発行元証明機関 (CA) が OTP ログオン証明書の発行を拒否しました。 証明書の要求署名されていない適切で正しい EKU (OTP 登録機関アプリケーション ポリシー)、またはユーザーでは、DA OTP テンプレートには、"Enroll"アクセス許可はありません。  
  
**ソリューション**  
  
DirectAccess の OTP ユーザーがログオンの DirectAccess の OTP 証明書を登録するアクセス許可を持つことと、適切な「アプリケーション ポリシー」が、DA OTP 登録機関の署名テンプレートに含まれていることを確認してください。 また、リモート アクセス サーバーで DirectAccess の登録機関の証明書が有効であることを確認してください。 3.2 OTP 証明書テンプレートの計画し、3.3 登録機関の証明書の計画を参照してください。  
  
## <a name="missing-or-invalid-computer-account-certificate"></a>コンピューター アカウント証明書が見つからないか無効です。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。  ローカル コンピューターの証明書ストアに OTP に必要なコンピューター証明書が見つからないために、OTP 認証を完了できません。  
  
**原因**  
  
DirectAccess OTP 認証には、DirectAccess サーバーとの SSL 接続を確立するためにクライアント コンピューターの証明書が必要です。ただし、クライアント コンピューターの証明書が見つからなかったか、有効でない、たとえば、証明書の有効期限が切れた場合。  
  
**ソリューション**  
  
コンピューター証明書が存在し、有効では確認します。  
  
1.  MMC 証明書コンソールのローカル コンピューター アカウント用に、クライアント コンピューターで開きます**Personal/Certificates**します。  
  
2.  コンピューター名に一致するを発行する証明書がかどうかを確認し、証明書をダブルクリックします。  
  
3.  **証明書** ダイアログ ボックスで、**証明書のパス** タブの **証明書のステータス**、「この証明書は問題ありません」書かれていることを確認。  
  
有効な証明書が見つからない場合は、いずれかを実行して、(存在する) 場合、無効な証明書とコンピューター証明書の再登録を削除`gpupdate /Force`から管理者特権のコマンド プロンプトまたはクライアント コンピューターを再起動します。  
  
## <a name="missing-ca-that-issues-otp-certificates"></a>OTP 証明書を発行した CA がありません。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 DA サーバーでは、発行元 CA のアドレスが返されませんでしたので、OTP 認証を完了できません。  
  
**原因**  
  
OTP 証明書を構成するを発行する Ca がないか、OTP 証明書を発行している構成済みの Ca のすべての応答速度が。  
  
**ソリューション**  
  
1.  次のコマンドを使用して、(CAServer で CA の名前が表示されます) OTP 証明書を発行している Ca の一覧を取得する:`Get-DAOtpAuthentication`します。  
  
2.  Ca が構成されていない: 場合  
  
    1.  いずれかのコマンドを使用して`Set-DAOtpAuthentication`またはリモート アクセス管理コンソールにログオン証明書を発行するには、DirectAccess の OTP Ca を構成します。  
  
    2.  新しい構成を適用して、強制的に実行して、DirectAccess の GPO の設定を更新するようにクライアント`gpupdate /Force`から管理者特権のコマンド プロンプトまたはクライアント マシンを再起動します。  
  
3.  Ca が構成されている場合は、オンラインで、登録要求に応答していることを確認します。  
  
## <a name="misconfigured-directaccess-server-address"></a>DirectAccess サーバーのアドレスが正しく構成されていません。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 OTP 認証を正常に完了できません。 名前またはリモート アクセス サーバーのアドレスを特定できません。  エラー コード: < error_code >。 DirectAccess の設定は、サーバーの管理者によって検証する必要があります。  
  
**原因**  
  
DirectAccess サーバーのアドレスが正しく構成されていません。  
  
**ソリューション**  
  
構成された DirectAccess サーバー アドレスを使用して、チェック`Get-DirectAccess`の構成が正しい場合は、アドレスを修正します。  
  
実行して最新の設定がクライアント コンピューターに展開されていることを確認`gpupdate /force`から、管理者特権でコマンド プロンプトまたはクライアント コンピューターを再起動します。  
  
## <a name="failed-to-generate-the-otp-logon-certificate-request"></a>OTP のログオン証明書の要求を生成できませんでした。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 OTP 認証用証明書の要求を初期化することはできません。 いずれか、プライベート キーを生成することはできません、またはユーザー<username>ドメイン コント ローラーで証明書テンプレート < OTP_template_name > にアクセスできません。  
  
**原因**  
  
このエラーの考えられる原因が 2 つあります。  
  
-   ユーザーが OTP ログオンのテンプレートを読み取るアクセス許可を持っていません。  
  
-   ユーザーのコンピューターは、ネットワークの問題により、ドメイン コント ローラーにアクセスできません。  
  
**ソリューション**  
  
-   OTP のログオンのテンプレートを設定するアクセス許可を確認し、DirectAccess の OTP 用にプロビジョニングされたすべてのユーザー '読み取り' アクセス許可がかどうかを確認します。  
  
-   ドメイン コント ローラーが管理サーバーとして構成されていることと、クライアント コンピューターがインフラストラクチャ トンネル経由でドメイン コント ローラーに到達できることを確認してください。 3.2 プラン OTP 証明書テンプレートを参照してください。  
  
## <a name="no-connection-to-the-domain-controller"></a>ドメイン コント ローラーへの接続なし  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 OTP 認証するために、ドメイン コント ローラーとの接続を確立できません。 エラー コード: < error_code >。  
  
**原因**  
  
このエラーの考えられる原因が 2 つあります。  
  
-   ユーザーのコンピューターには、ネットワーク接続がありません。  
  
-   ドメイン コント ローラーにインフラストラクチャ トンネル経由でアクセスできません。  
  
**ソリューション**  
  
-   PowerShell プロンプトから次のコマンドを実行して、ドメイン コント ローラーが管理サーバーとして構成されていることを確認します。`Get-DAMgmtServer -Type All`します。  
  
-   クライアント コンピューターがインフラストラクチャ トンネル経由でドメイン コント ローラーに到達できることを確認します。  
  
## <a name="otp-provider-requires-challengeresponse"></a>OTP のプロバイダーは、チャレンジ/レスポンスが必要です。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 ユーザーのリモート アクセス サーバー (< DirectAccess_server_name >) と OTP 認証 (<username>)、ユーザーからのチャレンジが必要です。  
  
**原因**  
  
使用する OTP プロバイダーでは、RADIUS チャレンジ/レスポンス exchange、Windows Server 2012 の DirectAccess の OTP でサポートされていないの形式で追加の資格情報を提供するユーザーが必要です。  
  
**ソリューション**  
  
どのようなシナリオでは、チャレンジ/レスポンスを必要としない OTP プロバイダーを構成します。  
  
## <a name="incorrect-otp-logon-template-used"></a>OTP ログオン テンプレートが正しくないために使用  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 ユーザーからの CA テンプレート<username>OTP 証明書を発行する証明書が構成されていない要求です。  
  
**原因**  
  
DirectAccess OTP ログオンのテンプレートが置換された、クライアント コンピューターが、古いテンプレートを使用して認証しようとしています。  
  
**ソリューション**  
  
クライアント コンピューターが、次のいずれかの操作を実行することによって、最新の OTP の構成を使用することを確認します。  
  
-   管理者特権でコマンド プロンプトから次のコマンドを実行してグループ ポリシーの更新を強制:`gpupdate /Force`します。  
  
-   クライアント コンピューターを再起動します。  
  
## <a name="missing-otp-signing-certificate"></a>OTP 証明書の署名がありません。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)。 OTP 署名の証明書が見つかりません。 OTP 証明書の登録要求を署名することはできません。  
  
**原因**  
  
リモート アクセス サーバーで DirectAccess の OTP の署名証明書が見つかりませんそのため、リモート アクセス サーバーによってユーザーの証明書の要求に署名できません。 署名証明書がないか、署名証明書の有効期限が切れたし、が更新されません。  
  
**ソリューション**  
  
リモート アクセス サーバーでこれらの手順を実行します。  
  
1.  PowerShell コマンドレットを実行して構成されている OTP 署名証明書テンプレート名を確認して`Get-DAOtpAuthentication`値の検査と`SigningCertificateTemplateName`します。  
  
2.  証明書 MMC スナップインを使用して、このテンプレートから登録されている有効な証明書がコンピューターに存在するかどうかを確認します。  
  
3.  このような証明書が存在しない場合は、(存在する場合は、有効期限が切れた証明書を削除し、このテンプレートに基づいて新しい証明書を登録します。  
  
OTP の署名を作成するには、証明書テンプレートは、登録機関の証明書 3.3 プランを表示します。  
  
## <a name="missing-or-incorrect-upndn-for-the-user"></a>見つからないか正しくない UPN/DN のユーザー  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント イベント ログ)  
  
次のエラーのいずれか:  
  
-   ユーザー <username> OTP で認証することはできません。 UPN が Active Directory でユーザー名に対して定義されていることを確認します。 エラー コード: < error_code >。  
  
-   ユーザー <username> OTP で認証することはできません。 Active Directory でユーザー名の DN が定義されていることを確認します。 エラー コード: < error_code >。  
  
**表示されるエラー** (サーバーのイベント ログ)  
  
ユーザー名<username>指定された OTP 認証は存在しません。  
  
**原因**  
  
ユーザーには、ユーザー プリンシパル名 (UPN) はありません。 またはユーザー アカウントの識別名 (DN) 属性が適切に設定をこれらのプロパティは DirectAccess の OTP を適切に機能するために必要です。  
  
**ソリューション**  
  
ドメイン コント ローラーで、Active Directory ユーザーとコンピューター コンソールを使用して、これらの属性の両方が正しく設定されて、認証するユーザーのことを確認します。  
  
## <a name="otp-certificate-is-not-trusted-for-login"></a>OTP 証明書はログインに対して信頼されていません。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**原因**  
  
OTP 証明書を発行した CA をエンタープライズ NTAuth ストアにはそのため、登録済みの証明書は、ログオンに使用できません。 これは、クロス ドメインの CA の信頼が確立されていない複数のドメインとマルチ フォレスト環境で発生します。  
  
**ソリューション**  
  
OTP 証明書を発行する CA 階層のルートの証明書が NTAuth 証明書ストアに、ユーザーが認証しようとするドメインのエンタープライズにインストールされていることを確認します。  
  
## <a name="windows-could-not-verify-user-credentials"></a>Windows は、ユーザー資格情報を確認できませんでした。  
**シナリオ**します。 ユーザーは、エラーで OTP を使用して認証に失敗します。「内部エラーのための認証に失敗しました」  
  
**表示されるエラー** (クライアント コンピューター)。 何かは、Windows が資格情報の検証中に問題が発生します。 再試行するかについては、管理者に問い合わせてください。  
  
**原因**  
  
Kerberos 認証プロトコルでは、DirectAccess の OTP ログオン証明書に CRL が含まれていない場合は機能しません。 に、DirectAccess の OTP ログオン証明書が CRL を含まれませんか。  
  
-   オプションを使用して構成された DirectAccess OTP のログオン テンプレート**発行された証明書の失効情報を含めないでください**します。  
  
-   CA は、Crl を発行しないように構成されます。  
  
**ソリューション**  
  
1.  リモート アクセス管理コンソールで、このエラーの原因を確認する**手順 2 リモート アクセス サーバー**、 をクリックして**編集**、し、**リモート アクセス サーバーのセットアップ**ウィザードで、をクリックして**OTP 証明書テンプレート**します。 OTP 認証用に発行される証明書の登録に使用される証明書テンプレートをメモしておきます。 開いている証明機関 コンソールの左側のウィンドウでクリックして**証明書テンプレート**、証明書テンプレートのプロパティを表示する OTP のログオン証明書をダブルクリックします。  
  
    この問題を解決するために、OTP ログオン証明書の証明書を構成し、選択しないでください、**発行された証明書の失効情報を含めないでください**チェック ボックスをオン、 **Server**テンプレートのタブプロパティ ダイアログ ボックス。  
  
2.  CA サーバーで、証明機関 MMC を開き、発行元 CA を右クリックして をクリックして**プロパティ**します。 **拡張**タブ CRL の発行が正しく構成されていることを確認します。  
  


