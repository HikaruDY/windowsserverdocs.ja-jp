---
title: RDS での高可用性を構成する RD 接続ブローカー サーバーを追加します。
description: 高可用性 RDS デプロイに、RD 接続ブローカーを追加する方法について説明します。
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 04/10/2017
ms.tgt_pltfrm: na
ms.topic: article
author: lizap
manager: dongill
ms.openlocfilehash: b1e5726e3976527278b11f105007a32548da0bc4
ms.sourcegitcommit: d888e35f71801c1935620f38699dda11db7f7aad
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/07/2019
ms.locfileid: "66805154"
---
# <a name="add-the-rd-connection-broker-server-to-the-deployment-and-configure-high-availability"></a>RD 接続ブローカー サーバーを展開に追加し、高可用性を構成する

>適用対象:Windows Server (半期チャネル)、Windows Server 2019、Windows Server 2016

可用性と、リモート デスクトップ サービス インフラストラクチャのスケールを向上させるためにリモート デスクトップ接続ブローカー (RD 接続ブローカー) クラスターを展開することができます。 

## <a name="pre-requisites"></a>前提条件

2 つ目の RD 接続ブローカーとして機能するサーバーのセットアップ-物理サーバーまたは VM のいずれかに指定できます。

接続ブローカーのデータベースを設定します。 使用することができます[Azure SQL Database](https://azure.microsoft.com/documentation/articles/sql-database-get-started/#create-a-new-aure-sql-database)インスタンスまたはローカルの環境での SQL Server。 以下、Azure SQL を使用する方法について説明しますが、手順は、SQL Server にも適用されます。 データベースの接続文字列を検索し、適切な ODBC ドライバーがあるかどうかを確認する必要があります。

## <a name="step-1-configure-the-database-for-the-connection-broker"></a>手順 1:データベース接続ブローカーを構成します。

1. 作成したデータベースの接続文字列を見つける - 両方に、後で、自体 (ステップ 3)、接続ブローカーを構成しているときにこれを保存文字列で参照できます簡単に別の場所の ODBC ドライバーのバージョンを識別する必要があります。 Azure SQL の接続文字列を検索する方法を次に示します。  
    1. Azure portal のをクリックして**参照 > リソース グループ**デプロイ用のリソース グループをクリックします。   
    2. (たとえば、CB DB1) 作成した SQL データベースを選択します。   
    3. クリックして**設定** > **プロパティ** > **データベース接続文字列の表示**します。   
    4. 接続文字列をコピー **ODBC (Node.js を含む)** 、するようになります。   
      
        ```
        Driver={SQL Server Native Client 13.0};Server=tcp:cb-sqls1.database.windows.net,1433;Database=CB-DB1;Uid=sqladmin@contoso;Pwd={your_password_here};Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30;
        ```
  
    5. "Your_password_here"を実際のパスワードに置き換えます。 データベースに接続するときに、含まれるパスワードがこの文字列全体を使用します。 
2. 新しい接続ブローカーの ODBC ドライバーをインストールします。 
   1. 接続ブローカーの VM を使用する場合は、最初の RD 接続ブローカーのパブリック IP アドレスを作成します。 (だけがある場合は、RDM の仮想マシンに RDP 接続を許可するパブリック IP アドレスを既にがあるない場合。)
       1. Azure portal のをクリックして**参照** > **リソース グループ**や、展開、リソース グループをクリックします (たとえば、RD 接続ブローカーの最初の仮想マシンをクリックしますContoso-Cb1)。
       2. クリックして**設定 > ネットワーク インターフェイス**、対応するネットワーク インターフェイスを順にクリックします。
       3. クリックして**設定 > IP アドレス**します。
       4. **パブリック IP アドレス**を選択します**有効**、 をクリックし、 **IP アドレス**します。
       5. 使用する既存のパブリック IP アドレスがある場合は、一覧から選択します。 それ以外の場合、をクリックして**新規作成**、名前を入力し、をクリックし、 **OK**し**保存**します。
   2. 最初の RD 接続ブローカーに接続します。
       1. Azure portal のをクリックして**参照** > **リソース グループ**や、展開、リソース グループをクリックします (たとえば、RD 接続ブローカーの最初の仮想マシンをクリックしますContoso-Cb1)。
       2. をクリックして**Connect > を開く**をリモート デスクトップ クライアントを開きます。
       3. クライアントで、次のようにクリックします。 **Connect**、 をクリックし、**別のユーザー アカウントを使用して、** します。 ドメイン管理者アカウントのユーザー名とパスワードを入力します。
       4. をクリックして**はい**とき、証明書に関する警告が表示されます。
   3. ダウンロード、 [SQL Server 用 ODBC driver](https://www.microsoft.com/download/confirmation.aspx?id=50420) ODBC 接続文字列内のバージョンと一致します。 上記の例の文字列バージョン 13 の ODBC ドライバーをインストールする必要があります。
   4. 最初の RD 接続ブローカー サーバーに sqlincli.msi ファイルをコピーします。   
   5. Sqlincli.msi ファイルを開き、ネイティブ クライアントをインストールします。  
   6. 各追加の RD 接続ブローカー (たとえば、Contoso-Cb2) の手順 1. ~ 5. を繰り返します。
   7. 接続ブローカーを実行する各サーバー上の ODBC ドライバーをインストールします。

## <a name="step-2-configure-load-balancing-on-the-rd-connection-brokers"></a>手順 2:RD 接続ブローカーの負荷分散を構成します。 

Azure インフラストラクチャを使用している場合を作成、 [Azure ロード バランサー](#create-a-load-balancer)かどうか、設定できるは最大[DNS ラウンド ロビン](#configure-dns-round-robin)します。

### <a name="create-a-load-balancer"></a>ロード バランサーを作成します。  
1. Azure ロード バランサーを作成します。   
      1. Azure ポータルで**参照 > ロード バランサー > 追加**します。   
      2. 新しいロード バランサー (たとえば、hacb) の名前を入力します。   
      3. 選択**内部**の**スキーム**、**仮想ネットワーク**展開に (たとえば、Contoso-VNet)、および**サブネット**すべてリソース (たとえば、既定値)。   
      4. 選択**静的**の**IP アドレスの割り当て**を入力し、**プライベート IP アドレス**は現在使用中でない (たとえば、10.0.0.32)。   
      5. 適切な選択**サブスクリプション**、**リソース グループ**すべてのリソースと、適切な**場所**します。   
      6. **[作成]** を選択します。   
2. 作成、[プローブ](https://azure.microsoft.com/documentation/articles/load-balancer-custom-probe-overview/)モニターがどのサーバーがアクティブにします。   
      1. Azure portal で次のようにクリックします。**参照 > のロード バランサー**、先ほど作成したロード バランサー (CBLB など) を順にクリックします。 **[設定]** をクリックします。   
      2. クリックして**プローブ > 追加**します。   
      3. プローブの名前を入力します (たとえば、 **RDP**) を選択します**TCP**として、**プロトコル**、入力**3389**の**ポート**、 をクリックし、 **OK**します。   
3. 接続ブローカーのバックエンド プールを作成します。   
      1. **設定**、 をクリックして**バックエンド アドレス プール > 追加**します。   
      2. 名前 (たとえば、CBBackendPool) を入力し、をクリックして**仮想マシンの追加**します。  
      3. 可用性セット (たとえば、CbAvSet) を選択し、クリックして**OK**します。   
      3. をクリックして**仮想マシンを選択**、各仮想マシンを選択し、クリックして**選択 > ok > ok**します。   
4. RDP の負荷分散規則を作成します。   
      1. **設定**、 をクリックして**負荷分散規則**、 をクリックし、**追加**します。   
      2. 名前を入力します (たとえば、RDP) を選択します**TCP**の**プロトコル**、入力**3389**両方の**ポート**と**バックエンド ポート**、 をクリック**OK**します。   
5. ロード バランサーの DNS レコードを追加します。   
      1. RDM server 仮想マシン (たとえば、Contoso-CB1) に接続します。 チェック アウト、 [、RD 接続ブローカー VM を準備](Prepare-the-RD-Connection-Broker-VM-for-Remote-Desktop.md)VM に接続する方法の手順についての記事。   
      2. サーバー マネージャーで、**ツール > DNS**します。   
      3. 左側のウィンドウで  **DNS**DNS マシンをクリックします。 をクリックし、**前方参照ゾーン**、ドメイン名 (Contoso.com など) を順にクリックします。 (については、DNS サーバーにクエリを処理するまでに数秒をかかる場合があります。)  
      4. クリックして**アクション > 新しいホスト (A または AAAA)** します。   
      9. 名前 (たとえば、hacb) と (たとえば、10.0.0.32) 前に指定した IP アドレスを入力します。   

### <a name="configure-dns-round-robin"></a>DNS ラウンド ロビンを構成します。  
  
次の手順は、Azure 内部ロード バランサーを作成する代わりにします。   
  
1. Azure portal で、RDM サーバーに接続します。 リモート デスクトップ接続クライアントを使用します。   
2. DNS レコードを作成します。   
      1. サーバー マネージャーで、**ツール > DNS**します。   
      2. 左側のウィンドウで  **DNS**DNS マシンをクリックします。 をクリックし、**前方参照ゾーン**、ドメイン名 (Contoso.com など) を順にクリックします。 (については、DNS サーバーにクエリを処理するまでに数秒をかかる場合があります。)  
      3. クリックして**アクション**と**新しいホスト (A または AAAA)** します。   
      4. 入力、 **DNS 名**RD 接続ブローカー (たとえば、hacb) クラスターし、入力し、 **IP アドレス**最初の RD 接続ブローカーの。   
      5. 各一意の IP アドレスを提供する追加の各レコードの追加各 RD 接続ブローカーのステップ 3 と 4 を繰り返します。


たとえば、RD 接続ブローカーの 2 つの仮想マシンの IP アドレス 10.0.0.8、10.0.0.9、2 つの DNS ホスト レコードを作成するは。
 - ホスト名: hacb.contoso.com、IP アドレス。10.0.0.8
 - ホスト名: hacb.contoso.com、IP アドレス。10.0.0.9

## <a name="step-3-configure-the-connection-brokers-for-high-availability"></a>手順 3:高可用性のため、接続ブローカーを構成します。

1. サーバー マネージャーへの新しい RD 接続ブローカー サーバーを追加します。
   1. サーバー マネージャーで、**管理 > サーバーの追加**します。
   2. **[Find Now]** をクリックします。
   3. 新しく作成された RD 接続ブローカー サーバー (たとえば、Contoso-Cb2) をクリックし、をクリックして**OK**します。
2. RD 接続ブローカーの高可用性を構成します。
   1. サーバー マネージャーで、 **Remote Desktop Services > 概要**します。
   2. 右クリック**RD 接続ブローカー**、 をクリックし、**高可用性の構成**します。
   3. 構成の種類のセクションに表示されるまでウィザードを表示します。 選択**データベース サーバーの共有**、順にクリックします**次**します。
   4. RD 接続ブローカーのクラスターの DNS 名を入力します。
   5. SQL db の場合、接続文字列を入力し、高可用性を確立するためにウィザードを使用し、ページします。
3. 展開への新しい RD 接続ブローカーの追加します。
   1. サーバー マネージャーで、 **Remote Desktop Services > 概要**します。
   2. RD 接続ブローカーを右クリックし、をクリックし、 **RD 接続ブローカー サーバーの追加**します。
   3. サーバーの選択 に表示されるまでウィザードを使用してページは、新しく作成された RD 接続ブローカー サーバー (たとえば、Contoso-CB2) を選択します。
   4. 既定値を使用して、ウィザードを完了します。
4. RD 接続ブローカー サーバーおよびクライアントで信頼された証明書を構成します。

