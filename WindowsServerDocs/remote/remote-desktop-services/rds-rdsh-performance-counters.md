---
title: リモート デスクトップ セッション ホスト上のアプリケーションの応答性の問題を診断するのにパフォーマンス カウンターを使用します。
description: アプリの動作が遅い rds かどうか。 RDSH 上のアプリのパフォーマンスの問題を診断に使用できるパフォーマンス カウンターについて説明します
ms.prod: windows-server-threshold
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 09/19/2018
ms.tgt_pltfrm: na
ms.topic: article
author: lizap
manager: dougkim
ms.localizationpriority: medium
ms.openlocfilehash: 241b2b776a68cf5aec68a4d331201a07f0e5ea53
ms.sourcegitcommit: e84e328c13a701e8039b16a4824a6e58a6e59b0b
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/22/2018
ms.locfileid: "4133718"
---
# リモート デスクトップ セッション ホスト上のアプリのパフォーマンスの問題を診断するのにパフォーマンス カウンターを使用します。

不適切なアプリケーションのパフォーマンスを診断する最も困難な問題の 1 つは、アプリケーションが低速を実行しているまたは応答しません。 従来、収集 CPU、メモリ、ディスク入力/出力、およびその他のメトリックで診断を開始し、問題の原因を理解して Windows Performance Analyzer のようなツールを使用します。 残念ながらほとんどの状況でこのデータしない役立つリソース消費カウンターが頻繁に追加し、大規模なバリエーションがあるために、根本原因を特定します。 これにより、データを読み込み、報告された問題に関連付けることが難しいです。 アプリのパフォーマンスの問題を迅速に解決するために、いくつか新しいパフォーマンス (利用可能なカウンター[をダウンロードする](#download-windows-server-insider-software) [Windows Insider Program](https://insider.windows.com)を通じて) ユーザー入力のフローを測定することが追加されました。

ユーザー入力の遅延カウンターは、悪いエンド ユーザー エクスペリエンスを RDP の根本原因を迅速に識別するのに役立ちます。 時間の長さ、ユーザーの入力 (マウスまたはキーボードの使用量) などのまま、キュー内のプロセスが選択前にこのカウンターを測定し、カウンターがローカルとリモート両方のセッションで動作します。

次の図は、アプリケーションをクライアントからユーザー入力フローの大まかな表現を示します。

![リモート デスクトップのアプリケーションにユーザーのリモート デスクトップ クライアントからのユーザー入力フロー](.\media\rds-user-input.png)

ユーザー入力の遅延カウンターは、次のフロー チャートに示すように、入力キューに登録されている間、および、[従来のメッセージ ループ](https://msdn.microsoft.com/library/windows/desktop/ms644927.aspx#loop)内でアプリが選択最大デルタ (内の時間間隔) を測定します。

![リモート デスクトップのユーザー入力の遅延のパフォーマンス カウンターのフロー](.\media\rds-user-input-delay.png)

このカウンターの 1 つの重要な詳細は、構成可能な間隔内で最大ユーザー入力の遅延を報告します。 これは、入力に入力などの重要なと表示されている操作の速度に影響を与えることができるアプリケーションに到達するまで最長時間です。

たとえば、次の表では、ユーザー入力の遅延が報告されます 1,000 ms としてこの間隔内。 カウンターのレポート、最も低速なユーザー入力の遅延の間隔で「低速」のユーザーの認識は、入力中で最も時間によって決定されるため (最大) が発生すると、すべての合計入力の平均速度ではなくします。

|Number| 0 | 1 | 2 |
|------|---|---|---|
|遅延 |16 ms| 20 ms| 1,000 ms|

## 有効にして新しいパフォーマンス カウンターの使用

これらの新しいパフォーマンス カウンターを使用するには、最初にこのコマンドを実行してレジストリ キーを有効にする必要があります。

```
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v "EnableLagCounter" /t REG_DWORD /d 0x1 /f
```

>[!NOTE]
> Windows 10 1809 またはそれ以降のバージョンまたは Windows Server 2019 以降を使っている場合は、レジストリ キーを有効にする必要はありません。

次に、サーバーを再起動します。 次に、パフォーマンス モニターを開き、次のスクリーン ショットに示すようにプラス記号 (+) を選択します。

![リモート デスクトップのユーザーを追加する方法を示すスクリーン ショットの入力の遅延のパフォーマンス カウンター](.\media\rds-add-user-input-counter-screen.png)

これを行うことの後に**プロセスごとのユーザー入力の遅延**または**セッションごとのユーザー入力の遅延**を選択したカウンターの追加] ダイアログ表示されます。

![リモート デスクトップの 1 つのセッションのユーザー入力の遅延を追加する方法を示すスクリーン ショット](.\media\rds-user-delay-per-session.png)

![リモート デスクトップの 1 つのプロセスのユーザー入力の遅延を追加する方法を示すスクリーン ショット](.\media\rds-user-delay-per-process.png)

**プロセスごとのユーザー入力の遅延**を選択した場合に **、選択したオブジェクトのインスタンス**(つまり、プロセス) が表示されます```SessionID:ProcessID <Process Image>```形式です。

たとえば、[セッション ID は 1](https://msdn.microsoft.com/library/ms524326.aspx)で電卓アプリを実行すると、わかります```1:4232 <Calculator.exe>```します。

> [!NOTE]
> すべてのプロセスが含まれています。 システムとして実行されている任意のプロセスは表示されません。

カウンターは、ユーザー入力の遅延を追加するとすぐにレポートを開始します。 既定では、最大のスケールを 100 (ミリ秒) に設定されているに注意してください。 

![リモート デスクトップのパフォーマンス モニターで表したプロセスごとのユーザー入力の遅延のアクティビティの例](.\media\rds-sample-user-input-delay-perfmon.png)

次に、 **1 つのセッションのユーザー入力の遅延**を見てみましょう。 各セッション ID のインスタンスし、そのカウンターが指定されたセッション内で任意のプロセスのユーザー入力の遅延を表示します。 さらに、"Max"(、最大ユーザー入力の遅延のすべてのセッション間で) と「平均」(平均 acorss すべてのセッション) と呼ばれる 2 つのインスタンスがあります。

次の表は、これらのインスタンスの視覚的な例を示します。 (情報を取得できます、同じパフォーマンス モニターでグラフのレポートの種類に切り替えることで。)

|カウンターの種類|インスタンス名|報告された遅延 (ミリ秒)|
|---------------|-------------|-------------------|
|1 つのプロセスのユーザー入力の遅延|1:4232 < Calculator.exe >|  200|
|1 つのプロセスのユーザー入力の遅延|2:1000 < Calculator.exe >|  16|
|1 つのプロセスのユーザー入力の遅延|1:2000 < Calculator.exe >|  32|
|1 つのセッションのユーザー入力の遅延|1|    200|
|1 つのセッションのユーザー入力の遅延|2|    16|
|1 つのセッションのユーザー入力の遅延|平均|  108|
|1 つのセッションのユーザー入力の遅延|Max|  200|

## オーバー ロードされたシステムで使用されるカウンター

ここでどのような場合に表示されますレポートで、アプリのパフォーマンスが低下を見てみましょう。 次のグラフは、Microsoft Word でリモートで作業しているユーザーの読み取り値を示しています。 この場合、RDSH サーバーのパフォーマンスより多くのユーザーのログイン、時間の経過と共に低下します。

![リモート デスクトップの Microsoft Word を実行している RDSH サーバー用の例のパフォーマンス グラフ](.\media\rds-user-input-perf-graph.png)

グラフの行を読み取る方法を次に示します。

- ピンクの線は、サーバー上署名されているセッションの数を示します。
- 赤の行では、CPU 使用率です。
- 緑の線は、すべてのセッション間での最大ユーザー入力の遅延です。
- (このグラフで黒く表示されます)、青の行は、すべてのセッション間で平均的なユーザー入力の遅延を表します。

CPU スパイクとユーザー入力の遅延の相関関係があることがわかります-ユーザーの入力の遅延が増加、CPU は、複数の使用量を取得します。 またより多くのユーザーがシステムに追加されていく CPU 使用率は 100% より頻繁にユーザー入力の遅延ピーク時に先頭に近い取得します。 このカウンターは、サーバーがリソース不足に実行される場合に非常に便利ですは、特定のアプリケーションに関連するユーザー入力の遅延を追跡するも使うことができます。

## 構成オプション

このパフォーマンス カウンターを使用する場合に、重要な点は、既定では 1,000 ミリ秒の間隔でユーザー入力の遅延をレポートにです。 プロパティを設定してパフォーマンス カウンターのサンプル間隔に示すように、次のスクリーン ショット) さまざまなものを報告される値は適切なされません。

![リモート デスクトップのパフォーマンス モニターのプロパティ](.\media\rds-user-input-perfmon-properties.png)

これを解決するには、間隔 (ミリ秒単位) を使用すると一致する次のレジストリ キーを設定できます。 たとえば場合は、5 秒間にサンプル x 秒間隔を変更します 5000 ms にこのキーを設定する必要があります。

```
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server]

"LagCounterInterval"=dword:00005000
```

>[!NOTE]
>Windows 10 1809 またはそれ以降のバージョンまたは Windows Server 2019 以降を使っている場合は、パフォーマンス カウンターを修正する LagCounterInterval を設定する必要はありません。

いくつかのキーが同じレジストリ キーの下で役に立つも追加しました。

**LagCounterImageNameFirst** -このキーに設定`DWORD 1`(既定値の 0 またはキーが存在しない)。 これは、"Image Name < SessionID:ProcessId >"にカウンター名が変更されます。 たとえば、"explorer < 1:7964 >" これはイメージ名によって並べ替えを行う場合に便利です。

**LagCounterShowUnknown** -このキーに設定`DWORD 1`(既定値の 0 またはキーが存在しない)。 これには、サービスまたはシステムとして実行されているすべてのプロセスが表示されます。 その他のセッションとして設定をいくつかのプロセスが表示されます"?."

これは、どのようにを両方のキーが有効にします。

![リモート デスクトップの両方のキーとパフォーマンス モニター](.\media\rds-user-input-delay-with-two-counters.png)

## Microsoft 以外のツールでの新しいカウンターの使用

監視ツール[パフォーマンス モニター API](https://msdn.microsoft.com/library/windows/desktop/aa371903.aspx)を使用してこのカウンターを利用できます。

## Windows Server の Insider ソフトウェアをダウンロードします。

登録されている insider の皆様は、 [Windows Server Insider Preview のダウンロード ページ](https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewserver)を最新の Insider ソフトウェアのダウンロードの取得に直接移動できます。  Insider として登録する方法については、[サーバーの概要](https://insider.windows.com/en-us/for-business-getting-started-server/)をご覧ください。

## フィードバックを共有します。

フィードバック Hub を使用してこの機能についてのフィードバックを提出することができます。 選択**アプリ > 他のすべてのアプリ**が含まれています"RDS パフォーマンス カウンター: パフォーマンス モニター"投稿のタイトルにします。

一般的な機能のアイデア、 [RDS UserVoice ページ](https://aka.ms/uservoice-rds)を参照してください。
