---
title: Windows Server 2016 で HYPER-V ネットワーク仮想化の技術的な詳細
description: このトピックでは、Windows Server 2016 で HYPER-V ネットワーク仮想化に関する技術情報を提供します。
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.service: virtual-network
ms.suite: na
ms.technology:
- networking-sdn
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 8db47479d0c6e6014a7df6cecd59b1e87920b76a
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59887553"
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Windows Server 2016 で HYPER-V ネットワーク仮想化の技術的な詳細

>適用対象:Windows Server 2016

サーバー仮想化を導入すると、複数のサーバー インスタンスを 1 つの物理ホストで同時に実行できます。ただし、サーバー インスタンスは互いに独立しています。 各仮想マシンは基本的に、その仮想マシンだけが物理コンピューター上で実行されているサーバーであるかのように動作します。  
  
ネットワーク仮想化によって、同様の機能、どの複数の仮想ネットワーク (重複する IP アドレス) の可能性がありますが、同じ実行で物理ネットワーク インフラストラクチャと仮想ネットワークごとように動作がで実行されている唯一の仮想ネットワーク共有ネットワーク インフラストラクチャ。 この関係を示したのが図 1 です。  
  
![ サーバー仮想化とネットワーク仮想化](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)  
  
図 1: サーバー仮想化とネットワーク仮想化  
  
## <a name="hyper-v-network-virtualization-concepts"></a>Hyper-V ネットワーク仮想化の概念  
HYPER-V ネットワーク仮想化 (HNV) では、顧客またはテナントが、enterprise または datacenter で配置されている IP サブネットのセットの「所有者」として定義されます。 顧客には、企業または企業では、複数の部門やネットワークの分離を必要とするプライベート データ センターで部署やサービス プロバイダーによってホストされているパブリック データ センター内のテナントを指定できます。 各顧客は、1 つまたは複数を所有でき[仮想ネットワーク](#VirtualNetworks)1 つまたは複数のネットワークで構成されますとそれぞれの仮想データ センターに[仮想サブネット](#VirtualSubnets)します。  
  
Windows Server 2016 で使用できる、2 つの HNV 実装があります。HNVv1 HNVv2.  
  
-   **HNVv1**  
  
    HNVv1 は Windows Server 2012 R2 および System Center 2012 R2 Virtual Machine Manager (VMM) との互換性です。 HNVv1 の構成では、物理アドレス (PA) のマッピングおよびルーティングの分離の設定とカスタマー アドレス (CA) の仮想ネットワークに定義する WMI 管理と Windows PowerShell コマンドレットが (System Center VMM を容易になります) に依存します。 Windows Server 2016 で HNVv1 する追加機能が追加されていないと、新機能が予定されていません。  
    
    • チーミングを設定して、HNV V1 は、プラットフォームで互換性がありません。
    
    o HA NVGRE ゲートウェイのユーザーを使用する必要がありますいずれかを使用して LBFO チームまたはチームがありません。 または
    
    o セットでゲートウェイを使用してネットワーク コント ローラーの展開には、スイッチがチーム化します。

  
-   **HNVv2**  
  
    HNVv2 は、Azure 仮想フィルタ リング プラットフォーム (VFP) 転送では、HYPER-V スイッチ拡張機能を使用して実装するには、多数新機能にはが含まれます。 HNVv2 は、ソフトウェア定義ネットワーク (SDN) スタック内の新しいネットワーク コント ローラーを含む Microsoft Azure Stack に完全に統合します。  仮想ネットワークのポリシーは、Microsoft によって定義[ネットワーク コント ローラー](../../../sdn/technologies/network-controller/Network-Controller.md) RESTful NorthBound (NB) API を使用して、ホスト エージェントを使用して複数 SouthBound インターフェイス (SBI) OVSDB などを追加します。 ホスト エージェントのポリシーが適用される、HYPER-V スイッチの VFP 拡張機能にプログラムします。  
  
    > [!IMPORTANT]  
    > このトピックでは、HNVv2 について説明します。  
  
### <a name="VirtualNetworks"></a>仮想ネットワーク  
  
-   各仮想ネットワークは、1 つまたは複数の仮想サブネットで構成されます。 仮想ネットワーク、仮想ネットワーク内の仮想マシンは、互いと通信できるだけ分離境界を形成します。 これまでは、この分離が適用されて、分離された IP アドレス範囲と 802.1q Vlan を使用してタグまたは VLAN id。 NVGRE または VXLAN カプセル化を使用して、顧客またはテナントの間の IP サブネットの重複する可能性がありますオーバーレイ ネットワークを作成する、HNV の分離が適用されます。  
  
-   各仮想ネットワークには、ホスト上、一意のルーティング ドメイン ID (RDID) があります。 この RDID はほぼ仮想ネットワーク、ネットワーク コント ローラーの REST リソースを識別するためにリソース ID にマップします。 追加のリソース ID を持つ Uniform Resource Identifier (URI) の名前空間を使用して仮想ネットワークの REST リソースを参照します。  
  
### <a name="VirtualSubnets"></a>仮想サブネット  
  
-   仮想サブネットでは、同じサブネット内の仮想マシンにレイヤー 3 IP サブネット セマンティクスが実装されます。 仮想サブネット ブロードキャスト ドメインです (VLAN に似ています) のフォームし、NVGRE テナント ネットワーク ID (TNI) または VXLAN ネットワーク識別子 (VNI) のいずれかのフィールドを使用して分離が適用されています。  
  
-   各仮想サブネットが 1 つの仮想ネットワーク (RDID) に属しているし、一意の仮想サブネット ID (VSID) TNI または VNI のいずれかのキーをカプセル化されたパケット ヘッダーを使用してが割り当てられています。 4096 ~ 2 の範囲であり、データ センター内で一意である必要があります、VSID ^24-2 です。  
  
仮想ネットワークとルーティング ドメインの主な利点は、クラウドに移行するお客様は、独自のネットワーク トポロジ (たとえば、IP サブネット) できます。 図 2 の例では、Contoso Corp は R&D Net と Sales Net の 2 つの独立したネットワークを所有しています。 これらのネットワークはルーティング ドメイン ID が異なるため、干渉し合うことはありません。 つまり、Contoso R&D Net と Contoso Sales Net は共に Contoso Corp によって所有されていますが、Contoso R&D Net は Contoso Sales Net から切り離されています。Contoso R&D Net には 3 つの仮想サブネットが含まれています。 RDID と VSID の両方がデータセンター内で一意であることに注意してください。  
  
![ カスタマー ネットワークと仮想サブネット](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)  
  
図 2: カスタマー ネットワークと仮想サブネット  
  
**レイヤー 2 の転送**  
  
図 2 は、VSID 5001 の仮想マシンには、HYPER-V スイッチを通過 VSID 5001 内にある仮想マシンに転送されたパケットはそのことができます。 VSID 5001 の仮想マシンからの受信パケットは、HYPER-V スイッチで特定 VPort に送信されます。 イングレス ルール (例: 全て) とマッピング (encapsulation ヘッダーなど) は、これらのパケットを HYPER-V スイッチによって適用されます。 パケットが転送されます HYPER-V スイッチで異なる VPort のいずれか (送信先仮想マシンは、同じホストに接続されている) 場合、または別のホスト (送信先仮想マシンは別のホスト上にある) 場合に別の HYPER-V スイッチにします。  
  
**レイヤーの 3 つのルーティング**  
  
同様に、VSID 5001 の仮想マシンでは、これは各 HYPER-V ホストの VSwitch に存在 HNV 分散ルーターによって VSID 5002 または VSID 5003 の仮想マシンにルーティングを介してパケットを持つことができます。 スイッチを Hyper-v ホストにパケットを配信すると、HNV 着信パケットの VSID を送信先仮想マシンの VSID に更新します。 これは両方の VSID が同じ RDID 内にある場合にだけ行われます。  したがって、rdid1 の仮想ネットワーク アダプターは、ゲートウェイを通過することがなく、rdid2 の仮想ネットワーク アダプターにパケットを送信できません。  
  
> [!NOTE]  
> パケット フロー説明上、という用語「仮想マシン」実際には、仮想マシン上の仮想ネットワーク アダプター。 通常、仮想マシン上には仮想ネットワーク アダプターが 1 つしかありません。 この場合は、「仮想マシン」と「仮想ネットワーク アダプター」できます概念的には、同じことを意味します。  
  
各仮想サブネットでは、レイヤー 3 IP サブネットと VLAN に似たレイヤー 2 (L2) ブロードキャスト ドメイン境界が定義されます。 仮想マシンは、パケットをブロードキャスト、HNV は元のパケットのコピーを作成し、接続先 IP と MAC を同じ VSID 内にある各 VM のアドレスに置き換えますユニキャスト レプリケーション (UR) を使用します。  
  
> [!NOTE]  
> Windows Server 2016 が出荷されるときに、ブロードキャストとサブネットのマルチキャストは、ユニキャスト レプリケーションを使用して実装されます。 サブネット間のマルチキャスト ルーティングと IGMP はサポートされていません。  
  
VSID は、ブロードキャスト ドメインであるだけでなく、分離も提供します。 HNV の仮想ネットワーク アダプターは、ポート (virtualNetworkInterface REST リソース) に直接、または一部をそれが仮想サブネット (VSID) を適用する ACL 規則がある、HYPER-V スイッチ ポートに接続されます。  
  
HYPER-V スイッチ ポート ACL ルールが適用されてが必要です。 この ACL は、する ALLOW ALL、DENY ALL、またはのみ特定の種類の 5 タプル (ソース IP、接続先 IP、発信元ポート、宛先ポート、プロトコル) と一致するトラフィックを許可する詳細を指定できませんでした。  
  
> [!NOTE]  
> HYPER-V スイッチ拡張機能は、新しいソフトウェア定義ネットワーク (SDN) スタックで HNVv2 で機能しません。 HNVv2 は、その他のサード パーティのスイッチ拡張機能と組み合わせて使用できない Azure 仮想フィルタ リング プラットフォーム (VFP) のスイッチ拡張機能を使用して実装されます。  
  
## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>スイッチと HYPER-V ネットワーク仮想化でのルーティング  
HNVv2 適切レイヤー 2 (L2) の切り替えと物理スイッチと同様に動作する第 3 層 (L3) ルーティング セマンティクスを実装またはルーターが機能します。 仮想マシンに接続 HNV の仮想ネットワークは、リモートの仮想マシンの CA の MAC アドレスを参照する必要がありますまず同じ仮想サブネット (VSID) で別の仮想マシンとの接続を確立しようとします。 ソース仮想マシンの ARP テーブルの変換先の仮想マシンの IP アドレスの ARP エントリがある場合は、このエントリから MAC アドレスが使用されます。 エントリが存在しない場合、ソース仮想マシンは、ARP が返される、変換先の仮想マシンの IP アドレスに対応する MAC アドレスの要求によるブロードキャストを送信します。 HYPER-V スイッチがこの要求をインターセプトし、ホストのエージェントに送信します。 ホスト エージェントは、要求された変換先の仮想マシンの IP アドレスの対応する MAC アドレスをローカル データベースになります。  
  
> [!NOTE]  
> OVSDB サーバーとして機能する、ホスト エージェントでは、CA と PA のマッピングや MAC のテーブルを格納するのに VTEP スキーマの一種を使用します。  
  
MAC アドレスを使用できる場合、ホスト エージェントは、ARP 応答を挿入し、仮想マシンに送信します。 仮想マシンのネットワーク スタックは、すべての必要な L2 ヘッダー情報がある、フレーム、V スイッチに対応する、HYPER-V ポートに送信されます。 内部的には、HYPER-V スイッチでは、V ポートに割り当てられている照合ルールを N タプルに対してこのフレームをテストし、これらの規則に基づいてフレームに特定の変換を適用します。 最も重要なは、ネットワーク コント ローラーで定義されているポリシーによっては、NVGRE または VXLAN のいずれかを使用して、カプセル化ヘッダーを構築する一連の変換をカプセル化が適用されます。 ホストのエージェントによってプログラムのポリシーに基づいて、CA と PA のマッピングに使用されます、HYPER-V ホストの IP アドレスを決定送信先仮想マシンが存在する場所。 HYPER-V スイッチにより、正しいルーティング ルールと、リモートの PA アドレスに到達するために VLAN タグが外側のパケットに適用されます。  
  
HNV の仮想ネットワークに接続されている仮想マシンは、別の仮想サブネット (VSID) 内の仮想マシンの接続を作成する必要がある場合、パケットを適切にルーティングされるようにする必要があります。 HNV スター型トポロジを前提としていますが次ホップとしてすべての IP プレフィックス (つまり 1 つの既定ルート/ゲートウェイ) に到達するために使用する CA 空間内に 1 つだけの IP アドレスがある場合。 現時点では、これにより、1 つの既定のルートに制限を強制して、既定以外のルートがサポートされていません。  
  
### <a name="routing-between-virtual-subnets"></a>仮想サブネット間のルーティング  
物理ネットワークでは、IP サブネットは、場所 (仮想および物理) コンピューターは、互いと通信できる直接レイヤー 2 (L2) ドメインです。 L2 ドメインは、ブロードキャスト ドメイン ARP エントリ (IP:MAC アドレス マップ) はすべてのインターフェイスでは、ブロードキャストする ARP 要求を通じて学習、ARP 応答が要求元のホストに送信されます。 コンピューターでは、ARP 応答から学習した MAC の情報を使用して、イーサネット ヘッダーを含む L2 フレームを完全に構築します。 ただし、IP アドレスが異なる L3 サブネット内にある場合は、ARP 要求はこの L3 境界を通過しません。 代わりに、ソースのサブネットの IP アドレスを持つ L3 ルーター インターフェイス (次ホップまたはデフォルト ゲートウェイ) は、独自の MAC アドレスを持つ ARP 要求に対応する必要があります。  
  
標準の Windows ネットワーク キングでは、管理者は静的ルートを作成し、これらのネットワーク インターフェイスに割り当てます。 さらに、「デフォルト ゲートウェイ」は通常、既定のルート (0.0.0.0/0) 宛てのパケットの送信先となるインターフェイスの次ホップの IP アドレスを構成します。 パケットは、特定のルートが存在しない場合、この既定のゲートウェイに送信されます。 これは通常、物理ネットワークのルーターです。  HNV は、すべてのホストの一部が、仮想ネットワークの分散ルーターを作成するには、すべて VSID インターフェイス組み込みルーターを使用します。  
  
HNV は、スター型トポロジを仮定するため、HNV の分散ルーターが同じ VSID ネットワークの一部である仮想サブネット間を移動するすべてのトラフィックの 1 つの既定のゲートウェイとして機能します。 アドレスは、VSID の最下位の IP アドレス、デフォルト ゲートウェイは既定として使用され、HNV の分散ルーターに割り当てられます。 この分散ルーターでは、各ホストは、中継ぎ局をしなくても適切なホストにトラフィックを直接ルーティングできるので、適切にルーティングする VSID ネットワーク内のすべてのトラフィックの非常に効率的な方法でできます。  これは特に、同じ VM ネットワーク内の異なる仮想サブネットで、2 つの仮想マシンが同じ物理ホスト上にある場合に当てはまります。  このセクションで後ほど説明するように、この場合にパケットは物理ホストを離れる必要はありません。  
  
### <a name="routing-between-pa-subnets"></a>PA サブネット間のルーティング  
各仮想サブネット (VSID) 1 つの PA IP アドレスが割り当てられいる HNVv1 とは対照的 HNVv2 は今すぐ Switch-Embedded チーミング (SET) の NIC チームのメンバーごとに 1 つの PA IP アドレスを使用します。 既定のデプロイでは、2 つの NIC チームを前提としていて、ホストごとに 2 つの PA IP アドレスを割り当てます。 1 つのホストには、同じプロバイダー (PA) に、同じ vlan 論理サブネットから割り当てられている PA Ip があります。 同じ仮想サブネット内の 2 つのテナントの Vm は、2 つの異なるプロバイダー論理サブネットに接続している 2 つの異なるホスト上にある実際可能性があります。 HNV では、CA と PA のマッピングを基にカプセル化されたパケットの外部の IP ヘッダーを構築します。 ただし、既定の PA ゲートウェイの ARP をホストの TCP/IP スタックに依存し、ARP 応答に基づいて、外側のイーサネット ヘッダーをビルドします。 通常、この ARP 応答が SVI インターフェイスから物理スイッチまたは L3 ルーターで、ホストが接続されています。 HNV プロバイダー論理サブネット間でカプセル化されたパケットをルーティングする L3 ルーターでしたがっては依存しています/Vlan です。  
  
### <a name="routing-outside-a-virtual-network"></a>仮想ネットワークの外側のルーティング  
ほとんどの顧客展開では、HNV 環境から HNV 環境の一部ではないリソースへの通信が必要になります。 2 つの環境間の通信を実現するためには、ネットワーク仮想化ゲートウェイが必要です。 HNV ゲートウェイを必要とするインフラストラクチャには、プライベート クラウドやハイブリッド クラウドが含まれます。 基本的に、HNV ゲートウェイは、レイヤー 3 内部および外部の (物理) ネットワークを使用して、(NAT を含む) 間、または別のサイトや IPSec VPN または GRE トンネルを使用してクラウド (プライベートまたはパブリック) の間のルーティングに必要です。  
  
ゲートウェイはさまざまな物理フォーム ファクターで提供されます。 Windows Server 2016 に組み込まれて、トップ オブ ラック (TOR) スイッチとして機能する VXLAN ゲートウェイは、アクセスを仮想 IP (VIP)、ロード バランサーによってアドバタイズされたその他の既存のネットワーク アプライアンスにまたは新しいスタンドアロンのネットワーク アプライアンスでは、上に作成できる、.  
  
Windows RAS ゲートウェイ オプションの詳細については、次を参照してください。 [RAS ゲートウェイ](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)します。  
  
## <a name="packet-encapsulation"></a>パケット カプセル化  
HNV の各仮想ネットワーク アダプターは、次の 2 つの IP アドレスに関連付けられます。  
  
-   **顧客の住所**(CA) IP アドレスがそのイントラネット インフラストラクチャに基づいて、顧客によって割り当てられます。 このアドレスの存在によって、顧客は、パブリック クラウドまたはプライベート クラウドに移行されたことを意識せずに、仮想マシンとの間でネットワーク トラフィックをやり取りすることができます。 CA は、仮想マシンから見える、顧客が到達可能なアドレスです。  
  
-   **プロバイダー アドレス**ホスティング プロバイダーによって割り当てられた (PA) IP アドレスまたは物理ネットワーク インフラストラクチャに基づくデータ センターの管理者。 PA は、仮想マシンをホストしている Hyper-V を実行するサーバーとの間で交換されるネットワーク上のパケットに格納されます。 PA は、物理ネットワーク上では見えますが、仮想マシンからは見えません。  
  
カスタマー ネットワークのトポロジは、CA によって保たれていますが、カスタマー ネットワークは仮想化され、その基になる (PA によって実現されている) 実際の物理ネットワークのトポロジとアドレスからは切り離されています。 次の図は、ネットワーク仮想化の結果としての仮想マシンの CA とネットワーク インフラストラクチャの PA の概念上の関係を示しています。  
  
![ 物理インフラストラクチャ上のネットワーク仮想化の概念図](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)  
  
図 6: 物理インフラストラクチャ上のネットワーク仮想化の概念図  
  
図では、顧客の仮想マシンは CA 空間内の仮想ネットワーク、または「トンネル」を物理ネットワーク インフラストラクチャを横断するデータ パケットに送信します。 上記の例では、トンネルを Contoso と Fabrikam データ パケットを左側の送信元ホストから右側の送信先ホストに配信される緑の宛先ラベル (PA アドレス) を包む「封筒」として考えることができます。 キーは、ホストが「宛先アドレス」を特定する方法、Contoso と Fabrikam の CA、パケットを包む「封筒」を配置する方法と、宛先ホストがパケットのラップを解除し、Contoso と Fabrikam に配信する方法に対応する (PA)変換先の仮想マシンを正しくします。  
  
この簡単な例では、次のようなネットワーク仮想化の主要な側面に焦点を当てました。  
  
-   各仮想マシンの CA は物理ホストの PA にマップされます。 同じ PA に関連付けられた複数の CA が存在する場合があります。  
  
-   仮想マシンは、「封筒」PA の送信元と送信先のペアでマッピングに基づいてに入れられますは CA 空間でデータ パケットを送信します。  
  
-   CA と PA のマッピングでは、ホストがさまざまなカスタマー仮想マシン宛てのパケットを区別できるようにする必要があります。  
  
そのため、ネットワークを仮想化するメカニズムは、仮想マシンで使用されるネットワーク アドレスを仮想化することになります。 ネットワーク コント ローラーは、アドレスのマッピングを担当し、ホスト エージェントが MS_VTEP スキーマを使用して、マッピング データベースを保持します。 次のセクションでは、実際のアドレス仮想化メカニズムについて説明します。  
  
## <a name="network-virtualization-through-address-virtualization"></a>アドレス仮想化によるネットワーク仮想化  
HNV の実装では、Network Virtualization Generic Routing Encapsulation (NVGRE) または仮想拡張可能なローカル エリア ネットワーク (VXLAN) のいずれかを使用して、テナント ネットワークをオーバーレイします。  VXLAN では、既定値です。  
  
### <a name="virtual-extensible-local-area-network-vxlan"></a>仮想拡張可能なローカル エリア ネットワーク (VXLAN)  
仮想拡張可能なローカル エリア ネットワーク (VXLAN) ([RFC 7348](https://www.rfc-editor.org/info/rfc7348)) プロトコルが Cisco、Brocade、Arista、Dell、HP などのベンダーからのサポートを市場で広く採用されています。 VXLAN プロトコルは、UDP をトランスポートとして使用します。 VXLAN の IANA によって割り当てられた UDP 宛先ポートは 4789 と、UDP 発信元ポートは、ECMP を展開するために内側のパケットからの情報のハッシュをする必要があります。 UDP ヘッダーの後の VXLAN ネットワーク識別子 (VNI) - VSID - 予約済みの別の 1 バイト フィールドに続けて 3 バイトのフィールドでその後に、予約済みの 4 バイト フィールドを含むパケットに VXLAN ヘッダーが追加されます。 VXLAN ヘッダーの後、元の CA L2 フレーム (せずに、CA イーサネット フレーム FCS) が追加されます。  
  
![VXLAN のパケット ヘッダー](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)  
  
### <a name="generic-routing-encapsulation-nvgre"></a>汎用ルーティング カプセル化 (NVGRE)  
このネットワーク仮想化メカニズムは、トンネル ヘッダーの一部として、Generic Routing Encapsulation (NVGRE) を使用します。 Nvgre で仮想マシンのパケットに別のパケット カプセル化します。 この新しいパケットのヘッダーには、図 7 に示すように、GRE ヘッダーのキー フィールドに格納される仮想サブネット ID に加えて、該当する送信元と送信先の PA IP アドレスが格納されます。  
  
![NVGRE カプセル化](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)  
  
図 7: ネットワーク仮想化 - NVGRE カプセル化  
  
ホストのすべてのパケットについてカスタマー仮想マシンを識別するためが重複する場合でも、PA と CA が、パケット上の仮想サブネット ID できます。 これにより、図 7 に示すように、同じホスト上のすべての仮想マシンが単一の PA を共有できます。  
  
PA の共有はネットワークのスケーラビリティに大きく影響します。 ネットワーク インフラストラクチャに覚えさせる必要がある IP アドレスと MAC アドレスの数を大幅に削減できます。 たとえば、すべてのエンド ホストに平均 30 個の仮想マシンがある場合、ネットワーク インフラストラクチャに覚えさせる必要がある IP アドレスと MAC アドレスの数は 30 の倍数だけ減少します。また、パケットに埋め込まれた仮想サブネット ID により、パケットを実際の顧客に簡単に関連付けることも可能になります。  
  
VSID あたり 1 つの PA は、Windows Server 2012 R2 のスキームを共有 PA は、ホストごとです。 Windows Server 2016 の NIC チームのメンバーごとの 1 つの PA は、スキームです。  
  
Windows Server 2016 以降、HNV を完全にサポート NVGRE と VXLAN すぐ;これは、アップグレードまたは Nic (ネットワーク アダプター)、スイッチ、ルーターなどの新しいネットワーク ハードウェアを購入するには必要ありません。 これは、ネットワーク上でこれらのパケットが今日のネットワーク インフラストラクチャとの互換性のある PA 空間での通常の IP パケットであるためです。  ただし、パフォーマンスを最大限に活用するには、タスク オフロードをサポートする最新のドライバーと Nic をサポートします。  
  
## <a name="multi-tenant-deployment-example"></a> マルチテナント展開の例  
次の図は、CA と PA の関係をネットワーク ポリシーで定義されているクラウド データ センターにある 2 人の顧客の展開の例を示します。  
  
![ マルチテナント展開の例](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)  
  
図 8: マルチテナント展開の例  
  
図 8 の例を考えてみます。 ホスティング プロバイダーの共有 IaaS サービスに移行する前は、次のようになっています。  
  
-   Contoso Corp は、**SQL** という名前の SQL Server を IP アドレス 10.1.1.11 で運用し、その SQL Server をデータベース トランザクションに使用していた **Web** という名前の Web サーバーを IP アドレス 10.1.1.12 で運用していました。  
  
-   Fabrikam Corp も、**SQL** という名前の SQL Server を IP アドレス 10.1.1.11 で運用し、その SQL Server をデータベース トランザクションに使用していた **Web** という名前の Web サーバーを IP アドレス 10.1.1.12 で運用していました。  
  
ホスティング サービス プロバイダーがその物理ネットワーク トポロジに対応するネットワーク コント ローラーからプロバイダー (PA) の論理ネットワークを作成していたことと仮定されます。 ネットワーク コント ローラーは、ホストが接続されている論理サブネットの IP プレフィックスから 2 つの PA IP アドレスを割り当てます。 ネットワーク コント ローラーには、IP アドレスに適用する適切な VLAN タグも示されます。  
  
その仮想ネットワークと、ホスティング サービス プロバイダーによって指定されたプロバイダー (PA) の論理ネットワークでバックアップされているサブネットを作成し、ネットワーク コント ローラー、Contoso Corp と Fabrikam Corp を使用しています。 Contoso Corp と Fabrikam Corp は、それぞれの SQL Server と Web サーバーを、同じホスティング プロバイダーの共有 IaaS サービスに移動し、偶然にも **SQL** 仮想マシンを Hyper-V ホスト 1 で、 **Web** (IIS7) 仮想マシンを Hyper-V ホスト 2 で運用します。 すべての仮想マシンには、元のイントラネット IP アドレス (各社の CA) が保たれます。  
  
両方の会社は、次に示すように、ネットワーク コント ローラーによって次仮想サブネット ID (VSID) を割り当てられます。  各 HYPER-V ホストにホスト エージェントは、ネットワーク コント ローラーから割り当てられている PA IP アドレスを受け取るし、既定ではないネットワーク コンパートメント内の 2 つの PA ホスト Vnic を作成します。 ネットワーク インターフェイスは、次に示すように、PA IP アドレスが割り当てられているこれらのホスト Vnic のそれぞれに割り当てられています。  
  
-   VSID と Pa は、Contoso Corp の仮想マシン:**VSID**は 5001、 **SQL の PA**は 192.168.1.10、 **Web の PA**は 192.168.2.20  
  
-   VSID と Pa は、Fabrikam Corp の仮想マシン:**VSID**は 6001、 **SQL の PA**は 192.168.1.10、 **Web の PA**は 192.168.2.20  
  
ネットワーク コント ローラーには、(OVSDB データベースのテーブル) に永続的なストアでポリシーを保持する、SDN ホスト エージェントへ (CA と PA のマッピングを含む) すべてのネットワーク ポリシーが組み込まれます。  
  
HYPER-V ホスト 2 上の Contoso Corp の Web 仮想マシン (10.1.1.12) では、SQL Server への TCP 接続を作成します (10.1.1.11) に対して、ときに、次のようになります。  
  
-   10.1.1.11 の宛先 MAC アドレスを VM Arp  
  
-   VSwitch で VFP 拡張機能は、このパケットをインターセプトし、SDN のホストのエージェントに送信します  
  
-   SDN のホスト エージェントが 10.1.1.11 の MAC アドレスの場合は、そのポリシー ストアで検索します。  
  
-   MAC が見つかると、ホスト エージェントは、VM に、ARP 応答を挿入します。  
  
-   MAC が見つからない場合は、応答は送信されませんされ 10.1.1.11 の VM での ARP エントリは、到達不能でマークされます。  
  
-   今すぐ VM は、正しい CA イーサネットや IP ヘッダーと TCP パケットを構築しますおよび vSwitch に送信します  
  
-   転送拡張機能、vSwitch の VFP (下記参照)、パケットを受信したし、VFP 統合フロー テーブルに新しいフローのエントリを作成、元の vSwitch ポートに割り当てられている VFP 層を介してこのパケットを処理します。  
  
-   VFP エンジンでは、IP およびイーサネット ヘッダーに基づいて、各レイヤー (例: 仮想ネットワーク レイヤー) の規則に一致するか、フロー テーブル ルックアップを実行します。  
  
-   仮想ネットワーク レイヤーで一致したルールは、CA と PA のマッピング領域を参照し、カプセル化を実行します。  
  
-   いずれか VXLAN (NVGRE) カプセル化の種類は、VSID と VNet のレイヤーで指定されます。  
  
-   VXLAN のカプセル化の場合は、外側の UDP ヘッダーは、VSID 5001 VXLAN ヘッダーで構築されます。  
    外部の IP ヘッダーは、HYPER-V ホスト 2 (192.168.2.20) と、HYPER-V ホスト 1 (192.168.1.10) SDN のホスト エージェントのポリシー ストアに基づいて、それぞれに割り当て元と送信先の PA アドレスで構築されます。  
  
-   このパケットは、VFP の PA ルーティング レイヤーにフローします。  
  
-   VFP の PA ルーティング レイヤーでは、PA 空間のトラフィックと VLAN ID に使用するネットワーク コンパートメントを参照して、正しく PA パケットを HYPER-V ホスト 1 に転送するように、ホストの TCP/IP スタックを使用します。  
  
-   カプセル化されたパケットの受信、時に、HYPER-V ホスト 1 は、PA ネットワーク コンパートメントにパケットを受信し、vSwitch に転送します。  
  
-   VFP は、VFP 階層を通じてパケットを処理し、VFP 統合フロー テーブルに新しいフローのエントリを作成します。  
  
-   VFP エンジンでは、仮想ネットワーク レイヤーで ingres 規則と一致して、外側のカプセル化されたパケットのイーサネットや IP では、VXLAN のヘッダーを削除します。  
  
-   VFP エンジンは、接続先の VM が接続されている vSwitch ポートにパケットを転送します。  
  
同様のプロセスが、Fabrikam Corp の **Web** 仮想マシンと **SQL** 仮想マシン間のトラフィックで生じる場合には、Fabrikam Corp の HNV ポリシー設定が使用されます。その結果、Fabrikam Corp の仮想マシンと Contoso Corp の仮想マシンは、HNV により、それぞれの元のイントラネット上に存在するかのように振る舞います。 同じ IP アドレスを使用していても、決して干渉し合うことはありません。  
  
別のアドレス (Ca および Pa)、HYPER-V ホストのポリシー設定と、CA と PA の仮想マシンの受信と送信トラフィックの間のアドレス変換は、これらの NVGRE キーまたは VLXAN VNID のいずれかを使用してサーバーのセットを分離します。 さらに、仮想化のマッピングと変換により、仮想ネットワーク アーキテクチャが物理ネットワーク インフラストラクチャから切り離されます。 Contoso の **SQL** および **Web** と Fabrikam の **SQL** および **Web** は独自の CA IP サブネット (10.1.1/24) 内にありますが、それぞれの物理的な展開は異なる PA サブネット (Contoso は 192.168.1/24、Fabrikam は 192.168.2/24) 内の 2 台のホスト上で行われます。 つまり、HNV では、サブネット間での仮想マシンのプロビジョニングとライブ マイグレーションが可能になります。  
  
## <a name="hyper-v-network-virtualization-architecture"></a>Hyper-V ネットワーク仮想化のアーキテクチャ  
Windows Server 2016 HNVv2 は、Azure 仮想フィルタ リング プラットフォーム (VFP) は、HYPER-V スイッチ内の NDIS フィルター拡張機能を使用して実装されます。 VFP の重要な概念では、ネットワーク ポリシーのプログラミングの SDN のホストのエージェントに公開されている内部 API を使用して一致操作フロー エンジンのです。 SDN のホスト エージェント自体は、ネットワーク コント ローラーから、OVSDB と WCF の SouthBound 通信チャネル経由でネットワーク ポリシーを受信します。 仮想ネットワークのポリシーがあるだけでなく (例: CA と PA のマッピング) VFP が、Acl や QoS などの他のポリシーを使用してプログラムします。  
  
転送拡張機能の VFP と vSwitch のオブジェクト階層次に示します。  
  
-   vSwitch  
  
    -   外部 NIC の管理  
  
    -   NIC のハードウェアのオフロード  
  
    -   グローバルの転送ルール  
  
    -   ポート  
  
        -   十字線を固定するためのレイヤーを転送するエグレス  
  
        -   マッピングと NAT プールの容量を一覧表示します。  
  
        -   統合フロー テーブル  
  
        -   VFP レイヤー  
  
            -   フロー テーブル  
  
            -   グループ  
  
            -   ルール  
  
                -   ルールは、スペースを参照できます。  
  
VFP では、レイヤーは、ポリシーの種類 (たとえば、仮想ネットワーク) あたりを作成し、汎用の一連のルール/フロー テーブル。 ない任意の組み込み機能の特定の規則がこのような機能を実装するためにそのレイヤーに割り当てられるまでです。 各レイヤーには、優先順位が割り当てられているし、レイヤーは、ポートに、優先度の昇順で割り当てられています。 ルールは、方向と IP アドレス ファミリに主に基づくグループに編成されます。 優先順位が割り当てられているグループと、最大でグループから 1 つのルールは、特定のフローと一致します。  
  
VFP 拡張機能と vSwitch の転送ロジックは次のとおりです。  
  
-   受信処理 (受信ポートに送信されるパケットの観点から)  
  
-   転送  
  
-   送信処理 (送信ポート、パケットの観点から)  
  
VFP には、外部 MAC VLAN ベースの転送と、NVGRE と VXLAN のカプセル化型の内部 MAC 転送がサポートされています。  
  
低速パスと高速パスのパケット検査、VFP 拡張機能があります。 フローの最初のパケットが各レイヤー内のすべてのルール グループを走査し、ルールの操作を行う必要があります負荷の高い操作を参照します。 ただし、統合フロー テーブル (照合ルールに基づく) アクションの一覧で、フローが登録されるとは統合フロー テーブルのエントリに基づいて後続パケットはすべてを処理するは。  
  
HNV のポリシーは、ホストのエージェントによって設定されます。 各仮想マシンのネットワーク アダプターは、IPv4 アドレスで構成されます。 これらは仮想マシンが相互通信に使用する CA で、仮想マシンから IP パケットで伝送されます。 HNV は、ホスト エージェントのデータベースに格納されているネットワーク仮想化ポリシーに基づいて PA フレーム内の CA のフレームをカプセル化します。  
  
![HNV のアーキテクチャ](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)  
  
図 9:HNV のアーキテクチャ  
  
## <a name="summary"></a>概要  
クラウド ベースのデータセンターは、スケーラビリティの向上やリソース使用効率の改善など多数のメリットを提供します。 これらの潜在的メリットを実現するには、動的環境におけるマルチテナントのスケーラビリティの問題を根本的に解決するテクノロジが必要です。 HNV は、こうした問題を解決し、また物理ネットワーク トポロジに対して仮想ネットワーク トポロジを分離することによりデータセンターの運用効率を向上させるように設計されました。 既存の標準に基づいて構築、HNV は今日のデータ センターで実行され、VXLAN の既存のインフラストラクチャで操作を行います。 HNV のお客様では、今すぐをプライベート クラウドに自社のデータ センターを統合したり、ハイブリッド クラウドでのホスティング サーバー プロバイダーの環境に自社のデータ センターをシームレスに拡張することができます。  
  
## <a name="BKMK_LINKS"></a>参照してください。  
学習 HNVv2 についての詳細は、次のリンクを参照してください。  
  
|コンテンツの種類|参考資料|  
|----------------|--------------|  
|**コミュニティ リソース**|-   [プライベート クラウド アーキテクチャのブログ](https://blogs.technet.com/b/privatecloud)<br />-質問があります。 [cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)|  
|**RFC**|-   [NVGRE ドラフト RFC](https://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [VXLAN の RFC 7348](https://www.rfc-editor.org/info/rfc7348)|  
|**関連テクノロジ**|-Windows Server 2012 R2 で HYPER-V ネットワーク仮想化の技術的な詳細についてを参照してください[、Hyper-v ネットワーク仮想化の技術的な詳細。](https://technet.microsoft.com/library/jj134174.aspx)<br />-   [ネットワーク コント ローラー](../../../sdn/technologies/network-controller/Network-Controller.md)|  
  


