---
title: ネットワーク ポリシー サーバー アカウンティングを構成します。
description: このトピックでは、テキスト ファイル サービスおよび Windows Server 2016 でネットワーク ポリシー サーバーのログ出力の SQL Server に関する情報を提供します。
manager: brianlic
ms.prod: windows-server-threshold
ms.technology: networking
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 69341e30d90ee1be29c40d835a4f71fe433c11dc
ms.sourcegitcommit: 19d9da87d87c9eefbca7a3443d2b1df486b0b010
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2018
---
# <a name="configure-network-policy-server-accounting"></a>ネットワーク ポリシー サーバー アカウンティングを構成します。

ネットワーク ポリシー サーバー \(NPS\) のログの 3 つの種類があります。

- **イベント ログ**します。 監査とトラブルシューティングの接続試行に主に使用されます。 NPS イベントを NPS コンソールで、NPS サーバーのプロパティを取得することでログ機能を構成することができます。

- **ローカル ファイルにユーザーの認証およびアカウンティング要求のログ**します。 接続の分析と課金のために主に使用します。 便利なセキュリティの調査ツールとして攻撃を受けた後の悪意のあるユーザーのアクティビティを追跡する方法が提供するためです。 アカウンティング構成ウィザードを使用してローカル ファイル ログを構成することができます。

- **Microsoft SQL Server XML 準拠データベースへのユーザー認証とアカウンティング要求のログ**します。 1 つのデータ ソースを使用して NPS を実行している複数のサーバーを許可するように使用されます。 また、リレーショナル データベースを使用する利点を提供します。 SQL Server のログを構成するには、アカウンティング構成ウィザードを使用します。

## <a name="use-the-accounting-configuration-wizard"></a>アカウンティング構成ウィザードを使用してください。

アカウンティング構成ウィザードを使用すると、次の 4 つアカウンティングの設定を構成できます。

- **SQL ログインのみ**します。 この設定を使用すると、SQL Server に接続し、SQL server にアカウンティング データを送信するために NPS を許可するへデータのリンクを構成できます。 さらに、ウィザードは、SQL Server データベースが SQL の NPS サーバーのログと互換性があることを確認するにデータベースを構成できます。
- **テキスト ログのみ**します。 この設定を使用すると、アカウンティング データをテキスト ファイルに記録するために NPS を構成できます。
- **ログ記録を並列**します。 この設定を使用すると、SQL Server データのリンクとデータベースを構成できます。 また、NPS をテキスト ファイル サービスおよび SQL Server データベースを同時にログに記録されるように、テキスト ファイルのログを構成することができます。 
- **SQL ログのバックアップで**します。 この設定を使用すると、SQL Server データのリンクとデータベースを構成できます。 さらに、SQL Server のログが失敗した場合、NPS が使用してテキスト ファイルのログを構成することができます。

これらの設定だけでなくテキスト ログと SQL Server のログの両方を許可する NPS が引き続きログが失敗した場合、接続要求を処理するかどうかを指定できます。 これを指定することができます、**アクションのセクションのエラーをログ**ローカル ファイル ログのプロパティに、SQL server ログ プロパティでは、アカウンティング構成ウィザードを実行しているときにします。

### <a name="to-run-the-accounting-configuration-wizard"></a>アカウンティング構成ウィザードを実行するには

アカウンティングの構成ウィザードを実行するには、次の手順を実行します。

1. NPS コンソールまたは NPS Microsoft 管理コンソール (MMC) スナップインを開きます。
2. コンソール ツリーでクリックして**アカウンティング**します。
3. 詳細ウィンドウで [**アカウンティング**、] をクリックして**アカウンティングを構成する**します。

## <a name="configure-nps-log-file-properties"></a>NPS のログ ファイルのプロパティを構成します。

ユーザーの認証要求、メッセージのアクセス許可、アクセス拒否メッセージ、アカウンティング要求と応答、および定期的なステータスの更新のリモート認証ダイヤルイン ユーザー サービス (RADIUS) のアカウンティングを実行するように、ネットワーク ポリシー サーバー (NPS) を構成することができます。 アカウンティング データを格納するログ ファイルを構成するのには、この手順を使用することができます。

ログ ファイルの解釈の詳細については、次を参照してください。[解釈 NPS データベース形式のログ ファイル](https://technet.microsoft.com/library/cc771748.aspx)します。

ログ ファイルをハード ドライブいっぱいになるを防ぐにはシステム パーティションから別のパーティションに格納することを強くお勧めします。 NPS のアカウンティングを構成する方法について以下に示します。

- 別のプロセスによって、ログ ファイル コレクションのデータを送信するには、名前付きパイプへの書き込みを NPS を構成できます。 名前付きパイプを使用するには、\\.\pipe または \\ComputerName\pipe にログ ファイルのフォルダーを設定します。 名前付きパイプのサーバー プログラムでは、データを受け入れる \\.\pipe\iaslog.log と呼ばれる名前付きパイプを作成します。 新しいログ ファイルを選択しない (無制限のファイル サイズ) を作成する」で、ローカル ファイルのプロパティ] ダイアログ ボックスに名前付きパイプを使用するとします。

- %Systemdrive%、%systemroot%、%windir% など、(ユーザー変数) ではなくシステム環境変数を使用して、ログ ファイルのディレクトリを作成することができます。 たとえば、環境変数 %windir% を使用して、次のパスは、サブフォルダー \System32\Logs (つまり、%windir%\system32\logs\) でシステム ディレクトリにあるログ ファイルを検索します。

- ログ ファイルの形式の切り替えを作成する新しいログは発生しません。 ログ ファイルの形式を変更する場合、2 つの形式の組み合わせが、変更の時点でアクティブになっているファイルが含まれます (ログの開始時のレコードが以前の形式し、ログの最後のレコードは新しい形式になります)。

- フル ハード ディスク ドライブまたはその他の原因のために RADIUS アカウンティング失敗した場合、NPS では、ユーザーがネットワーク リソースにアクセスするを防ぐ接続要求の処理が停止します。

- NPS では、ローカル ファイルにログに追加、またはその代わりに、Microsoft® SQL Server™ データベースに記録する機能を提供します。

内のメンバーシップ、**Domain Admins**グループはこの手順を実行するために必要な最小値。


### <a name="to-configure-nps-log-file-properties"></a>NPS のログ ファイルのプロパティを構成するには

1. NPS コンソールまたは NPS Microsoft 管理コンソール (MMC) スナップインを開きます。
2. コンソール ツリーでクリックして**アカウンティング**します。
3. 詳細ウィンドウで、[**ログ ファイルのプロパティ**、] をクリックして**ログ ファイル プロパティの変更**します。 **ログ ファイル プロパティ**] ダイアログ ボックスが開きます。
4. **ログ ファイル プロパティ**] の [、**設定**] タブの [ **、次の情報をログ**、アカウンティングの目標を達成するための十分な情報をログに選択することを確認します。 たとえば、ログは、セッションの関連付けを実行する必要がある場合、は、すべてのチェック ボックスを選択します。
5. **失敗したアクションのログ**[**ログが失敗する場合は、接続要求を破棄**ログ ファイルは、何らかの理由で完全または使用できないときに、アクセス要求メッセージの処理を停止するために NPS したい場合。 ログが失敗した場合、接続要求の処理を続行するために NPS を実行する場合では、このチェック ボックスはオンされません。
6. **ログ ファイルのプロパティ**ダイアログ ボックスで、をクリックして、**ログ ファイル**] タブ。
7. **ログファイル**] タブの [**ディレクトリ**、NPS のログ ファイルを格納する場所を入力します。 既定の場所は、systemroot\System32\LogFiles フォルダーです。
    >[!NOTE]
    >内の完全なパスの説明を指定しないかどうかは**ログ ファイル ディレクトリ**、既定のパスを使用します。 たとえば、次のように入力する**NPSLogFile**で**ログ ファイル ディレクトリ**、%systemroot%\system32\npslogfile にファイルがあります。
8. **形式**、] をクリックして**DTS 準拠**します。 場合は、代わりを選択、従来のファイル形式など**ODBC \(Legacy\)**または**IAS \(Legacy\)**します。
    >[!NOTE]
    >**ODBC**と**IAS**従来のファイルの種類には、NPS は、その SQL Server データベースに送信される情報のサブセットが含まれています。 **DTS 準拠**ファイルの種類の XML 形式の NPS を使用して、SQL Server データベースにデータをインポートする XML 形式と同じです。 そのため、**DTS 準拠**ファイル形式は、NPS より効率的かつ完全なデータの転送に標準の SQL Server データベースを提供します。
9. **新しいログ ファイルを作成**、指定した間隔で新しいログ ファイルを起動、使用する間隔] をクリックするために NPS を構成します。
    - 大量のトランザクション ログのアクティビティをクリックして**毎日**します。
    - 小さいトランザクションのボリュームとログのアクティビティをクリックして**毎週**または**マンスリー**します。
    - 1 つのログ ファイル内のすべてのトランザクションを格納する] をクリックして**Never \(unlimited file size\)**します。
    - 各ログ ファイルのサイズを制限する] をクリックして**ログ ファイルがこのサイズに達したとき**、新しいログの作成後、ファイルのサイズを入力します。 既定のサイズは、10 メガバイト (MB です)。
10. NPS をハード ディスクが容量の近くにある場合は、新しいログ ファイルのディスク領域を作成する以前のログ ファイルを削除する場合は、いることを確認**とディスクは、古いログ ファイルを完全削除**が選択されています。 このオプションは使用できません、ただし場合の値**新しいログ ファイルを作成**は**Never \(unlimited file size\)**します。 また、古いログ ファイルが現在のログ ファイルの場合は削除されません。

## <a name="configure-nps-sql-server-logging"></a>NPS の SQL Server ログを構成します。

Microsoft SQL Server を実行しているローカルまたはリモートのデータベースに RADIUS アカウンティング データをログには、この手順を使用することができます。

>[!NOTE]
>NPS がアカウンティング データを書式設定に送信する XML ドキュメントとして、**report_event** NPS で指定した SQL Server データベースのストアド プロシージャします。 正常に機能するログ、SQL Server が必要という名前のストアド プロシージャ**report_event**を受信し、NPS の XML ドキュメントを解析する SQL Server データベースにします。

Domain admins グループ、またはそれと同等のメンバーシップは、この手順を完了するために必要な最低限です。

### <a name="to-configure-sql-server-logging-in-nps"></a>SQL Server を NPS にログを構成するには

1. NPS コンソールまたは NPS Microsoft 管理コンソール (MMC) スナップインを開きます。
2. コンソール ツリーでクリックして**アカウンティング**します。
3. 詳細ウィンドウで [ **SQL Server ログ プロパティ**、] をクリックして**[SQL Server ログ プロパティ**します。 **SQL Server ログ プロパティ**] ダイアログ ボックスが開きます。
4. **、次の情報をログ**、ログに記録情報を選択します。 
    - ログオンするすべてのアカウンティング要求、] をクリックして**アカウンティング要求**します。
    - 認証要求のログ記録は、[**認証要求**します。
    - ログオンする定期的なアカウンティングの状態、] をクリックして**定期的なアカウンティング状態**します。
    - 中間のアカウンティング要求などの定期的な状態を記録する] をクリックして**定期的なステータス**します。
5. NPS および SQL Server を実行しているサーバー間で許可される同時セッションの数を構成するには、数値を入力**同時セッションの最大数**します。
6. SQL Server データ ソースを構成する**SQL Server ログ**、] をクリックして**構成**します。 **データ リンク プロパティ**] ダイアログ ボックスが開きます。 **接続**タブで、次を指定します。 
    - データベースが格納されているサーバーの名前を指定するには、入力するかに名前を選択**を選択またはサーバー名を入力**します。
    - サーバーにログオンに使用する認証方法を指定する] をクリックして**Windows NT の統合セキュリティ**します。 または、クリックして**、特定のユーザー名とパスワードを使用して**、しでの資格情報を入力**ユーザー名**と**パスワード**します。
    - 空白のパスワードを許可する] をクリックして**空白のパスワード**します。
    - パスワードを保存する] をクリックして**パスワードを保存する**します。
    - SQL Server を実行しているコンピューターに接続するデータベースを指定する] をクリックして**サーバー上のデータベースを選択して**、一覧からデータベース名を選択します。
7. NPS および SQL Server 間の接続をテストするには、クリックして**接続のテスト**します。 をクリックして**OK**を閉じる**データ リンク プロパティ**します。
8. **失敗したアクションのログ**[**フェールオーバー用のテキスト ファイルのログを有効にする**SQL Server のログが失敗した場合に、テキスト ファイルのログを続行するために NPS を使用する場合します。 
9. **失敗したアクションのログ**[**ログが失敗する場合は、接続要求を破棄**ログ ファイルは、何らかの理由で完全または使用できないときに、アクセス要求メッセージの処理を停止するために NPS したい場合。 ログが失敗した場合、接続要求の処理を続行するために NPS を実行する場合では、このチェック ボックスはオンされません。

## <a name="ping-user-name"></a>Ping のユーザー名

一部の RADIUS プロキシ サーバーとネットワーク アクセス サーバー、NPS サーバーがネットワークに存在することを確認する (ping 要求と呼ばれます)、認証とアカウンティングの要求を定期的に送信します。 これらの ping 要求には、架空のユーザー名が含まれます。 NPS では、これらの要求を処理するとき、イベントとアカウンティング ログは、さらに難しく有効なレコードを追跡するため、アクセス拒否のレコードでいっぱいになっています。

レジストリ エントリを構成するときに**ユーザー名を ping**、NPS で他のサーバーに対して ping 要求のユーザー名の値のレジストリ エントリの値に一致します。 A**ユーザー名を ping**レジストリ エントリは、RADIUS プロキシ サーバーとネットワーク アクセス サーバーによって送信された架空のユーザー名 (またはユーザー名パターンでは、変数を使用して、架空のユーザー名と一致する) を指定します。 NPS が一致する ping 要求を受け取った場合、**ユーザー名を ping**レジストリ エントリの値、NPS は、要求を処理せずに、認証要求を拒否します。 NPS は、イベント ログを解釈を容易にログ ファイル、架空のユーザー名を含むトランザクションを記録しません。

**ユーザー名を ping**既定ではインストールされません。 追加する必要があります**ユーザー名を ping**レジストリにします。 レジストリ エディタを使用してレジストリにエントリを追加することができます。

>[!CAUTION]
>レジストリを誤って編集すると、システムを著しく壊す恐れ可能性があります。 レジストリに変更を加える前に、コンピューター上の重要なデータをバックアップしてください。

### <a name="to-add-ping-user-name-to-the-registry"></a>レジストリへの ping のユーザー名を追加するには

文字列値としては、ローカルの Administrators グループのメンバーが Ping のユーザー名を次のレジストリ キーに追加できます。

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **名前**: `ping user-name`
- **種類**: `REG_SZ`
- **データ**:*ユーザー名*

>[!TIP]
>1 つ以上のユーザー名を示すために、**ユーザー名を ping**値にワイルドカード文字を含む、DNS 名などの名前パターンを入力**データ**します。
