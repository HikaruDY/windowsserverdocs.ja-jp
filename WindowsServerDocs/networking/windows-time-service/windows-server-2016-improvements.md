

## <a name="windows-server-2016-improvements"></a>Windows Server 2016 の機能強化
### <a name="windows-time-service-and-ntp"></a>Windows タイム サービスと NTP
Windows Server 2016 には、時間を修正し、UTC と同期するローカル クロックの条件を使用して、アルゴリズムが改善します。  NTP 時刻のオフセットを計算する 4 つの値を使用してクライアントの要求/応答、サーバー要求/応答のタイムスタンプに基づきます。  ただし、ネットワークは、ノイズの多い、NTP のネットワークの輻輳やその他のネットワーク待機時間に影響を与える要因によりデータの急増があります。  Windows 2016 アルゴリズムは安定性と正確なクロックでさまざまな手法の番号を使用してこのノイズを平均します。  さらに、ソースを使用します正確な時刻の参照により、高解像度を向上 API。  これらの改善により、ドメイン全体で UTC に対して 1 ミリ秒精度を実現するためにできなくなっています。

### <a name="hyper-v"></a>Hyper-V
Windows 2016 には、HYPER-V TimeSync サービスが向上しました。 機能強化には、VM の起動、または VM の復元や w32time に提供されるサンプルの割り込みの待機時間の修正により正確な最初の時間が含まれます。  この機能強化により、常には、RMS (ルート平均 2 乗、差異を示す)、ホストの 10µs 内の 75% の負荷を持つマシン上でも、50µs。 詳細については、次を参照してください。 [Hyper-v アーキテクチャ](https://msdn.microsoft.com/library/cc768520.aspx)します。

> [!NOTE]
> 負荷は、バランスの取れたプロファイルを使用して prime95 ベンチマークを使用して作成されました。

また、ホストがゲストに報告する階層レベルより透過的です。  以前、ホストでは、その正確性に関係なく、2 の固定階層があります。  Windows Server 2016 での変更により、ホストは、1 つの仮想ゲストのチャンスにつながりますホスト階層よりも大きい階層を報告します。  ホストの階層は、そのソース時刻に基づいて通常の方法で w32time によって決定されます。  ドメインには、ゲストは、既定では、ホストではなく、最も正確なクロックを検索は、Windows 2016 が参加しています。  Windows 2012R2 での上下のドメインに参加しているマシンの HYPER-V タイム プロバイダー設定を手動で無効にすることをお勧めしますが、このためでした。

### <a name="monitoring"></a>監視
パフォーマンス モニター カウンターが追加されました。  監視、および時刻の精度のトラブルシューティングを行うこれらベースラインにできます。  これらのカウンターは次のとおりです。

カウンター|説明|
----- | ----- |
時刻のオフセットを計算します。|   W32Time サービスによってマイクロ秒単位で計算される、システム クロックと、選択したタイム ソースの間のオフセットの絶対時間。 新しい有効なサンプルが利用できる場合、計算時間は、このサンプルで示されるタイム オフセットで更新されます。 これは、ローカルの時計の実際の時間オフセットです。 W32time は、このオフセットを使用してクロックの修正を開始し、ローカル クロックを適用する必要がある残りの時間オフセットでのサンプル間の計算時間を更新します。 クロックの精度は、低のポーリング間隔でこのパフォーマンス カウンターを使用して追跡できます (例: 256 秒以下) の目的のクロックの精度の制限よりも小さくするためのカウンター値を探します。|
クロック周波数の調整| あたり 12億部分で W32Time がローカル システム クロックに加えた絶対クロック周波数に調整します。 このカウンターは、W32time が実行されている操作の視覚化に役立ちます。|
NTP ラウンドト リップ遅延|    最新のラウンド トリップ遅延マイクロ秒単位でサーバーから応答の受信、NTP クライアントで発生します。 これは、時間経過 NTP クライアントの NTP サーバーへの要求を送信して、サーバーから有効な応答の受信にします。 このカウンターは、NTP クライアントでの遅延を特徴付けることができます。 拡大またはさまざまなラウンド トリップは、順番を NTP 時刻の同期の精度に影響する可能性があります NTP 時間計算をノイズを追加できます。|
NTP Client Source Count|    NTP クライアントによって使用されている NTP タイム ソースの有効な番号です。 これは、このクライアントの要求に応答しているサーバーの時間の作業中、個別の IP アドレスの数です。 この数は、ピア名と reach の機能の現在の DNS 解決によって、構成されたピアより大きいか小さい可能性があります。|
NTP サーバーの受信要求|   NTP サーバー (要求数/秒) が受信した要求の数。|
NTP サーバーの発信応答|  NTP サーバー (応答数/秒) から返される要求の数。|

最初の 3 つのカウンターは、精度の問題のトラブルシューティングのシナリオを対象します。  時刻の精度のトラブルシューティングと NTP セクション未満[ベスト プラクティス](#BestPractices)が詳しく説明します。
最後の 3 つのカウンターは、NTP サーバーのシナリオに対応しする際に役立つ判断基準と、現在のパフォーマンスはします。

### <a name="configuration-updates-per-environment"></a>環境ごとの構成の更新
次に、Windows 2016 と以前のバージョン間の各ロールの既定の構成の変更について説明します。  Windows Server 2016 および Windows 10 Anniversary Update (ビルド 14393) の設定になった一意これが別々 の列として表示されますが理由です。 

|ロール|設定|Windows Server 2016|Windows 10|Windows Server 2012 R2</br>Windows Server 2008 R2</br>Windows 10|
|---|---|---|---|---|
|**スタンドアロン/Nano Server**||||
| |*タイム サーバー*|time.windows.com|該当なし|time.windows.com|
| |*ポーリング間隔*|64-1024 (秒)|該当なし|週 1 回|
| |*クロックの更新頻度*|1 秒に 1 回|該当なし|1 時間に 1 回|
|**スタンドアロン クライアント**||||
| |*タイム サーバー*|該当なし|time.windows.com|time.windows.com|
| |*ポーリング間隔*|該当なし|1 日 1 回|週 1 回|
| |*クロックの更新頻度*|該当なし|1 日 1 回|週 1 回|
|**ドメイン コント ローラー**||||
| |*タイム サーバー*|PDC/GTIMESERV|該当なし|PDC/GTIMESERV|
| |*ポーリング間隔*|64-1024 秒|該当なし|1024-32768 秒|
| |*クロックの更新頻度*|1 日 1 回|該当なし|週 1 回|
|**ドメイン メンバー サーバー**||||
| |*タイム サーバー*|DC|該当なし|DC|
| |*ポーリング間隔*|64-1024 秒|該当なし|1024-32768 秒|
| |*クロックの更新頻度*|1 秒に 1 回|該当なし|5 分ごとに 1 回|
|**ドメイン メンバー クライアント**||||
| |*タイム サーバー*|該当なし|DC|DC|
| |*ポーリング間隔*|該当なし|1204-32768 秒|1024-32768 秒|
| |*クロックの更新頻度*|該当なし|5 分ごとに 1 回|5 分ごとに 1 回|
|**HYPER-V ゲスト**||||
| |*タイム サーバー*|ホストと時間のサーバーの階層に基づき、最適なオプションを選択します。|ホストと時間のサーバーの階層に基づき、最適なオプションを選択します。|既定値はホスト|
| |*ポーリング間隔*|上記のロールに基づく|上記のロールに基づく|上記のロールに基づく|
| |*クロックの更新頻度*|上記のロールに基づく|上記のロールに基づく|上記のロールに基づく|

>[!NOTE]
>HYPER-V で linux の場合、次を参照してください。、 [、Hyper-v ホストに使用できるように Linux](#AllowingLinux)以下のセクション。

### <a name="impact-of-increased-polling-and-clock-update-frequency"></a>ポーリングとクロック更新頻度の影響
正確な時刻を提供するために、若干の調整をより頻繁に行う周波数と時計の更新をポーリングするための既定値を増加します。  これによりより多くの UDP/NTP トラフィック、ただし、これらのパケットが小さいため、ほとんど存在する必要がありますまたはブロード バンド リンク経由での影響はありません。 利点が、その時間はさまざまなハードウェア、および環境上で見やすい必要があります。

バックアップ バッテリのデバイスのポーリングの頻度を増やすことと、問題が発生することができます。  デバイスのバッテリには、になっている間の時間を格納しないでください。  復帰すると、時計を頻繁に修正が必要です。  ポーリングの頻度を増やすと、クロックが不安定になると、および多くの電力を使用することもできます。  Microsoft では、クライアントの既定の設定を変更しないことをお勧めします。

ドメイン コント ローラーは、AD ドメインの NTP クライアントからの増加の更新プログラムの乗算の効果を使用しても最小影響を受ける必要があります。  NTP は、その他のプロトコルと周辺の影響と比較して、小規模なリソースの消費が。  Windows Server 2016 の新しい設定の影響する前に他のドメインの機能の制限に到達する可能性が高くなりますが。  時間を単純な NTP のよりも小さい正確に同期される傾向にあり、セキュリティで保護された NTP を使用して active Directory が、PDC からクライアントの 2 つの階層をスケール アップは既に確認しました。

、控えめな計画としては、コアあたり 1 秒あたり 100 個の NTP 要求を予約する必要があります。  たとえばの 4 つのコアを持つ 4 つの Dc から成るドメイン、はず毎秒 1600 の NTP 要求を処理するためにします。  64 秒に 1 回、同期の時刻に構成されている 10 個の k クライアントがあり、時間の経過と共に、要求が均一に受信した場合は、10,000/64 を参照してくださいまたは約 160 要求数/秒がすべての Dc に分散します。  1600 NTP 要求数/秒この例に基づく範囲内に簡単になります。  これらは慎重に計画に関する推奨事項であり、もちろん、大規模な依存関係があるネットワーク、プロセッサ速度、負荷のように、常に基準計画およびテスト環境内で。

Dc が 40% を超える大きな CPU 負荷を実行している場合これはほぼ確実に NTP の応答にノイズを追加、ドメイン内、時間精度に影響を重要です。  ここでも、実際の結果を理解するための環境でテストする必要があります。

## <a name="time-accuracy-measurements"></a>時間精度の測定
### <a name="methodology"></a>方法論
Windows Server 2016 の時刻の精度を測定する、さまざまなツール、メソッド、および環境を使用しています。  これらの手法を使用するには測定、環境を調整して、精度の結果が、要件を満たしているかどうかを判断します。 

高精度の NTP サーバー GPS ハードウェアが 2 つのドメイン ソース時計を行いました。  測定値は、さまざまな製造元からインストールされている高精度の GPS ハードウェアにもあるのも、テスト マシンを別の参照を使用しました。  テストの一部は、正確で信頼性の高いクロック ソースだけでなく、ドメインのクロックのソースの参照として使用する必要があります。

4 つの方法を使用して、物理および仮想マシンの両方を使用した精度を測定しました。 複数のメソッドには、結果を検証する独立した手段が提供されます。


1. 別の GPS ハードウェアが、参照をテスト コンピューターに対して w32tm によって条件が設定されるローカルの時計を測定します。  
2.  W32tm"stripchart"を使用するクライアントに NTP サーバーからのメジャー NTP の ping
3.  W32tm"stripchart"を使用して、NTP サーバーをクライアントからのメジャー NTP の ping
4.  タイム スタンプ カウンター (TSC) を使用してゲストをホストから HYPER-V のメジャーの結果します。  このカウンターは、両方のパーティションのパーティションとシステム時刻の両方で共有されます。  仮想マシンのホストの時間と、クライアントの時間の差を計算しました。  測定値は、同時に発生しないため、ゲストからホストの時間を補間するのに TSC クロックを使用します。  また、API で遅延と待機時間を TSV クロック要素を使用します。

W32tm が組み込まれておりには、テストと使用状況のオープン ソースとして、テスト中に使用して、その他のツールは GitHub 上の Microsoft リポジトリを使用できます。  リポジトリの WIKI では、測定を行うツールを使用する方法の詳細についてがあります。

> [https://github.com/Microsoft/Windows-Time-Calibration-Tools](https://github.com/Microsoft/Windows-Time-Calibration-Tools)

次に示すテスト結果は、テスト環境のいずれかに加えられた測定値のサブセットです。  開始時間の階層、および時間階層の最後の子ドメインのクライアントで管理されている精度について説明します。  比較については、同じマシン 2012 ベースのトポロジでこれと比較されます。

### <a name="topology"></a>トポロジ
比較については、Windows Server 2012 r2 と Windows Server 2016 がベースのトポロジの両方をテストしました。  両方のトポロジは、インストールされている GPS クロックのハードウェアで Windows Server 2016 コンピューターを参照する 2 つの物理的な HYPER-V ホスト コンピューターで構成されます。  各ホストでは、次のトポロジに従って並んでいる 3 つのドメイン参加済み windows ゲストが実行されます。  線は、時間の階層、および使用されるプロトコル/トランスポートを表します。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology1.png)

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology2.png)

### <a name="graphical-results-overview"></a>グラフィカルな結果の概要
次の 2 つのグラフは、上記のトポロジに基づくドメイン内の 2 つの特定メンバーの時刻の精度を表します。  各グラフが表示されます、Windows Server 2012R2 とオーバーレイ、2016 の結果の両方を視覚的に改善を示します。  精度をホストと比較して、ゲスト マシン内から測定されました。  グラフィック データは、そのテストのセット全体のサブセットを表し、最良の場合と最悪のシナリオを示しています。  

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology3.png)

### <a name="performance-of-the-root-domain-pdc"></a>ルート ドメインの PDC のパフォーマンス
ルート PDC は、正確性と安定性の両方があることがわかっている GPS ハードウェアで Windows Server 2016 である、HYPER-V ホスト (VMIC を使用) に同期されます。  これは、緑の網掛けとして表示されている 1 ms 精度のための重要な要件です。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart1.png)

### <a name="performance-of-the-child-domain-client"></a>子ドメインのクライアントのパフォーマンス
子ドメインのクライアントは、ルート PDC に通信して、子ドメインの PDC にアタッチされます。  内の 1 時間も ms 要件。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart2.png)


### <a name="long-distance-test"></a>時間の長い距離のテスト
次の図は、Windows Server 2016 で 6 つの物理ネットワーク ホップを 1 つの仮想ネットワークのホップを比較します。  2 つのグラフは、透明度が重複するデータを表示する互いに重なって表示されます。  ネットワーク ホップ数の増加、待機時間が長くより大きな時間の偏差を意味します。  グラフは拡大し、その 1 ミリ秒の境界、緑色の領域によって表されるが大きくなっています。  時刻差が 1 でまだご覧のように、複数のホップを使用した ms。  これは悪影響シフトされ、ネットワークの悪さを示しています。  もちろん、すべてのネットワークが異なると測定値は、さまざまな環境要因に依存します。

![Windows タイム](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart3.png)

## <a name="BestPractices"></a>正確な計時のベスト プラクティス
### <a name="solid-source-clock"></a>Solid ソース クロック
マシンには、ほどでは、ソースのクロックと同期としてのみです。  1 を実現するために ms の正確さ、または必要な GPS ハードウェア時間アプライアンス マスター ソース クロックとして参照するネットワーク上。  Time.windows.com の既定値を使用して、可能性があります、安定性とローカル タイム ソースは提供されません。  さらに、ソース クロックからさらに、利用できるよう、ネットワークは、精度に影響します。  マスター ソース クロックを持つ各データ センターが最適な精度の必要です。

### <a name="hardware-gps-options"></a>ハードウェアの GPS オプション
正確な時刻を提供できるさまざまなハードウェア ソリューションがあります。  一般に、現在、ソリューションは GPS のアンテナに基づいています。  オプション ボタンや専用の行を使用して、ダイヤルアップ モデム ソリューションもあります。  アプライアンスのいずれかとしてネットワークに接続、または PC、PCIe または USB デバイス経由で Windows のインスタンスに接続します。  さまざまなオプションはさまざまなレベルの精度を提供し、として常に、結果は、環境に依存します。  変数精度に影響するにはには、GPS の可用性、ネットワークの安定性と負荷、および PC のハードウェアが含まれます。  これらは、安定性と正確な時間の要件を説明したようには、ソースの時計を選択するときに、すべての重要な要素です。

### <a name="domain-and-synchronizing-time"></a>ドメインと時刻の同期
ドメイン メンバー コンピューターを決定する、ドメインの階層を使用して時刻を同期するソースとして使用します。  各ドメインのメンバーでは、クロック ソースとして保存してを同期する別のコンピューターを紹介します。  各型のドメインのメンバーでは、時刻の同期のクロックのソースを検索するために異なる一連のルールに従います。  フォレスト ルート PDC は、すべてのドメインの既定のクロック ソースです。  以下に示すは、さまざまなロールと、ソースの検索方法について大まかな説明を示します。


- **PDC ロールを持つドメイン コント ローラー** – このマシンは、ドメインの信頼できるタイム ソース。 以外の場合、親ドメインの DC と同期する必要があり、ドメインで使用可能な最も正確な時間がある場所[GTIMESERV](#GTIMESERV)ロールが有効にします。 
- **その他のドメイン コント ローラー** – このマシンは、クライアントとドメインのメンバー サーバーのタイム ソースとして機能します。 DC は、独自のドメインの PDC または自身の親ドメインの任意の DC と同期できます。
- **メンバーのクライアント/サーバー** – このマシンは DC などの独自のドメインまたは DC の PDC または親ドメインの PDC 同期できます。

使用可能な候補に基づき、スコア付けシステムは、最適なタイム ソースの検索に使用されます。  このシステムでは、タイム ソースとその相対的な位置の信頼性が考慮されます。  これは、ときに時間は、サービスの開始後に発生します。  時間の同期方法の詳細に制御する必要がある場合は、特定の場所で適切なタイム サーバーを追加または冗長性を追加できます。  参照してください、[指定をローカル信頼性の高いタイム サービスを使用して GTIMESERV](#GTIMESERV)詳細についてはします。

#### <a name="mixed-os-environments-win2012r2-and-win2008r2"></a>OS の混在環境 (Win2012R2 および Win2008R2)
純粋な Windows Server 2016 ドメイン環境が最適な精度の必要なときに利点がありますが混在する環境でします。  Windows Server 2016 HYPER-V は、Windows 2012 のドメインを展開すると、のみ、ゲストが場合も Windows Server 2016 が上記のように機能強化のため、ゲストが役立ちます。  Windows Server 2016 PDC はより安定したソースことがアルゴリズムの向上のためのより正確な時刻を提供できるようにします。  PDC の交換できない可能性があります、オプション、代わりにでは、Windows Server 2016 DC を追加することができます、 [GTIMESERV](#GTIMESERV)というが、アップグレード ドメインの精度のセットをロールバックします。  Windows Server 2016 の DC は、ダウン ストリーム クライアントに最適なタイミングを配信できます、ただし、そのソース NTP 時刻と同じにはのみです。

、前述のようにも Windows Server 2016 では、クロックのポーリングと更新の頻度が変更されました。  これらは、ダウンレベルの Dc に手動で変更できます。 またはグループ ポリシーを使用して適用します。  これらの構成をテストしていない、中を Win2008R2 と Win2012R2 でも動作し、いくつかのメリットをもたらします。

Windows Server 2016 は、その結果、システムの調整が行われた後にすぐにドリフトされている時間を維持する正確な時刻を保持する複数の問題を抱えていました。 前に、のバージョン。  このためは、頻繁に正確な NTP ソースからタイム サンプルを取得して、データのローカル クロックを安定化が内のサンプリング期間中、ダウンレベルの OS バージョン上に保持する最適なタイミングでその結果、システム クロックの誤差が小さいにつながります。 観察対象の最適な精度は、高精度の設定で構成された、Windows Server 2012R2 の NTP クライアントが、正確な Windows 2016 の NTP サーバーからの時間を同期するときに、約 5 ミリ秒をしました。

ゲストのドメイン コント ローラーに関連する一部のシナリオで、HYPER-V TimeSync サンプルはドメインの時刻の同期が中断されることができます。  これは、Server 2016 HYPER-V ホストで実行されている Server 2016 ゲストの問題を不要になったにする必要があります。

W32time するためのサンプルを提供することから、HYPER-V TimeSync サービスを無効にするには、次のゲスト レジストリ キーを設定します。

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider 
    "Enabled"=dword:00000000

#### <a name="AllowingLinux"></a>Linux が HYPER-V ホストの時間を使用することができます。
HYPER-V で実行されている Linux ゲストの場合、クライアントは通常、NTP サーバーに対して時刻同期の NTP デーモンを使用する構成します。  Linux ディストリビューションが TimeSync バージョン 4 のプロトコルをサポートし、Linux ゲスト TimeSync 統合サービスを有効になっているが場合、は、ホストの時間に対して同期されます。 これにより一貫性のない時間の両方の方法が有効になっている場合を維持することです。

ホストの時間に対してのみを同期するには、をお勧め NTP 時刻の同期を無効にするいずれかで。

- Ntp.conf ファイルに任意の NTP サーバーを無効にします。
- または、NTP デーモンを無効にします。

この構成では、タイム サーバー パラメーターは、このホストが。  そのポーリング頻度は 5 秒と、クロックの更新頻度は 5 秒間でも。

NTP 経由でのみ、同期、ゲストで TimeSync 統合サービスを無効にすることをお勧めします。

> [!NOTE]
> 注:Linux ゲストの正確な時刻のサポートが最新上位 Linux カーネルでのみサポートされる機能を必要とし、広くで使用可能なすべての Linux ディストリビューションまだものはありません。 参照してください[Windows 上の HYPER-V ではサポートされている Linux および FreeBSD の仮想マシン](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows)ディストリビューションのサポートの詳細についてはします。

#### <a name="GTIMESERV"></a>GTIMESERV を使用して、ローカルの信頼性の高いタイム サービスを指定します。
1 つまたは複数のドメイン コント ローラーを指定するには正確なソースのクロックと GTIMESERV、良いタイム サーバーを使用して、フラグを設定します。  たとえば、GPS ハードウェアが搭載されて特定のドメイン コント ローラーを GTIMESERV としてフラグが設定できます。  ドメインを参照して、GPS ハードウェアに基づいてクロックこのことが保証されます。

> [!NOTE]
> ドメイン フラグの詳細についてで見つかんだことができます、 [MS ADTS プロトコル ドキュメント](https://msdn.microsoft.com/library/mt226583.aspx)します。

TIMESERV は別関連ドメイン サービスを示す、コンピューターに現在の権限があるかどうかをフラグ DC には、接続が失われた場合は変更できます。  この状態の DC には、「不明な階層」NTP を使用して照会されたときに返されます。  複数回を試した後、DC は、システム イベントのタイム サービス イベント 36 を記録します。

として、GTIMESERV DC を構成する場合は、この構成できます、次のコマンドを使用して手動で。  ここで、DC で別のマシンを使用して、マスターのクロックとは。  アプライアンスまたは専用のマシンを指定できます。

    w32tm /config /manualpeerlist:”master_clock1,0x8 master_clock2,0x8” /syncfromflags:manual /reliable:yes /update

> [!NOTE]
> 詳細については、次を参照してください[、Windows タイム サービスを構成する。](https://technet.microsoft.com/library/cc731191.aspx)

ドメイン コント ローラーにインストールされている GPS ハードウェアがある場合は、次の手順を使用して、NTP クライアントを無効にし、NTP サーバーを有効にする必要があります。

NTP クライアントを無効にして開始し、これらのレジストリ キー変更を使用して、NTP サーバーを有効にします。

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpClient /v Enabled /t REG_DWORD /d 0 /f

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpServer /v Enabled /t REG_DWORD /d 1 /f

次に、Windows タイム サービスを再起動します。

    net stop w32time && net start w32time

最後に、このコンピューターを使用して信頼性の高いタイム ソースを持つことを示します。
   
    w32tm /config /reliable:yes /update

変更が正しく実行されていることを確認するには、次に示す結果に影響する次のコマンドを実行できます。 

    w32tm /query /configuration

値|予期される設定|
----- | ----- |
AnnounceFlags|  5 (ローカル)|
NtpServer   |(ローカル)|
DllName |C:\WINDOWS\SYSTEM32\w32time します。DLL (ローカル)|
有効 |1 (ローカル)|
NtpClient|  (ローカル)|

    w32tm /query /status /verbose

値|  予期される設定|
----- | ----- |
階層|    1 (プライマリ リファレンス - syncd ラジオ クロックで)|
ReferenceId|    0x4C4F434C (ソース名。「ローカル」)|
Source| ローカル CMOS クロック|
フェーズ オフセット|   0.0000000s|
サーバーの役割|    576 (信頼性の高いタイム サービス)|

#### <a name="windows-server-2016-on-3rd-party-virtual-platforms"></a>サード パーティの仮想プラットフォームでの Windows Server 2016
Windows を仮想化されたときに既定では、ハイパーバイザーが時間を提供する責任を負います。  ただし、Active Directory が正常に動作するためにドメイン コント ローラーと同期する必要があるメンバーがドメインに参加しています。  ゲストとホスト、サード パーティの仮想プラットフォームの間の時間の仮想化を無効にすることをお勧めします。

#### <a name="discovering-the-hierarchy"></a>階層を検出します。
マスター クロック ソースに時間階層のチェーンには、ドメインでは、動的にネゴシエートされたが、ためには、タイム ソースとチェーン マスター ソース クロックを認識して、特定のコンピューターの状態を照会する必要があります。  これは、時間の同期に関する問題の診断に役立ちます。

付与してトラブルシューティングを行う、特定のクライアント最初の手順では、この w32tm コマンドを使用して、そのタイム ソースを理解します。

    w32tm /query /status

結果は、特に、ソースを表示します。  ソースでは、相手のドメインで時間を同期することを示します。  これは、このマシンの時間階層の最初の手順です。
上記のソースのエントリを使用して、次に、/StripChart パラメーターを使用して、チェーン内で、[次へ] のタイム ソースを検索します。

    w32tm /stripchart /computer:MySourceEntry /packetinfo /samples:1

便利で、次のコマンドは、指定されたドメイン内で見つかった各ドメイン コント ローラーの一覧を表示し、結果は、各パートナーを決定することができますを出力します。  このコマンドは、手動で構成されているマシンが含まれます。
    
    w32tm /monitor /domain:my_domain

リストを使用して、ドメインを使用して、結果をトレースし、各ステップで時間オフセットだけでなく、階層を理解できます。  時刻オフセットが大幅に低下を取得するポイントを配置することにより、不適切な時間のルートを特定できます。  その時刻が正しくない理由を有効にして理解して、そこから[w32tm ログ](#W32Logging)します。 

#### <a name="using-group-policy"></a>グループ ポリシーを使用
できますグループ ポリシーを使用するより厳密な精度を実現たとえば、特定の NTP サーバーを使用または制御方法ダウンレベルの OS が構成されている仮想化する場合は、クライアントを割り当てること。  
考えられるシナリオと関連するグループ ポリシー設定の一覧を次に示します。

**ドメインを仮想化**- HYPER-V ホストが、このレジストリ エントリを無効にできますのではなく、自分のドメインと時間を同期するように Windows 2012R2 で仮想化ドメイン コント ローラーを制御するためにします。   PDC で HYPER-V ホストでは、安定性の高いタイム ソースを提供します。 エントリを無効にするはありません。  レジストリ エントリでは、変更した後は、w32time サービスを再起動することが必要です。

    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider]
    "Enabled"=dword:00000000

**精度の機密性の高い負荷**- 時間精度の機密性の高いワークロードでは、NTP サーバーを設定するマシンのグループを構成でき、更新頻度をポーリングし、時計など時間の設定、関連します。  これは通常、ドメインによって処理されるが、制御する場合は、マスターのクロックを直接指す特定のコンピューターを対象にできます。

グループ ポリシー設定|   新しい値|
----- | ----- |
NtpServer|  ClockMasterName、0x8|
MinPollInterval|    6 – 64 秒|
MaxPollInterval|    6|
UpdateInterval| 100-1 秒あたり 1 回|
EventLogFlags|  3 – すべての特殊な時間のログ記録|

> [!NOTE]
> NtpServer と EventLogFlags の設定は System\Windows タイム Service\Time プロバイダーが、Windows NTP クライアントの構成設定を使用して下にあります。  他の 3 は、グローバル構成設定を使用して System\Windows タイム サービスの下に配置されます。

**リモート精度機密性の高い負荷リモート**– インスタンス小売およびペイメント クレジット業界 (PCI) のブランチのドメインにシステムでは、Windows は現在のサイト情報を使用し、手動の NTP がない限り、ローカルの DC を検索する DC ロケーターのタイム ソース構成されています。  この環境には、1 秒の正しい時刻に高速の収束を使用して、正確性が必要です。  このオプションは、クロックを逆方向に移動する w32time サービスを使用できます。  許容されるとこの要件を満たしている場合は、次のポリシーを作成できます。   として任意の環境でテストし、基準に、ネットワーク。 

グループ ポリシー設定|   新しい値|
----- | ----- |
MaxAllowedPhaseOffset|  1、2 つ目は、上の複数の場合は、正しい時刻にまま時計を設定します。|

MaxAllowedPhaseOffset 設定はグローバル構成設定を使用して System\Windows タイム サービスの下にあります。

> [!NOTE]
> グループ ポリシーと関連するエントリの詳細については、次を参照してください。 [Windows タイム サービス ツール](windows-time-service-tools-and-settings.md)と TechNet の記事を設定します。

## <a name="azure-and-windows-iaas-considerations"></a>Azure と Windows IaaS に関する考慮事項

### <a name="azure-virtual-machine-active-directory-domain-services"></a>Azure の仮想マシン:Active Directory Domain Services
Active Directory Domain Services を実行する Azure VM が既存のオンプレミスの一部である場合、Active Directory フォレスト、しの TimeSync(VMIC) を無効にする必要があります。 これは、1 つの時間同期階層を使用して、物理および仮想、フォレスト内のすべての Dc を許可します。 ベスト プラクティスに関するホワイト ペーパーを参照してください["を実行しているドメイン コント ローラーで、HYPER-V"](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx)

### <a name="azure-virtual-machine-domain-joined-machine"></a>Azure の仮想マシン:ドメインに参加しているコンピューター
仮想または物理、ドメインに既存の Active Directory フォレストに参加しているコンピューターをホストしている場合のベスト プラクティスはゲスト TimeSync を無効にし、時間の構成を使用して、ドメイン コント ローラーと同期する W32Time が構成されていることを確認種類 = NTP5

### <a name="azure-virtual-machine-standalone-workgroup-machine"></a>Azure の仮想マシン:スタンドアロンのワークグループ コンピューター
場合は、Azure VM がドメインに参加していないもに、ドメイン コント ローラーは、既定の時間構成を保持し、VM のホストとの同期があるお勧めします。

## <a name="windows-application-requiring-accurate-time"></a>正確な時刻を必要とする Windows アプリケーション
### <a name="time-stamp-api"></a>API のタイムスタンプ
(UTC) と時間の経過しないに関して最高の精度を必要とするプログラムを使用する必要があります、 [GetSystemTimePreciseAsFileTime API](https://msdn.microsoft.com/library/windows/desktop/Hh706895.aspx)します。  これにより、アプリケーション、Windows タイム サービスによって条件が設定のシステム時刻を取得します。

### <a name="udp-performance"></a>UDP のパフォーマンス
ベース フィルター エンジンのポートは UDP 通信トランザクションとは、待機時間を最小限に抑えるのレジストリのエントリから除外するポートの範囲を構成に使用できるいくつかの関連アプリケーションがあるかどうか。  両方の待機時間短縮され、スループットが上げるされます。  ただし、レジストリの変更は、経験豊富な管理者に制限する必要があります。  さらに、この回避策は、ファイアウォールによって保護からのポートを除外します。  詳細については以下の記事リファレンスを参照してください。

Windows Server 2012 と Windows Server 2008 は、まず修正プログラムをインストールする必要があります。  このサポート技術情報の記事を参照することができます。[Windows 8 および Windows Server 2012 では、マルチキャストの受信側のアプリケーションを実行するときに、データグラムの損失](https://support.microsoft.com/kb/2808584)

### <a name="update-network-drivers"></a>ネットワーク ドライバーを更新します。
一部のネットワーク ベンダーは、ドライバーの待機時間と UDP パケットをバッファリングに関してパフォーマンスを向上させるドライバーの更新プログラムがあります。  UDP のスループットを支援する更新プログラムがあるかどうかをネットワーク ベンダーに問い合わせてください。

## <a name="logging-for-auditing-purposes"></a>監査ログ
時間のトレースの規制を遵守するには、w32tm ログ、イベント ログおよびパフォーマンス モニターの情報を手動でアーカイブできます。  後で、アーカイブ済みの情報は、過去の特定の時点でのコンプライアンスの証明に使用できます。  次の要因は、精度を示すために使用されます。


1. クロックの時刻のオフセットの計算のパフォーマンス モニター カウンターを使用して精度。  これには、必要な精度で使用するクロックが表示されます。
2.  クロック ソースは w32tm ログで「からの応答のピア」を検索します。   次のメッセージ テキストは、IP アドレスまたは VMIC で、タイム ソースと参照クロックのチェーン内の次の検証について説明します。
3.  W32tm ログを使用することを検証する条件の状態をクロック"ClockDispl 統制します。\*傾斜\*時間\*"が発生しています。  これは、時にその w32tm がアクティブなを示します。

### <a name="event-logging"></a>イベントのログ記録
完全なストーリーを取得するには、イベント ログ情報も必要があります。  システム イベント ログを収集してタイム サーバーがフィルター処理で、Microsoft Windows カーネル ブート、Microsoft Windows のカーネル全般、ことができますが変更された場合、たとえば、サード パーティの他の影響があるかどうかを検出します。  これらのログを外部からの干渉を排除するために必要なことがあります。  グループ ポリシー イベント ログは、ログに書き込まれるに影響を与えることができます。  使用してグループ ポリシーの詳細については、上のセクションを参照してください。

### <a name="W32Logging"></a>デバッグ ログを W32time
監査のため w32tm を有効にするのには、次のコマンドは、ソース クロックを示し、クロックの定期的な更新プログラムが表示されるログを有効します。  新しいログ記録を有効にするサービスを再起動します。  

詳細については、次を参照してください。[デバッグで、Windows タイム サービスのログ記録を有効にする方法](https://support.microsoft.com/kb/816043)します。

    w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-73,103,107,110

### <a name="performance-monitor"></a>パフォーマンス モニター
Windows Server 2016 の Windows タイム サービスは、監査ログを収集するために使用できるパフォーマンス カウンターを公開します。  これらは、ローカルまたはリモートで記録できます。  コンピューター時間のオフセットとのラウンド トリップ遅延時間のカウンターを記録することができます。  
パフォーマンス カウンターのようにそれらをリモートで監視および System Center Operations Manager を使用してアラートを作成します。  たとえば、アラートを使用する必要な精度からずれた時間のオフセットの警報をことができます。  [System Center 管理パック](https://social.technet.microsoft.com/wiki/contents/articles/15251.system-center-management-pack-authoring-guide.aspx)の詳細。

### <a name="windows-traceability-example"></a>Windows の追跡機能の例
W32tm ログ ファイルから 2 つの情報を検証するされます。  最初は、ログ ファイルは、クロックの条件では現在を示す値です。  未解決の時に、Windows タイム サービスによって、時計を規定されているがこれを証明します。

    151802 20:18:32.9821765s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:223 CR:156250 UI:100 phcT:65 KPhO:14307
    151802 20:18:33.9898460s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:64 KPhO:41
    151802 20:18:44.1090410s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:65 KPhO:38

重要な点は、証明 w32time である ClockDispln 統制の付いたメッセージは、システム クロックの対話が表示されます。
 
次に、参照クロックと現在使用されているソース コンピューターを報告する未解決の時刻より前に、ログの最後のレポートを検索する必要があります。  IP アドレスやコンピューターの名前を示すことが、hyper-v ホストと同期 VMIC プロバイダーことが考えられます。  次の例では、10.197.216.105 の IPv4 アドレスを提供します。

    151802 20:18:54.6531515s - Response from peer 10.197.216.105,0x8 (ntp.m|0x8|0.0.0.0:123->10.197.216.105:123), ofs: +00.0012218s

これで、参照時チェーン内の最初のシステムを検証した、参照のタイム ソース上のログ ファイルを調査し、同じ手順を繰り返して必要があります。  これは、GPS、NIST のような既知のタイム ソースなどの物理クロックを取得するまで続行します。  参照クロックは、GPS ハードウェアが、場合は、製造からのログが必要にもあります。

## <a name="network-considerations"></a>ネットワークに関する考慮事項
NTP プロトコルのアルゴリズムでは、ネットワークの対称性を依存関係があります。  ネットワーク ホップ数の増加、としては、非対称の確率が増加します。  表示されます、特定の環境でどのような種類の精度を予測する困難です。 

パフォーマンス モニター、および Windows Server 2016 の新しい Windows 時間カウンター、環境の精度を評価し、基準の作成に使用できます。 さらに、ネットワーク上の任意のコンピューターの現在のオフセットを決定するためのトラブルシューティングを行うことができます。

ネットワーク経由で正確な時刻の 2 つの一般的な規格でがあります。  PTP ([精度タイム プロトコル - IEEE 1588](https://www.nist.gov/el/intelligent-systems-division-73500/introduction-ieee-1588)) ネットワーク インフラストラクチャ上の厳しい要件を持つが、多くの場合、サブ マイクロ秒単位の精度を提供できます。  NTP ([ネットワーク タイム プロトコル – の RFC 1305](https://tools.ietf.org/html/rfc1305)) は拡大のさまざまなネットワークや環境では、管理しやすくなります。 

Windows では、既定では非ドメイン参加済みコンピューターの簡単な NTP (RFC2030) をサポートしています。  呼ばれるセキュリティで保護された NTP を使用してマシンをドメインに参加、 [MS SNTP](https://msdn.microsoft.com/library/cc246877.aspx)RFC1305 と RFC5905 で説明されている認証の NTP 経由で管理できるというメリットを提供するドメインがネゴシエートされたシークレットを活用します。   

ドメインとドメイン非参加しているプロトコルの両方には、UDP ポート 123 が必要です。  NTP のベスト プラクティスの詳細についてを参照してください[ネットワーク タイム プロトコル ベスト現在プラクティスの IETF ドラフト](https://tools.ietf.org/html/draft-ietf-ntp-bcp-00)します。

### <a name="reliable-hardware-clock-rtc"></a>信頼性の高いハードウェア クロック (RTC)
Windows は手順時間ではなく、特定の制限を超えるがクロックを分野ではなく、します。  W32tm クロック更新頻度が、Windows Server 2016 で秒おきにどの既定値の設定を使用して、一定の間隔で、クロックの頻度を調整することを意味します。  頻度が高速化、クロックの背後にある場合は、頻度が長くなる場合これは、.  ただし、クロック周波数の調整の間で、ハードウェア クロックは管理します。  ファームウェアまたはハードウェア クロックで問題があるコンピューターの時刻が正確さに欠けるになります。

これは、テストする必要がある理由の 1 つと、環境内のベースラインです。  「時間のオフセットの計算」パフォーマンス カウンターは、対象とする精度を安定化しない場合、は、ファームウェアが最新の状態を確認する必要がありますがします。  別のテストとして、重複するハードウェア、同じ問題を再現する場合を確認できます。

### <a name="troubleshooting-time-accuracy-and-ntp"></a>時刻の精度と NTP のトラブルシューティング
検出を使用することができますの不正確なタイム ソースを理解するのには、上の階層のセクション。  時刻が NTP ソースからほとんどと見なすと、階層内のポイントを検索する時間のオフセットを見ると、します。  階層構造を理解するとを試して、その特定のタイム ソースが正確な時刻を受信しない理由を理解します。  

異なる時刻でシステムに重点を置いて、次にこれらのツールを使用して、解像度を検索して、問題を特定するための情報を収集します。  以下、UpstreamClockSource 参照には、"w32tm/config/status"を使用して検出されたクロックです。


- システム イベント ログ
- Enable logging using: w32tm logs - w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-300
- w32Time レジストリ キー HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time
- ローカル ネットワークのトレース
- (ローカル コンピューターまたは、UpstreamClockSource) からパフォーマンス カウンター
- W32tm/stripchart/computer:UpstreamClockSource
- PING UpstreamClockSource 待機時間とソースへのホップの数を理解するには
- Tracert UpstreamClockSource

問題|    現象|   解決方法|
----- | ----- | ----- |
ローカルの TSC クロックが安定しません。| いくつか 100us の 1 ~ 2 分ごと制を使用してパフォーマンス モニターの物理コンピューター – 同期クロック安定した、まだが表示されます。 |   ファームウェアの更新または検証別のハードウェアが同じ問題を表示しません。|
ネットワーク待機時間|    w32tm stripchart では、10 ミリ秒未満に以上の RoundTripDelay が表示されます。  遅延のバリエーションの 1 つでは、半分は一方向でのみ、遅延のインスタンスのラウンド トリップ時間のと同じ大きさのノイズが発生します。</br></br>UpstreamClockSource は複数のホップ、PING で示されます。  TTL は、128 近づく必要があります。</br></br>Tracert を使用すると、各ホップで、待機時間を検索できます。    | 時刻の近くのクロック ソースが見つかりません。  1 つのソリューションでは、同じセグメントにソース クロックをインストールするか、手動で地理的に近いソース クロック をポイントします。  ドメインのシナリオでは、GTimeServ の役割を持つコンピューターを追加します。 |  
NTP ソースに確実に到達できません。|    W32tm/stripchart が断続的に「要求がタイムアウトしたか」を返します    |NTP ソースは応答性はありません。|
NTP ソースは応答性はありません。|    NTP クライアント ソースの数、NTP サーバーの受信要求では、NTP サーバーの送信応答のパフォーマンス カウンターを確認し、ベースラインと比較して、使用量を決定します。|    サーバーのパフォーマンス カウンターを使用して、ベースラインに関して負荷が変更されたかどうかを決定します。</br></br>ネットワークの輻輳の問題はありますか。|
最も正確なクロックを使用していないドメイン コント ローラー|    トポロジまたは最近追加された時刻のマスター クロックに変更します。|   w32tm/resync/rediscover|
クライアントの時計がドリフトします。| タイム サービス 36 システム イベント ログまたはテキスト ファイル内のイベント ログを記述する:"NTP クライアントの時間のソース Count"カウンターが 1 から 0 に移動|アップ ストリーム ソースのトラブルシューティングを行うし、パフォーマンスの問題を実行しているかどうかを理解します。|

### <a name="baselining-time"></a>基準時間
最初に、パフォーマンスと、ネットワークの正確性を理解して、問題が発生したときに、将来されたベースラインと比較できるように、ベースラインの設定が重要です。  ルート PDC を基準にする必要あります。 または任意のマシンが、GTIMESRV でマークします。  お勧めするすべてのフォレスト内の PDC の基準。  最後に、重要なの Dc または距離や負荷が高い基準などの興味深い特性を持つマシンを選択、します。

Windows Server 2012 r2 のパフォーマンス カウンターを持たないため、比較に使用できるツールとして w32tm/stripchart がのみがあるにも to ベースライン Windows Server 2016 と 2012 R2 では、便利です。  同じの特性を持つ 2 つのマシンの選択、コンピューターをアップグレードまたは更新後の結果を比較してください。  Windows の時間測定の補遺では、2016 と 2012 の間の詳細な測定を行う方法の詳細についてがあります。

すべて、w32time パフォーマンス カウンターを使用して、少なくとも 1 週間のデータを収集します。  実行時刻の精度が安定した信頼性を提供するのに十分な時間の経過と共に、ネットワーク内のさまざまなアカウントへの参照を十分にあるこのことが保証されます。

### <a name="ntp-server-redundancy"></a>NTP サーバーの冗長性
非ドメイン参加しているマシンまたは PDC で使用される手動の NTP サーバー構成では、サーバーを 1 つ以上の可用性が発生した場合比較的優れた冗長性メジャー。  すべてのソースが正確で安定したと仮定した場合の精度を向上をもそのことがあります。  ただし、トポロジが適切に設計されていない、またはタイム ソースは、安定性がなく、結果として得られる正確性が悪化するのでご注意ください。  サーバー w32time が手動で参照できる、サポートされている時間の上限は 10 です。 

## <a name="leap-seconds"></a>うるう秒
地球のローテーション期間の経過と共に変化、climatic および地質イベントによって発生します。 通常、バリエーションの 1 つは、約 1 秒数年間ごとです。 時間が atomic との差異が大きくなりすぎると、1 秒 (上下) の修正が挿入、うるう秒と呼ばれます。 これは、差が 0.9 秒を超えることはない方法で行います。 この修正は、実際の修正前の 6 か月に発表されます。 Windows Server 2016 では、前に、Microsoft のタイム サービスはうるう秒の単位に認識していなかったが、これに対応する外部タイム サービスに依存していました。 Windows Server 2016 の 時間の増大正確さには、マイクロソフトはうるう秒の問題をより適切なソリューションに取り組んでいます。

## <a name="secure-time-seeding"></a>時間のシード処理をセキュリティで保護します。
Server 2016 で W32time には、時間のシード処理をセキュリティで保護機能が含まれます。 この機能は、SSL 接続の送信からおおよその現在の時刻を決定します。  この時刻値は、ローカル システム クロックを監視し、gross のエラー修正に使用されます。 詳細の機能について[このブログの投稿](https://blogs.msdn.microsoft.com/w32time/2016/09/28/secure-time-seeding-improving-time-keeping-in-windows/)します。  信頼性の高いタイム ソースと時刻のオフセットの監視が含まれる、監視対象のマシンのデプロイでは、時間のシード処理をセキュリティで保護機能を使用し、代わりに、既存のインフラストラクチャに依存することができます。 

以下の手順で、機能を無効にすることができます。

1.  特定のコンピューターで、UtilizeSSLTimeData レジストリ構成の値を 0 に設定します。

    reg は、HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config/v UtilizeSslTimeData/t REG_DWORD/d 0/f を追加します。


2.  なんらかの理由によりすぐにコンピューターを再起動されない場合は、W32time サービスについて、構成の更新を通知できます。 これは、時の監視を停止し、時刻のデータに基づく強制 SSL 接続から収集されます。 

    W32tm.exe /config /update

3.  コンピューターの再起動により、設定をすぐに有効なされも SSL 接続からのデータの収集を停止します。  後半部分では、非常に少量のオーバーヘッドを備え、パフォーマンスの問題をすることはできません。

4.  ドメイン全体でこの設定を適用するに、W32time のグループ ポリシー設定を 0 に UtilizeSSLTimeData 値を設定して、発行、設定してください。  設定は、グループ ポリシーのクライアントによって取得と W32time サービスに通知時の監視と強制 SSL 時間データの使用を停止します。 各マシンが再起動すると、SSL 時間データの収集が停止します。 ドメインにポータブル スリムのラップトップ/タブレットやその他のデバイスがある場合は、このポリシーの変更からそのようなマシンを除外したい場合があります。 バッテリの消耗が最終的に直面してこれらのデバイスと、時間のブートス トラップ機能時のセキュリティで保護されたシード必要があります。


