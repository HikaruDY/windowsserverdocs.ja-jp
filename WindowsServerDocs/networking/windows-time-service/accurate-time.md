---
ms.assetid: 72a90d00-56ee-48a9-9fae-64cbad29556c
title: Windows 2016 の正確な時刻
description: ''
author: shortpatti
ms.author: pashort
manager: brianlic
ms.date: 3/12/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: networking
ms.openlocfilehash: f4b61dbf07fbc21820dd7b9326bbc990e4db3602
ms.sourcegitcommit: fb4e2ace2e0a29e0f6b028f1cb945cab6aa6ee2c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/05/2018
---
# <a name="windows-server-2016-accurate-time"></a>Windows Server 2016 の正確な時刻

>Windows Server 2016 の適用対象:

Windows Server 2016 で時刻の同期の精度は完全な下位古いバージョンの Windows と NTP の互換性を維持しながら、大幅に強化されました。 1 を維持する妥当な動作条件下で ms の正確性に関して、UTC または Windows Server 2016 および Windows 10 Anniversary Update のドメイン メンバーの向上します。

Windows タイム サービスは、クライアントとサーバーの時刻同期プロバイダー プラグイン モデルを使用するコンポーネントです。  Windows では、組み込みのクライアントの 2 つのプロバイダーがあるし、サード パーティ製プラグインを使用できるがあります。 1 つのプロバイダーを使用して[NTP (RFC 1305)](https://tools.ietf.org/html/rfc1305)または[MS NTP](https://msdn.microsoft.com/en-us/library/cc246877.aspx) NTP や MS NTP 準拠参照サーバーにローカル システム時刻を同期します。 他のプロバイダーでは、インストールされた Hyper-v は、し、Hyper-V ホストに仮想マシン (VM) を同期します。  複数のプロバイダーが存在する場合、Windows はルートの遅延、ルートの分散、続けて階層レベルを最初を使用して、最適なプロバイダーを選択し、時間のオフセットの最後にします。

>[!NOTE]
>Windows タイム サービスの概要、見てこの[大まかな概要ビデオ](https://aka.ms/WS2016TimeVideo)します。

<!-- Not sure what to do with the following -->
このトピックの「について説明... これらトピックに正確な時刻有効すると関連します。 

- 機能強化
- 測定値
- ベスト プラクティス

>[!IMPORTANT]
> Windows 2016 の正確性時刻資料によって参照される補遺をダウンロードできます[ここ](http://windocs.blob.core.windows.net/windocs/WindowsTimeSyncAccuracy_Addendum.pdf)します。  このドキュメントでは、詳細については、テストおよび測定の方法を示します。



> [!NOTE] 
> Windows タイム プロバイダー プラグイン モデルが[technet「について](https://msdn.microsoft.com/en-us/library/windows/desktop/ms725475%28v=vs.85%29.aspx)します。
<!-- -->





## <a name="domain-hierarchy"></a>ドメインの階層
ドメインおよびスタンドアロン構成の動作が異なります。

- ドメインのメンバーは、セキュリティで保護された認証を使用して、セキュリティ、および時刻の参照の信頼性を確保する NTP プロトコルを使用します。  ドメインのメンバーは、ドメインの階層と評価システムによって決まりますマスター クロックと同期します。  ドメインでは、各ドメイン コントローラーがより正確な時刻階層と親の DC を指すそれにより、時間 stratums の階層的なレイヤーがあります。  階層は、PDC、フォレスト ルート内の DC またはドメインの適切なタイム サーバーを表す GTIMESERV ドメイン フラグを使用して DC に解決されます。  参照してください、[指定、ローカル信頼性の高いタイム サービスを使用して GTIMESERV](#GTIMESERV)以下のセクションです。

- スタンドアロン コンピューターは、既定で time.windows.com を使用するよう構成します。  この名前は、リソースを所有している Microsoft] をポイントする必要があります ISP によって解決されます。  など、ネットワークの停止のすべての遠隔地に時間参照同期できないようにすることがあります。  ネットワーク トラフィックの負荷および非対称のネットワーク パスが時刻の同期の精度を減らすことがあります。  1 ミリ秒の精度をリモートのタイム ソースに依存することはできません。

Hyper-V ゲストがから選択するには、少なくとも 2 つの Windows タイム プロバイダーであるため、ホストの時間と NTP、表示されるドメインまたはスタンドアロンのいずれかで異なる動作ゲストとして実行しているときにあります。

> [!NOTE] 
> ドメインの階層とスコア システムに関する詳細については、次を参照してください、["Windows タイム サービスは何ですか?"。](https://blogs.msdn.microsoft.com/w32time/2007/07/07/what-is-windows-time-service/) ブログの投稿します。

> [!NOTE]
> 階層が NTP と Hyper-V の両方のプロバイダーで使用される概念とその値を階層内のクロックの場所を示します。  第 1 階層が最上位の時計の予約済みおよび階層 0 と見なされます正確なハードウェアに予約されているし、はあまりまたは遅延関連付けられていません。  階層 2 は、階層 1 のサーバーに階層 2 に階層 3 で説明します。  下位の階層より正確なクロック多くの場合を示して、不一致を検索すること勧めします。  また、W32time は、15 の階層から、または下回った時間のみを受け付けます。  クライアントの階層を表示するを使用して*w32tm/query/status*します。

## <a name="critical-factors-for-accurate-time"></a>正確な時刻の重要な要素
正確な時刻の場合は、次の 3 つの重要な要素があります。

1. **実線ソース クロック**-ソースの時計が安定していて、正確なドメインのニーズにします。 これは通常、GPS デバイスのインストールまたは 3 を考慮して、階層 1 のソースをポイントしていることを意味します。 類似点と比較して、もう 1 つの高度に測定しようとしているが、2 つボートにして、水がある場合、正確性は、ソース ボートが非常に安定性と移動しない場合に最適です。 時間の場合も同じし場合は、移行元コンピューターの時計が安定していない場合は、クロックを同期させるのチェーン全体が影響を受けるし、各段階で拡大します。 それもある必要がありますアクセス可能な接続の中断は、時刻の同期には影響します。 セキュリティで保護された、最後にあります。 参照は適切です。時間を維持または可能性のある悪意のある人物によって運営されて、時間ベースの攻撃に対してドメインを公開する可能性があります。
2. **安定したクライアントのクロック**-安定したクライアントのクロック オシレーターの自然なドリフトが containable であることを保証します。  NTP を条件し、ローカル コンピューター時計を規律可能性のある複数の NTP サーバーから複数のサンプルを使用します。  時間の変更を手順しないではなく速度が低下または NTP 要求の間のローカル クロックを実現するには、正確な時間を簡単にすると常に正確な速度が向上します。  ただし、クライアント コンピューターの時計オシレーターが安定しない場合し調整の間に複数の変動が発生することが、Windows は、クロックの条件を使用して、アルゴリズムが正確に動作しないです。  場合によっては、ファームウェア更新プログラムが正確な時刻の必要な可能性があります。
3. **対称 NTP 通信**-NTP 通信用の接続は対称的であることが重要です。  NTP は、計算を使用して、ネットワークの修正プログラムは対称的前提としている時間を調整します。  NTP パケットは、パス、サーバーに、さまざまな時間のかかるを返す、精度が影響を受けます。  たとえば、ネットワーク トポロジ、または別のインターフェイスの速度のデバイスを経由してルーティングされるパケット内の変更のため、パスの変更でした。


バッテリー駆動デバイス、移植性とモバイルの両方は、さまざまな方法を検討する必要があります。  マイクロソフトの推奨事項に従って正確な時刻を維持することにも、クロック統制された 1 秒、クロックの更新頻度を相互をするのに必要があります。 これらの設定が期待し、省電力モード利用可能な Windows でこのようなデバイスを妨げる可能性がよりも多くのバッテリ電力消費されます。 バッテリー駆動デバイスでは、実行中、クロックを規律および正確な時刻を維持する W32time の機能と干渉しないからすべてのアプリケーションを停止する特定の電源モードもあります。 さらに、モバイル デバイスの時計できません非常に正確な第一に。  環境光の環境に影響を与えるクロックの精度と時間を正確に保持するには、その機能を妨げる可能性があります次にモバイル デバイスが 1 つの環境光条件から移動できます。  そのため、Microsoft 推奨しません高精度の設定で、バッテリー駆動ポータブル デバイスを設定すること。 

## <a name="why-is-time-important"></a>時間が重要な理由  


## <a name="windows-server-2016-improvements"></a>Windows Server 2016 の機能強化
### <a name="windows-time-service-and-ntp"></a>Windows タイム サービスと NTP
Windows Server 2016 には、時間を修正し、UTC と同期するローカル クロックの条件を使用して、アルゴリズムが向上しました。  NTP では、4 つの値を使用して、時間のオフセットを計算するクライアント要求/応答およびサーバー要求/応答のタイムスタンプに基づいています。  ただし、ネットワーク間で送受信され、ネットワークの輻輳とネットワークの待機時間に影響するその他の要因が原因の NTP データのスパイクがあります。  Windows 2016 アルゴリズムは、その結果、安定性と正確なクロックのさまざまな技術の番号を使用してこのノイズが平均です。  さらに、ソース使用の正確な時刻のリファレンス API 以上の解像度を向上します。  これらの機能強化を使ってドメイン全体で、UTC に対して 1 ms 精度を実現します。

### <a name="hyper-v"></a>Hyper-v の概要
Windows 2016 は、Hyper-V TimeSync サービスを向上しました。 VM のスタート画面または VM の復元と w32time に提供されるサンプルの割り込みの待機時間補正より正確な最初の時間が強化されました。  この機能強化により、RMS (ルート平均 2 乗、差異を示す)、ホストの内 10µs を維持するための 75% の負荷を搭載したマシン上でも、50µs できます。

> [!NOTE]
> この記事を参照してください[Hyper-V アーキテクチャ](https://msdn.microsoft.com/library/cc768520.aspx)詳細についてはします。

> [!NOTE]
> 負荷が分散プロファイルを使用して prime95 ベンチマークを使用して作成されました。

さらに、ホストがゲストに報告している階層レベルより透過的です。  以前、ホストであれば、その精度に関係なく、2 の固定階層です。  Windows Server 2016 での変更は、ホストは、1 つの仮想ゲストより良い時間につながるホスト階層より大きい階層を報告します。  ホストの階層は、そのソース時間に基づく通常の方法で w32time によって決定されます。  ドメインには、ゲストは、最も正確なクロックよりホストに既定の検索は、Windows 2016 が参加しています。  この理由からおを手動で Windows 2012R2 にし、下のドメインに参加しているマシンの Hyper-V タイム プロバイダの設定を無効にすることをお勧めでした。

### <a name="monitoring"></a>監視
パフォーマンス モニター カウンターが追加されました。  監視、および時刻の精度をトラブルシューティングこれらを基準に許可します。  これらのカウンターは次のとおりです。

カウンター|説明|
----- | ----- |
時間のオフセットを計算|   W32Time サービスによってマイクロ秒単位で計算されるシステム クロックと、選択した時間ソースの間でオフセット絶対時間。 新しい有効なサンプルが利用可能な計算された時間は、サンプルによって示される時間のオフセットで更新されます。 これは、ローカルの時計の実際の時間のオフセットです。 W32time は、このオフセットを使用したクロック補正を開始し、サンプルの間に計算された時刻をローカル クロックに適用する必要がある残り時間オフセットで更新します。 クロックの精度は、このパフォーマンス カウンターを使用して低ポーリング間隔を追跡ことができます (例: 256 秒以内) し、必要なクロックの精度制限よりも小さくなるように、カウンターの値を探しています。|
クロックの周波数の調整| 10億ごとの部分で W32Time がローカル システム クロックに加えた絶対クロックの周波数調整します。 このカウンタは、W32time が実行している操作を視覚化することができます。|
NTP 往復遅延時間|    最新のラウンド トリップ遅延マイクロ秒単位で、サーバーから応答の受信、NTP クライアントで発生します。 これは、時間経過した日数 NTP クライアントの NTP サーバーへの要求を送信して、サーバーから有効な応答を受信します。 このカウンタは、NTP クライアントによって経験豊富な遅延の特性を説明することができます。 拡大またはさまざまなラウンドト リップは、さらに NTP で時刻の同期の精度に影響する可能性があります、NTP タイム計算をノイズを追加できます。|
NTP クライアントのソースの数|    NTP クライアントで使用されている NTP タイム ソースのアクティブな数です。 これは、このクライアントの要求に応答して、タイム サーバーの IP アドレスを使用中の個別の数です。 この番号は、構成されているピア、ピア名と現在リーチを拡大機能の DNS の解像度に応じてより大きくまたは小さく可能性があります。|
NTP サーバー入力方向の要求|   NTP サーバー (要求数/秒) が受信した要求の数。|
NTP サーバーの出力方向の応答|  NTP サーバー (応答/秒) が回答する要求の数。|

最初の 3 つのカウンターは、正確性の問題のトラブルシューティングのシナリオを対象です。  時刻の精度のトラブルシューティングと NTP、後述の「下にある[ベスト プラクティス](#BestPractices)、が詳しく説明します。
最後の 3 カウンターは、NTP サーバーのシナリオを対象し、する際に役立つとを判別負荷ベース ライニング、現在のパフォーマンスがします。

### <a name="configuration-updates-per-environment"></a>環境ごとの構成の更新
次に、Windows 2016 と以前のバージョンの間での役割ごとの既定の構成の変更について説明します。  Windows Server 2016 と Windows 10 Anniversary Update(build 14393)、設定ができるようになりました一意ですが、別々 の列として表示されます。 

|ロール|設定|Windows Server 2016|Windows 10 バージョン 1607|Windows Server 2012 R2</br>Windows Server 2008 R2</br>Windows 10|
|---|---|---|---|---|
|**スタンドアロン/Nano Server**||||
| |*タイム サーバー*|time.windows.com|NA|time.windows.com|
| |*ポーリング間隔*|64-1024 (秒)|NA|毎週 1 回|
| |*クロックの更新頻度*|1 秒に 1 回|NA|1 時間に 1 回|
|**スタンドアロンのクライアント**||||
| |*タイム サーバー*|NA|time.windows.com|time.windows.com|
| |*ポーリング間隔*|NA|1 日 1 回|毎週 1 回|
| |*クロックの更新頻度*|NA|1 日 1 回|毎週 1 回|
|**ドメイン コント ローラー**||||
| |*タイム サーバー*|PDC/GTIMESERV|NA|PDC/GTIMESERV|
| |*ポーリング間隔*|64-1024 (秒)|NA|1024-32768 (秒)|
| |*クロックの更新頻度*|1 日 1 回|NA|毎週 1 回|
|**ドメイン メンバー サーバー**||||
| |*タイム サーバー*|DC|NA|DC|
| |*ポーリング間隔*|64-1024 (秒)|NA|1024-32768 (秒)|
| |*クロックの更新頻度*|1 秒に 1 回|NA|5 分に 1 回|
|**ドメイン メンバー クライアント**||||
| |*タイム サーバー*|NA|DC|DC|
| |*ポーリング間隔*|NA|1204-32768 (秒)|1024-32768 (秒)|
| |*クロックの更新頻度*|NA|5 分に 1 回|5 分に 1 回|
|**Hyper-V ゲスト**||||
| |*タイム サーバー*|ホストと時間のサーバーの階層に基づいて最適なオプションを選択します。|ホストと時間のサーバーの階層に基づいて最適なオプションを選択します。|既定値はホスト|
| |*ポーリング間隔*|上記の役割に基づく|上記の役割に基づく|上記の役割に基づく|
| |*クロックの更新頻度*|上記の役割に基づく|上記の役割に基づく|上記の役割に基づく|

>[!NOTE]
>インストールされた Hyper-v の Linux を参照してください、[Hyper-V ホストの時刻を使用するを許可する Linux](#AllowingLinux)以下のセクションです。

### <a name="impact-of-increased-polling-and-clock-update-frequency"></a>ポーリングし、周波数を更新した場合の影響
正確な時刻を提供するためのポーリングの頻度およびクロックの更新プログラムの既定値が増加して小規模の調整をより頻繁に行うことができるようにします。  これは、結果より多くの UDP/NTP トラフィック、ただし、これらのパケットは小さいので非常に小さなが存在する必要がありますまたはブロード バンド リンク経由で影響はありません。 利点が、その時間より多様なハードウェア、および環境の方が優れてする必要があります。

、バッテリ バックアップ デバイス用のポーリング間隔を増やすと、問題が発生することができます。  バッテリー デバイスがになっている間の時間を保存しないでください。  再開したときは、時計を頻繁に修正が必要です。  ポーリングの頻度を増やすことが不安定になるクロックが発生しより多くの電力を使用することもできます。  Microsoft では、クライアントの既定の設定を変更しないことをお勧めします。

ドメイン コントローラーは、AD ドメインに NTP クライアントからの向上、更新プログラムの乗算の効果を使用しても最小限に抑える影響を受ける必要があります。  NTP には、その他のプロトコルとわずかな影響を受けると比較してより小さなリソースの消費があります。  Windows Server 2016 の向上の設定によって影響を受けている前にその他のドメインの機能の制限に到達することが多くなります。  Active Directory は、時刻を同期する単純な NTP のよりも低くなります正確にされる傾向にあり、セキュリティで保護された NTP を使用しますが、PDC から離れた場所のクライアントの 2 つの階層をスケール アップは確認しました。

慎重な計画、としては、コアあたり 1 秒あたり 100 の NTP 要求を予約する必要があります。  たとえば、4 つのコアでの 4 つの Dc から成るドメインにする必要がありますできる 1 秒あたりの 1600 NTP 要求を処理します。  10 の k クライアントが 64 秒に 1 回、時刻を同期するように構成があると時間の経過と共に、要求が均一に受信、10,000/64 で表示される場合、または場合 160 約要求数/秒は、すべての Dc に分散します。  当社 1600 NTP 要求数/秒この例に基づいて範囲内に簡単になります。  これらは慎重に計画に関する推奨事項であり、もちろん依存している大規模なネットワーク、プロセッサ速度、負荷のように、常にベースラインおよびテスト環境におけるします。

注意すること、Dc が 40% を超える膨大な CPU 負荷を実行している場合これはほぼ間違いなく NTP の応答にノイズを追加、ドメイン内の時刻の精度に影響を与える重要です。  もう一度、実際の結果を理解する環境でテストする必要があります。

## <a name="time-accuracy-measurements"></a>時刻の精度の測定
### <a name="methodology"></a>手法
Windows Server 2016 の時刻の精度を測定するには、さまざまなツール、メソッド、および環境を使用しています。  測定する環境内の調整し、特定の精度の結果が、要件を満たしているかどうかに、これらの手法を使用できます。 

GPS ハードウェアで高精度 NTP サーバーを 2 つのドメイン ソース時計を行いました。  別の参照のテスト コンピューターは、高精度 GPS ハードウェアの製造元が異なるからインストールもが測定値のおにも使用されます。  テストの一部は、参照だけでなく、ドメインのクロックのソースとして使用する、クロックを正確かつ信頼性の高いソースする必要があります。

4 つの方法を使用して、物理および仮想マシンの両方の正確性を測定します。 複数の方法では、結果を検証する独立した手段が用意されています。


1. 別の GPS ハードウェアは、参照テスト コンピューターに対して w32tm して顧客をローカルの時計を測定します。  
2.  W32tm"stripchart"を使用したクライアントの NTP サーバーから測定 NTP ping
3.  W32tm"stripchart"を使用して、NTP サーバーをクライアントからのメジャー NTP の ping
4.  測定の Hyper-V ホストがタイム スタンプ カウンタ (TSC) を使用して、ゲストに起因します。  このカウンタは、両方のパーティションのパーティションとシステム時刻の両方の間で共有されます。  ここには、仮想マシンでのホストの時間とクライアントの時間差が計算されます。  測定値は、同時に発生しないので、ゲストからホストの時間を補間するのに TSC クロックを使用します。  また、API の遅延と待機時間を TSV クロック要素を使用します。

W32tm は組み込まれてが、テストと使用状況のオープン ソースとして、テスト中に使用して、その他のツールは、Microsoft のリポジトリの GitHub で利用可能です。  リポジトリの WIKI を測定値を行うには、ツールを使用する方法を説明する詳細があります。

> [https://github.com/Microsoft/Windows-Time-Calibration-Tools](https://github.com/Microsoft/Windows-Time-Calibration-Tools)

次に示すテストの結果は、テスト環境のいずれかに行った測定値のサブセットです。  これらは、開始時間の階層と時間の階層の最後に子ドメインのクライアントで管理されている精度を示しています。  これは、同じマシン 2012 ベースのトポロジで比較のためと比較されます。

### <a name="topology"></a>トポロジ
比較のため、Windows Server 2012R2 と Windows Server 2016 のベース トポロジーをテストしました。  両方のトポロジは、GPS クロックのハードウェアがインストールされていると、Windows Server 2016 コンピューターを参照している 2 台の物理的な Hyper-V ホスト コンピューターで構成されます。  各ホストでは、3 ドメインに参加している windows ゲストは、次のトポロジに従って配置を実行します。  行は、時間の階層、および使用されるプロトコル/トランスポートを表します。

![Windows タイム](media/Windows-2016-Accurate-Time/topology1.png)

![Windows タイム](media/Windows-2016-Accurate-Time/topology2.png)

### <a name="graphical-results-overview"></a>グラフィカルな結果の概要
次の 2 つのグラフは、2 つの特定メンバー上のトポロジに基づくドメイン内の時刻の精度を表します。  各グラフが表示されます Windows Server 2012R2 と 2016 の結果、オーバーレイの両方を視覚的に強化点を示します。  精度は、ホストと比較して、ゲスト マシン内から測定されたします。  グラフィカルなデータは、行ったテストのセット全体のサブセットを表し、最善のケースと最悪のシナリオを示しています。  

![Windows タイム](media/Windows-2016-Accurate-Time/topology3.png)

### <a name="performance-of-the-root-domain-pdc"></a>ルート ドメインの PDC のパフォーマンス
ルート PDC は、正確性と安定性の両方であることが実証済みの GPS ハードウェアと Windows Server 2016 である Hyper-V ホスト (VMIC を使用) に同期されます。  これは、1 ms 正確さ、緑色の影の領域として表示されているが重要な要件です。

![Windows タイム](media/Windows-2016-Accurate-Time/chart1.png)

### <a name="performance-of-the-child-domain-client"></a>子ドメインのクライアントのパフォーマンス
子ドメインのクライアントは、ルート PDC と通信する子ドメインの PDC に関連付けられます。  時間内にあるも 1 ms 要件。

![Windows タイム](media/Windows-2016-Accurate-Time/chart2.png)


### <a name="long-distance-test"></a>長距離のテスト
次の表は、Windows Server 2016 での 6 つの物理ネットワーク ホップ数を 1 つの仮想ネットワークのホップを比較します。  2 つのグラフは、重複するデータを表示する透明度を互いに重なって表示されます。  高待機時間、およびタイム誤差が大きく増加のネットワーク ホップ数を意味します。  グラフが拡大して、1 ms 境界、緑色の領域で表されるが大きい。  時間がまだ内にある 1 がわかるように、複数のホップで ms です。  それが悪影響シフトされ、ネットワーク非対称性を示します。  もちろん、すべてのネットワークが異なるため、および測定値は、多くの環境の要因によって異なります。

![Windows タイム](media/Windows-2016-Accurate-Time/chart3.png)

## <a name="BestPractices"></a>正確な計時のベスト プラクティス
### <a name="solid-source-clock"></a>実線ソース クロック
マシン時間と同期ソース クロックと同程度のみです。  1 を達成するために ms の正確性をする必要があります GPS ハードウェアまたは時間アプライアンス、マスター ソース クロックとして参照するネットワーク上でします。  time.windows.com の既定値を使用して、可能性があります、安定性とローカルのタイム ソースは提供されません。  さらに、ソース クロックから離れた場所にさらにすると、ネットワークは精度に影響します。  マスター ソース クロックを持つ各データ センターは精度を最大限に必要です。

### <a name="hardware-gps-options"></a>ハードウェアの GPS オプション
正確な時刻を提供するさまざまなハードウェア ソリューションがあります。  一般に、現在、解決策は GPS アンテナに基づいています。  ラジオおよび専用の行を使用するダイヤルアップ モデム ソリューションもあります。  これらはアプライアンスは、いずれかとしてネットワークに接続またはインスタンスから Windows PCIe または USB デバイスを PC に接続します。  さまざまなオプションはさまざまなレベルの正確性を提供し、として常に、結果は、環境に依存します。  変数精度に影響を与えるにはには、GPS の可用性、ネットワークの安定性と負荷、および PC のハードウェアが含まれます。  これらは、安定性と正確な時刻の要件を説明したようは、移行元のクロックを選択すると、すべての重要な要素です。

### <a name="domain-and-synchronizing-time"></a>ドメインと時刻の同期
ドメイン メンバー コンピューターを決定する、ドメインの階層を使用して時刻を同期するソースとして使用します。  各ドメインのメンバーでは、クロックのソースとして保存してを同期する別のコンピューターを検索します。  ドメイン メンバーの種類ごとでは、時刻の同期のクロックのソースを検索するために別の規則のセットを次に示します。  フォレスト ルート内 PDC は、すべてのドメインの既定のクロック ソースです。  以下に示すは、さまざまな役割とソースを検索する方法の高レベルの説明を示します。


- **PDC の役割を持つドメイン コントローラー** – このコンピューターがドメインの信頼できるタイム ソース。 ドメインで、利用可能な最も正確な時間があること、および以外の場合、親ドメイン内の DC と同期する必要があります、[GTIMESERV](#GTIMESERV)ロールが有効にします。 
- **その他のドメイン コントローラー** – このマシンは、クライアントと、ドメインのメンバー サーバーのタイム ソースとして機能します。 DC は、独自のドメインの PDC または親ドメインの任意の DC と同期できます。
- **クライアント/メンバー サーバー** – このマシンは、すべての DC または、独自のドメイン、または、DC の PDC または親ドメインの PDC と同期できます。

使用可能な候補に基づき、スコア システムは、最適なタイム ソースを検索に使用されます。  このシステムでは、タイム ソースとの相対的な位置の信頼性が考慮されます。  これとは、時刻はサービスの開始後に発生します。  時刻の同期方法の詳細に制御する場合は、特定の場所で適切なタイム サーバーを追加したり、冗長性を追加できます。  参照してください、[指定、ローカル信頼性の高いタイム サービスを使用して GTIMESERV](#GTIMESERV)の詳細については、セクションです。

#### <a name="mixed-os-environments-win2012r2-and-win2008r2"></a>OS が混在環境 (Win2012R2 と Win2008R2)
純粋な Windows Server 2016 ドメイン環境より正確に必要なときにまだ利点があります、混在環境でします。  Windows Server 2016 Hyper-V で Windows 2012 のドメインを展開すると、のみ場合、ゲストも Windows Server 2016 が上で説明したようにの機能強化のため、ゲストが役立ちます。  Windows Server 2016 PDC より安定したソースはなりますアルゴリズムの向上のためのより正確な時刻を提供できるようになります。  PDC の代替としてできない可能性があります、オプション、代わりと Windows Server 2016 の DC を追加することができます、[GTIMESERV](#GTIMESERV)以前のバージョンにアップグレード ドメインの精度になる設定します。  Windows Server 2016 の DC がダウン ストリーム タイム クライアントをより良い時間を配信できます、ただし、そのソース NTP 時刻と同程度はのみです。

、前述のようにも Windows Server 2016 では、クロックのポーリングと更新頻度が変更されました。  これらは、ダウンレベルの Dc を手動で変更できます。またはグループ ポリシーを通じて適用します。  これらの構成をテストしましたしていないときにこれら Win2008R2 と Win2012R2 で適切に動作され、いくつかの利点を提供する必要があります。

Windows Server 2016 には、複数の問題が、システム時刻ふわふわと漂う調整が行われた後すぐにその結果の状態に保つ正確な時刻を維持することが必要がある前に、のバージョン。  このためは、頻繁に正確な NTP ソースからタイム サンプルを取得し、データをローカル クロックを調整が下位レベルの OS バージョンでの状態に保つ、これまでの間サンプリング期間中にそれらのシステム クロックの小さいドリフトにつながります。 観察された最適な精度は、高精度の設定で構成された、Windows Server 2012R2 の NTP クライアントは、正確な Windows 2016 NTP サーバーからその時間を同期するときに、約 5 ms をしました。

ゲストのドメイン コントローラーが関係するシナリオによっては、Hyper-V TimeSync サンプルは、ドメインの時刻の同期を中断することができます。  Server 2016 の Hyper-v ホストで実行されている Server 2016 のゲストの問題となったあります。

W32time にサンプルを提供することから、Hyper-V TimeSync サービスを無効にするには、次のゲスト レジストリ キーを設定します。

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider 
    "Enabled"=dword:00000000

#### <a name="AllowingLinux"></a>Hyper-V ホストの時刻を使用する Linux を許可します。
Hyper-V で実行されている Linux ゲスト、クライアントは通常に使用する NTP デーモンの NTP サーバーに対して時刻同期を構成します。  TimeSync バージョン 4 のプロトコルをサポートする Linux ディストリビューション、Linux ゲスト TimeSync 統合サービスを有効になっている場合は、ホストの時間と同期されます。 両方の方法が有効にした場合の状態に保つ矛盾した時刻にこの可能性があります。

ホストの時間に対してのみを同期することが推奨 NTP 時刻の同期を無効にするいずれかで。

- Ntp.conf ファイルに存在する NTP サーバーを無効にします。
- または、NTP デーモンを無効にします。

この構成では、タイム サーバー パラメーターは、このホストです。  ポーリング間隔は、5 秒、クロックの更新頻度も 5 秒です。

NTP 経由でのみ同期をゲストで TimeSync 統合サービスを無効にすることをお勧めします。

> [!NOTE]
> 注: Linux ゲストの正確な時刻のサポートが必要です、最新アップ ストリームの Linux カーネルでのみサポートされている機能し、そうでないもの広く利用可能なすべての Linux ディストリビューションの間でまだします。 参照してください[Windows にインストールされた Hyper-v のサポートされている Linux および FreeBSD の仮想マシン](https://technet.microsoft.com/en-us/windows-server-docs/virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows)サポート ディストリビューションの詳細についてはします。

#### <a name="GTIMESERV"></a>GTIMESERV を使用して、ローカルの信頼性の高いタイム サービスを指定します。
クロックの正確なソースとして 1 つまたは複数のドメイン コントローラーを指定できます GTIMESERV、良好なのタイム サーバーを使用してフラグを設定します。  たとえば、特定のドメイン コントローラが搭載されて GPS ハードウェア フラグを設定できます、GTIMESERV として。  GPS ハードウェアに基づいてクロックを参照して、ドメインが保証されます。

> [!NOTE]
> ドメインのフラグの詳細については記載されて、[MS ADTS プロトコル ドキュメント](https://msdn.microsoft.com/library/mt226583.aspx)します。

TIMESERV は、別関連ドメイン サービスを示すフラグ、マシンに現在の権限があるかどうかを DC には、接続が失われた場合に変更できます。  この状態では、DC は「不明な階層」NTP を使用して照会されたときに戻ります。  複数回を試行して、ドメイン コントローラーは、システム イベント タイム サービスのイベント 36 を記録します。

GTIMESERV として DC を構成する場合は、この構成できます、次のコマンドを使用して手動でします。  この場合、DC は、マスター クロックとして別のマシンを使用しています。  これにより、アプライアンスまたは専用マシン可能性があります。

    w32tm /config /manualpeerlist:”master_clock1,0x8 master_clock2,0x8” /syncfromflags:manual /reliable:yes /update

> [!NOTE]
> 詳細については、次を参照してください[Windows タイム サービスを構成する。](https://technet.microsoft.com/library/cc731191.aspx)

DC にインストールされている GPS ハードウェアがある場合は、次の手順を使用して、NTP クライアントを無効にし、NTP サーバーを有効にする必要があります。

NTP クライアントを無効にして起動し、これらのレジストリ キーの変更を使用して、NTP サーバーを有効にします。

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpClient /v Enabled /t REG_DWORD /d 0 /f

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpServer /v Enabled /t REG_DWORD /d 1 /f

次に、Windows タイム サービスを再起動します。

    net stop w32time && net start w32time

最後に、このコンピューターを使用して信頼性の高いタイム ソースがあるを指定します。
   
    w32tm /config /reliable:yes /update

変更が正しく実行されていることを確認するには、下に表示される結果に影響する次のコマンドを実行できます。 

    w32tm /query /configuration

値|予想される設定|
----- | ----- |
AnnounceFlags|  5 (ローカル)|
NtpServer   |(ローカル)|
宣言されました。 |C:\WINDOWS\SYSTEM32\w32time.DLL (ローカル)|
有効になっています。 |1 (ローカル)|
NtpClient|  (ローカル)|

    w32tm /query /status /verbose

値|  予想される設定|
----- | ----- |
階層|    1 (プライマリ リファレンス - ラジオ クロックで syncd)|
ReferenceId|    0x4C4F434C (移行元の名前:"LOCAL")|
ソース| ローカル CMOS クロック|
フェーズ オフセット|   0.0000000s|
サーバーの役割|    576 (信頼性の高いタイム サービス)|

#### <a name="windows-server-2016-on-3rd-party-virtual-platforms"></a>サード パーティの仮想プラットフォームで Windows Server 2016
Windows が仮想化されたときに既定では、ハイパーバイザーは時間を提供する責任です。  Active Directory が正常に動作するためにドメイン コントローラーと同期がとれていである必要があるメンバーがドメインに参加しています。  ゲストと、サード パーティの仮想プラットフォームのホストの間の任意の時間仮想化を無効にすることをお勧めします。

#### <a name="discovering-the-hierarchy"></a>階層の検出
時間マスター クロック ソース階層のチェーンには、ドメインでは、動的かつネゴシエートされたが後のタイム ソースとチェーンをマスター ソース クロックが理解する特定のコンピューターの状態を照会する必要があります。  これは、時刻の同期の問題の診断に役立ちます。

指定する特定のクライアントのトラブルシューティング最初の手順では、この w32tm コマンドを使用してそのタイム ソースを理解しています。

    w32tm /query /status

結果は、特に、ソースを表示します。  ソースは、相手ドメイン内の時刻を同期することを示します。  これは、このマシン時間階層の最初のステップです。
次に上からソース エントリを使用し、使用、/StripChart チェーン内の次のタイム ソースを検索するパラメーターです。

    w32tm /stripchart /computer:MySourceEntry /packetinfo /samples:1

便利ですが、次のコマンドは、指定されたドメイン内で見つかった各ドメイン コントローラーの一覧を表示し、結果は、各パートナーを決定することができますを印刷します。  このコマンドは、手動で構成されているコンピューターが含まれます。
    
    w32tm /monitor /domain:my_domain

リストを使用して、ドメインを使用して、結果のトレースし、各ステップにタイム オフセットだけでなく、階層理解できます。  時間のオフセットが大幅に低下を取得ポイントを特定するで正しくない時刻のルートを特定できます。  そこからできますしようとする理由その時刻が正しくない有効にして理解[w32tm ログ](#W32Logging)します。 

#### <a name="using-group-policy"></a>グループ ポリシーを使用
使えばグループ ポリシーによってより厳密な正確さを実現するインスタンス、使用する特定の NTP サーバーまたは仮想化されたときに制御する方法、ダウンレベル OS が構成されているクライアントを割り当てることできます。  
考えられるシナリオと関連するグループ ポリシー設定の一覧を次に示します。

**ドメインを仮想化された**- Hyper-V ホストが、このレジストリ エントリを無効にでくのではなく、自分のドメインと時刻を同期するように Windows 2012R2 の仮想化ドメイン コントローラーを制御するためにします。   PDC のたくエントリを無効にするように、Hyper-v ホストが安定性の高いタイム ソースを提供します。  レジストリ エントリでは、それが変更された後、w32time サービスを再起動する必要があります。

    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider]
    "Enabled"=dword:00000000

**精度機密性の高い負荷**- 時間精度機密性の高いワークロードの場合、NTP サーバーを設定するコンピューターのグループを構成でき、いずれかに関連する時刻の設定などのポーリングとクロック周波数を更新します。  これは通常、ドメインによって処理されるが、詳細な制御でしたをターゲットにする特定のコンピューターに、マスター クロックを直接指し示します。

グループ ポリシー設定|   新しい値|
----- | ----- |
NtpServer|  ClockMasterName、0x8|
MinPollInterval|    6 ~ 64 (秒)|
MaxPollInterval|    6|
UpdateInterval| 1 秒間に 1 回 100 –|
EventLogFlags|  3-すべての特殊な時間ログ|

> [!NOTE]
> NtpServer と EventLogFlags の設定は、Windows NTP クライアントの構成設定を使って System\Widows タイム Service\Time プロバイダー \bin にあります。  その他の 3 は、グローバル構成設定を使用して System\Windows タイム サービスは \bin にあります。

**リモート精度機密性の高い負荷がリモート**– インスタンス小売と支払クレジット Industry (PCI) はブランチのドメインでシステム、Windows は、現在のサイト情報を使用し、ローカルの DC を検索、手動の NTP がない限り、DC ロケーター タイム ソースが構成されています。  この環境では、1 秒間の正確性を正しい時刻に高速の収束を使用するが必要です。  このオプションでは、w32time サービスにより、クロックを逆方向に移動します。  これは許容、要件を満たしている場合は、次のポリシーを作成できます。   あらゆる環境と同様、ことを確認してテストとベースライン ネットワーク。 

グループ ポリシー設定|   新しい値|
----- | ----- |
MaxAllowedPhaseOffset|  1、2 番目の複数の場合を正しい時刻にまま時計を設定します。|

MaxAllowedPhaseOffset 設定は、グローバル構成設定を使用して System\Windows タイム サービスは \bin にあります。

> [!NOTE]
> グループ ポリシーと関連するエントリの詳細については、次を参照してください。[Windows タイム サービス ツール](windows-time-service-tools-and-settings.md)と TechNet の記事を設定します。

#### <a name="azure-and-windows-iaas-considerations"></a>Azure と Windows IaaS に関する考慮事項

##### <a name="azure-virtual-machine-active-directory-domain-services"></a>Active Directory ドメイン サービスの azure 仮想マシンの場合:
Active Directory ドメイン サービスを実行して、Azure VM 既存にオンプレミスの一部である場合、Active Directory フォレスト、TimeSync(VMIC) しを無効にする必要があります。 これは、1 つの時間同期階層を使用して物理および仮想的では、フォレスト内のすべての Dc を許可するようにします。 ベスト プラクティスに関するホワイト ペーパーを参照してください[「を実行しているドメイン コントローラーにインストールされた Hyper-v」](https://technet.microsoft.com/en-us/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx)

##### <a name="azure-virtual-machine-domain-joined-machine"></a>Azure 仮想マシンの場合: ドメインに参加しているコンピューター
仮想でも物理でも、既存の Active Directory フォレストに参加しているドメインのマシンをホストしている場合、ベスト プラクティスはゲストの TimeSync を無効にし、W32Time がの種類の時間を構成する経由では、ドメイン コントローラーと同期するように構成を NTP5 を =

##### <a name="azure-virtual-machine-standalone-workgroup-machine"></a>Azure 仮想マシンの場合: スタンドアロン ワークグループ マシン
場合は、Azure VM が、ドメインに参加していないもに、ドメイン コントローラーは、既定時の設定を保持し、ホストとの同期、VM があるをお勧めします。

### <a name="windows-application-requiring-accurate-time"></a>正確な時刻を必要とする Windows アプリケーション
#### <a name="time-stamp-api"></a>タイムスタンプ API
(UTC) と時間の経過しないに関する最大の精度を必要とするプログラムを使用する必要があります、[GetSystemTimePreciseAsFileTime API](https://msdn.microsoft.com/library/windows/desktop/Hh706895.aspx)します。  これにより、アプリケーションは、システム時刻は、Windows タイム サービスによって条件を取得します。

#### <a name="udp-performance"></a>UDP パフォーマンス
基本的なエンジンをフィルタ リングをポート UDP 通信を使用してトランザクションとは、待機時間を最小限に抑えるが関連するいくつかのレジストリ エントリの対象から除外するために、ポートの範囲を構成することができますを使用するアプリケーションがあるかどうか。  両方の待機時間を向上させるためされ、スループットが向上します。  ただし、レジストリの変更は、経験豊富な管理者に制限する必要があります。  さらに、この回避策からファイアウォールでセキュリティ保護されているポートを除外します。  詳細については次の記事リファレンスを参照してください。

Windows Server 2012 と Windows Server 2008 では、まず修正プログラムをインストールする必要があります。  このサポート技術情報の記事を参照することができます:[データグラムが失われる場合、Windows 8 および Windows Server 2012 でのマルチキャストの受信側のアプリケーションを実行します。](https://support.microsoft.com/en-us/kb/2808584)

#### <a name="update-network-drivers"></a>ネットワーク ドライバーを更新します。
一部のネットワーク ベンダーは、ドライバーの待機時間と UDP パケットをバッファー処理についてのパフォーマンスを向上させるドライバーの更新プログラムがあります。  UDP スループットを支援する更新プログラムがあるかどうかをネットワーク ベンダーに問い合わせてください。

### <a name="logging-for-auditing-purposes"></a>監査目的でログ記録
時間トレース規制に準拠するために手動で w32tm ログ、イベント ログおよびパフォーマンス モニタの情報を保存することができます。  後で、アーカイブされた情報は、過去の特定の時点で対応を証明する際に使用できます。  次の要因については、正確性を示すために使用されます。


1. クロックの精度が時間のオフセットを計算するパフォーマンス モニター カウンターを使用します。  これにより、必要な精度内でクロックが表示されます。
2.  クロックのソースが w32tm ログに「からの応答をピア」を探しています。   次のメッセージ テキストは、IP アドレスまたは VMIC で、タイム ソースと、[次への参照の時計のチェーン内を検証するについて説明します。
3.  W32tm ログを使用することを検証する条件の状態のクロック"ClockDispl 統制: \*SKEW\*TIME\*"が発生しています。  これは、時にその w32tm がアクティブなを示します。

#### <a name="event-logging"></a>イベント ログ
完全なストーリーを取得するには、イベント ログの情報も必要があります。  によって、システム イベント ログを収集して、タイム サーバーがのフィルタ リング、Microsoft Windows カーネル ブート、Microsoft Windows のカーネル全般、ことができますが変更されている場合、たとえば、サード パーティの他の影響があるかどうかを検出します。  これらのログを外部からの干渉を除外する必要があります。  グループ ポリシー イベント ログがログに書き込まれるに影響を与えることができます。  使用してグループ ポリシーの詳細については、上のセクションを参照してください。

#### <a name="W32Logging"></a>W32time デバッグ ログ
監査目的で w32tm を有効にするのには、次のコマンドは、ログ記録をクロックの定期的な更新プログラムを表示し、移行元のクロックを示しますを有効します。  新しいログを有効にサービスを再起動します。  

詳細については、次を参照してください。[Windows タイム サービスでデバッグ ログをオンにする方法](https://support.microsoft.com/en-us/kb/816043)します。

    w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-73,103,107,110

#### <a name="performance-monitor"></a>パフォーマンス モニター
Windows Server 2016 の Windows タイム サービスは、監査ログを収集するために使用するパフォーマンス カウンターを公開します。  これらは、ローカルまたはリモートでログインすることができます。  コンピューターの時間のオフセットおよびラウンド トリップ遅延カウンターを記録することができます。  
パフォーマンス カウンターのようにリモート サーバーを監視および System Center Operations Manager を使用してアラートを作成します。  必要な精度からずれた時間オフセットの警報をアラートを使用することができます、たとえば。  [System Center 管理パック](https://social.technet.microsoft.com/wiki/contents/articles/15251.system-center-management-pack-authoring-guide.aspx)の詳細についてはします。

#### <a name="windows-traceability-example"></a>Windows の追跡機能の例
W32tm ログ ファイルから、2 つの情報を検証するされます。  1 つ目は、ログ ファイルが現在クロックの条件を示します。  これを証明する争議時に、Windows タイム サービスによって、コンピューターの時計を規定されているされました。

    151802 20:18:32.9821765s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:223 CR:156250 UI:100 phcT:65 KPhO:14307
    151802 20:18:33.9898460s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:64 KPhO:41
    151802 20:18:44.1090410s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:65 KPhO:38

主なポイントは、メッセージは実証 w32time ClockDispln 統制付きますが、システム時計と対話するが表示されることです。
 
次に参照クロックとして使用されている移行元コンピューターを報告争議時刻より前に、ログの最後のレポートを検索する必要があります。  IP アドレス、コンピューター名、またはインストールされた Hyper-v のホストとの同期には、ことを示す VMIC プロバイダーを使用できます。  次の例では、10.197.216.105 の IPv4 アドレスを提供します。

    151802 20:18:54.6531515s - Response from peer 10.197.216.105,0x8 (ntp.m|0x8|0.0.0.0:123->10.197.216.105:123), ofs: +00.0012218s

これで、参照時間チェーン内の最初のシステムを検証する参照のタイム ソース上のログ ファイルを調査し、同じ手順を繰り返して必要があります。  これは、GPS など NIST のような既知のタイム ソースの物理的なクロックが表示されるまでは続行されます。  参照クロックが GPS ハードウェアの場合は、製造からログも必要になります。

### <a name="network-considerations"></a>ネットワークに関する考慮事項
NTP プロトコル アルゴリズムは、ネットワークの対称に依存しています。  ネットワーク ホップの数の増加、として非対称の危険性が向上します。  どのような種類の精度に表示される、特定の環境を予測するために困難です。 

パフォーマンス モニタ、および Windows Server 2016 での新しい Windows Time カウンターは、環境の正確性を評価し、基準の作成に使用できます。 さらに、ネットワーク上の任意のコンピューターの現在のオフセットを決定するためのトラブルシューティングを行うことができます。

ネットワーク経由で 2 つの一般的な規格の正確な時刻があります。  PTP ([精度タイム プロトコル - IEEE 1588](https://www.nist.gov/el/intelligent-systems-division-73500/introduction-ieee-1588)) に対してより厳密な要件がネットワーク インフラストラクチャ、サブのマイクロ秒の正確性を提供できる多くの場合。  NTP ([ネットワーク タイム プロトコル – の RFC 1305](https://tools.ietf.org/html/rfc1305)) は、大規模なさまざまなネットワークと環境では、管理しやすくなるで機能します。 

Windows では、既定ではないドメインに参加しているマシンの単純な NTP (RFC2030) をサポートしています。  ドメインに参加しているコンピューター、お使用と呼ばれるセキュリティで保護された NTP [MS SNTP](https://msdn.microsoft.com/en-us/library/cc246877.aspx)、RFC1305 と RFC5905 で説明されている認証 NTP 経由で管理できるというメリットを提供するドメインがネゴシエート シークレットを活用します。   

ドメインと非ドメインに参加しているプロトコルの両方の UDP ポート 123 が必要です。  NTP のベスト プラクティスに関する詳細についてを参照してください[ネットワーク タイム プロトコル ベスト プラクティス IETF この下](https://tools.ietf.org/html/draft-ietf-ntp-bcp-00)します。

### <a name="reliable-hardware-clock-rtc"></a>信頼性の高いハードウェア クロック (RTC)
手順時刻ではなく、Windows では特定の制限が超過しましたではなく、クロックを分野しない限り、します。  つまり、w32tm クロック更新頻度、Windows Server 2016 で秒おきにどの既定値の設定を使用して、定期的な間隔でクロックの周波数を調整します。  頻度が高速化、クロックがの内側にある場合と先である場合が長くなる頻度。  ただし、その間のクロック周波数の調整の間で、ハードウェア クロックがコントロールします。  ファームウェアまたはハードウェア クロックで問題がある場合、コンピューターの時刻が正確性が劣るになります。

これをテストする必要がある別の原因として、環境内で基準です。  「時間オフセットを計算」パフォーマンス カウンタは、対象とする正確さで安定化しない、する可能性がある場合は、ファームウェアが最新の状態を確認します。  別のテストと重複するハードウェアが、同じ問題を再現する場合を確認できます。

### <a name="troubleshooting-time-accuracy-and-ntp"></a>時刻の精度と NTP のトラブルシューティング
検出を使用する階層上記の不正確なタイム ソースを理解します。  時刻が NTP ソースから最もと見なすと、階層内のポイントの検索時間オフセットを見ると、します。  階層について理解すると、その特定のタイム ソースが正確な時刻を表示しない理由を理解してみてくださいします。  

発散時間を使用してシステムに重点を置いて、以下のこれらのツールを使用して、解像度を検索して、問題を特定するための詳細情報を収集します。  以下、UpstreamClockSource 参照は、クロックを使用して検出された"w32tm /config/status"です。


- システム イベント ログ
- ログを使用して有効にする]: w32tm ログ - w32tm/debug/enable/file: C:\Windows\Temp\w32time-test.log/size: 10000000 /entries: 0 ~ 300
- HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time w32Time レジストリ キー
- ローカル ネットワーク トレース
- パフォーマンス カウンター (ローカル コンピューターまたは、UpstreamClockSource から)
- W32tm /stripchart /computer: UpstreamClockSource
- PING UpstreamClockSource 待機時間とソースへのホップの数を理解するには
- Tracert UpstreamClockSource

問題|    問題の症状|   解決策|
----- | ----- | ----- |
ローカル TSC クロックが安定しません。| Perfmon - 物理コンピューター – 同期クロック安定したクロック、まだを使用することを確認 100us いくつかの 1 ~ 2 分ごとです。 |   ファームウェアを更新または確認さまざまなハードウェアは、同じ問題を表示しません。|
ネットワークの待機時間|    w32tm stripchart では、複数の 10 ms の RoundTripDelay が表示されます。  遅延のバリエーションには、半分のラウンド トリップ時間、一方向でのみである遅延インスタンスと同じ大きさ異音が発生します。</br></br>UpstreamClockSource は複数のホップでは、PING によって示されます。  TTL が 128 の近くにする必要があります。</br></br>Tracert を使用すると、各ホップで、待機時間を検索できます。    | 時間の近くのクロック ソースを検索します。  1 つのソリューションでは、同じセグメントにソース クロックをインストールするか、手動では、地理的に近いソース クロックをポイントします。  ドメインのシナリオでは、GTimeServ の役割を持つコンピューターを追加します。 |  
確実に NTP ソースに到達できません。|    W32tm /stripchart 断続的に「要求がタイムアウト」を返します    |NTP ソースが応答性の高いがないです。|
NTP ソースが応答性の高いがないです。|    NTP クライアント ソースの数、NTP サーバーの入力方向の要求の NTP サーバーの発信応答のパフォーマンス カウンターを確認し、基準と比較して、使用量を決定します。|    サーバーのパフォーマンス カウンターを使用して、基準を参照して、負荷が変更されたかどうかを決定します。</br></br>ネットワークの輻輳の問題があるか。|
最も正確なクロックを使用していないドメイン コントローラー|    トポロジまたは最近追加したマスター タイム クロックに変更します。|   w32tm/resync/rediscover|
クライアントの時計がふわふわと漂う| タイム サービス イベント 36 をされることを示すログ ファイル内のシステム イベント ログおよびテキスト: しようとして 1 から 0"NTP クライアントの時間のソース Count"カウンタ|アップ ストリームのソースのトラブルシューティングを行うし、パフォーマンスの問題に実行されているかどうかを理解します。|

### <a name="baselining-time"></a>ベース ライニング時間
最初に、パフォーマンスと、ネットワークの正確性について理解して、問題が発生したときに、今後、基準と比較できるように、ベース ライニングが重要です。  基準にルート PDC または、GTIMESRV でマークされているすべてのマシンします。  お勧めする基準すべてのフォレストで PDC します。  最後に、重要な Dc または距離または負荷が高いとベースラインと同様に、興味深い特性を持つコンピューターを選ぶようです。

ただし、w32tm のみがある Windows Server 2016 の基準 vs 2012 R2、すると便利ですも /stripchart を比較して、Windows Server 2012R2 はパフォーマンス カウンターがあるないためのツールとして使用できます。  同じの特性を持つ 2 台のコンピューターの選択、コンピューターをアップグレードまたは更新後に結果を比較してください。  Windows 時間の測定に関する補遺 2016 と 2012 の間で詳細な測定値を行う方法の詳細があります。

すべての w32time パフォーマンス カウンターを使用して、少なくとも 1 週間のデータを収集します。  さまざまな時間の経過と共に、ネットワーク内のアカウントへの参照の十分な数と、時刻の精度が安定している信頼度を提供する、実行の十分な数がある保証します。

### <a name="ntp-server-redundancy"></a>NTP サーバーの冗長性
非ドメインに参加しているコンピューターまたは PDC で使用する手動の NTP サーバー構成、サーバーを 1 つ以上が可用性が発生した場合、良好な冗長性対策です。  すべてのソースと安定性が正確であると見なして、精度が向上にも与えられます。  ただし、トポロジ適切に設計されていません、タイム ソースが安定していない場合、または場合結果の精度可能性があります状況も悪化のでご注意ください。  サーバー w32time が参照できる手動でサポートされている時間の制限は 10 です。 

## <a name="leap-seconds"></a>Leap (秒)
地球の回転の期間は climatic および地質学的イベントの原因となった時間の経過と共に変化します。 通常、バリエーションは約 1 秒間ごと数年です。 アトミックの時刻からのバリエーションが大きくなりすぎる場合は、常に 1 秒間 (上下) の修正が挿入、leap 秒と呼ばれます。 これは、このような形で違いが 0.9 秒を超えることはありません。 この修正が、実際の修正事前 6 か月を発表しました。 、Windows Server 2016 の前に、Microsoft のタイム サービスが leap 時間 (秒)、気が付かなかったが、これに対処するための外部のタイム サービスに依存します。 Windows Server 2016 の「大きくなり、時間正確さで Microsoft が生じます問題をより適切なソリューションに取り組んでいます。

## <a name="secure-time-seeding"></a>時間のシードをセキュリティで保護します。
Server 2016 で W32time には、時間のシードをセキュリティで保護機能が含まれています。 この機能では、出力方向の SSL 接続からおおよその現在の時間を決定します。  この時刻値は、ローカル システム クロックを監視し、総エラーを修正に使用されます。 詳細を読み取ることができます、機能に関する[このブログ投稿](https://blogs.msdn.microsoft.com/w32time/2016/09/28/secure-time-seeding-improving-time-keeping-in-windows/)します。  信頼性の高いタイムでの展開でソースと時間オフセットの監視が含まれるも監視対象のコンピューターでは、時間のシードをセキュリティで保護機能を使用し、代わりに、既存のインフラストラクチャに依存しないすることもできます。 

これらの手順で、機能を無効にすることができます。

1.  特定のコンピューターで、UtilizeSSLTimeData レジストリ構成の値を 0 に設定します。

    Reg は、HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config/v UtilizeSslTimeData/t REG_DWORD/d 0/f を追加します。


2.  すぐになんらかの理由により、マシンを再起動することはできない場合、は、W32time サービス構成の更新に関するを通知できます。 これにより、停止時の監視され、SSL 接続から時間データに基づく実施が収集されます。 

    W32tm.exe /config/update

3.  コンピューターの再起動設定効果的なすぐになりもは、SSL 接続からのデータの収集を停止します。  後半は非常に小さいオーバーヘッドが発生し、パフォーマンスの問題ができないようにします。

4.  ドメイン全体でこの設定を適用するには、W32time グループ ポリシー設定を 0 に UtilizeSSLTimeData 値を設定し、設定を公開してください。  設定は、選択グループ ポリシー クライアントによってと W32time サービスは通知時の監視と SSL の時間データを使用して実施は停止します。 SSL 時間データ コレクションは、各コンピューターの再起動時に停止します。 ポータブル薄型のラップトップ/タブレットやその他のデバイスがドメインにある、場合は、このポリシーの変更からそのようなマシンを除外することがあります。 これらのデバイスのバッテリーのドレインを最終的に直面して、時間のブートス トラップに対する機能時間シードをセキュリティで保護された必要があります。














 













 




