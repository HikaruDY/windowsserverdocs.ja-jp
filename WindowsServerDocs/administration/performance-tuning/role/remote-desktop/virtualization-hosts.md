---
title: リモートデスクトップ仮想化ホストのパフォーマンスチューニング
description: リモートデスクトップ仮想化ホストのパフォーマンスチューニング
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 6aad1560fa9f9429af94426487d9a33369137ded
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/27/2019
ms.locfileid: "71370029"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>リモートデスクトップ仮想化ホストのパフォーマンスチューニング


リモートデスクトップ仮想化ホスト (RD 仮想化ホスト) は、仮想デスクトップインフラストラクチャ (VDI) シナリオをサポートし、複数の同時ユーザーが、を実行しているサーバーでホストされている仮想マシンで Windows ベースのアプリケーションを実行できるようにする役割サービスです。Windows Server 2016 および Hyper-v。

Windows Server 2016 では、仮想デスクトップ、個人用仮想デスクトップ、プールされた仮想デスクトップの2種類がサポートされています。

**このトピックの内容:**

-   [一般的な考慮事項](#general-considerations)

-   [パフォーマンスの最適化](#performance-optimizations)

## <a name="general-considerations"></a>全般的な考慮事項


### <a name="storage"></a>ストレージ

ストレージは、パフォーマンスのボトルネックとなる可能性が高いので、仮想マシンの状態の変更によって生成される i/o 負荷を適切に処理するために、記憶域のサイズを変更することが重要です。 パイロットまたはシミュレーションが不可能な場合は、4つのアクティブな仮想マシン用に1つのディスクスピンドルをプロビジョニングすることをお勧めします。 書き込みパフォーマンスが良好なディスク構成 (RAID 1 + 0 など) を使用します。

必要に応じて、ディスクの重複除去とキャッシュを使用してディスクの読み取り負荷を軽減し、記憶域ソリューションを有効にして、イメージの重要な部分をキャッシュすることでパフォーマンスを向上させます。

### <a name="data-deduplication-and-vdi"></a>データ重複除去と VDI

Windows Server 2012 R2 で導入されたデータ重複除去では、開いているファイルの最適化をサポートしています。 重複除去ボリュームで実行されている仮想マシンを使用するには、仮想マシンファイルを Hyper-v ホストとは別のホストに格納する必要があります。 Hyper-v と重複除去が同じコンピューター上で実行されている場合、2つの機能はシステムリソースに対して競合し、全体のパフォーマンスに悪影響を与えます。

また、"仮想デスクトップインフラストラクチャ (VDI)" 重複除去の最適化の種類を使用するようにボリュームを構成する必要があります。 これを構成するには、サーバーマネージャー (**ファイルサービスおよび記憶域サービス** - &gt; **ボリューム** - &gt;の**重複除去設定**) を使用するか、次の Windows PowerShell コマンドを使用します。

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

> [!NOTE]
> 開いているファイルのデータ重複除去の最適化は、SMB 3.0 経由のリモート記憶域を使用する Hyper-v の VDI シナリオでのみサポートされます。

### <a name="memory"></a>Memory

サーバーのメモリ使用量は、主に次の3つの要因によって決まります。

-   オペレーティングシステムのオーバーヘッド

-   仮想マシンごとの hyper-v サービスのオーバーヘッド

-   各仮想マシンに割り当てられたメモリ

一般的なナレッジワーカーワークロードの場合は、x86 ウィンドウ8または Windows 8.1 を実行しているゲスト仮想マシンに、ベースラインとして ~ 512 MB のメモリが割り当てられている必要があります。 ただし、ワークロードによっては、動的メモリによってゲスト仮想マシンのメモリが約 800 MB に増加する可能性があります。 X64 では、約 800 MB が開始され、1024 MB に増加しています。

そのため、予想されるゲスト仮想マシンの数に必要なメモリを満たすために十分なサーバーメモリを確保し、そのサーバーに十分な量のメモリを確保することが重要です。

### <a name="cpu"></a>CPU

RD 仮想化ホストサーバーのサーバー容量を計画する場合、物理コアあたりの仮想マシンの数は、ワークロードの性質によって異なります。 出発点として、物理コアあたり12台の仮想マシンを計画してから、適切なシナリオを実行してパフォーマンスと密度を検証することが妥当です。 ワークロードの詳細によっては、密度が高くなる可能性があります。

ハイパースレッディングを有効にすることをお勧めしますが、論理プロセッサの数ではなく、物理コアの数に基づいてオーバーサブスクリプションの比率を計算することをお勧めします。 これにより、CPU ごとに予想されるパフォーマンスレベルが保証されます。

### <a name="virtual-gpu"></a>仮想 GPU

RD 仮想化ホストの Microsoft RemoteFX は、ホスト側のリモート処理、レンダリングキャプチャエンコードのパイプライン、クライアントに基づく制限の高い効率的な GPU ベースのエンコードを使用した、仮想デスクトップインフラストラクチャ (VDI) のための豊富なグラフィックスエクスペリエンスを提供します。アクティビティ、および DirectX 対応の仮想 GPU。 RD 仮想化ホスト用 RemoteFX 仮想 GPU を DirectX9 から DirectX11 にアップグレードします。 また、より高い解像度でより多くのモニターをサポートすることで、ユーザーエクスペリエンスが向上します。

RemoteFX DirectX11 experience は、ソフトウェアによってエミュレートされるドライバーを使用して、ハードウェア GPU なしで使用できます。 このソフトウェア GPU は優れたエクスペリエンスを提供しますが、RemoteFX virtual graphics processing unit (VGPU) は、仮想デスクトップにハードウェアアクセラレータのエクスペリエンスを追加します。

Windows Server 2016 を実行しているサーバーで RemoteFX VGPU エクスペリエンスを利用するには、ホストサーバーで GPU ドライバー (DirectX 11.1 や WDDM 1.2 など) が必要です。 RD 仮想化ホスト用 RemoteFX で使用する GPU オファリングの詳細については、GPU プロバイダーに問い合わせてください。

VDI の展開で RemoteFX 仮想 GPU を使用する場合、デプロイ容量は使用シナリオとハードウェア構成によって異なります。 展開を計画するときは、次の点を考慮してください。

-   システム上の Gpu の数

-   Gpu のビデオメモリ容量

-   システム上のプロセッサとハードウェアのリソース

### <a name="remotefx-server-system-memory"></a>RemoteFX サーバーのシステムメモリ

仮想 GPU が有効になっているすべての仮想デスクトップについて、RemoteFX はゲストオペレーティングシステムと RemoteFX 対応サーバーのシステムメモリを使用します。 ハイパーバイザーは、ゲストオペレーティングシステムのシステムメモリの可用性を保証します。 サーバーでは、各仮想 GPU 対応仮想デスクトップで、システムのメモリ要件をハイパーバイザーに提供する必要があります。 仮想 GPU が有効な仮想デスクトップを起動すると、ハイパーバイザーは、VGPU が有効な仮想デスクトップ用に RemoteFX 対応サーバーに追加のシステムメモリを予約します。

Remotefx が有効になっているサーバーで消費されるメモリの量は、VGPU が有効な仮想デスクトップに関連付けられているモニターの数と、の最大解像度に依存しているため、RemoteFX が有効になっているサーバーのメモリ要件は動的です。これらのモニター。

### <a name="remotefx-server-gpu-video-memory"></a>RemoteFX サーバー GPU ビデオメモリ

すべての仮想 GPU 対応仮想デスクトップでは、ホストサーバー上の GPU ハードウェアのビデオメモリを使用してデスクトップがレンダリングされます。 レンダリングに加えて、ビデオメモリは、レンダリングされた画面を圧縮するためにコーデックによって使用されます。 必要なメモリの量は、仮想マシンにプロビジョニングされているモニターの量によって決まります。

予約されているビデオメモリは、モニターの数とシステムの画面解像度によって異なります。 ユーザーによっては、特定のタスクに対して画面の解像度が高くなることがあります。 他のすべての設定が変わらない場合、低い解像度の設定でスケーラビリティが向上します。

### <a name="remotefx-processor"></a>RemoteFX プロセッサ

ハイパーバイザーは、RemoteFX が有効なサーバーと、CPU 上の仮想 GPU が有効な仮想デスクトップをスケジュールします。 システムメモリとは異なり、RemoteFX がハイパーバイザーと共有する必要があるその他のリソースに関連する情報はありません。 RemoteFX が仮想 GPU 対応仮想デスクトップにもたらす追加の CPU オーバーヘッドは、仮想 GPU ドライバーとユーザーモードリモートデスクトッププロトコルスタックの実行に関連します。

RemoteFX 対応サーバーでは、仮想 GPU が有効な仮想デスクトップごとに追加のプロセス (rdvgm) が実行されるため、オーバーヘッドが増加します。 このプロセスでは、グラフィックスデバイスドライバーを使用して、GPU 上でコマンドを実行します。 また、コーデックは Cpu を使用して、クライアントに送り返す必要がある画面データを圧縮します。

より多くの仮想プロセッサは、より優れたユーザーエクスペリエンスを意味します。 仮想 GPU が有効な仮想デスクトップごとに少なくとも2つの仮想 Cpu を割り当てることをお勧めします。 また、仮想 GPU が有効な仮想デスクトップ用の x64 アーキテクチャを使用することをお勧めします。これは、x64 仮想マシンのパフォーマンスが x86 仮想マシンと比較しやすくなるためです。

### <a name="remotefx-gpu-processing-power"></a>RemoteFX GPU 処理能力

各仮想 GPU が有効な仮想デスクトップには、RemoteFX 対応サーバーで実行されている対応する DirectX プロセスがあります。 このプロセスでは、RemoteFX 仮想デスクトップから受信したすべてのグラフィックスコマンドが物理 GPU に再生されます。 物理 GPU の場合は、複数の DirectX アプリケーションを同時に実行することと同じです。

通常、グラフィックスデバイスとドライバーは、デスクトップ上でいくつかのアプリケーションを実行するようにチューニングされています。 RemoteFX は、Gpu を一意の方法で拡大します。 GPU が RemoteFX サーバーでどのように実行されているかを測定するために、RemoteFX 要求に対する GPU 応答を測定するためのパフォーマンスカウンターが追加されました。

通常、GPU リソースのリソースが不足している場合は、GPU に対する読み取りと書き込みの操作が完了するまでに時間がかかります。 パフォーマンスカウンターを使用すると、管理者は予防措置を講じて、エンドユーザーのダウンタイムを回避できます。

RemoteFX サーバーでは、次のパフォーマンスカウンターを使用して、仮想 GPU のパフォーマンスを測定できます。

**RemoteFX グラフィックス**

-   スキップされた**フレーム数/秒-クライアントリソースが不足**していますクライアントリソースが不足しているためにスキップされたフレームの1秒あたりの数

-   **グラフィックスの圧縮率**入力したバイト数にエンコードされたバイト数の比率

**RemoteFX ルート GPU 管理**

-   **参考サーバー gpu**の tdrs サーバーの gpu で TDR がタイムアウトする合計回数

-   **参考Remotefx 3d ビデオアダプター**がインストールされている仮想マシンの合計数を実行している仮想マシン

-   **VRAM使用されて**いない専用のビデオメモリの GPU 容量あたりの使用可能な MB

-   **VRAMGPU あたりの予約% @ no__t-RemoteFX 用に予約されている専用のビデオメモリの 0%

**RemoteFX ソフトウェア**

-   **モニタのキャプチャレート**\[1-4\]モニター1-4 の RemoteFX キャプチャ率を表示します

-   **圧縮率**Windows 8 で非推奨とされ、**グラフィックス圧縮比**に置き換えられました

-   **遅延フレーム/秒**一定の時間内にグラフィックスデータが送信されなかった1秒あたりのフレーム数

-   **キャプチャからの GPU 応答時間**GPU 操作を完了するために RemoteFX キャプチャで計測される待機時間 (マイクロ秒)

-   **レンダリングからの GPU 応答時間**GPU 操作を完了するための RemoteFX レンダリングで測定される待機時間 (マイクロ秒)

-   **出力バイト数**RemoteFX 出力バイト数の合計

-   **クライアント数/秒を待機して**いますWindows 8 で非推奨とされ、スキップされた**フレーム数/秒-クライアントリソースが不足**しています

**RemoteFX vGPU 管理**

-   **参考Tdrs ローカルから virtual machines**この仮想マシンで発生した tdrs の合計数 (仮想マシンに伝達されたサーバーは含まれません)

-   **参考サーバー上で発生し** 、仮想マシンに反映された tdrs の合計数に基づく tdrs

**RemoteFX 仮想マシン vGPU パフォーマンス**

-   **データ** 1 秒あたりに仮想マシンのデスクトップに表示される現在の操作の数 (秒単位) を起動したもの。

-   **データ送信された**表示数/秒1秒あたりの仮想マシンによってサーバー GPU に送信された現在の操作の総数

-   **データ1秒あたりの**読み取りバイト数と RemoteFX が有効なサーバーからの読み取りバイト数の合計

-   **データ1秒あたりの**送信バイト数 (RemoteFX が有効なサーバー GPU に送信されたバイト数の合計)

-   **DMA通信バッファーの平均遅延時間 (** 秒)。通信バッファーで費やされた平均時間 (秒)

-   **DMADma が送信されて**から完了するまでの待機時間 (秒)

-   **DMARemoteFX 3d**ビデオアダプターのキューの長さの DMA キューの長さ

-   **参考仮想マシンの gpu**あたりの TDR タイムアウト数 TDR タイムアウトの数

-   **参考TDR タイムアウト (gpu エンジン**あたり)-仮想マシンの gpu エンジンごとに発生した TDR タイムアウトの数

RemoteFX 仮想 GPU のパフォーマンスカウンターに加えて、ビデオメモリの使用量と GPU 使用率を示すプロセスエクスプローラーを使用して、GPU 使用率を測定することもできます。

## <a name="performance-optimizations"></a>パフォーマンスの最適化

### <a name="dynamic-memory"></a>動的メモリ

動的メモリを使用すると、実行中の仮想マシン間でメモリを分散する方法を分散することにより、Hyper-v を実行しているサーバーのメモリリソースをより効率的に使用できます。 変化するワークロードに応じて、仮想マシン間でメモリを動的に再割り当てできます。

動的メモリを使用すると、パフォーマンスやスケーラビリティを犠牲にすることなく、既存のリソースで仮想マシンの密度を高めることができます。 その結果、コストのかかるサーバーハードウェアリソースがより効率的に使用されます。これにより、管理が容易になり、コストを削減できます。

複数の論理プロセッサにまたがる仮想プロセッサを使用して Windows 8 以降を実行しているゲストオペレーティングシステムでは、メモリ使用量を最小限に抑え、動的メモリを無効にしてパフォーマンスを向上させるために、動的メモリとの間のトレードオフを考慮してください。コンピュータートポロジを認識するアプリケーションの。 このようなアプリケーションでは、トポロジ情報を活用して、スケジュール設定とメモリ割り当てに関する決定を行うことができます。

### <a name="tiered-storage"></a>階層型記憶域

RD 仮想化ホストは、仮想デスクトッププール用の階層型記憶域をサポートします。 コレクション内のすべてのプールされた仮想デスクトップで共有される物理コンピューターでは、ミラー化されたソリッドステートドライブ (SSD) などの、サイズの小さい高パフォーマンスの記憶域ソリューションを使用できます。 プールされた仮想デスクトップは、RAID 1 + 0 などの低コストの従来の記憶域に配置できます。

物理コンピューターは、プールされた仮想デスクトップからの読み取り i/o のほとんどが管理オペレーティングシステムに移動するため、SSD に配置する必要があります。 そのため、物理コンピューターによって使用される記憶域は、1秒あたりの読み取り i/o の量を大幅に増やす必要があります。

この展開構成では、パフォーマンスが必要な場合に、コスト効果の高いパフォーマンスを保証します。 SSD は、構成に応じて、より小さいサイズのディスク (コレクションあたり最大 20 GB) のパフォーマンスを向上させることができます。 プールされた仮想デスクトップの従来の記憶域 (RAID 1 + 0) では、仮想マシンあたり約 3 GB が使用されます。

### <a name="csv-cache"></a>CSV キャッシュ

Windows Server 2012 以降のフェールオーバークラスタリングでは、クラスター共有ボリューム (CSV) でのキャッシュが提供されます。 これは、読み取り i/o の大部分が管理オペレーティングシステムから取得されるプールされた仮想デスクトップコレクションに対して非常に有益です。 CSV キャッシュを使用すると、2回以上読み取られるブロックがキャッシュされ、システムメモリから配信されるため、i/o を減らすことができるため、パフォーマンスが向上します。 CSV キャッシュの詳細については、「 [Csv キャッシュを有効にする方法](http://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx)」を参照してください。

### <a name="pooled-virtual-desktops"></a>プールされた仮想デスクトップ

既定では、プールされた仮想デスクトップは、ユーザーがサインアウトした後に不自然状態にロールバックされるため、最後のユーザーのサインイン以降に Windows オペレーティングシステムに加えられた変更は破棄されます。

ロールバックを無効にすることはできますが、仮想デスクトップテンプレートのさまざまな更新によってプールされた仮想デスクトップコレクションが再作成されるので、一時的な状態になります。

永続的な状態に依存する Windows の機能とサービスを無効にすることは理にかなっています。 また、主に非エンタープライズシナリオ用のサービスを無効にすることも意味があります。

各サービスは、広範なデプロイの前に適切に評価される必要があります。 次に、最初に考慮すべき点をいくつか示します。

| サービス                                      | なぜでしょうか。                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 自動更新                                  | プールされた仮想デスクトップは、仮想デスクトップテンプレートを再作成することによって更新されます。                                                                                                                          |
| オフラインファイル                                | 仮想デスクトップは常にオンラインであり、ネットワーク上の観点から接続されています。                                                                                                                         |
| バックグラウンドデフラグ                            | ファイルシステムの変更は、ユーザーがサインオフした後に破棄されます (不自然状態へのロールバック、または仮想デスクトップテンプレートの再作成により、プールされたすべての仮想デスクトップが再作成されます)。 |
| 休止状態またはスリープ状態                           | このような VDI の概念はありません                                                                                                                                                                                   |
| バグチェックメモリダンプ                        | プールされた仮想デスクトップにはこのような概念はありません。 バグチェックのプールされた仮想デスクトップは、不自然状態から開始します。                                                                                       |
| WLAN 自動 autoconfig                              | VDI 用の WiFi デバイスインターフェイスはありません                                                                                                                                                                 |
| Windows Media Player ネットワーク共有サービス | コンシューマー中心のサービス                                                                                                                                                                                  |
| ホームグループプロバイダー                          | コンシューマー中心のサービス                                                                                                                                                                                  |
| インターネット接続の共有                  | コンシューマー中心のサービス                                                                                                                                                                                  |
| Media Center 拡張サービス               | コンシューマー中心のサービス                                                                                                                                                                                  |
> [!NOTE]
> この一覧は、意図された目的とシナリオに影響する変更があるため、完全な一覧ではありません。 詳細については、「ホットオフ」、「今すぐ入手」、「 [Windows 8 VDI の最適化スクリプト」、「PFE!](http://blogs.technet.com/b/jeff_stokes/archive/2013/04/09/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe.aspx)」を参照してください。

 
> [!NOTE]
> 既定では、Windows 8 の SuperFetch が有効になっています。 VDI 対応であり、無効にしないでください。 SuperFetch を使用すると、VDI の利点を活用して、メモリページ共有によってメモリ消費をさらに減らすことができます。 Windows 7 を実行するプールされた仮想デスクトップ、SuperFetch は無効にする必要がありますが、Windows 7 を実行している個人用仮想デスクトップの場合は、そのままにしておく必要があります。

 
